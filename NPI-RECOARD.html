<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPI Record - Multi-User Real-time</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Myriad Pro', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #000;
            line-height: 1.2;
            padding: 10px;
            margin: 0;
            font-size: 11px;
        }
        
        .container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .form-content {
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }
        
        .header h1 {
            color: #000;
            margin-bottom: 5px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .form-section {
            margin-bottom: 20px;
            border: 1px solid #000;
            border-radius: 2px;
            padding: 10px;
            background-color: #fff;
            page-break-inside: auto;
        }
        
        .section-title {
            background-color: #e0e0e0;
            color: #000;
            padding: 8px 10px;
            margin: -10px -10px 10px -10px;
            border-bottom: 1px solid #000;
            font-size: 14px;
            font-weight: bold;
        }
        
        .sub-section-title {
            background-color: #f0f0f0;
            color: #000;
            padding: 6px 8px;
            margin: 10px -10px;
            border-top: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            font-size: 13px;
            font-weight: bold;
        }
        
        .form-row {
            display: flex;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .form-group {
            flex: 1;
            min-width: 180px;
            margin-bottom: 8px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #000;
            font-size: 11px;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 5px 8px;
            border: 1px solid #999;
            border-radius: 3px;
            font-size: 11px;
            background-color: white;
            transition: all 0.3s ease;
        }
        
        .form-group textarea {
            min-height: 70px;
            resize: vertical;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 8px;
            padding: 8px 0;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
        }
        
        .checkbox-item input {
            margin-right: 6px;
        }
        
        .signature-container {
            border: 1px solid #999;
            border-radius: 3px;
            padding: 8px;
            margin-top: 8px;
            background-color: white;
        }
        
        .signature-pad {
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 100%;
            height: 120px;
            cursor: crosshair;
        }
        
        .signature-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .signature-controls button {
            padding: 6px 12px;
            background-color: #4a6fa5;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .signature-controls button:hover {
            background-color: #3a5a8a;
        }
        
        .signature-display {
            height: 80px;
            border: 1px dashed #999;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-style: italic;
            background-color: #f9f9f9;
        }
        
        .signature-display img {
            max-width: 100%;
            max-height: 100%;
        }
        
        .buttons-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 5px;
            position: sticky;
            top: 10px;
            z-index: 100;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            min-width: 160px;
        }
        
        .btn-primary {
            background-color: #4a6fa5;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #3a5a8a;
        }
        
        .btn-success {
            background-color: #2e7d32;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #1b5e20;
        }
        
        .btn-danger {
            background-color: #c62828;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #b71c1c;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            margin-bottom: 15px;
            font-size: 11px;
            table-layout: fixed;
        }
        
        th, td {
            border: 1px solid #000;
            padding: 6px;
            text-align: left;
            vertical-align: top;
            word-wrap: break-word;
        }
        
        th {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
        }
        
        td.long-content-cell {
            min-height: 60px;
            height: auto;
        }
        
        .note {
            font-size: 10px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        .footer {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 11px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                padding: 0;
                margin: 0;
                background-color: white;
                font-size: 10pt;
            }
            
            .container {
                box-shadow: none;
                padding: 0;
                margin: 0;
                width: 100%;
            }
            
            .form-content {
                padding: 15mm;
            }
            
            .signature-display {
                border: 1px solid #000;
            }
            
            .buttons-container {
                display: none;
            }
            
            .form-section {
                page-break-inside: auto;
            }
            
            input, textarea, select, .signature-pad {
                display: none !important;
            }
        }
        
        .input-small {
            width: 100px;
            display: inline-block;
        }
        
        .input-medium {
            width: 180px;
            display: inline-block;
        }
        
        .form-group.full-width {
            flex: 0 0 100%;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        /* ========== HIGHLIGHT DỮ LIỆU ========== */
        .form-input.has-data,
        .form-textarea.has-data,
        .form-select.has-data {
            color: #1565C0 !important;
            border-color: #000 !important;
            background-color: transparent !important;
            font-weight: 300 !important;
        }
        
        .checkbox-item input:checked {
            accent-color: #1565C0;
        }
        
        .highlight-text {
            color: #1565C0 !important;
            font-weight: normal !important;
            background-color: transparent !important;
            padding: 2px 4px;
            border-radius: 2px;
        }
        
        .signature-display.has-signature {
            border: 2px solid #1565C0;
            background-color: #E8F5E9;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(21, 101, 192, 0.2);
        }
        
        .highlight-row {
            background-color: #F5F9FF !important;
        }
        
        /* Cloud Status */
        .cloud-status {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cloud-status .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .online { background-color: #4CAF50; }
        .offline { background-color: #f44336; }
        .syncing { 
            background-color: #FF9800; 
            animation: pulse 1s infinite; 
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Online Users */
        .online-users {
            background: linear-gradient(135deg, #2196F3 0%, #21CBF3 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .users-list-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .users-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .user-badge .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .user-badge .user-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        .user-badge.editing {
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 0 2px currentColor;
        }
        
        /* Project Info */
        .project-info {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 10px;
        }
        
        #projectIdDisplay {
            font-family: monospace;
            cursor: pointer;
            padding: 2px 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }
        
        /* Field being edited by others */
        .field-being-edited {
            animation: fieldPulse 2s infinite;
            box-shadow: 0 0 0 2px #FF9800 !important;
        }
        
        @keyframes fieldPulse {
            0%, 100% { background-color: rgba(255, 152, 0, 0.1); }
            50% { background-color: rgba(255, 152, 0, 0.3); }
        }
        
        /* Real-time typing indicator */
        .typing-indicator {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #FF9800;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 11px;
            z-index: 9999;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .field-updated {
            animation: fieldUpdate 1s ease;
        }
        
        @keyframes fieldUpdate {
            0% { background-color: #E8F5E9; }
            50% { background-color: #C8E6C9; }
            100% { background-color: #E8F5E9; }
        }
        
        .share-link-container {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            display: none;
        }
        
        .share-link {
            word-break: break-all;
            background: white;
            padding: 8px;
            border-radius: 3px;
            margin-top: 5px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 12px;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a6fa5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: 500;
            z-index: 10001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }
        
        .toast-success {
            background: #4CAF50;
        }
        
        .toast-error {
            background: #f44336;
        }
        
        .toast-info {
            background: #2196F3;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .validation-error {
            border-color: #f44336 !important;
            box-shadow: 0 0 0 2px rgba(244, 67, 54, 0.2) !important;
        }
        
        /* Tab navigation */
        .process-tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 2px solid #4a6fa5;
            margin-bottom: 15px;
            background-color: #f0f0f0;
        }
        
        .process-tab {
            padding: 10px 20px;
            background: #e0e0e0;
            border: none;
            border-right: 1px solid #ccc;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .process-tab.active {
            background: #4a6fa5;
            color: white;
        }
        
        .process-tab:hover:not(.active) {
            background: #d0d0d0;
        }
        
        .process-content {
            display: none;
        }
        
        .process-content.active {
            display: block;
        }
        
        /* ========== CHỮ KÝ THEO MẪU ẢNH ========== */
        .signature-section {
            position: relative;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background-color: #fff;
        }
        
        .signature-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .signature-header h4 {
            margin: 0;
            font-size: 14px;
            color: #333;
            flex: 1;
        }
        
        .signature-header .role-tag {
            background: linear-gradient(135deg, #2196F3 0%, #21CBF3 100%);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .signature-type-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .signature-type-selector label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .signature-type-selector label:hover {
            background: #e3f2fd;
        }
        
        .signature-type-selector input[type="radio"] {
            margin: 0;
            accent-color: #2196F3;
        }
        
        .signature-drawing-area {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background: #fafafa;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .signature-upload-area {
            display: none;
            border: 2px dashed #2196F3;
            border-radius: 5px;
            padding: 20px;
            background: #f8fdff;
            margin-bottom: 10px;
            text-align: center;
            cursor: pointer;
        }
        
        .signature-upload-placeholder {
            color: #666;
            font-size: 12px;
            margin: 10px 0;
        }
        
        .signature-upload-placeholder i {
            font-size: 36px;
            color: #2196F3;
            margin-bottom: 8px;
            display: block;
        }
        
        .signature-preview {
            max-width: 100%;
            max-height: 80px;
            margin: 10px auto;
            display: block;
            border: 1px solid #ddd;
            padding: 3px;
            background: white;
            border-radius: 3px;
        }
        
        .signature-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .signature-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .signature-actions .btn-clear {
            background: #f44336;
            color: white;
        }
        
        .signature-actions .btn-clear:hover {
            background: #d32f2f;
        }
        
        .signature-actions .btn-save {
            background: #4CAF50;
            color: white;
        }
        
        .signature-actions .btn-save:hover {
            background: #2E7D32;
        }
        
        .signature-actions .btn-upload {
            background: #2196F3;
            color: white;
        }
        
        .signature-actions .btn-upload:hover {
            background: #0b7dda;
        }
        
        .signature-display-container {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #eee;
        }
        
        .signature-display-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .signature-display {
            height: 90px;
            border: 2px dashed #ccc;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-style: italic;
            background-color: white;
            overflow: hidden;
        }
        
        .signature-display.has-signature {
            border: 2px solid #4CAF50;
            background-color: #f1f8e9;
        }
        
        .signature-display img {
            max-width: 100%;
            max-height: 85px;
        }
        
        .signer-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .signer-info .form-group {
            margin: 0;
        }
        
        .signer-info label {
            font-size: 11px;
            color: #555;
            margin-bottom: 3px;
            display: block;
        }
        
        .signer-info input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .remove-signer-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #f44336;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .remove-signer-btn:hover {
            background: #d32f2f;
        }
        
        .signature-template {
            display: none;
        }
        
        .upload-signature-btn {
            padding: 6px 12px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .upload-signature-btn:hover {
            background-color: #0b7dda;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
        }
        
        .signature-option-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            background: #f5f5f5;
            border: 2px solid #ddd;
            border-radius: 5px;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .signature-option-btn:hover {
            background: #e3f2fd;
            border-color: #2196F3;
        }
        
        .signature-option-btn i {
            margin-right: 10px;
            color: #2196F3;
        }
        
        .signature-upload-area-large {
            border: 2px dashed #2196F3;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .signature-upload-area-large:hover {
            background: #e3f2fd;
        }
        
        .signature-upload-area-large i {
            font-size: 48px;
            color: #2196F3;
            margin-bottom: 10px;
        }
        
        .signature-preview-large {
            max-width: 100%;
            max-height: 150px;
            margin: 10px auto;
            display: block;
            border: 1px dashed #ccc;
            padding: 5px;
        }
        
        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
            
            .signature-type-selector {
                flex-direction: column;
                gap: 10px;
            }
            
            .signature-actions {
                flex-direction: column;
            }
            
            .signer-info {
                grid-template-columns: 1fr;
            }
        }
        
        /* Label Image Upload */
        .label-upload-area {
            border: 2px dashed #2196F3;
            border-radius: 5px;
            padding: 10px;
            background: #f8fdff;
            margin-bottom: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .label-upload-area:hover {
            background: #e3f2fd;
            border-color: #0b7dda;
        }
        
        .label-upload-placeholder {
            color: #666;
            font-size: 12px;
            margin: 10px 0;
        }
        
        .label-upload-placeholder i {
            font-size: 24px;
            color: #2196F3;
            margin-bottom: 5px;
            display: block;
        }
        
        .label-preview {
            max-width: 100%;
            max-height: 100px;
            margin: 5px auto;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 2px;
        }
        
        /* Highlight cho ảnh đã upload */
        .label-has-image {
            border: 2px solid #1565C0 !important;
            background-color: #E3F2FD !important;
        }
        
        .label-has-image .label-preview {
            border-color: #1565C0 !important;
        }
        
        /* Highlight cho dòng có ảnh */
        .row-has-label-image {
            background-color: #F5F9FF !important;
        }
        
        .row-has-label-image td {
            background-color: #F5F9FF !important;
        }

/* ========== FIX CHO CÁC Ô INPUT TRONG BẢNG ========== */
.form-section table input[type="text"],
.form-section table input[type="number"],
.form-section table select {
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box;
    margin: 2px 0;
}

/* Đặc biệt cho các ô xác nhận */
td div .input-medium,
td div .input-small {
    width: 100% !important;
    max-width: 120px !important;
    display: inline-block !important;
}

/* Đảm bảo ô chứa input không bị tràn */
td {
    position: relative;
    min-height: 20px;
}

/* Fix cho các dòng chứa nhiều input */
td > div {
    display: flex;
    flex-direction: column;
    gap: 3px;
    width: 100%;
}

td > div > span,
td > div > div {
    white-space: nowrap;
}

/* Responsive cho bảng nhỏ */
@media screen and (max-width: 768px) {
    .form-section table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }
    
    .input-medium, .input-small {
        max-width: 80px !important;
        font-size: 10px;
    }
}
    </style>
</head>
<body>
    <!-- Cloud Status Bar -->
    <div class="cloud-status no-print">
        <div>
            <span class="status-indicator offline" id="cloudStatus"></span>
            <span id="cloudStatusText">Chưa kết nối</span>
        </div>
        <div id="userCount" style="display: flex; align-items: center; gap: 5px;">
            <i class="fas fa-users"></i>
            <span>Chưa có project</span>
        </div>
    </div>

    <!-- Online Users -->
    <div class="online-users no-print" id="onlineUsersContainer" style="display: none;">
        <div class="users-list-title">
            <i class="fas fa-users"></i> 
            <span id="onlineUsersCount">0 người online</span>
            <span class="project-info">
                <i class="fas fa-project-diagram"></i>
                <span id="projectIdDisplay" title="Click để copy ID">ID: Chưa có project</span>
            </span>
        </div>
        <div class="users-list" id="usersList"></div>
    </div>

    <!-- Share Link Container -->
    <div class="share-link-container no-print" id="shareLinkContainer">
        <strong><i class="fas fa-share-alt"></i> LINK CHIA SẺ:</strong>
        <div class="share-link" id="shareLinkText"></div>
        <div style="margin-top: 10px;">
            <button id="copyLinkBtn" style="padding: 5px 10px; background: #4a6fa5; color: white; border: none; border-radius: 3px; cursor: pointer;">
                <i class="fas fa-copy"></i> Copy Link
            </button>
            <button id="closeShareBtn" style="margin-left: 10px; padding: 5px 10px; background: #666; color: white; border: none; border-radius: 3px; cursor: pointer;">
                <i class="fas fa-times"></i> Đóng
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div id="loadingMessage">Đang xử lý...</div>
        </div>
    </div>

    <!-- Buttons for actions -->
    <div class="buttons-container no-print">
        <button type="button" class="btn btn-primary" id="projectAction">
            <i class="fas fa-users"></i> Tạo/Tham gia Project
        </button>
        <button type="button" class="btn btn-success" id="saveToCloud">
            <i class="fas fa-cloud-upload-alt"></i> Lưu lên Cloud
        </button>
        <button type="button" class="btn btn-primary" id="shareForm">
            <i class="fas fa-share-alt"></i> Chia sẻ
        </button>
        <button type="button" class="btn btn-success" id="exportPdf">
            <i class="fas fa-file-pdf"></i> Xuất PDF
        </button>
        <button type="button" class="btn btn-danger" id="resetForm">
            <i class="fas fa-redo"></i> Làm mới
        </button>
        <button type="button" class="btn btn-primary" id="printForm">
            <i class="fas fa-print"></i> In trực tiếp
        </button>
    </div>

    <!-- Main form container -->
    <div class="container" id="main-form">
        <div class="form-content">
            <!-- Header -->
            <div class="header" style="display:flex; align-items:center; border-bottom:1px solid #000; padding-bottom:8px;">
                <!-- LOGO TRÁI -->
                <img src="logo.png" alt="Logo" style="height:60px; margin-right:15px;">
                <!-- TIÊU ĐỀ -->
                <div style="text-align:center; flex:1;">
                    <h1 style="margin:0;">BIỂU GHI NPI - NPI RECORD</h1>
                    <div style="font-size:12px; margin-top:4px;">
                        TNEMS-EN-F-048-NPI RECORD-VER03
                    </div>
                </div>
            </div>
            
            <!-- Product Information Section -->
            <div class="form-section" id="section-product-info">
                <div class="section-title">THÔNG TIN SẢN PHẨM - PRODUCT INFORMATION</div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="model">MÃ HÀNG / MODEL: <span class="required" style="color: red;">*</span></label>
                        <input type="text" id="model" placeholder="Nhập mã hàng/model" class="form-input required-field">
                    </div>
                    
                    <div class="form-group">
                        <label for="customer">KHÁCH HÀNG / CUSTOMER: <span class="required" style="color: red;">*</span></label>
                        <input type="text" id="customer" placeholder="Nhập tên khách hàng" class="form-input required-field">
                    </div>
                    
                    <div class="form-group">
                        <label for="partNo">Part No:</label>
                        <input type="text" id="partNo" placeholder="Nhập Part No" class="form-input">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label>Quy trình / Process:</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="processSMT" value="SMT" class="form-checkbox">
                                <label for="processSMT">SMT</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="processThroughHole" value="THROUGH HOLE" class="form-checkbox">
                                <label for="processThroughHole">THROUGH HOLE</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="processCoating" value="COATING" class="form-checkbox">
                                <label for="processCoating">COATING</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="processBoxbuild" value="BOXBUILD" class="form-checkbox">
                                <label for="processBoxbuild">BOXBUILD</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="processPacking" value="PACKING" class="form-checkbox">
                                <label for="processPacking">PACKING</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="flex: 1;">
                        <label for="date">Ngày / Date:</label>
                        <input type="date" id="date" value="" class="form-input">
                    </div>
                </div>
            </div>

            <!-- Process Tabs -->
            <div class="process-tabs no-print" id="processTabs">
                <button class="process-tab active" data-tab="smt">SMT PROCESS</button>
                <button class="process-tab" data-tab="through-hole">THROUGH-HOLE</button>
                <button class="process-tab" data-tab="coating">COATING</button>
                <button class="process-tab" data-tab="boxbuild">BOXBUILD</button>
                <button class="process-tab" data-tab="packaging">PACKAGING</button>
                <button class="process-tab" data-tab="conclusion">CONCLUSION</button>
            </div>

            <!-- SMT Process Section -->
            <div class="process-content active" id="smt-process">
                <div class="form-section">
                    <div class="section-title">SMT PROCESS</div>
                    
                    <!-- LASER MARKING -->
                    <div class="sub-section-title">LASER MARKING</div>
                    <table>
                        <tr>
                            <th width="30%">NỘI DUNG</th>
                            <th width="70%">GIÁ TRỊ</th>
                        </tr>
                        <tr>
                            <td>Tên chương trình/ Program name</td>
                            <td>
                                <input type="text" id="laserProgram" placeholder="Nhập tên chương trình" style="width: 100%;" class="form-input">
                            </td>
                        </tr>
                        <tr>
                            <td>Loại QR code/ QR code type</td>
                            <td>
                                <input type="text" id="qrType" placeholder="Nhập loại QR code" style="width: 100%;" class="form-input">
                            </td>
                        </tr>
                        <tr>
                            <td>Kích thước QR code/ QR code size</td>
                            <td>
                                <input type="text" id="qrSize" placeholder="Nhập kích thước QR code" style="width: 100%;" class="form-input">
                            </td>
                        </tr>
                        <tr>
                            <td>Cường độ khắc/ Engraving intensity</td>
                            <td>
                                <input type="text" id="engravingIntensity" placeholder="Nhập cường độ khắc" style="width: 100%;" class="form-input">
                            </td>
                        </tr>
                        <tr>
                            <td>Side BOT: Nội dung QR code/ QR code content</td>
                            <td class="long-content-cell">
                                <textarea id="qrContentBot" placeholder="Nhập nội dung QR code mặt BOT" rows="3" style="width: 100%;" class="form-textarea long-content"></textarea>
                            </td>
                        </tr>
                        <tr>
                            <td>Side TOP: Nội dung QR code/ QR code content</td>
                            <td class="long-content-cell">
                                <textarea id="qrContentTop" placeholder="Nhập nội dung QR code mặt TOP" rows="3" style="width: 100%;" class="form-textarea long-content"></textarea>
                            </td>
                        </tr>
                        <tr>
                            <td>Nội dung QR code khi quét bằng máy</td>
                            <td class="long-content-cell">
                                <textarea id="qrScanContent" placeholder="Nhập nội dung khi quét QR" rows="3" style="width: 100%;" class="form-textarea long-content"></textarea>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- PRINTER -->
                    <div class="sub-section-title">PRINTER</div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <input type="text" id="printerControl" placeholder="Ghi chú về printer" value="Theo Process control sheet đính kèm/According to the attached Process Control Sheet" style="width: 100%;" class="form-input">
                        </div>
                    </div>
                    
                    <!-- MOUNTER -->
                    <div class="sub-section-title">MOUNTER</div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <input type="text" id="mounterControl" placeholder="Ghi chú về mounter" value="Theo Process control sheet đính kèm (có xác nhận và đo giá trị của các bên)/According to the attached Process Control Sheet" style="width: 100%;" class="form-input">
                        </div>
                    </div>
                    
                    <!-- VISUAL INSPECTION 1 -->
                    <div class="sub-section-title">NGOẠI QUAN VISUAL INSPECTION</div>
                    <table>
                        <tr>
                            <th width="40%">HƯỚNG LINH KIỆN/COMPONENT POLARITY</th>
                            <th width="30%">SỐ LƯỢNG LINH KIỆN/COMPONENT QUANTITY</th>
                            <th width="15%">KẾT QUẢ/RESULT</th>
                            <th width="15%">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td>Theo bảng hướng linh kiện đính kèm (QC)</td>
                            <td>
                                <div>Theo BOM/ According to the BOM: 
                                    <input type="text" id="bomQty" class="input-small form-input" placeholder="Số lượng">
                                </div>
                                <div style="margin-top: 5px;">Thực tế/ Reality: 
                                    <input type="text" id="actualQty" class="input-small form-input" placeholder="Số lượng">
                                </div>
                            </td>
                            <td style="text-align: center;">
                                <select id="visualResult1" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: left;">
                                <div>ENG: 
                                    <input type="text" id="engVerify1" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="qcVerify1" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- REFLOW OVEN -->
                    <div class="sub-section-title">LÒ REFLOW/REFLOW OVEN</div>
                    <table>
                        <tr>
                            <th width="30%">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                            <th width="40%">THÔNG SỐ CÀI ĐẶT MÁY/MACHINE PARAMETERS SETTING</th>
                            <th width="15%">KẾT QUẢ/RESULT</th>
                            <th width="15%">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                - Theo Process control sheet đính kèm<br>
                                - Profile lò đính kèm
                            </td>
                            <td class="long-content-cell">
                                <textarea id="reflowParams" placeholder="Thông số cài đặt" rows="4" style="width: 100%;" class="form-textarea long-content"></textarea>
                            </td>
                            <td style="text-align: center;">
                                <select id="reflowResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: left;">
                                <div>ENG: 
                                    <input type="text" id="reflowEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="reflowQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- AOI -->
                    <div class="sub-section-title">AOI/AUTOMATED OPTICAL INSPECTION</div>
                    <table>
                        <tr>
                            <th width="30%">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                            <th width="25%">SỐ LƯỢNG PCBA ĐÃ AOI/PCBA AOI INSPECTED QUANTITY</th>
                            <th width="15%">KẾT QUẢ/RESULT</th>
                            <th width="30%">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <div>BOT: 
                                    <input type="text" id="aoiProgramBot" class="input-medium form-input" placeholder="Tên chương trình">
                                </div>
                                <div style="margin-top: 5px;">TOP: 
                                    <input type="text" id="aoiProgramTop" class="input-medium form-input" placeholder="Tên chương trình">
                                </div>
                            </td>
                            <td>
                                <input type="text" id="aoiQty" class="input-small form-input" placeholder="Số lượng" style="width: 100%;">
                            </td>
                            <td style="text-align: center;">
                                <select id="aoiResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: left;">
                                <div>ENG: 
                                    <input type="text" id="aoiEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="aoiQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- FLYING PROBE -->
                    <div class="sub-section-title">FLYING PROBE (20%)</div>
                    <table>
                        <tr>
                            <th width="30%">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                            <th width="25%">SỐ LƯỢNG ĐÃ ĐO/MEASURED QUANTITY</th>
                            <th width="15%">KẾT QUẢ/RESULT</th>
                            <th width="30%">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <div>BOT: 
                                    <input type="text" id="probeProgramBot" class="input-medium form-input" placeholder="Tên chương trình">
                                </div>
                                <div style="margin-top: 5px;">TOP: 
                                    <input type="text" id="probeProgramTop" class="input-medium form-input" placeholder="Tên chương trình">
                                </div>
                            </td>
                            <td>
                                <input type="text" id="probeQty" class="input-small form-input" placeholder="Số lượng" style="width: 100%;">
                            </td>
                            <td style="text-align: center;">
                                <select id="probeResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: left;">
                                <div>ENG: 
                                    <input type="text" id="probeEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="probeQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- VISUAL INSPECTION 2 -->
                    <div class="sub-section-title">NGOẠI QUAN VISUAL INSPECTION</div>
                    <div class="note" style="margin-bottom: 10px;">
                        KIỂM TRA SỐ LƯỢNG LINH KIỆN, CHẤT LƯỢNG MỐI HÀN, HƯỚNG LINH KIỆN, CÁC LỖI ĐÁNH GIÁ THEO IPC
                    </div>
                    <table>
                        <tr>
                            <th width="40%">NỘI DUNG KIỂM TRA</th>
                            <th width="30%">KẾT QUẢ</th>
                            <th width="30%">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td>- Số lượng linh kiện/ Component Quantity</td>
                            <td style="text-align: center;">
                                <select id="visual2Result1" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td rowspan="4" style="text-align: left; vertical-align: middle;">
                                <div>ENG: 
                                    <input type="text" id="visual2Eng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 10px;">QC: 
                                    <input type="text" id="visual2Qc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>- Chất lượng mối hàn/ Solder Joint Quality</td>
                            <td style="text-align: center;">
                                <select id="visual2Result2" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>- Hướng linh kiện/ Component Orientation</td>
                            <td style="text-align: center;">
                                <select id="visual2Result3" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>- Các lỗi đánh giá theo IPC/ Defects Evaluated per IPC</td>
                            <td style="text-align: center;">
                                <select id="visual2Result4" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- THROUGH-HOLE Process Section -->
            <div class="process-content" id="through-hole-process">
                <div class="form-section">
                    <div class="section-title">THROUGH-HOLE PROCESS</div>
                    
                    <!-- Component Quantity Check -->
                    <div class="sub-section-title">KIỂM TRA SỐ LƯỢNG LINH KIỆN / COMPONENT QUANTITY CHECK</div>
                    <table>
                        <tr>
                            <th width="40%">NỘI DUNG KIỂM TRA/INSPECTION CONTENT</th>
                            <th width="30%">GIÁ TRỊ/VALUE</th>
                            <th width="15%">KẾT QUẢ/RESULT</th>
                            <th width="15%">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td>ĐÚNG MÃ / CORRECT PART NUMBER</td>
                            <td>
                                <input type="text" id="thPartNumber" placeholder="Nhập thông tin" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="thPartNumberResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: left;">
                                <div>ENG: 
                                    <input type="text" id="thQuantityEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="thQuantityQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>SỐ LƯỢNG / QUANTITY</td>
                            <td>
                                <input type="text" id="thQuantity" placeholder="Nhập số lượng" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="thQuantityResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: left;">
                                <div>ENG: 
                                    <input type="text" id="thQuantityEng2" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="thQuantityQc2" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Soldering -->
                    <div class="sub-section-title">HÀN / SOLDERING</div>
                    <table>
                        <tr>
                            <th width="40%">THÔNG SỐ / PARAMETERS</th>
                            <th width="30%">GIÁ TRỊ / VALUE</th>
                            <th width="15%">KẾT QUẢ / RESULT</th>
                            <th width="15%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>NHIỆT ĐỘ CÀI ĐẶT HÀN TAY / HAND SOLDERING TEMPERATURE SETTING</td>
                            <td>
                                <input type="text" id="handSolderTemp" placeholder="VD: 350°C" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="handSolderResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td rowspan="3" style="text-align: left; vertical-align: middle;">
                                <div>ENG: 
                                    <input type="text" id="thSolderingEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 10px;">QC: 
                                    <input type="text" id="thSolderingQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Loại nozzle/Nozzle type:</td>
                            <td>
                                <input type="text" id="nozzleType" placeholder="Nhập loại nozzle" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="nozzleResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Preheat (ºC): Solder pot (ºC): Thời gian preheat (s)</td>
                            <td>
                                <input type="text" id="solderParams" placeholder="VD: 100°C, 250°C, 30s" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="solderParamsResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Testing -->
                    <div class="sub-section-title">TESTING</div>
                    <table>
                        <tr>
                            <th width="40%">GIÁ TRỊ KIỂM TRA / INSPECTION VALUE</th>
                            <th width="30%">CÁC BƯỚC KIỂM TRA / INSPECTION STEPS</th>
                            <th width="15%">KẾT QUẢ / RESULT</th>
                            <th width="15%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>Xem file đính kèm Test đính kèm / See attached file</td>
                            <td>Xem file đính kèm Test đính kèm / See attached file</td>
                            <td style="text-align: center;">
                                <select id="testingResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: left;">
                                <div>ENG: 
                                    <input type="text" id="thTestingEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="thTestingQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- PCBA Cleaning -->
                    <div class="sub-section-title">VỆ SINH PCBA / PCBA CLEANING</div>
                    <table>
                        <tr>
                            <th width="40%">PHƯƠNG PHÁP VỆ SINH / CLEANING METHOD</th>
                            <th width="30%">DỤNG CỤ & DUNG DỊCH / TOOLS & SOLUTION</th>
                            <th width="15%">KẾT QUẢ / RESULT</th>
                            <th width="15%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <input type="text" id="cleaningMethod" placeholder="Nhập phương pháp vệ sinh" style="width: 100%;" class="form-input">
                            </td>
                            <td>
                                <input type="text" id="cleaningTools" placeholder="Nhập dụng cụ & dung dịch" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="cleaningResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: left;">
                                <div>ENG: 
                                    <input type="text" id="thCleaningEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="thCleaningQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Visual Inspection -->
                    <div class="sub-section-title">NGOẠI QUAN VISUAL INSPECTION</div>
                    <table>
                        <tr>
                            <th width="40%">CHẤT LƯỢNG MỐI HÀN VÀ VỆ SINH / SOLDER JOINT QUALITY AND CLEANLINESS</th>
                            <th width="30%">ĐÚNG, ĐỦ LINH KIỆN / CORRECT AND COMPLETE COMPONENTS</th>
                            <th width="15%">KẾT QUẢ / RESULT</th>
                            <th width="15%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <input type="text" id="thVisualQuality" placeholder="Nhập đánh giá chất lượng" style="width: 100%;" class="form-input">
                            </td>
                            <td>
                                <input type="text" id="thVisualComponents" placeholder="Nhập đánh giá linh kiện" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="thVisualResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: left;">
                                <div>ENG: 
                                    <input type="text" id="thVisualEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="thVisualQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- COATING Process Section -->
            <div class="process-content" id="coating-process">
                <div class="form-section">
                    <div class="section-title">COATING PROCESS</div>
                    
                    <!-- COATING -->
                    <div class="sub-section-title">COATING</div>
                    <table>
                        <tr>
                            <th width="40%">THÔNG SỐ / PARAMETERS</th>
                            <th width="40%">GIÁ TRỊ / VALUE</th>
                            <th width="10%">KẾT QUẢ / RESULT</th>
                            <th width="10%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>- Dung dịch coating/ Coating solution:</td>
                            <td>
                                <input type="text" id="coatingSolution" placeholder="Nhập dung dịch coating" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="coatingSolutionResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td rowspan="5" style="text-align: left; vertical-align: middle;">
                                <div>ENG: 
                                    <input type="text" id="coatingEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 10px;">QC: 
                                    <input type="text" id="coatingQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>- Phương pháp coating/ Coating method:</td>
                            <td>
                                <input type="text" id="coatingMethod" placeholder="Nhập phương pháp coating" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="coatingMethodResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>- Phương pháp sấy/ Drying method:</td>
                            <td>
                                <input type="text" id="dryingMethod" placeholder="Nhập phương pháp sấy" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="dryingMethodResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>- Nhiệt độ sấy/ Drying temperature:</td>
                            <td>
                                <input type="text" id="dryingTemp" placeholder="VD: 80°C" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="dryingTempResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>- Thời gian sấy/ Drying time:</td>
                            <td>
                                <input type="text" id="dryingTime" placeholder="VD: 30 phút" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="dryingTimeResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- BOXBUILD Process Section -->
            <div class="process-content" id="boxbuild-process">
                <div class="form-section">
                    <div class="section-title">LẮP RÁP / BOXBUILD PROCESS</div>
                    
                    <!-- Assembly Jig/Tool -->
                    <div class="sub-section-title">LẮP RÁP BOXBUILD</div>
                    <table>
                        <tr>
                            <th width="40%">JIG/DỤNG CỤ LẮP RÁP / ASSEMBLY JIG OR TOOL</th>
                            <th width="30%">TIÊU CHUẨN / SPECIFICATION</th>
                            <th width="15%">KẾT QUẢ / RESULT</th>
                            <th width="15%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <input type="text" id="assemblyJig" placeholder="Nhập JIG/dụng cụ" style="width: 100%;" class="form-input">
                            </td>
                            <td>
                                <input type="text" id="assemblySpec" placeholder="Nhập tiêu chuẩn" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="assemblyJigResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: left;">
                                <div>ENG: 
                                    <input type="text" id="assemblyJigEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="assemblyJigQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Assembly Component -->
                    <div class="sub-section-title">SỐ LƯỢNG LINH KIỆN LẮP RÁP / ASSEMBLY COMPONENT QUANTITY</div>
                    <table>
                        <tr>
                            <th width="40%">SỐ LƯỢNG LINH KIỆN / COMPONENT QUANTITY</th>
                            <th width="30%">HƯỚNG/CHIỀU LẮP LINH KIỆN / COMPONENT ORIENTATION</th>
                            <th width="15%">KẾT QUẢ / RESULT</th>
                            <th width="15%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <input type="text" id="assemblyQty" placeholder="Nhập số lượng" style="width: 100%;" class="form-input">
                            </td>
                            <td>Theo bản vẽ/ According to the drawing</td>
                            <td style="text-align: center;">
                                <select id="assemblyQtyResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: left;">
                                <div>ENG: 
                                    <input type="text" id="assemblyQtyEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="assemblyQtyQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- IMEI/Label -->
                    <div class="sub-section-title">IMEI / LABEL</div>
                    <table>
                        <tr>
                            <th width="25%">VỊ TRÍ DÁN NHÃN / LABEL POSITION</th>
                            <th width="20%">HƯỚNG DÁN NHÃN / LABEL ORIENTATION</th>
                            <th width="35%">NỘI DUNG NHÃN / LABEL CONTENT</th>
                            <th width="10%">KẾT QUẢ / RESULT</th>
                            <th width="10%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <input type="text" id="labelPosition" placeholder="Nhập vị trí" style="width: 100%;" class="form-input">
                            </td>
                            <td>
                                <input type="text" id="labelOrientation" placeholder="Nhập hướng" style="width: 100%;" class="form-input">
                            </td>
                            <td>
                                <input type="text" id="labelContent" placeholder="Nhập nội dung" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="labelResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: left;">
                                <div>ENG: 
                                    <input type="text" id="labelEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="labelQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Visual Inspection -->
                    <div class="sub-section-title">KIỂM TRA NGOẠI QUAN / VISUAL INSPECTION</div>
                    <table>
                        <tr>
                            <th width="40%">TIÊU CHUẨN KIỂM TRA / INSPECTION REQUIREMENT</th>
                            <th width="40%">MÔ TẢ / DESCRIPTION</th>
                            <th width="10%">KẾT QUẢ / RESULT</th>
                            <th width="10%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <input type="text" id="boxInspectionReq" placeholder="Nhập tiêu chuẩn" style="width: 100%;" class="form-input">
                            </td>
                            <td>
                                <input type="text" id="boxInspectionDesc" placeholder="Nhập mô tả" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="boxInspectionResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: left;">
                                <div>ENG: 
                                    <input type="text" id="boxInspectionEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="boxInspectionQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- PACKAGING Process Section -->
            <div class="process-content" id="packaging-process">
                <div class="form-section">
                    <div class="section-title">ĐÓNG GÓI / PACKAGING PROCESS</div>
                    
                    <!-- Packaging -->
                    <div class="sub-section-title">ĐÓNG GÓI / PACKAGING</div>
                    <table>
                        <tr>
                            <th width="30%">VẬT LIỆU ĐÓNG GÓI / PACKAGING MATERIAL</th>
                            <th width="30%">PHƯƠNG PHÁP ĐÓNG GÓI / PACKAGING METHOD</th>
                            <th width="20%">SỐ LƯỢNG/THÙNG / QUANTITY PER BOX</th>
                            <th width="10%">KẾT QUẢ / RESULT</th>
                            <th width="10%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <div>- Theo BOM Đính kèm/ Attached BOM</div>
                                <div>- Bổ sung (nếu có)/ Additional (if any): 
                                    <input type="text" id="packagingMaterial" placeholder="Nhập bổ sung" style="width: 100%; margin-top: 5px;" class="form-input">
                                </div>
                            </td>
                            <td>
                                <input type="text" id="packagingMethod" placeholder="Nhập phương pháp" style="width: 100%;" class="form-input">
                            </td>
                            <td>
                                <input type="text" id="packagingQty" placeholder="Nhập số lượng" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="packagingResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: left;">
                                <div>ENG: 
                                    <input type="text" id="packagingEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="packagingQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Label -->
                    <div class="sub-section-title">LABEL</div>
                    <table id="packLabelTable">
                        <tr>
                            <th width="40%">NỘI DUNG LABEL / LABEL CONTENT</th>
                            <th width="40%">MẪU HOẶC HÌNH ẢNH LABEL THỰC TẾ / ACTUAL IMAGE/SAMPLE</th>
                            <th width="10%">KẾT QUẢ / RESULT</th>
                            <th width="10%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <input type="text" id="packLabelContent" placeholder="Nhập nội dung label" style="width: 100%;" class="form-input">
                            </td>
                            <td>
                                <!-- Upload Image Area -->
                                <div class="label-upload-area" id="packLabelUploadArea">
                                    <div class="label-upload-placeholder" id="packLabelUploadPlaceholder">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        Click để chọn hoặc kéo thả ảnh label
                                        <div style="font-size: 11px; color: #999; margin-top: 5px;">
                                            Hỗ trợ: JPG, PNG (Tối đa 2MB)
                                        </div>
                                    </div>
                                    <img src="" alt="Label Image Preview" class="label-preview" id="packLabelImagePreview" style="display: none;">
                                </div>
                                
                                <!-- Hidden input for file -->
                                <input type="file" id="packLabelImageInput" accept="image/*" style="display: none;">
                                
                                <!-- Text area for description (optional) -->
                                <textarea id="packLabelImageDesc" placeholder="Mô tả hình ảnh (tùy chọn)" rows="2" style="width: 100%; margin-top: 10px; font-size: 11px;" class="form-textarea"></textarea>
                                
                                <!-- Hidden field to store image data -->
                                <input type="hidden" id="packLabelImageData">
                                
                                <div class="signature-actions" style="margin-top: 10px;">
                                    <button type="button" id="packLabelUploadBtn" class="btn-upload" style="padding: 4px 8px; font-size: 11px;">
                                        <i class="fas fa-upload"></i> Chọn ảnh
                                    </button>
                                    <button type="button" id="packLabelClearBtn" class="btn-clear" style="padding: 4px 8px; font-size: 11px;">
                                        <i class="fas fa-trash"></i> Xóa ảnh
                                    </button>
                                </div>
                            </td>
                            <td style="text-align: center;">
                                <select id="packLabelResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: left;">
                                <div>ENG: 
                                    <input type="text" id="packLabelEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="packLabelQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- CONCLUSION Section -->
            <div class="process-content" id="conclusion-process">
                <div class="form-section">
                    <div class="section-title">KẾT LUẬN / CONCLUSION</div>
                    
                    <table>
                        <tr>
                            <th width="20%">KẾT QUẢ CUỐI CÙNG / FINAL RESULT</th>
                            <th width="25%">RỦI RO TRONG CÁC CÔNG ĐOẠN / RISKS IN EACH PROCESS STEP</th>
                            <th width="25%">BÀI HỌC TỪNG CÔNG ĐOẠN / LESSONS LEARNED FROM EACH PROCESS STEP</th>
                            <th width="30%">CẢI TIẾN CÔNG ĐOẠN / PROCESS IMPROVEMENT</th>
                        </tr>
                        <tr>
                            <td style="text-align: center; vertical-align: middle;" class="conclusion-cell">
                                <select id="finalResult" style="width: 90%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="PASS">PASS</option>
                                    <option value="FAIL">FAIL</option>
                                    <option value="CONDITIONAL">CONDITIONAL PASS</option>
                                </select>
                            </td>
                            <td class="conclusion-cell long-content-cell">
                                <textarea id="processRisks" placeholder="Rủi ro trong các công đoạn" rows="8" style="width: 100%; height: auto; min-height: 120px;" class="form-textarea long-content"></textarea>
                            </td>
                            <td class="conclusion-cell long-content-cell">
                                <textarea id="lessonsLearned" placeholder="Bài học từng công đoạn" rows="8" style="width: 100%; height: auto; min-height: 120px;" class="form-textarea long-content"></textarea>
                            </td>
                            <td class="conclusion-cell long-content-cell">
                                <textarea id="processImprovement" placeholder="Cải tiến công đoạn" rows="8" style="width: 100%; height: auto; min-height: 120px;" class="form-textarea long-content"></textarea>
                            </td>
                        </tr>
                    </table>
                    
                    <div class="form-row" style="margin-top: 15px;">
                        <div class="form-group">
                            <label for="totalQty">Tổng số lượng (PCBA): <br>Total qty (PCBA):</label>
                            <input type="number" id="totalQty" placeholder="Nhập tổng số lượng" class="form-input" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="okQty">OK :</label>
                            <input type="number" id="okQty" placeholder="Nhập số lượng OK" class="form-input" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="ngQty">NG (scrap) :</label>
                            <input type="number" id="ngQty" placeholder="Nhập số lượng NG" class="form-input" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="defectRate">Tỷ lệ lỗi/ Defect rate (%) : <br> (NG/Total)</label>
                            <input type="text" id="defectRate" placeholder="Tự động tính toán" readonly style="background-color: #f0f0f0;" class="form-input">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="defectDescription">Mô tả chi tiết lỗi / detailed defect description:</label>
                            <textarea id="defectDescription" placeholder="Mô tả chi tiết các lỗi" rows="4" style="width: 100%;" class="form-textarea long-content"></textarea>
                        </div>
                    </div>
                    
                    <!-- Electronic Signatures - GIAO DIỆN MỚI THEO ẢNH -->
                    <div class="sub-section-title">XÁC NHẬN ĐIỆN TỬ - ELECTRONIC SIGNATURES</div>

                    <!-- Controls for adding signers -->
                    <div class="no-print" style="margin-bottom: 15px; padding: 10px; background: #f5f9ff; border-radius: 5px;">
                        <button type="button" id="addSignerBtn" class="btn btn-primary" style="padding: 8px 15px; font-size: 12px;">
                            <i class="fas fa-user-plus"></i> Thêm người ký
                        </button>
                    </div>

                    <!-- Dynamic signatures container -->
                    <div id="dynamicSignaturesContainer" class="two-column" style="margin-top: 10px;">
                        <!-- Engineer Signature (default) -->
                        <div class="signature-section" id="engineer-signature-section">
                            <!-- Header -->
                            <div class="signature-header">
                                <h4>Chữ ký Kỹ sư</h4>
                                <span class="role-tag">KỸ SƯ / ENGINEER</span>
                            </div>
                            
                            <!-- Radio buttons -->
                            <div class="signature-type-selector">
                                <label>
                                    <input type="radio" name="engineerSignatureType" value="draw" checked> 
                                    <i class="fas fa-pen"></i> Vẽ chữ ký
                                </label>
                                <label>
                                    <input type="radio" name="engineerSignatureType" value="upload"> 
                                    <i class="fas fa-upload"></i> Upload ảnh chữ ký
                                </label>
                            </div>
                            
                            <!-- Drawing Area -->
                            <div class="signature-drawing-area" id="engineer-drawing-area">
                                <div class="signature-upload-placeholder">
                                    <i class="fas fa-pen"></i>
                                    Vẽ chữ ký của bạn trong khung bên dưới
                                </div>
                                <canvas id="engineerSignature" class="signature-pad"></canvas>
                            </div>
                            
                            <!-- Upload Area (hidden by default) -->
                            <div class="signature-upload-area" id="engineer-upload-area">
                                <div class="signature-upload-placeholder" id="engineer-upload-placeholder">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    Click để chọn hoặc kéo thả ảnh chữ ký
                                    <div style="font-size: 11px; color: #999; margin-top: 5px;">
                                        Hỗ trợ: JPG, PNG (Tối đa 2MB)
                                    </div>
                                </div>
                                <img src="" alt="Signature Preview" class="signature-preview" id="engineer-upload-preview" style="display: none;">
                                <input type="file" id="engineerImageInput" accept="image/*" style="display: none;">
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="signature-actions">
                                <button type="button" class="btn-clear" id="clearEngineerSignature">
                                    <i class="fas fa-trash"></i> Xóa chữ ký
                                </button>
                                <button type="button" class="btn-save" id="saveEngineerSignature">
                                    <i class="fas fa-save"></i> Lưu chữ ký
                                </button>
                                <button type="button" class="btn-upload" id="uploadEngineerImageBtn">
                                    <i class="fas fa-upload"></i> Chọn ảnh
                                </button>
                            </div>
                            
                            <!-- Signature Display -->
                            <div class="signature-display-container">
                                <div class="signature-display-title">Chữ ký đã lưu:</div>
                                <div class="signature-display" id="engineerSignatureDisplay">
                                    <div style="padding: 15px; text-align: center; color: #888;">
                                        <i class="fas fa-signature" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                                        Chữ ký sẽ hiển thị ở đây sau khi lưu
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Signer Info -->
                            <div class="signer-info">
                                <div class="form-group">
                                    <label for="engineerName">Tên Kỹ sư:</label>
                                    <input type="text" id="engineerName" placeholder="Nhập tên kỹ sư" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label for="engineerRole">Chức vụ:</label>
                                    <input type="text" id="engineerRole" placeholder="Nhập chức vụ" value="Kỹ sư / Engineer" class="form-input">
                                </div>
                            </div>
                        </div>
                        
                        <!-- QC Signature (default) -->
                        <div class="signature-section" id="qc-signature-section">
                            <!-- Header -->
                            <div class="signature-header">
                                <h4>Chữ ký QA</h4>
                                <span class="role-tag" style="background: linear-gradient(135deg, #FF9800 0%, #FFB74D 100%);">QA / QUALITY ASSURACE</span>
                            </div>
                            
                            <!-- Radio buttons -->
                            <div class="signature-type-selector">
                                <label>
                                    <input type="radio" name="qcSignatureType" value="draw" checked> 
                                    <i class="fas fa-pen"></i> Vẽ chữ ký
                                </label>
                                <label>
                                    <input type="radio" name="qcSignatureType" value="upload"> 
                                    <i class="fas fa-upload"></i> Upload ảnh chữ ký
                                </label>
                            </div>
                            
                            <!-- Drawing Area -->
                            <div class="signature-drawing-area" id="qc-drawing-area">
                                <div class="signature-upload-placeholder">
                                    <i class="fas fa-pen"></i>
                                    Vẽ chữ ký của bạn trong khung bên dưới
                                </div>
                                <canvas id="qcSignature" class="signature-pad"></canvas>
                            </div>
                            
                            <!-- Upload Area (hidden by default) -->
                            <div class="signature-upload-area" id="qc-upload-area">
                                <div class="signature-upload-placeholder" id="qc-upload-placeholder">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    Click để chọn hoặc kéo thả ảnh chữ ký
                                    <div style="font-size: 11px; color: #999; margin-top: 5px;">
                                        Hỗ trợ: JPG, PNG (Tối đa 2MB)
                                    </div>
                                </div>
                                <img src="" alt="Signature Preview" class="signature-preview" id="qc-upload-preview" style="display: none;">
                                <input type="file" id="qcImageInput" accept="image/*" style="display: none;">
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="signature-actions">
                                <button type="button" class="btn-clear" id="clearQcSignature">
                                    <i class="fas fa-trash"></i> Xóa chữ ký
                                </button>
                                <button type="button" class="btn-save" id="saveQcSignature">
                                    <i class="fas fa-save"></i> Lưu chữ ký
                                </button>
                                <button type="button" class="btn-upload" id="uploadQcImageBtn">
                                    <i class="fas fa-upload"></i> Chọn ảnh
                                </button>
                            </div>
                            
                            <!-- Signature Display -->
                            <div class="signature-display-container">
                                <div class="signature-display-title">Chữ ký đã lưu:</div>
                                <div class="signature-display" id="qcSignatureDisplay">
                                    <div style="padding: 15px; text-align: center; color: #888;">
                                        <i class="fas fa-signature" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                                        Chữ ký sẽ hiển thị ở đây sau khi lưu
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Signer Info -->
                            <div class="signer-info">
                                <div class="form-group">
                                    <label for="qcName">Tên QC:</label>
                                    <input type="text" id="qcName" placeholder="Nhập tên QA" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label for="qcRole">Chức vụ:</label>
                                    <input type="text" id="qcRole" placeholder="Nhập chức vụ" value="QA Engineer" class="form-input">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- File input for image upload (hidden) -->
                    <input type="file" id="signatureImageInput" accept="image/*" style="display: none;">
                </div>
            </div>
            
            <div class="footer">
                <p>NPI Record - TNEMS</p>
                <p>© 2025 - BẢN ĐIỆN TỬ</p>
                <p style="font-size: 10px; color: #888;" id="dataInfo"></p>
            </div>
        </div>
    </div>

    <!-- Template for additional signers -->
    <template id="signerTemplate">
        <div class="signature-section" data-signer-id="">
            <button type="button" class="remove-signer-btn" title="Xóa người ký">
                <i class="fas fa-times"></i>
            </button>
            
            <!-- Header -->
            <div class="signature-header">
                <h4 class="signer-title">Chữ ký</h4>
                <span class="role-tag" style="background: linear-gradient(135deg, #9C27B0 0%, #E1BEE7 100%);">NGƯỜI KÝ</span>
            </div>
            
            <!-- Radio buttons -->
            <div class="signature-type-selector">
                <label>
                    <input type="radio" name="signerType_" value="draw" checked> 
                    <i class="fas fa-pen"></i> Vẽ chữ ký
                </label>
                <label>
                    <input type="radio" name="signerType_" value="upload"> 
                    <i class="fas fa-upload"></i> Upload ảnh chữ ký
                </label>
            </div>
            
            <!-- Drawing Area -->
            <div class="signature-drawing-area" id="drawing-area_">
                <div class="signature-upload-placeholder">
                    <i class="fas fa-pen"></i>
                    Vẽ chữ ký của bạn trong khung bên dưới
                </div>
                <canvas class="signature-pad" id="signatureCanvas_"></canvas>
            </div>
            
            <!-- Upload Area (hidden by default) -->
            <div class="signature-upload-area" id="upload-area_">
                <div class="signature-upload-placeholder">
                    <i class="fas fa-cloud-upload-alt"></i>
                    Click để chọn hoặc kéo thả ảnh chữ ký
                    <div style="font-size: 11px; color: #999; margin-top: 5px;">
                        Hỗ trợ: JPG, PNG (Tối đa 2MB)
                    </div>
                </div>
                <img src="" alt="Signature Preview" class="signature-preview" id="upload-preview_" style="display: none;">
                <input type="file" class="signature-upload-input" accept="image/*" style="display: none;">
            </div>
            
            <!-- Action Buttons -->
            <div class="signature-actions">
                <button type="button" class="btn-clear clear-signature-btn">
                    <i class="fas fa-trash"></i> Xóa chữ ký
                </button>
                <button type="button" class="btn-save save-signature-btn">
                    <i class="fas fa-save"></i> Lưu chữ ký
                </button>
                <button type="button" class="btn-upload upload-signature-trigger">
                    <i class="fas fa-upload"></i> Chọn ảnh
                </button>
            </div>
            
            <!-- Signature Display -->
            <div class="signature-display-container">
                <div class="signature-display-title">Chữ ký đã lưu:</div>
                <div class="signature-display" id="signatureDisplay_">
                    <div style="padding: 15px; text-align: center; color: #888;">
                        <i class="fas fa-signature" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                        Chữ ký sẽ hiển thị ở đây sau khi lưu
                    </div>
                </div>
            </div>
            
            <!-- Signer Info -->
            <div class="signer-info">
                <div class="form-group">
                    <label for="signerName_">Họ tên:</label>
                    <input type="text" id="signerName_" placeholder="Nhập họ tên" class="form-input signer-name">
                </div>
                <div class="form-group">
                    <label for="signerRole_">Chức vụ:</label>
                    <input type="text" id="signerRole_" placeholder="Nhập chức vụ" class="form-input signer-role">
                </div>
            </div>
        </div>
    </template>

    <!-- Modal for image signature upload -->
    <div class="modal" id="imageSignatureModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-signature"></i> Tải ảnh chữ ký lên
                </div>
                <button class="close-modal">&times;</button>
            </div>
            <div style="padding: 20px;">
                <p style="margin-bottom: 15px; color: #666;">Chọn phương thức thêm chữ ký ảnh:</p>
                
                <button class="signature-option-btn" id="uploadEngineerSignatureModal">
                    <i class="fas fa-user-cog"></i>
                    <div style="text-align: left;">
                        <div style="font-weight: bold;">Thay thế chữ ký Kỹ sư</div>
                        <div style="font-size: 12px; color: #666;">Tải ảnh chữ ký cho Kỹ sư hiện tại</div>
                    </div>
                </button>
                
                <button class="signature-option-btn" id="uploadQcSignatureModal">
                    <i class="fas fa-user-check"></i>
                    <div style="text-align: left;">
                        <div style="font-weight: bold;">Thay thế chữ ký QA</div>
                        <div style="font-size: 12px; color: #666;">Tải ảnh chữ ký cho QC hiện tại</div>
                    </div>
                </button>
                
                <button class="signature-option-btn" id="uploadNewSignerModal">
                    <i class="fas fa-user-plus"></i>
                    <div style="text-align: left;">
                        <div style="font-weight: bold;">Thêm người ký mới với ảnh</div>
                        <div style="font-size: 12px; color: #666;">Thêm người ký mới và sử dụng ảnh chữ ký</div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========== CẤU HÌNH FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDtXBh4JBdUeLvzNKWp6VUNatdML871k8E",
            authDomain: "npi-record.firebaseapp.com",
            databaseURL: "https://npi-record-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "npi-record",
            storageBucket: "npi-record.appspot.com",
            messagingSenderId: "615504087682",
            appId: "1:615504087682:web:5a1a78fd56ea4f9714429b"
        };

        // ========== BIẾN TOÀN CỤC ==========
        let app;
        let database;
        let currentProjectId = null;
        let currentUser = null;
        let users = {};
        let isSaving = false;
        let lastSavedData = {};
        let userTimeout = null;
        let engineerSignaturePad = null;
        let qcSignaturePad = null;
        let additionalSigners = [];
        let signaturePads = {};

        // ========== KHỞI TẠO FIREBASE ==========
        try {
            if (!firebase.apps.length) {
                app = firebase.initializeApp(firebaseConfig);
            } else {
                app = firebase.app();
            }
            database = firebase.database();
            console.log("✅ Firebase đã khởi tạo");
        } catch (error) {
            console.error("❌ Lỗi khởi tạo Firebase:", error);
            showToast("Không thể kết nối đến server", "error");
        }

        // ========== HÀM HIỂN THỊ THÔNG BÁO ==========
        function showToast(message, type = "success") {
            const toast = document.createElement("div");
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === "success" ? "check-circle" : type === "error" ? "exclamation-triangle" : "info-circle"}"></i>
                ${message}
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function showLoading(message) {
            document.getElementById("loadingMessage").textContent = message;
            document.getElementById("loadingOverlay").style.display = "flex";
        }

        function hideLoading() {
            document.getElementById("loadingOverlay").style.display = "none";
        }

        // ========== KHỞI TẠO NGƯỜI DÙNG ==========
        function initUser() {
            let savedUser = localStorage.getItem("npi_user");
            
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                console.log("👤 Đã load user:", currentUser.name);
            } else {
                const names = ["Kỹ sư", "QC", "Quản lý", "Chuyên viên"];
                const randomName = names[Math.floor(Math.random() * names.length)] + " " + Math.floor(Math.random() * 100);
                
                const colors = ["#FF5722", "#2196F3", "#4CAF50", "#FF9800", "#9C27B0", "#009688"];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                currentUser = {
                    id: "user_" + Math.random().toString(36).substr(2, 9),
                    name: randomName,
                    color: randomColor,
                    online: true,
                    lastActive: Date.now(),
                    editingField: null
                };
                
                localStorage.setItem("npi_user", JSON.stringify(currentUser));
                console.log("👤 Đã tạo user mới:", currentUser.name);
            }
            
            updateUserBadge();
        }

        function updateUserBadge() {
            const userCountEl = document.getElementById("userCount");
            if (userCountEl && currentUser) {
                userCountEl.innerHTML = `
                    <i class="fas fa-user" style="color: ${currentUser.color}"></i>
                    <span>${currentUser.name}</span>
                    <button id="changeNameBtn" style="background: transparent; border: none; color: white; cursor: pointer; margin-left: 5px; font-size: 10px;" title="Đổi tên">
                        <i class="fas fa-edit"></i>
                    </button>
                `;
                
                document.getElementById("changeNameBtn")?.addEventListener("click", changeUserName);
            }
        }

        function changeUserName() {
            const newName = prompt("Nhập tên hiển thị mới:", currentUser.name);
            if (newName && newName.trim() && newName !== currentUser.name) {
                currentUser.name = newName.trim();
                localStorage.setItem("npi_user", JSON.stringify(currentUser));
                updateUserBadge();
                
                if (currentProjectId && database) {
                    database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).update({
                        name: currentUser.name,
                        lastActive: Date.now()
                    });
                }
                
                showToast(`✅ Đã đổi tên thành: ${currentUser.name}`, "success");
            }
        }

        // ========== TẠO/THAM GIA PROJECT ==========
        async function handleProjectAction() {
            if (!database) {
                showToast("Chưa kết nối được Firebase", "error");
                return;
            }
            
            if (currentProjectId) {
                const confirmLeave = confirm(`Bạn đang trong project: ${currentProjectId}\n\nMuốn rời đi để tạo/tham gia project khác?`);
                if (!confirmLeave) return;
                
                await leaveCurrentProject();
                currentProjectId = null;
                document.getElementById("onlineUsersContainer").style.display = "none";
                updateStatus("Đã rời project", "offline");
            }
            
            const action = confirm(`Chọn hành động:\n\n• OK: Tạo project MỚI\n• Cancel: Tham gia project CÓ SẴN`);
            
            if (action === true) {
                await createNewProject();
            } else {
                await joinExistingProject();
            }
        }

        async function leaveCurrentProject() {
            if (currentProjectId && currentUser && database) {
                try {
                    await database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).update({
                        online: false,
                        lastActive: Date.now(),
                        editingField: null
                    });
                } catch (error) {
                    console.error("Lỗi rời project:", error);
                }
            }
        }

        async function createNewProject() {
            showLoading("Đang tạo project mới...");
            
            try {
                currentProjectId = "npi_" + Date.now().toString(36) + "_" + Math.random().toString(36).substr(2, 3).toUpperCase();
                
                if (!currentUser) initUser();
                
                const initialData = collectFormData();
                initialData._metadata = {
                    created: new Date().toISOString(),
                    createdBy: currentUser.id,
                    version: 1
                };
                
                await database.ref(`projects/${currentProjectId}`).set({
                    data: initialData,
                    users: {
                        [currentUser.id]: {
                            ...currentUser,
                            online: true,
                            lastActive: Date.now()
                        }
                    },
                    metadata: {
                        created: new Date().toISOString(),
                        createdBy: currentUser.name,
                        projectName: `NPI-${new Date().toLocaleDateString("vi-VN")}`
                    }
                });
                
                updateUrlWithProjectId();
                document.getElementById("projectIdDisplay").textContent = `ID: ${currentProjectId}`;
                document.getElementById("projectIdDisplay").title = "Click để copy ID";
                document.getElementById("onlineUsersContainer").style.display = "block";
                
                setupRealtimeListeners();
                updateShareLink();
                
                showToast(`✅ Đã tạo project: ${currentProjectId}`, "success");
                updateStatus("Đang đồng bộ thời gian thực", "online");
                
            } catch (error) {
                console.error("Lỗi tạo project:", error);
                showToast("❌ Lỗi tạo project: " + error.message, "error");
            } finally {
                hideLoading();
            }
        }

        async function joinExistingProject() {
            const projectId = prompt("Nhập ID project muốn tham gia:");
            if (!projectId || !projectId.trim()) {
                showToast("❌ Chưa nhập ID project", "error");
                return;
            }
            
            showLoading(`Đang tham gia project ${projectId}...`);
            
            try {
                const snapshot = await database.ref(`projects/${projectId}`).once("value");
                
                if (!snapshot.exists()) {
                    showToast("❌ Project không tồn tại!", "error");
                    hideLoading();
                    return;
                }
                
                currentProjectId = projectId;
                if (!currentUser) initUser();
                
                await database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).set({
                    ...currentUser,
                    online: true,
                    lastActive: Date.now()
                });
                
                updateUrlWithProjectId();
                document.getElementById("projectIdDisplay").textContent = `ID: ${currentProjectId}`;
                document.getElementById("projectIdDisplay").title = "Click để copy ID";
                document.getElementById("onlineUsersContainer").style.display = "block";
                
                setupRealtimeListeners();
                loadProjectData();
                
                showToast(`✅ Đã tham gia project ${projectId}`, "success");
                updateStatus("Đang đồng bộ thời gian thực", "online");
                
            } catch (error) {
                console.error("Lỗi tham gia project:", error);
                showToast("❌ Lỗi tham gia project: " + error.message, "error");
            } finally {
                hideLoading();
            }
        }

        // ========== REALTIME LISTENERS ==========
        function setupRealtimeListeners() {
            if (!currentProjectId || !database) return;
            
            console.log("👂 Đang lắng nghe thay đổi từ server...");
            
            // 1. Lắng nghe thay đổi dữ liệu form
            database.ref(`projects/${currentProjectId}/data`).on("value", (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    updateFormFromServer(data);
                }
            });
            
            // 2. Lắng nghe thay đổi danh sách user
            database.ref(`projects/${currentProjectId}/users`).on("value", (snapshot) => {
                if (snapshot.exists()) {
                    users = snapshot.val();
                    updateUsersDisplay();
                }
            });
            
            keepAlive();
            
            window.addEventListener("beforeunload", () => {
                if (currentProjectId && currentUser) {
                    database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).update({
                        online: false,
                        lastActive: Date.now(),
                        editingField: null
                    });
                }
            });
        }

        function keepAlive() {
            if (userTimeout) clearTimeout(userTimeout);
            
            userTimeout = setTimeout(() => {
                if (currentProjectId && currentUser && database) {
                    database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).update({
                        lastActive: Date.now(),
                        online: true
                    });
                    keepAlive();
                }
            }, 10000);
        }

        // ========== XỬ LÝ DỮ LIỆU FORM ==========
        function collectFormData() {
            const data = {};
            
            document.querySelectorAll("input, textarea, select").forEach(element => {
                if (element.id && element.id !== "") {
                    if (element.type === "checkbox") {
                        data[element.id] = element.checked;
                    } else if (element.type === "radio") {
                        if (element.checked) data[element.name] = element.value;
                    } else {
                        data[element.id] = element.value;
                    }
                }
            });
            
            // Lưu ảnh label từ localStorage
            const labelImage = localStorage.getItem('pack_label_image');
            if (labelImage) data._packLabelImage = labelImage;
            
            const engineerSig = localStorage.getItem("engineer_signature");
            const qcSig = localStorage.getItem("qc_signature");
            if (engineerSig) data._engineerSignature = engineerSig;
            if (qcSig) data._qcSignature = qcSig;
            
            return data;
        }

        function updateFormFromServer(serverData) {
            if (isSaving) return;
            
            const formData = {...serverData};
            delete formData._metadata;
            delete formData._lastUpdated;
            delete formData._lastUpdatedBy;
            
            let changedCount = 0;
            
            Object.keys(formData).forEach(fieldId => {
                if (fieldId.startsWith("_")) {
                    // Xử lý dữ liệu đặc biệt
                    if (fieldId === "_engineerSignature" && formData[fieldId]) {
                        localStorage.setItem("engineer_signature", formData[fieldId]);
                        const engDisplay = document.getElementById("engineerSignatureDisplay");
                        if (engDisplay) {
                            engDisplay.innerHTML = `<img src="${formData[fieldId]}" alt="Engineer Signature" style="max-width: 100%; max-height: 70px;">`;
                            engDisplay.classList.add("has-signature");
                        }
                    }
                    if (fieldId === "_qcSignature" && formData[fieldId]) {
                        localStorage.setItem("qc_signature", formData[fieldId]);
                        const qcDisplay = document.getElementById("qcSignatureDisplay");
                        if (qcDisplay) {
                            qcDisplay.innerHTML = `<img src="${formData[fieldId]}" alt="QC Signature" style="max-width: 100%; max-height: 70px;">`;
                            qcDisplay.classList.add("has-signature");
                        }
                    }
                    if (fieldId === "_packLabelImage" && formData[fieldId]) {
                        loadLabelImageFromCloud(formData);
                    }
                    return;
                }
                
                const field = document.getElementById(fieldId);
                if (field) {
                    const serverValue = formData[fieldId];
                    const currentValue = field.type === "checkbox" ? field.checked : field.value;
                    
                    if (serverValue !== currentValue) {
                        const isCurrentlyEditing = (field === document.activeElement);
                        
                        if (!isCurrentlyEditing) {
                            if (field.type === "checkbox") {
                                field.checked = Boolean(serverValue);
                            } else {
                                field.value = serverValue || "";
                            }
                            
                            updateHighlight(field);
                            changedCount++;
                            showFieldUpdateEffect(field);
                        }
                    }
                }
            });
            
            if (changedCount > 0) {
                showTypingNotification(changedCount);
            }
            
            lastSavedData = {...formData};
            calculateDefectRate();
        }

        function showFieldUpdateEffect(field) {
            field.classList.add("field-updated");
            setTimeout(() => {
                field.classList.remove("field-updated");
            }, 1000);
        }

        function showTypingNotification(count) {
            let notification = document.getElementById("typing-notification");
            if (!notification) {
                notification = document.createElement("div");
                notification.id = "typing-notification";
                notification.className = "typing-indicator";
                document.body.appendChild(notification);
            }
            
            notification.textContent = `🔄 ${count} trường được cập nhật từ người khác`;
            notification.style.display = "block";
            
            setTimeout(() => {
                notification.style.display = "none";
            }, 2000);
        }

        // ========== CẬP NHẬT GIAO DIỆN NGƯỜI DÙNG ==========
        function updateUsersDisplay() {
            const usersListEl = document.getElementById("usersList");
            const onlineCountEl = document.getElementById("onlineUsersCount");
            
            if (!usersListEl || !onlineCountEl) return;
            
            const now = Date.now();
            const onlineUsers = Object.values(users).filter(user => 
                user.online || (now - user.lastActive < 30000)
            );
            
            onlineCountEl.textContent = `${onlineUsers.length} người online`;
            usersListEl.innerHTML = "";
            
            onlineUsers.forEach(user => {
                const userEl = document.createElement("div");
                userEl.className = `user-badge ${user.editingField ? "editing" : ""}`;
                userEl.style.borderLeft = `3px solid ${user.color}`;
                
                userEl.innerHTML = `
                    <div class="status-dot" style="background: ${user.color}"></div>
                    <div class="user-avatar" style="background: ${user.color}">
                        ${user.name.charAt(0).toUpperCase()}
                    </div>
                    <span>${user.name}</span>
                    ${user.id === currentUser?.id ? '<span style="font-size:9px;">(bạn)</span>' : ""}
                    ${user.editingField ? `<span style="font-size:9px; margin-left:5px;">✏️</span>` : ""}
                `;
                
                userEl.title = `${user.name}\n${user.editingField ? `Đang nhập: ${user.editingField}` : "Đang online"}`;
                usersListEl.appendChild(userEl);
            });
            
            updateEditingHighlights();
        }

        function updateEditingHighlights() {
            document.querySelectorAll(".field-being-edited").forEach(field => {
                field.classList.remove("field-being-edited");
                field.removeAttribute("data-editor");
            });
            
            Object.values(users).forEach(user => {
                if (user.editingField && user.id !== currentUser?.id) {
                    const field = document.getElementById(user.editingField);
                    if (field) {
                        field.classList.add("field-being-edited");
                        field.setAttribute("data-editor", user.name);
                    }
                }
            });
        }

        // ========== XỬ LÝ INPUT THỜI GIAN THỰC ==========
        function setupRealTimeInput() {
            let debounceTimer;
            
            document.querySelectorAll("input, textarea, select").forEach(field => {
                field.addEventListener("focus", function() {
                    if (currentProjectId && currentUser) {
                        currentUser.editingField = this.id;
                        updateUserEditingStatus(this.id);
                    }
                });
                
                field.addEventListener("input", function() {
                    clearTimeout(debounceTimer);
                    
                    if (currentProjectId && currentUser) {
                        saveFieldToServer(this.id, this.type === "checkbox" ? this.checked : this.value);
                        
                        debounceTimer = setTimeout(() => {
                            saveFieldToServer(this.id, this.type === "checkbox" ? this.checked : this.value);
                        }, 200);
                    }
                    
                    updateHighlight(this);
                    
                    if (this.id === "totalQty" || this.id === "ngQty" || this.id === "okQty") {
                        calculateDefectRate();
                    }
                });
                
                field.addEventListener("change", function() {
                    if (currentProjectId && currentUser) {
                        saveFieldToServer(this.id, this.type === "checkbox" ? this.checked : this.value);
                    }
                    updateHighlight(this);
                });
                
                field.addEventListener("blur", function() {
                    if (currentProjectId && currentUser) {
                        currentUser.editingField = null;
                        updateUserEditingStatus(null);
                    }
                });
                
                if (field.tagName === 'INPUT' || field.tagName === 'TEXTAREA') {
                    field.addEventListener('keyup', function() {
                        if (currentProjectId && currentUser) {
                            updateUserEditingStatus(this.id);
                        }
                    });
                }
            });
        }

        async function saveFieldToServer(fieldId, value) {
            if (!currentProjectId || !database || isSaving) return;
            
            isSaving = true;
            
            try {
                await database.ref(`projects/${currentProjectId}/data/${fieldId}`).set(value);
                await database.ref(`projects/${currentProjectId}/data/_lastUpdated`).set(new Date().toISOString());
                await database.ref(`projects/${currentProjectId}/data/_lastUpdatedBy`).set(currentUser?.id || "unknown");
                
                lastSavedData[fieldId] = value;
                
            } catch (error) {
                console.error("Lỗi lưu field:", error);
                showToast("❌ Lỗi đồng bộ dữ liệu", "error");
            } finally {
                setTimeout(() => { isSaving = false; }, 50);
            }
        }

        async function updateUserEditingStatus(fieldId) {
            if (!currentProjectId || !currentUser || !database) return;
            
            try {
                await database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).update({
                    editingField: fieldId,
                    lastActive: Date.now()
                });
            } catch (error) {
                console.error("Lỗi cập nhật trạng thái editing:", error);
            }
        }

        // ========== HIGHLIGHT DỮ LIỆU ==========
        function updateHighlight(element) {
            if (!element) return;
            
            const hasData = element.type === "checkbox" 
                ? element.checked
                : element.type === "select-one"
                ? element.value && element.value !== ""
                : element.value && element.value.trim() !== "";
            
            if (hasData) {
                element.classList.add("has-data");
                const row = element.closest("tr");
                if (row) row.classList.add("highlight-row");
            } else {
                element.classList.remove("has-data");
                const row = element.closest("tr");
                if (row) row.classList.remove("highlight-row");
            }
        }

        function calculateDefectRate() {
            const total = parseInt(document.getElementById("totalQty").value) || 0;
            const ng = parseInt(document.getElementById("ngQty").value) || 0;
            
            let rate = 0;
            if (total > 0) {
                rate = (ng / total) * 100;
            }
            
            document.getElementById("defectRate").value = rate.toFixed(2) + "%";
            updateHighlight(document.getElementById("defectRate"));
        }

        // ========== URL & SHARING ==========
        function updateUrlWithProjectId() {
            if (!currentProjectId) return;
            
            const url = new URL(window.location);
            url.searchParams.set("project", currentProjectId);
            window.history.pushState({}, "", url);
        }

        function updateShareLink() {
            if (!currentProjectId) return "";
            
            const shareUrl = `${window.location.origin}${window.location.pathname}?project=${currentProjectId}`;
            document.getElementById("shareLinkText").textContent = shareUrl;
            
            return shareUrl;
        }

        // ========== LOAD DỮ LIỆU TỪ SERVER ==========
        async function loadProjectData() {
            if (!currentProjectId || !database) return;
            
            showLoading("Đang tải dữ liệu...");
            
            try {
                const snapshot = await database.ref(`projects/${currentProjectId}/data`).once("value");
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    updateFormFromServer(data);
                    showToast("✅ Đã tải dữ liệu từ server", "success");
                }
            } catch (error) {
                console.error("Lỗi tải dữ liệu:", error);
                showToast("❌ Lỗi tải dữ liệu từ server", "error");
            } finally {
                hideLoading();
            }
        }

        // ========== HÀM LƯU TOÀN BỘ ==========
        async function saveAllToCloud() {
            if (!currentProjectId) {
                showToast("❌ Chưa có project! Hãy tạo hoặc tham gia project trước.", "error");
                return false;
            }
            
            showLoading("Đang lưu toàn bộ dữ liệu...");
            
            try {
                const formData = collectFormData();
                formData._lastUpdated = new Date().toISOString();
                formData._lastUpdatedBy = currentUser?.id || "unknown";
                
                await database.ref(`projects/${currentProjectId}/data`).set(formData);
                
                showToast("✅ Đã lưu toàn bộ dữ liệu!", "success");
                return true;
                
            } catch (error) {
                console.error("Lỗi lưu toàn bộ:", error);
                showToast("❌ Lỗi lưu dữ liệu: " + error.message, "error");
                return false;
            } finally {
                hideLoading();
            }
        }

        // ========== CHỨC NĂNG CHIA SẺ ==========
        function generateShareLink() {
            if (!currentProjectId) {
                showToast("❌ Chưa có project! Hãy tạo hoặc tham gia project trước.", "error");
                return;
            }
            
            const shareUrl = updateShareLink();
            document.getElementById("shareLinkContainer").style.display = "block";
            
            navigator.clipboard.writeText(shareUrl).then(() => {
                showToast("✅ Đã copy link vào clipboard!", "success");
            }).catch(() => {
                const tempInput = document.createElement("input");
                tempInput.value = shareUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand("copy");
                document.body.removeChild(tempInput);
                showToast("✅ Đã copy link vào clipboard!", "success");
            });
        }

        function copyShareLink() {
            const shareUrl = document.getElementById("shareLinkText").textContent;
            if (shareUrl && shareUrl.trim() !== "") {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showToast("✅ Đã copy link vào clipboard!", "success");
                }).catch(() => {
                    const tempInput = document.createElement("input");
                    tempInput.value = shareUrl;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand("copy");
                    document.body.removeChild(tempInput);
                    showToast("✅ Đã copy link vào clipboard!", "success");
                });
            } else {
                showToast("❌ Chưa có link chia sẻ!", "error");
            }
        }

        function hideShareLink() {
            document.getElementById("shareLinkContainer").style.display = "none";
        }

        // ========== CHỮ KÝ ĐIỆN TỬ - GIAO DIỆN MỚI ==========
        function setupSignaturePads() {
            // Khởi tạo Signature Pad cho Kỹ sư
            const engineerCanvas = document.getElementById("engineerSignature");
            if (engineerCanvas) {
                engineerSignaturePad = new SignaturePad(engineerCanvas, {
                    backgroundColor: "rgb(255, 255, 255)",
                    penColor: "rgb(0, 0, 0)"
                });
                
                // Xử lý radio button cho Kỹ sư
                document.querySelectorAll('input[name="engineerSignatureType"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        const isDraw = this.value === 'draw';
                        document.getElementById('engineer-drawing-area').style.display = isDraw ? 'block' : 'none';
                        document.getElementById('engineer-upload-area').style.display = isDraw ? 'none' : 'block';
                        engineerCanvas.style.display = isDraw ? 'block' : 'none';
                    });
                });
                
                // Xử lý nút xóa cho Kỹ sư
                document.getElementById("clearEngineerSignature").addEventListener("click", function() {
                    engineerSignaturePad.clear();
                    localStorage.removeItem("engineer_signature");
                    document.getElementById("engineerSignatureDisplay").innerHTML = `
                        <div style="padding: 15px; text-align: center; color: #888;">
                            <i class="fas fa-signature" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                            Chữ ký sẽ hiển thị ở đây sau khi lưu
                        </div>`;
                    document.getElementById("engineerSignatureDisplay").classList.remove("has-signature");
                    showToast("Đã xóa chữ ký kỹ sư", "info");
                    
                    // Xóa preview ảnh nếu có
                    document.getElementById('engineer-upload-preview').style.display = 'none';
                    document.getElementById('engineerImageInput').value = '';
                    
                    if (currentProjectId && database) {
                        database.ref(`projects/${currentProjectId}/data/_engineerSignature`).remove();
                    }
                });
                
                // Xử lý nút lưu cho Kỹ sư
                document.getElementById("saveEngineerSignature").addEventListener("click", function() {
                    const isDrawMode = document.querySelector('input[name="engineerSignatureType"]:checked').value === 'draw';
                    
                    if (isDrawMode) {
                        // Lưu chữ ký vẽ
                        if (!engineerSignaturePad.isEmpty()) {
                            const dataURL = engineerSignaturePad.toDataURL();
                            saveEngineerSignature(dataURL);
                        } else {
                            showToast("❌ Vui lòng ký trước khi lưu!", "error");
                        }
                    } else {
                        // Lưu chữ ký ảnh
                        const preview = document.getElementById('engineer-upload-preview');
                        if (preview.src && preview.src !== '') {
                            saveEngineerSignature(preview.src);
                        } else {
                            showToast("❌ Vui lòng tải ảnh chữ ký trước khi lưu!", "error");
                        }
                    }
                });
                
                // Xử lý upload ảnh cho Kỹ sư
                document.getElementById("uploadEngineerImageBtn").addEventListener("click", function() {
                    document.getElementById('engineerImageInput').click();
                });
                
                document.getElementById('engineerImageInput').addEventListener('change', function(e) {
                    handleImageUpload(e.target.files[0], 'engineer');
                });
                
                // Load chữ ký đã lưu
                const savedEngineerSig = localStorage.getItem("engineer_signature");
                if (savedEngineerSig) {
                    loadSavedSignature(savedEngineerSig, 'engineer');
                }
            }
            
            // Khởi tạo Signature Pad cho QC
            const qcCanvas = document.getElementById("qcSignature");
            if (qcCanvas) {
                qcSignaturePad = new SignaturePad(qcCanvas, {
                    backgroundColor: "rgb(255, 255, 255)",
                    penColor: "rgb(0, 0, 0)"
                });
                
                // Xử lý radio button cho QC
                document.querySelectorAll('input[name="qcSignatureType"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        const isDraw = this.value === 'draw';
                        document.getElementById('qc-drawing-area').style.display = isDraw ? 'block' : 'none';
                        document.getElementById('qc-upload-area').style.display = isDraw ? 'none' : 'block';
                        qcCanvas.style.display = isDraw ? 'block' : 'none';
                    });
                });
                
                // Xử lý nút xóa cho QC
                document.getElementById("clearQcSignature").addEventListener("click", function() {
                    qcSignaturePad.clear();
                    localStorage.removeItem("qc_signature");
                    document.getElementById("qcSignatureDisplay").innerHTML = `
                        <div style="padding: 15px; text-align: center; color: #888;">
                            <i class="fas fa-signature" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                            Chữ ký sẽ hiển thị ở đây sau khi lưu
                        </div>`;
                    document.getElementById("qcSignatureDisplay").classList.remove("has-signature");
                    showToast("Đã xóa chữ ký QA", "info");
                    
                    // Xóa preview ảnh nếu có
                    document.getElementById('qc-upload-preview').style.display = 'none';
                    document.getElementById('qcImageInput').value = '';
                    
                    if (currentProjectId && database) {
                        database.ref(`projects/${currentProjectId}/data/_qcSignature`).remove();
                    }
                });
                
                // Xử lý nút lưu cho QC
                document.getElementById("saveQcSignature").addEventListener("click", function() {
                    const isDrawMode = document.querySelector('input[name="qcSignatureType"]:checked').value === 'draw';
                    
                    if (isDrawMode) {
                        // Lưu chữ ký vẽ
                        if (!qcSignaturePad.isEmpty()) {
                            const dataURL = qcSignaturePad.toDataURL();
                            saveQcSignature(dataURL);
                        } else {
                            showToast("❌ Vui lòng ký trước khi lưu!", "error");
                        }
                    } else {
                        // Lưu chữ ký ảnh
                        const preview = document.getElementById('qc-upload-preview');
                        if (preview.src && preview.src !== '') {
                            saveQcSignature(preview.src);
                        } else {
                            showToast("❌ Vui lòng tải ảnh chữ ký trước khi lưu!", "error");
                        }
                    }
                });
                
                // Xử lý upload ảnh cho QC
                document.getElementById("uploadQcImageBtn").addEventListener("click", function() {
                    document.getElementById('qcImageInput').click();
                });
                
                document.getElementById('qcImageInput').addEventListener('change', function(e) {
                    handleImageUpload(e.target.files[0], 'qc');
                });
                
                // Load chữ ký đã lưu
                const savedQcSig = localStorage.getItem("qc_signature");
                if (savedQcSig) {
                    loadSavedSignature(savedQcSig, 'qc');
                }
            }
            
            // Setup dynamic signatures
            setupDynamicSignatures();
            
            // Setup modal
            setupSignatureModal();
        }

        // ========== HÀM HỖ TRỢ CHỮ KÝ ==========
        function saveEngineerSignature(dataURL) {
            localStorage.setItem("engineer_signature", dataURL);
            
            const displayDiv = document.getElementById("engineerSignatureDisplay");
            displayDiv.innerHTML = `<img src="${dataURL}" alt="Engineer Signature" style="max-width: 100%; max-height: 85px;">`;
            displayDiv.classList.add("has-signature");
            
            if (currentProjectId && database) {
                database.ref(`projects/${currentProjectId}/data/_engineerSignature`).set(dataURL);
            }
            
            showToast("✅ Đã lưu chữ ký kỹ sư!", "success");
            updateHighlight(document.getElementById("engineerName"));
        }

        function saveQcSignature(dataURL) {
            localStorage.setItem("qc_signature", dataURL);
            
            const displayDiv = document.getElementById("qcSignatureDisplay");
            displayDiv.innerHTML = `<img src="${dataURL}" alt="QC Signature" style="max-width: 100%; max-height: 85px;">`;
            displayDiv.classList.add("has-signature");
            
            if (currentProjectId && database) {
                database.ref(`projects/${currentProjectId}/data/_qcSignature`).set(dataURL);
            }
            
            showToast("✅ Đã lưu chữ ký QA!", "success");
            updateHighlight(document.getElementById("qcName"));
        }

        function handleImageUpload(file, target) {
            if (!file || !file.type.match('image.*')) {
                showToast('❌ Vui lòng chọn file ảnh hợp lệ', 'error');
                return;
            }
            
            if (file.size > 2 * 1024 * 1024) {
                showToast('❌ File ảnh quá lớn (tối đa 2MB)', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                
                if (target === 'engineer') {
                    const preview = document.getElementById('engineer-upload-preview');
                    preview.src = imageData;
                    preview.style.display = 'block';
                    
                    // Tự động chuyển sang chế độ upload
                    document.querySelector('input[name="engineerSignatureType"][value="upload"]').checked = true;
                    document.getElementById('engineer-drawing-area').style.display = 'none';
                    document.getElementById('engineer-upload-area').style.display = 'block';
                    document.getElementById('engineerSignature').style.display = 'none';
                    
                    showToast('✅ Đã tải ảnh chữ ký Kỹ sư', 'success');
                } else if (target === 'qc') {
                    const preview = document.getElementById('qc-upload-preview');
                    preview.src = imageData;
                    preview.style.display = 'block';
                    
                    // Tự động chuyển sang chế độ upload
                    document.querySelector('input[name="qcSignatureType"][value="upload"]').checked = true;
                    document.getElementById('qc-drawing-area').style.display = 'none';
                    document.getElementById('qc-upload-area').style.display = 'block';
                    document.getElementById('qcSignature').style.display = 'none';
                    
                    showToast('✅ Đã tải ảnh chữ ký QA', 'success');
                }
            };
            
            reader.readAsDataURL(file);
        }

        function loadSavedSignature(dataURL, target) {
            if (target === 'engineer') {
                document.getElementById("engineerSignatureDisplay").innerHTML = 
                    `<img src="${dataURL}" alt="Engineer Signature" style="max-width: 100%; max-height: 85px;">`;
                document.getElementById("engineerSignatureDisplay").classList.add("has-signature");
            } else if (target === 'qc') {
                document.getElementById("qcSignatureDisplay").innerHTML = 
                    `<img src="${dataURL}" alt="QC Signature" style="max-width: 100%; max-height: 85px;">`;
                document.getElementById("qcSignatureDisplay").classList.add("has-signature");
            }
        }

        // ========== QUẢN LÝ CHỮ KÝ ĐỘNG ==========
        function setupDynamicSignatures() {
            // Add signer button
            document.getElementById('addSignerBtn').addEventListener('click', addNewSigner);
            
        }

        function addNewSigner() {
            const template = document.getElementById('signerTemplate');
            const clone = template.content.cloneNode(true);
            const signerId = `signer_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
            
            // Update IDs and attributes
            const signatureSection = clone.querySelector('.signature-section');
            signatureSection.setAttribute('data-signer-id', signerId);
            signatureSection.setAttribute('id', `signer-section-${signerId}`);
            
            // Update title
            const signerCount = document.querySelectorAll('.signature-section[data-signer-id]').length + 1;
            clone.querySelector('.signer-title').textContent = `Chữ ký ${signerCount}`;
            
            // Update all IDs in the clone
            const elements = clone.querySelectorAll('[id*="_"]');
            elements.forEach(el => {
                const oldId = el.id;
                const newId = oldId.replace('_', signerId);
                el.id = newId;
                
                if (el.tagName === 'LABEL' && el.getAttribute('for')) {
                    el.setAttribute('for', newId);
                }
                
                if (el.name && el.name.includes('_')) {
                    el.name = el.name.replace('_', signerId);
                }
            });
            
            // Add to container
            document.getElementById('dynamicSignaturesContainer').appendChild(clone);
            
            // Initialize signature pad
            const canvas = document.getElementById(`signatureCanvas${signerId}`);
            if (canvas) {
                const signaturePad = new SignaturePad(canvas, {
                    backgroundColor: "rgb(255, 255, 255)",
                    penColor: "rgb(0, 0, 0)"
                });
                signaturePads[signerId] = signaturePad;
                
                // Load saved signature if exists
                const savedSig = localStorage.getItem(`signature_${signerId}`);
                if (savedSig) {
                    document.getElementById(`signatureDisplay${signerId}`).innerHTML = 
                        `<img src="${savedSig}" alt="Signature" style="max-width: 100%; max-height: 85px;">`;
                    document.getElementById(`signatureDisplay${signerId}`).classList.add("has-signature");
                }
            }
            
            // Setup event listeners
            setupSignerEvents(signerId);
            
            // Save to array
            const signerData = {
                id: signerId,
                name: '',
                role: '',
                signature: null,
                type: 'draw'
            };
            additionalSigners.push(signerData);
            
            showToast("✅ Đã thêm người ký mới", "success");
            
            // Scroll to the new signer
            setTimeout(() => {
                signatureSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        function setupSignerEvents(signerId) {
            const container = document.querySelector(`[data-signer-id="${signerId}"]`);
            
            // Remove button
            container.querySelector('.remove-signer-btn').addEventListener('click', function() {
                removeSigner(signerId);
            });
            
            // Type selector
            const typeRadios = container.querySelectorAll(`input[name="signerType${signerId}"]`);
            typeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    toggleSignatureType(signerId, this.value);
                });
            });
            
            // Upload trigger
            const uploadTrigger = container.querySelector('.upload-signature-trigger');
            const uploadInput = container.querySelector('.signature-upload-input');
            
            uploadTrigger.addEventListener('click', () => uploadInput.click());
            
            uploadInput.addEventListener('change', function(e) {
                handleSignerImageUpload(signerId, e.target.files[0]);
            });
            
            // Clear signature
            container.querySelector('.clear-signature-btn').addEventListener('click', function() {
                clearSignerSignature(signerId);
            });
            
            // Save signature
            container.querySelector('.save-signature-btn').addEventListener('click', function() {
                saveSignerSignature(signerId);
            });
            
            // Real-time input for name and role
            container.querySelector('.signer-name').addEventListener('input', function() {
                updateSignerData(signerId, 'name', this.value);
            });
            
            container.querySelector('.signer-role').addEventListener('input', function() {
                updateSignerData(signerId, 'role', this.value);
            });
        }

        function toggleSignatureType(signerId, type) {
            const container = document.querySelector(`[data-signer-id="${signerId}"]`);
            const drawingArea = container.querySelector(`#drawing-area${signerId}`);
            const uploadArea = container.querySelector(`#upload-area${signerId}`);
            const canvas = container.querySelector(`#signatureCanvas${signerId}`);
            
            if (type === 'draw') {
                drawingArea.style.display = 'block';
                uploadArea.style.display = 'none';
                if (canvas) canvas.style.display = 'block';
            } else {
                drawingArea.style.display = 'none';
                uploadArea.style.display = 'block';
                if (canvas) canvas.style.display = 'none';
            }
            
            // Update signer data
            const signer = additionalSigners.find(s => s.id === signerId);
            if (signer) {
                signer.type = type;
            }
        }

        function handleSignerImageUpload(signerId, file) {
            if (!file || !file.type.match('image.*')) {
                showToast('❌ Vui lòng chọn file ảnh hợp lệ', 'error');
                return;
            }
            
            if (file.size > 2 * 1024 * 1024) {
                showToast('❌ File ảnh quá lớn (tối đa 2MB)', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const container = document.querySelector(`[data-signer-id="${signerId}"]`);
                const preview = container.querySelector(`#upload-preview${signerId}`);
                preview.src = e.target.result;
                preview.style.display = 'block';
                
                // Update signer data
                const signer = additionalSigners.find(s => s.id === signerId);
                if (signer) {
                    signer.signature = e.target.result;
                    signer.signatureType = 'image';
                    
                    // Auto-save to localStorage
                    localStorage.setItem(`signature_${signerId}`, e.target.result);
                    
                    // Update display
                    const display = container.querySelector(`#signatureDisplay${signerId}`);
                    display.innerHTML = `<img src="${e.target.result}" alt="Signature" style="max-width: 100%; max-height: 85px;">`;
                    display.classList.add("has-signature");
                    
                    // Save to cloud if in project
                    if (currentProjectId && database) {
                        database.ref(`projects/${currentProjectId}/data/_signature_${signerId}`).set(e.target.result);
                    }
                    
                    showToast('✅ Đã tải ảnh chữ ký lên', 'success');
                }
            };
            
            reader.readAsDataURL(file);
        }

        function clearSignerSignature(signerId) {
            if (signaturePads[signerId]) {
                signaturePads[signerId].clear();
            }
            
            const container = document.querySelector(`[data-signer-id="${signerId}"]`);
            const display = container.querySelector(`#signatureDisplay${signerId}`);
            display.innerHTML = `
                <div style="padding: 15px; text-align: center; color: #888;">
                    <i class="fas fa-signature" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                    Chữ ký sẽ hiển thị ở đây sau khi lưu
                </div>`;
            display.classList.remove("has-signature");
            
            // Clear upload preview
            const preview = container.querySelector(`#upload-preview${signerId}`);
            if (preview) {
                preview.src = '';
                preview.style.display = 'none';
            }
            
            // Clear upload input
            const uploadInput = container.querySelector('.signature-upload-input');
            if (uploadInput) uploadInput.value = '';
            
            // Clear from localStorage
            localStorage.removeItem(`signature_${signerId}`);
            
            // Clear from signer data
            const signer = additionalSigners.find(s => s.id === signerId);
            if (signer) {
                signer.signature = null;
            }
            
            // Clear from cloud
            if (currentProjectId && database) {
                database.ref(`projects/${currentProjectId}/data/_signature_${signerId}`).remove();
            }
            
            showToast('Đã xóa chữ ký', 'info');
        }

        function saveSignerSignature(signerId) {
            const signer = additionalSigners.find(s => s.id === signerId);
            if (!signer) return;
            
            let signatureData = null;
            const container = document.querySelector(`[data-signer-id="${signerId}"]`);
            const isDrawMode = container.querySelector(`input[name="signerType${signerId}"]:checked`).value === 'draw';
            
            if (isDrawMode && signaturePads[signerId]) {
                if (!signaturePads[signerId].isEmpty()) {
                    signatureData = signaturePads[signerId].toDataURL();
                    signer.signatureType = 'draw';
                } else {
                    showToast('❌ Vui lòng ký trước khi lưu!', 'error');
                    return;
                }
            } else if (!isDrawMode) {
                const preview = container.querySelector(`#upload-preview${signerId}`);
                if (preview.src && preview.src !== '') {
                    signatureData = preview.src;
                    signer.signatureType = 'image';
                } else {
                    showToast('❌ Vui lòng thêm ảnh chữ ký trước khi lưu!', 'error');
                    return;
                }
            } else {
                showToast('❌ Vui lòng thêm chữ ký trước khi lưu!', 'error');
                return;
            }
            
            if (signatureData) {
                // Save to localStorage
                localStorage.setItem(`signature_${signerId}`, signatureData);
                signer.signature = signatureData;
                
                // Update display
                const display = container.querySelector(`#signatureDisplay${signerId}`);
                display.innerHTML = `<img src="${signatureData}" alt="Signature" style="max-width: 100%; max-height: 85px;">`;
                display.classList.add("has-signature");
                
                // Get name and role
                const name = container.querySelector('.signer-name').value || '';
                const role = container.querySelector('.signer-role').value || '';
                
                // Save to cloud if in project
                if (currentProjectId && database) {
                    database.ref(`projects/${currentProjectId}/data/_signature_${signerId}`).set(signatureData);
                    database.ref(`projects/${currentProjectId}/data/_signer_${signerId}_name`).set(name);
                    database.ref(`projects/${currentProjectId}/data/_signer_${signerId}_role`).set(role);
                    database.ref(`projects/${currentProjectId}/data/_signer_${signerId}_type`).set(signer.type);
                }
                
                showToast('✅ Đã lưu chữ ký!', 'success');
            }
        }

        function removeSigner(signerId) {
            if (confirm('Bạn có chắc muốn xóa người ký này?')) {
                const container = document.querySelector(`[data-signer-id="${signerId}"]`);
                if (container) {
                    container.remove();
                }
                
                // Remove from array
                additionalSigners = additionalSigners.filter(s => s.id !== signerId);
                
                // Remove from localStorage
                localStorage.removeItem(`signature_${signerId}`);
                localStorage.removeItem(`signer_${signerId}_name`);
                localStorage.removeItem(`signer_${signerId}_role`);
                
                // Remove from cloud
                if (currentProjectId && database) {
                    database.ref(`projects/${currentProjectId}/data/_signature_${signerId}`).remove();
                    database.ref(`projects/${currentProjectId}/data/_signer_${signerId}_name`).remove();
                    database.ref(`projects/${currentProjectId}/data/_signer_${signerId}_role`).remove();
                    database.ref(`projects/${currentProjectId}/data/_signer_${signerId}_type`).remove();
                }
                
                // Remove signature pad
                delete signaturePads[signerId];
                
                showToast('✅ Đã xóa người ký', 'success');
            }
        }

        function updateSignerData(signerId, field, value) {
            const signer = additionalSigners.find(s => s.id === signerId);
            if (signer) {
                signer[field] = value;
                
                // Save to localStorage
                localStorage.setItem(`signer_${signerId}_${field}`, value);
                
                // Save to cloud if in project
                if (currentProjectId && database) {
                    database.ref(`projects/${currentProjectId}/data/_signer_${signerId}_${field}`).set(value);
                }
            }
        }

        // ========== MODAL CHO CHỮ KÝ ẢNH ==========
        function setupSignatureModal() {
            const modal = document.getElementById('imageSignatureModal');
            
            // Close buttons
            modal.querySelector('.close-modal').addEventListener('click', () => {
                modal.style.display = 'none';
            });
            
            // Close when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            // Upload for engineer
            document.getElementById('uploadEngineerSignatureModal').addEventListener('click', () => {
                modal.style.display = 'none';
                uploadSignatureImage('engineer');
            });
            
            // Upload for QC
            document.getElementById('uploadQcSignatureModal').addEventListener('click', () => {
                modal.style.display = 'none';
                uploadSignatureImage('qc');
            });
            
            // Upload for new signer
            document.getElementById('uploadNewSignerModal').addEventListener('click', () => {
                modal.style.display = 'none';
                addNewSignerWithImage();
            });
        }

        function showImageSignatureModal() {
            document.getElementById('imageSignatureModal').style.display = 'block';
        }

        function uploadSignatureImage(target) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.type.match('image.*')) {
                    showToast('❌ Vui lòng chọn file ảnh hợp lệ', 'error');
                    return;
                }
                
                if (file.size > 2 * 1024 * 1024) {
                    showToast('❌ File ảnh quá lớn (tối đa 2MB)', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    
                    if (target === 'engineer') {
                        // Update engineer signature
                        const preview = document.getElementById('engineer-upload-preview');
                        preview.src = imageData;
                        preview.style.display = 'block';
                        
                        // Switch to upload mode
                        document.querySelector('input[name="engineerSignatureType"][value="upload"]').checked = true;
                        document.getElementById('engineer-drawing-area').style.display = 'none';
                        document.getElementById('engineer-upload-area').style.display = 'block';
                        document.getElementById('engineerSignature').style.display = 'none';
                        
                        // Auto-save
                        saveEngineerSignature(imageData);
                        
                        showToast('✅ Đã cập nhật ảnh chữ ký Kỹ sư', 'success');
                    } else if (target === 'qc') {
                        // Update QC signature
                        const preview = document.getElementById('qc-upload-preview');
                        preview.src = imageData;
                        preview.style.display = 'block';
                        
                        // Switch to upload mode
                        document.querySelector('input[name="qcSignatureType"][value="upload"]').checked = true;
                        document.getElementById('qc-drawing-area').style.display = 'none';
                        document.getElementById('qc-upload-area').style.display = 'block';
                        document.getElementById('qcSignature').style.display = 'none';
                        
                        // Auto-save
                        saveQcSignature(imageData);
                        
                        showToast('✅ Đã cập nhật ảnh chữ ký QA', 'success');
                    }
                };
                
                reader.readAsDataURL(file);
            });
            
            input.click();
        }

        function addNewSignerWithImage() {
            // First add new signer
            addNewSigner();
            
            // Then trigger image upload for the new signer
            setTimeout(() => {
                const latestSigner = additionalSigners[additionalSigners.length - 1];
                if (latestSigner) {
                    const container = document.querySelector(`[data-signer-id="${latestSigner.id}"]`);
                    if (container) {
                        // Switch to upload mode
                        const uploadRadio = container.querySelector('input[value="upload"]');
                        if (uploadRadio) {
                            uploadRadio.checked = true;
                            toggleSignatureType(latestSigner.id, 'upload');
                            
                            // Trigger upload
                            const uploadTrigger = container.querySelector('.upload-signature-trigger');
                            if (uploadTrigger) {
                                uploadTrigger.click();
                            }
                        }
                    }
                }
            }, 300);
        }

        // ========== XUẤT PDF GIỐNG FILE MẪU ==========
        async function exportToPDF() {
            if (!validateForm()) {
                showToast('Vui lòng điền đầy đủ các trường bắt buộc (Mã hàng và Khách hàng) trước khi xuất PDF!', 'error');
                return;
            }
            
            showLoading("Đang tạo PDF... Vui lòng đợi...");
            
            try {
                // 1. Thu thập tất cả dữ liệu
                const allData = collectFormData();
                const processes = [];
                if (allData.processSMT) processes.push('SMT');
                if (allData.processThroughHole) processes.push('THROUGH HOLE');
                if (allData.processCoating) processes.push('COATING');
                if (allData.processBoxbuild) processes.push('BOXBUILD');
                if (allData.processPacking) processes.push('PACKING');
                
                // 2. Tạo nội dung PDF
                const pdfContent = createPDFContent(allData, processes);
                
                // 3. Tạo HTML đầy đủ
                const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>NPI Record - ${allData.model || 'Unknown'}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 10pt;
                            line-height: 1.2;
                            color: #000;
                            margin: 0;
                            padding: 0;
                            width: 210mm;
                        }
                        
                        .page-container {
                            width: 210mm;
                            min-height: 297mm;
                            padding: 15mm;
                            box-sizing: border-box;
                        }
                        
                        .header {
                            text-align: center;
                            margin-bottom: 15px;
                            border-bottom: 2px solid #000;
                            padding-bottom: 10px;
                        }
                        
                        .header h1 {
                            margin-bottom: 5px;
                            font-size: 18pt;
                            font-weight: bold;
                        }
                        
                        .form-section {
                            border: 1px solid #000;
                            border-radius: 2px;
                            padding: 10px;
                            margin-bottom: 15px;
                            page-break-inside: auto;
                        }
                        
                        .section-title {
                            background-color: #e0e0e0;
                            color: #000;
                            padding: 8px 10px;
                            margin: -10px -10px 10px -10px;
                            border-bottom: 1px solid #000;
                            font-size: 12pt;
                            font-weight: bold;
                        }
                        
                        .sub-section-title {
                            background-color: #f0f0f0;
                            color: #000;
                            padding: 6px 8px;
                            margin: 10px -10px;
                            border-top: 1px solid #ddd;
                            border-bottom: 1px solid #ddd;
                            font-size: 11pt;
                            font-weight: bold;
                        }
                        
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 10px 0;
                            font-size: 9pt;
                        }
                        
                        th, td {
                            border: 1px solid #000;
                            padding: 4px;
                            vertical-align: top;
                        }
                        
                        th {
                            background-color: #f0f0f0;
                            font-weight: bold;
                            text-align: center;
                        }
                        
                        .highlight {
                            color: #1565C0 !important;
                            font-weight: normal !important;
                            background-color: #E3F2FD !important;
                        }
                        
                        .highlight-box {
                            border-left: 3px solid #1565C0;
                            padding: 3px 6px;
                            margin: 1px 0;
                        }
                        
                        .signature-container {
                            border: 2px solid #1565C0;
                            padding: 8px;
                            text-align: center;
                            min-height: 80px;
                            margin: 10px 0;
                        }
                        
                        .signature-img {
                            max-width: 100%;
                            max-height: 70px;
                        }
                        
                        .conclusion-table {
                            width: 100% !important;
                            border-collapse: collapse !important;
                            table-layout: fixed !important;
                        }
                        
                        .conclusion-table th,
                        .conclusion-table td {
                            border: 1px solid #000 !important;
                            padding: 3px !important;
                            word-wrap: break-word !important;
                            word-break: break-all !important;
                            overflow: hidden !important;
                        }
                        
                        .conclusion-table th {
                            background-color: #f0f0f0 !important;
                            font-weight: bold !important;
                            text-align: center !important;
                            vertical-align: middle !important;
                            height: 40px !important;
                            font-size: 8.5pt !important;
                        }
                        
                        .conclusion-table td {
                            height: 120px !important;
                            max-height: 120px !important;
                            vertical-align: top !important;
                        }
                        
                        .conclusion-table td:nth-child(1) { width: 18% !important; text-align: center !important; }
                        .conclusion-table td:nth-child(2) { width: 27% !important; }
                        .conclusion-table td:nth-child(3) { width: 27% !important; }
                        .conclusion-table td:nth-child(4) { width: 28% !important; }
                        
                        .conclusion-table th:nth-child(1) { width: 18% !important; }
                        .conclusion-table th:nth-child(2) { width: 27% !important; }
                        .conclusion-table th:nth-child(3) { width: 27% !important; }
                        .conclusion-table th:nth-child(4) { width: 28% !important; }
                        
                        .conclusion-content {
                            font-size: 7pt !important;
                            line-height: 1.0 !important;
                            margin: 0 !important;
                            padding: 1px 2px !important;
                            word-wrap: break-word !important;
                            word-break: break-all !important;
                            overflow: hidden !important;
                            display: block !important;
                            width: 100% !important;
                            height: 114px !important;
                            max-height: 114px !important;
                            overflow-y: hidden !important;
                        }
                        
                        .conclusion-result {
                            font-size: 9pt !important;
                            font-weight: bold !important;
                            text-align: center !important;
                            display: flex !important;
                            align-items: center !important;
                            justify-content: center !important;
                            height: 100% !important;
                            width: 100% !important;
                        }
                        
                        .page-break {
                            page-break-before: always;
                        }
                        
                        .no-print {
                            display: none !important;
                        }
                    </style>
                </head>
                <body>
                    <div class="page-container">
                        ${pdfContent}
                    </div>
                </body>
                </html>
                `;
                
                // 4. Mở cửa sổ mới và in
                const printWindow = window.open('', '_blank', 'width=900,height=700');
                printWindow.document.open();
                printWindow.document.write(htmlContent);
                printWindow.document.close();
                
                // 5. Chờ nội dung tải xong rồi kích hoạt in
                setTimeout(() => {
                    printWindow.focus();
                    printWindow.print();
                    
                    setTimeout(() => {
                        if (!printWindow.closed) {
                            printWindow.close();
                        }
                    }, 1000);
                    
                    showToast("✅ PDF đã sẵn sàng để in!", "success");
                    hideLoading();
                }, 500);
                
            } catch (error) {
                console.error("Lỗi xuất PDF:", error);
                showToast("❌ Lỗi xuất PDF: " + error.message, "error");
                hideLoading();
            }
        }

        // HÀM XỬ LÝ TEXT DÀI
        function splitTextForPDF(text, maxLineLength = 25, maxLines = 20) {
            if (!text || !text.trim()) return '';
            
            const cleanText = text.trim().replace(/\s+/g, ' ');
            
            if (cleanText.length <= maxLineLength * 3) {
                return cleanText;
            }
            
            const chunks = [];
            let currentChunk = '';
            
            for (let i = 0; i < cleanText.length; i++) {
                currentChunk += cleanText[i];
                
                if (currentChunk.length >= maxLineLength && 
                    (cleanText[i] === ' ' || i === cleanText.length - 1)) {
                    chunks.push(currentChunk.trim());
                    currentChunk = '';
                }
            }
            
            if (currentChunk.trim()) {
                chunks.push(currentChunk.trim());
            }
            
            if (chunks.length > maxLines) {
                return chunks.slice(0, maxLines).join(' ') + '...';
            }
            
            return chunks.join(' ');
        }

        // Hàm tạo nội dung PDF từ tất cả dữ liệu
        function createPDFContent(data, processes) {
            // XỬ LÝ TEXT ĐẶC BIỆT
            const risksText = splitTextForPDF(data.processRisks || '', 20, 25);
            const lessonsText = splitTextForPDF(data.lessonsLearned || '', 20, 25);
            const improvementText = splitTextForPDF(data.processImprovement || '', 20, 25);
            const defectText = splitTextForPDF(data.defectDescription || '', 30, 10);
            
            // Hàm helper để highlight dữ liệu
            function highlight(value) {
                if (value && value.toString().trim() !== '') {
                    return `<span style="color: #1565C0 !important; font-weight: normal; background-color: #E3F2FD; padding: 2px 4px; border-radius: 2px;">${value.toString()}</span>`;
                }
                return value || '';
            }

            function highlightTextarea(value) {
                if (value && value.trim() !== '') {
                    const processed = splitTextForPDF(value, 30, 8);
                    return `<div style="color: #1565C0; background-color: #E3F2FD; border-left: 3px solid #1565C0; padding: 3px 6px; margin: 1px 0;">${processed}</div>`;
                }
                return '';
            }

            function highlightSelect(value) {
                if (value && value !== '' && value !== '-- Chọn --') {
                    return `<span style="color: #1565C0 !important; font-weight: bold; background-color: #F5F9FF; padding: 2px 6px; border-radius: 3px; border: 1px solid #1565C0;">${value}</span>`;
                }
                return '';
            }
            
            // Format date
            function formatDate(dateStr) {
                if (!dateStr) return '';
                try {
                    const date = new Date(dateStr);
                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                } catch {
                    return dateStr;
                }
            }
            
            // Bắt đầu xây dựng nội dung
            let content = `
            <!-- Header -->
            <div class="header" style="display:flex; align-items:center; border-bottom:1px solid #000; padding-bottom:8px;">
                <!-- LOGO TRÁI -->
                <img src="logo.png" alt="Logo" style="height:60px; margin-right:15px;">
                <!-- TIÊU ĐỀ -->
                <div style="text-align:center; flex:1;">
                    <h1 style="margin:0;">BIỂU GHI NPI - NPI RECORD</h1>
                    <div style="font-size:12px; margin-top:4px;">
                        TNEMS-EN-F-048-NPI RECORD-VER03
                    </div>
                </div>
            </div>
            
            <!-- Product Information -->
            <div class="form-section">
                <div class="section-title">THÔNG TIN SẢN PHẨM - PRODUCT INFORMATION</div>
                
                <table>
                    <tr>
                        <td width="25%" style="font-weight: bold;">MÃ HÀNG / MODEL:</td>
                        <td width="35%">${highlight(data.model)}</td>
                        <td width="20%" style="font-weight: bold;">Part No:</td>
                        <td width="20%">${highlight(data.partNo)}</td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold;">KHÁCH HÀNG / CUSTOMER:</td>
                        <td>${highlight(data.customer)}</td>
                        <td style="font-weight: bold;">Ngày / Date:</td>
                        <td>${highlight(formatDate(data.date))}</td>
                    </tr>
                </table>
                
                <div style="margin-top: 10px;">
                    <span style="font-weight: bold;">Quy trình / Process:</span>
                    <div style="margin-top: 5px;">
                        ${processes.length > 0 ? highlight(processes.join(', ')) : ''}
                    </div>
                </div>
            </div>`;
            
            // ========== SMT PROCESS ==========
            if (processes.includes('SMT')) {
                content += `
                <div class="form-section">
                    <div class="section-title">SMT PROCESS</div>
                    
                    <!-- LASER MARKING -->
                    <div class="sub-section-title">LASER MARKING</div>
                    <table>
                        <tr>
                            <th width="30%">NỘI DUNG</th>
                            <th width="70%">GIÁ TRỊ</th>
                        </tr>
                        <tr>
                            <td>Tên chương trình/ Program name</td>
                            <td>${highlight(data.laserProgram)}</td>
                        </tr>
                        <tr>
                            <td>Loại QR code/ QR code type</td>
                            <td>${highlight(data.qrType)}</td>
                        </tr>
                        <tr>
                            <td>Kích thước QR code/ QR code size</td>
                            <td>${highlight(data.qrSize)}</td>
                        </tr>
                        <tr>
                            <td>Cường độ khắc/ Engraving intensity</td>
                            <td>${highlight(data.engravingIntensity)}</td>
                        </tr>
                        <tr>
                            <td>Side BOT: Nội dung QR code/ QR code content</td>
                            <td>${highlightTextarea(data.qrContentBot)}</td>
                        </tr>
                        <tr>
                            <td>Side TOP: Nội dung QR code/ QR code content</td>
                            <td>${highlightTextarea(data.qrContentTop)}</td>
                        </tr>
                        <tr>
                            <td>Nội dung QR code khi quét bằng máy</td>
                            <td>${highlightTextarea(data.qrScanContent)}</td>
                        </tr>
                    </table>
                    
                    <!-- PRINTER -->
                    <div class="sub-section-title">PRINTER</div>
                    <div style="padding: 5px;">
                        ${highlight(data.printerControl || 'Theo Process control sheet đính kèm/According to the attached Process Control Sheet')}
                    </div>
                    
                    <!-- MOUNTER -->
                    <div class="sub-section-title">MOUNTER</div>
                    <div style="padding: 5px;">
                        ${highlight(data.mounterControl || 'Theo Process control sheet đính kèm (có xác nhận và đo giá trị của các bên)/According to the attached Process Control Sheet')}
                    </div>
                    
                    <!-- VISUAL INSPECTION 1 -->
                    <div class="sub-section-title">NGOẠI QUAN VISUAL INSPECTION</div>
                    <table>
                        <tr>
                            <th width="40%">HƯỚNG LINH KIỆN/COMPONENT POLARITY</th>
                            <th width="30%">SỐ LƯỢNG LINH KIỆN/COMPONENT QUANTITY</th>
                            <th width="15%">KẾT QUẢ/RESULT</th>
                            <th width="15%">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td>Theo bảng hướng linh kiện đính kèm (QC)</td>
                            <td>
                                <div>Theo BOM/ According to the BOM: ${highlight(data.bomQty)}</div>
                                <div style="margin-top: 3px;">Thực tế/ Reality: ${highlight(data.actualQty)}</div>
                            </td>
                            <td style="text-align: center;">${highlightSelect(data.visualResult1)}</td>
                            <td style="text-align: center;">
                                <div style="font-size: 8.5pt;">ENG: ${highlight(data.engVerify1)}</div>
                                <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.qcVerify1)}</div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- REFLOW OVEN -->
                    <div class="sub-section-title">LÒ REFLOW/REFLOW OVEN</div>
                    <table>
                        <tr>
                            <th width="30%">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                            <th width="40%">THÔNG SỐ CÀI ĐẶT MÁY/MACHINE PARAMETERS SETTING</th>
                            <th width="15%">KẾT QUẢ/RESULT</th>
                            <th width="15%">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td>- Theo Process control sheet đính kèm<br>- Profile lò đính kèm</td>
                            <td>${highlightTextarea(data.reflowParams)}</td>
                            <td style="text-align: center;">${highlightSelect(data.reflowResult)}</td>
                            <td style="text-align: center;">
                                <div style="font-size: 8.5pt;">ENG: ${highlight(data.reflowEng)}</div>
                                <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.reflowQc)}</div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- AOI -->
                    <div class="sub-section-title">AOI/AUTOMATED OPTICAL INSPECTION</div>
                    <table>
                        <tr>
                            <th width="30%">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                            <th width="25%">SỐ LƯỢNG PCBA ĐÃ AOI/PCBA AOI INSPECTED QUANTITY</th>
                            <th width="15%">KẾT QUẢ/RESULT</th>
                            <th width="30%">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <div>BOT: ${highlight(data.aoiProgramBot)}</div>
                                <div style="margin-top: 3px;">TOP: ${highlight(data.aoiProgramTop)}</div>
                            </td>
                            <td style="text-align: center;">${highlight(data.aoiQty)}</td>
                            <td style="text-align: center;">${highlightSelect(data.aoiResult)}</td>
                            <td style="text-align: center;">
                                <div style="font-size: 8.5pt;">ENG: ${highlight(data.aoiEng)}</div>
                                <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.aoiQc)}</div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- FLYING PROBE -->
                    <div class="sub-section-title">FLYING PROBE (20%)</div>
                    <table>
                        <tr>
                            <th width="30%">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                            <th width="25%">SỐ LƯỢNG ĐÃ ĐO/MEASURED QUANTITY</th>
                            <th width="15%">KẾT QUẢ/RESULT</th>
                            <th width="30%">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <div>BOT: ${highlight(data.probeProgramBot)}</div>
                                <div style="margin-top: 3px;">TOP: ${highlight(data.probeProgramTop)}</div>
                            </td>
                            <td style="text-align: center;">${highlight(data.probeQty)}</td>
                            <td style="text-align: center;">${highlightSelect(data.probeResult)}</td>
                            <td style="text-align: center;">
                                <div style="font-size: 8.5pt;">ENG: ${highlight(data.probeEng)}</div>
                                <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.probeQc)}</div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- VISUAL INSPECTION 2 -->
                    <div class="sub-section-title">NGOẠI QUAN VISUAL INSPECTION</div>
                    <div style="font-size: 8.5pt; color: #666; margin: 5px 0; font-style: italic;">
                        KIỂM TRA SỐ LƯỢNG LINH KIỆN, CHẤT LƯỢNG MỐI HÀN, HƯỚNG LINH KIỆN, CÁC LỖI ĐÁNH GIÁ THEO IPC
                    </div>
                    <table>
                        <tr>
                            <th width="40%">NỘI DUNG KIỂM TRA</th>
                            <th width="30%">KẾT QUẢ</th>
                            <th width="30%">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td>- Số lượng linh kiện/ Component Quantity</td>
                            <td style="text-align: center;">${highlightSelect(data.visual2Result1)}</td>
                            <td rowspan="4" style="text-align: center; vertical-align: middle;">
                                <div style="font-size: 8.5pt;">ENG: ${highlight(data.visual2Eng)}</div>
                                <div style="margin-top: 5px; font-size: 8.5pt;">QC: ${highlight(data.visual2Qc)}</div>
                            </td>
                        </tr>
                        <tr>
                            <td>- Chất lượng mối hàn/ Solder Joint Quality</td>
                            <td style="text-align: center;">${highlightSelect(data.visual2Result2)}</td>
                        </tr>
                        <tr>
                            <td>- Hướng linh kiện/ Component Orientation</td>
                            <td style="text-align: center;">${highlightSelect(data.visual2Result3)}</td>
                        </tr>
                        <tr>
                            <td>- Các lỗi đánh giá theo IPC/ Defects Evaluated per IPC</td>
                            <td style="text-align: center;">${highlightSelect(data.visual2Result4)}</td>
                        </tr>
                    </table>
                </div>`;
            }
            
            // ========== THROUGH-HOLE PROCESS ==========
            if (processes.includes('THROUGH HOLE')) {
                content += `
                <div class="form-section">
                    <div class="section-title">THROUGH-HOLE PROCESS</div>
                    
                    <!-- Component Quantity Check -->
                    <div class="sub-section-title">KIỂM TRA SỐ LƯỢNG LINH KIỆN / COMPONENT QUANTITY CHECK</div>
                    <table>
                        <tr>
                            <th width="40%">NỘI DUNG KIỂM TRA/INSPECTION CONTENT</th>
                            <th width="30%">GIÁ TRỊ/VALUE</th>
                            <th width="15%">KẾT QUẢ/RESULT</th>
                            <th width="15%">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td>ĐÚNG MÃ / CORRECT PART NUMBER</td>
                            <td>${highlight(data.thPartNumber)}</td>
                            <td style="text-align: center;">${highlightSelect(data.thPartNumberResult)}</td>
                            <td style="text-align: center;">
                                <div style="font-size: 8.5pt;">ENG: ${highlight(data.thQuantityEng)}</div>
                                <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.thQuantityQc)}</div>
                            </td>
                        </tr>
                        <tr>
                            <td>SỐ LƯỢNG / QUANTITY</td>
                            <td>${highlight(data.thQuantity)}</td>
                            <td style="text-align: center;">${highlightSelect(data.thQuantityResult)}</td>
                            <td style="text-align: center;">
                                <div style="font-size: 8.5pt;">ENG: ${highlight(data.thQuantityEng2)}</div>
                                <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.thQuantityQc2)}</div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Soldering -->
                    <div class="sub-section-title">HÀN / SOLDERING</div>
                    <table>
                        <tr>
                            <th width="40%">THÔNG SỐ / PARAMETERS</th>
                            <th width="30%">GIÁ TRỊ / VALUE</th>
                            <th width="15%">KẾT QUẢ / RESULT</th>
                            <th width="15%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>NHIỆT ĐỘ CÀI ĐẶT HÀN TAY / HAND SOLDERING TEMPERATURE SETTING</td>
                            <td>${highlight(data.handSolderTemp)}</td>
                            <td style="text-align: center;">${highlightSelect(data.handSolderResult)}</td>
                            <td rowspan="3" style="text-align: center; vertical-align: middle;">
                                <div style="font-size: 8.5pt;">ENG: ${highlight(data.thSolderingEng)}</div>
                                <div style="margin-top: 5px; font-size: 8.5pt;">QC: ${highlight(data.thSolderingQc)}</div>
                            </td>
                        </tr>
                        <tr>
                            <td>Loại nozzle/Nozzle type:</td>
                            <td>${highlight(data.nozzleType)}</td>
                            <td style="text-align: center;">${highlightSelect(data.nozzleResult)}</td>
                        </tr>
                        <tr>
                            <td>Preheat (ºC): Solder pot (ºC): Thời gian preheat (s)</td>
                            <td>${highlight(data.solderParams)}</td>
                            <td style="text-align: center;">${highlightSelect(data.solderParamsResult)}</td>
                        </tr>
                    </table>
                    
                    <!-- Testing -->
                    <div class="sub-section-title">TESTING</div>
                    <table>
                        <tr>
                            <th width="40%">GIÁ TRỊ KIỂM TRA / INSPECTION VALUE</th>
                            <th width="30%">CÁC BƯỚC KIỂM TRA / INSPECTION STEPS</th>
                            <th width="15%">KẾT QUẢ / RESULT</th>
                            <th width="15%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>Xem file đính kèm Test đính kèm / See attached file</td>
                            <td>Xem file đính kèm Test đính kèm / See attached file</td>
                            <td style="text-align: center;">${highlightSelect(data.testingResult)}</td>
                            <td style="text-align: center;">
                                <div style="font-size: 8.5pt;">ENG: ${highlight(data.thTestingEng)}</div>
                                <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.thTestingQc)}</div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- PCBA Cleaning -->
                    <div class="sub-section-title">VỆ SINH PCBA / PCBA CLEANING</div>
                    <table>
                        <tr>
                            <th width="40%">PHƯƠNG PHÁP VỆ SINH / CLEANING METHOD</th>
                            <th width="30%">DỤNG CỤ & DUNG DỊCH / TOOLS & SOLUTION</th>
                            <th width="15%">KẾT QUẢ / RESULT</th>
                            <th width="15%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>${highlight(data.cleaningMethod)}</td>
                            <td>${highlight(data.cleaningTools)}</td>
                            <td style="text-align: center;">${highlightSelect(data.cleaningResult)}</td>
                            <td style="text-align: center;">
                                <div style="font-size: 8.5pt;">ENG: ${highlight(data.thCleaningEng)}</div>
                                <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.thCleaningQc)}</div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Visual Inspection -->
                    <div class="sub-section-title">NGOẠI QUAN VISUAL INSPECTION</div>
                    <table>
                        <tr>
                            <th width="40%">CHẤT LƯỢNG MỐI HÀN VÀ VỆ SINH / SOLDER JOINT QUALITY AND CLEANLINESS</th>
                            <th width="30%">ĐÚNG, ĐỦ LINH KIỆN / CORRECT AND COMPLETE COMPONENTS</th>
                            <th width="15%">KẾT QUẢ / RESULT</th>
                            <th width="15%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>${highlight(data.thVisualQuality)}</td>
                            <td>${highlight(data.thVisualComponents)}</td>
                            <td style="text-align: center;">${highlightSelect(data.thVisualResult)}</td>
                            <td style="text-align: center;">
                                <div style="font-size: 8.5pt;">ENG: ${highlight(data.thVisualEng)}</div>
                                <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.thVisualQc)}</div>
                            </td>
                        </tr>
                    </table>
                </div>`;
            }
            
            // ========== COATING PROCESS ==========
            if (processes.includes('COATING')) {
                content += `
                <div class="form-section">
                    <div class="section-title">COATING PROCESS</div>
                    
                    <!-- COATING -->
                    <div class="sub-section-title">COATING</div>
                    <table>
                        <tr>
                            <th width="40%">THÔNG SỐ / PARAMETERS</th>
                            <th width="40%">GIÁ TRỊ / VALUE</th>
                            <th width="10%">KẾT QUẢ / RESULT</th>
                            <th width="10%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>- Dung dịch coating/ Coating solution:</td>
                            <td>${highlight(data.coatingSolution)}</td>
                            <td style="text-align: center;">${highlightSelect(data.coatingSolutionResult)}</td>
                            <td rowspan="5" style="text-align: center; vertical-align: middle;">
                                <div style="font-size: 8.5pt;">ENG: ${highlight(data.coatingEng)}</div>
                                <div style="margin-top: 5px; font-size: 8.5pt;">QC: ${highlight(data.coatingQc)}</div>
                            </td>
                        </tr>
                        <tr>
                            <td>- Phương pháp coating/ Coating method:</td>
                            <td>${highlight(data.coatingMethod)}</td>
                            <td style="text-align: center;">${highlightSelect(data.coatingMethodResult)}</td>
                        </tr>
                        <tr>
                            <td>- Phương pháp sấy/ Drying method:</td>
                            <td>${highlight(data.dryingMethod)}</td>
                            <td style="text-align: center;">${highlightSelect(data.dryingMethodResult)}</td>
                        </tr>
                        <tr>
                            <td>- Nhiệt độ sấy/ Drying temperature:</td>
                            <td>${highlight(data.dryingTemp)}</td>
                            <td style="text-align: center;">${highlightSelect(data.dryingTempResult)}</td>
                        </tr>
                        <tr>
                            <td>- Thời gian sấy/ Drying time:</td>
                            <td>${highlight(data.dryingTime)}</td>
                            <td style="text-align: center;">${highlightSelect(data.dryingTimeResult)}</td>
                        </tr>
                    </table>
                </div>`;
            }
            
            // ========== BOXBUILD PROCESS ==========
            if (processes.includes('BOXBUILD')) {
                content += `
                <div class="form-section">
                    <div class="section-title">LẮP RÁP / BOXBUILD PROCESS</div>
                    
                    <!-- Assembly Jig/Tool -->
                    <div class="sub-section-title">LẮP RÁP BOXBUILD</div>
                    <table>
                        <tr>
                            <th width="40%">JIG/DỤNG CỤ LẮP RÁP / ASSEMBLY JIG OR TOOL</th>
                            <th width="30%">TIÊU CHUẨN / SPECIFICATION</th>
                            <th width="15%">KẾT QUẢ / RESULT</th>
                            <th width="15%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>${highlight(data.assemblyJig)}</td>
                            <td>${highlight(data.assemblySpec)}</td>
                            <td style="text-align: center;">${highlightSelect(data.assemblyJigResult)}</td>
                            <td style="text-align: center;">
                                <div style="font-size: 8.5pt;">ENG: ${highlight(data.assemblyJigEng)}</div>
                                <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.assemblyJigQc)}</div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Assembly Component -->
                    <div class="sub-section-title">SỐ LƯỢNG LINH KIỆN LẮP RÁP / ASSEMBLY COMPONENT QUANTITY</div>
                    <table>
                        <tr>
                            <th width="40%">SỐ LƯỢNG LINH KIỆN / COMPONENT QUANTITY</th>
                            <th width="30%">HƯỚNG/CHIỀU LẮP LINH KIỆN / COMPONENT ORIENTATION</th>
                            <th width="15%">KẾT QUẢ / RESULT</th>
                            <th width="15%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>${highlight(data.assemblyQty)}</td>
                            <td>Theo bản vẽ/ According to the drawing</td>
                            <td style="text-align: center;">${highlightSelect(data.assemblyQtyResult)}</td>
                            <td style="text-align: center;">
                                <div style="font-size: 8.5pt;">ENG: ${highlight(data.assemblyQtyEng)}</div>
                                <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.assemblyQtyQc)}</div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- IMEI/Label -->
                    <div class="sub-section-title">IMEI / LABEL</div>
                    <table>
                        <tr>
                            <th width="25%">VỊ TRÍ DÁN NHÃN / LABEL POSITION</th>
                            <th width="20%">HƯỚNG DÁN NHÃN / LABEL ORIENTATION</th>
                            <th width="35%">NỘI DUNG NHÃN / LABEL CONTENT</th>
                            <th width="10%">KẾT QUẢ / RESULT</th>
                            <th width="10%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>${highlight(data.labelPosition)}</td>
                            <td>${highlight(data.labelOrientation)}</td>
                            <td>${highlight(data.labelContent)}</td>
                            <td style="text-align: center;">${highlightSelect(data.labelResult)}</td>
                            <td style="text-align: center;">
                                <div style="font-size: 8.5pt;">ENG: ${highlight(data.labelEng)}</div>
                                <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.labelQc)}</div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Visual Inspection -->
                    <div class="sub-section-title">KIỂM TRA NGOẠI QUAN / VISUAL INSPECTION</div>
                    <table>
                        <tr>
                            <th width="40%">TIÊU CHUẨN KIỂM TRA / INSPECTION REQUIREMENT</th>
                            <th width="40%">MÔ TẢ / DESCRIPTION</th>
                            <th width="10%">KẾT QUẢ / RESULT</th>
                            <th width="10%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>${highlight(data.boxInspectionReq)}</td>
                            <td>${highlight(data.boxInspectionDesc)}</td>
                            <td style="text-align: center;">${highlightSelect(data.boxInspectionResult)}</td>
                            <td style="text-align: center;">
                                <div style="font-size: 8.5pt;">ENG: ${highlight(data.boxInspectionEng)}</div>
                                <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.boxInspectionQc)}</div>
                            </td>
                        </tr>
                    </table>
                </div>`;
            }
            
            // ========== PACKAGING PROCESS ==========
            if (processes.includes('PACKING')) {
                content += `
                <div class="form-section">
                    <div class="section-title">ĐÓNG GÓI / PACKAGING PROCESS</div>
                    
                    <!-- Packaging -->
                    <div class="sub-section-title">ĐÓNG GÓI / PACKAGING</div>
                    <table>
                        <tr>
                            <th width="30%">VẬT LIỆU ĐÓNG GÓI / PACKAGING MATERIAL</th>
                            <th width="30%">PHƯƠNG PHÁP ĐÓNG GÓI / PACKAGING METHOD</th>
                            <th width="20%">SỐ LƯỢNG/THÙNG / QUANTITY PER BOX</th>
                            <th width="10%">KẾT QUẢ / RESULT</th>
                            <th width="10%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <div>- Theo BOM Đính kèm/ Attached BOM</div>
                                <div>- Bổ sung (nếu có)/ Additional (if any): ${highlight(data.packagingMaterial)}</div>
                            </td>
                            <td>${highlight(data.packagingMethod)}</td>
                            <td style="text-align: center;">${highlight(data.packagingQty)}</td>
                            <td style="text-align: center;">${highlightSelect(data.packagingResult)}</td>
                            <td style="text-align: center;">
                                <div style="font-size: 8.5pt;">ENG: ${highlight(data.packagingEng)}</div>
                                <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.packagingQc)}</div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Label -->
                    <div class="sub-section-title">LABEL</div>
                    <table>
                        <tr>
                            <th width="40%">NỘI DUNG LABEL / LABEL CONTENT</th>
                            <th width="40%">MẪU HOẶC HÌNH ẢNH LABEL THỰC TẾ / ACTUAL IMAGE/SAMPLE</th>
                            <th width="10%">KẾT QUẢ / RESULT</th>
                            <th width="10%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>${highlight(data.packLabelContent)}</td>
                            <td>
                                ${data._packLabelImage ? `
                                <div style="text-align: center; background-color: #E3F2FD; padding: 5px; border-left: 3px solid #1565C0;">
                                    <img src="${data._packLabelImage}" alt="Label Image" style="max-width: 150px; max-height: 100px; border: 1px solid #ddd; padding: 2px;">
                                </div>
                                <div style="font-size: 8pt; margin-top: 3px; color: #1565C0; font-weight: normal;">
                                    ${data.packLabelImageDesc || 'Hình ảnh label thực tế'}
                                </div>
                                ` : (data.packLabelImageDesc ? 
                                    `<div style="color: #1565C0; background-color: #E3F2FD; padding: 3px 6px; border-left: 3px solid #1565C0;">${data.packLabelImageDesc}</div>` 
                                    : '- Thêm hình ảnh hoặc mẫu thực tế vào ô này')}
                            </td>
                            <td style="text-align: center;">${highlightSelect(data.packLabelResult)}</td>
                            <td style="text-align: center;">
                                <div style="font-size: 8.5pt;">ENG: ${highlight(data.packLabelEng)}</div>
                                <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.packLabelQc)}</div>
                            </td>
                        </tr>
                    </table>
                </div>`;
            }
            
            // ========== CONCLUSION SECTION (LUÔN HIỂN THỊ) ==========
            content += `
            <div class="form-section">
                <div class="section-title">KẾT LUẬN / CONCLUSION</div>
                
                <table class="conclusion-table">
                    <tr>
                        <th style="width: 18% !important;">KẾT QUẢ CUỐI CÙNG<br>FINAL RESULT</th>
                        <th style="width: 27% !important;">RỦI RO TRONG CÁC CÔNG ĐOẠN<br>RISKS IN EACH PROCESS STEP</th>
                        <th style="width: 27% !important;">BÀI HỌC TỪNG CÔNG ĐOẠN<br>LESSONS LEARNED FROM EACH PROCESS STEP</th>
                        <th style="width: 28% !important;">CẢI TIẾN CÔNG ĐOẠN<br>PROCESS IMPROVEMENT</th>
                    </tr>
                    <tr>
                        <td style="height: 120px; vertical-align: middle !important; text-align: center !important;">
                            <div class="conclusion-result">
                                ${data.finalResult ? highlightSelect(data.finalResult) : ''}
                            </div>
                        </td>
                        <td style="height: 120px;">
                            <div class="conclusion-content ${risksText ? 'highlight' : ''}">
                                ${risksText || ''}
                            </div>
                        </td>
                        <td style="height: 120px;">
                            <div class="conclusion-content ${lessonsText ? 'highlight' : ''}">
                                ${lessonsText || ''}
                            </div>
                        </td>
                        <td style="height: 120px;">
                            <div class="conclusion-content ${improvementText ? 'highlight' : ''}">
                                ${improvementText || ''}
                            </div>
                        </td>
                    </tr>
                </table>
                
                <div style="margin-top: 15px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                        <tr>
                            <td width="25%" style="padding: 4px; vertical-align: top;">
                                <div><strong>Tổng số lượng (PCBA):</strong></div>
                                <div><strong>Total qty (PCBA):</strong></div>
                                <div style="margin-top: 3px; font-size: 10pt;">
                                    ${data.totalQty ? highlight(data.totalQty) : '0'}
                                </div>
                            </td>
                            <td width="20%" style="padding: 4px; vertical-align: top;">
                                <div><strong>OK :</strong></div>
                                <div style="margin-top: 3px; font-size: 10pt;">
                                    ${data.okQty ? highlight(data.okQty) : '0'}
                                </div>
                            </td>
                            <td width="20%" style="padding: 4px; vertical-align: top;">
                                <div><strong>NG (scrap) :</strong></div>
                                <div style="margin-top: 3px; font-size: 10pt;">
                                    ${data.ngQty ? highlight(data.ngQty) : '0'}
                                </div>
                            </td>
                            <td width="35%" style="padding: 4px; vertical-align: top;">
                                <div><strong>Tỷ lệ lỗi/ Defect rate (%) :</strong></div>
                                <div><strong>(NG/Total)</strong></div>
                                <div style="margin-top: 3px; font-size: 10pt;">
                                    ${data.defectRate ? highlight(data.defectRate) : '0%'}
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <div style="margin-top: 10px;">
                    <div><strong>Mô tả chi tiết lỗi / detailed defect description:</strong></div>
                    <div style="margin-top: 3px; min-height: 40px; max-height: 60px; font-size: 8pt; line-height: 1.0; padding: 3px; border: 1px solid #ddd; overflow: hidden; word-break: break-all;">
                        ${defectText ? `<div class="highlight" style="padding: 1px;">${defectText}</div>` : ''}
                    </div>
                </div>
                
                <!-- Electronic Signatures -->
                <div style="margin-top: 15px;">
                    <div class="sub-section-title">XÁC NHẬN ĐIỆN TỬ - ELECTRONIC SIGNATURES</div>
                    
                    <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 8px;">`;
            
            // Engineer Signature
            content += `
                        <div style="flex: 1; min-width: 300px;">
                            <div><strong>Ký xác nhận của Kỹ sư / Engineer Signature:</strong></div>
                            <div class="signature-container">
                                ${data._engineerSignature ? `<img src="${data._engineerSignature}" alt="Engineer Signature" class="signature-img">` : ''}
                            </div>
                            <div style="margin-top: 3px; font-size: 9pt;">
                                <strong>Tên Kỹ sư / Engineer Name:</strong><br>
                                ${highlight(data.engineerName || '')}
                            </div>
                            <div style="margin-top: 3px; font-size: 9pt;">
                                <strong>Chức vụ / Role:</strong><br>
                                ${highlight(data.engineerRole || 'Kỹ sư / Engineer')}
                            </div>
                        </div>`;
            
            // QC Signature
            content += `
                        <div style="flex: 1; min-width: 300px;">
                            <div><strong>Ký xác nhận của QC / QC Signature:</strong></div>
                            <div class="signature-container">
                                ${data._qcSignature ? `<img src="${data._qcSignature}" alt="QC Signature" class="signature-img">` : ''}
                            </div>
                            <div style="margin-top: 3px; font-size: 9pt;">
                                <strong>Tên QA / QC Name:</strong><br>
                                ${highlight(data.qcName || '')}
                            </div>
                            <div style="margin-top: 3px; font-size: 9pt;">
                                <strong>Chức vụ / Role:</strong><br>
                                ${highlight(data.qcRole || 'QA')}
                            </div>
                        </div>`;
            
            // Additional Signatures from additionalSigners array
            additionalSigners.forEach((signer, index) => {
                const signerSignature = localStorage.getItem(`signature_${signer.id}`);
                const signerName = localStorage.getItem(`signer_${signer.id}_name`) || '';
                const signerRole = localStorage.getItem(`signer_${signer.id}_role`) || '';
                
                if (signerSignature || signerName || signerRole) {
                    content += `
                        <div style="flex: 1; min-width: 300px;">
                            <div><strong>Chữ ký ${index + 1} / Signature ${index + 1}:</strong></div>
                            <div class="signature-container">
                                ${signerSignature ? `<img src="${signerSignature}" alt="Additional Signature" class="signature-img">` : ''}
                            </div>
                            <div style="margin-top: 3px; font-size: 9pt;">
                                <strong>Họ tên / Full Name:</strong><br>
                                ${highlight(signerName)}
                            </div>
                            <div style="margin-top: 3px; font-size: 9pt;">
                                <strong>Chức vụ / Role:</strong><br>
                                ${highlight(signerRole)}
                            </div>
                        </div>`;
                }
            });
            
            content += `
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div style="text-align: center; margin-top: 15px; color: #666; font-size: 8pt; padding-top: 10px; border-top: 1px solid #ddd;">
                <p>NPI Record - TNEMS</p>
                <p>© 2025 - BẢN ĐIỆN TỬ</p>
                <p>Generated: ${new Date().toLocaleString('vi-VN')}</p>
            </div>`;
            
            return content;
        }

        // ========== CÁC HÀM HỖ TRỢ KHÁC ==========
        function validateForm() {
            const model = document.getElementById('model').value.trim();
            const customer = document.getElementById('customer').value.trim();
            
            if (!model) {
                document.getElementById('model').classList.add('validation-error');
                return false;
            } else {
                document.getElementById('model').classList.remove('validation-error');
            }
            
            if (!customer) {
                document.getElementById('customer').classList.add('validation-error');
                return false;
            } else {
                document.getElementById('customer').classList.remove('validation-error');
            }
            
            return true;
        }

        function updateStatus(text, status) {
            const statusEl = document.getElementById("cloudStatus");
            const textEl = document.getElementById("cloudStatusText");
            
            if (statusEl) statusEl.className = `status-indicator ${status}`;
            if (textEl) textEl.textContent = text;
        }

        function resetForm() {
            if (confirm("Bạn có chắc muốn làm mới toàn bộ form? Dữ liệu chưa lưu sẽ bị mất.")) {
                document.querySelectorAll("input, textarea, select").forEach(element => {
                    if (element.type === "checkbox") {
                        element.checked = false;
                    } else if (element.type === "select-one") {
                        element.value = "";
                    } else {
                        element.value = "";
                    }
                    updateHighlight(element);
                });
                
                // Reset signatures
                if (engineerSignaturePad) engineerSignaturePad.clear();
                if (qcSignaturePad) qcSignaturePad.clear();
                document.getElementById("engineerSignatureDisplay").innerHTML = `
                    <div style="padding: 15px; text-align: center; color: #888;">
                        <i class="fas fa-signature" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                        Chữ ký sẽ hiển thị ở đây sau khi lưu
                    </div>`;
                document.getElementById("qcSignatureDisplay").innerHTML = `
                    <div style="padding: 15px; text-align: center; color: #888;">
                        <i class="fas fa-signature" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                        Chữ ký sẽ hiển thị ở đây sau khi lưu
                    </div>`;
                localStorage.removeItem("engineer_signature");
                localStorage.removeItem("qc_signature");
                
                // Reset additional signers
                document.querySelectorAll('.signature-section[data-signer-id]').forEach(section => {
                    section.remove();
                });
                additionalSigners = [];
                signaturePads = {};
                
                showToast("✅ Đã làm mới form!", "success");
            }
        }

        function printForm() {
            window.print();
        }

        // ========== XỬ LÝ UPLOAD HÌNH ẢNH LABEL ==========
        function setupLabelImageUpload() {
            const uploadArea = document.getElementById('packLabelUploadArea');
            const uploadInput = document.getElementById('packLabelImageInput');
            const uploadBtn = document.getElementById('packLabelUploadBtn');
            const clearBtn = document.getElementById('packLabelClearBtn');
            const preview = document.getElementById('packLabelImagePreview');
            const placeholder = document.getElementById('packLabelUploadPlaceholder');
            
            if (!uploadArea || !uploadInput) return;
            
            // Click to upload
            uploadArea.addEventListener('click', () => uploadInput.click());
            uploadBtn.addEventListener('click', () => uploadInput.click());
            
            // File input change
            uploadInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                handleLabelImageUpload(file, preview, placeholder);
            });
            
            // Clear button
            clearBtn.addEventListener('click', function() {
                clearLabelImage(preview, placeholder);
            });
            
            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = '#4CAF50';
                uploadArea.style.background = '#E8F5E9';
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = '#2196F3';
                uploadArea.style.background = '#f8fdff';
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.style.borderColor = '#2196F3';
                uploadArea.style.background = '#f8fdff';
                
                const file = e.dataTransfer.files[0];
                if (file && file.type.match('image.*')) {
                    handleLabelImageUpload(file, preview, placeholder);
                } else {
                    showToast('❌ Vui lòng chọn file ảnh hợp lệ', 'error');
                }
            });
            
            // Load saved image from localStorage
            loadSavedLabelImage();
        }

        function handleLabelImageUpload(file, preview, placeholder) {
            if (!file || !file.type.match('image.*')) {
                showToast('❌ Vui lòng chọn file ảnh hợp lệ', 'error');
                return;
            }
            
            if (file.size > 2 * 1024 * 1024) {
                showToast('❌ File ảnh quá lớn (tối đa 2MB)', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                
                // Show preview
                preview.src = imageData;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
                
                // Thêm class highlight cho upload area
                document.getElementById('packLabelUploadArea').classList.add('label-has-image');
                
                // Thêm class highlight cho dòng trong bảng
                const labelRow = document.getElementById('packLabelTable').querySelector('tr:nth-child(2)');
                if (labelRow) {
                    labelRow.classList.add('row-has-label-image');
                    labelRow.classList.add('highlight-row');
                }
                
                // Save to localStorage
                localStorage.setItem('pack_label_image', imageData);
                
                // Save to cloud if in project
                if (currentProjectId && database) {
                    database.ref(`projects/${currentProjectId}/data/_packLabelImage`).set(imageData);
                }
                
                showToast('✅ Đã tải ảnh label lên', 'success');
            };
            
            reader.readAsDataURL(file);
        }

        function clearLabelImage(preview, placeholder) {
            preview.src = '';
            preview.style.display = 'none';
            placeholder.style.display = 'block';
            
            // Xóa class highlight
            document.getElementById('packLabelUploadArea').classList.remove('label-has-image');
            
            // Xóa class highlight cho dòng
            const labelRow = document.getElementById('packLabelTable').querySelector('tr:nth-child(2)');
            if (labelRow) {
                labelRow.classList.remove('row-has-label-image');
                labelRow.classList.remove('highlight-row');
            }
            
            // Clear from localStorage
            localStorage.removeItem('pack_label_image');
            
            // Clear from cloud
            if (currentProjectId && database) {
                database.ref(`projects/${currentProjectId}/data/_packLabelImage`).remove();
            }
            
            // Clear file input
            document.getElementById('packLabelImageInput').value = '';
            
            showToast('Đã xóa ảnh label', 'info');
        }

        function loadSavedLabelImage() {
            const savedImage = localStorage.getItem('pack_label_image');
            if (savedImage) {
                const preview = document.getElementById('packLabelImagePreview');
                const placeholder = document.getElementById('packLabelUploadPlaceholder');
                
                if (preview && placeholder) {
                    preview.src = savedImage;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                    
                    // Thêm class highlight
                    document.getElementById('packLabelUploadArea').classList.add('label-has-image');
                    
                    // Thêm class highlight cho dòng
                    const labelRow = document.getElementById('packLabelTable').querySelector('tr:nth-child(2)');
                    if (labelRow) {
                        labelRow.classList.add('row-has-label-image');
                        labelRow.classList.add('highlight-row');
                    }
                }
            }
        }

        // Load from cloud
        function loadLabelImageFromCloud(data) {
            if (data._packLabelImage) {
                localStorage.setItem('pack_label_image', data._packLabelImage);
                const preview = document.getElementById('packLabelImagePreview');
                const placeholder = document.getElementById('packLabelUploadPlaceholder');
                
                if (preview && placeholder) {
                    preview.src = data._packLabelImage;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';
                    
                    // Thêm class highlight
                    document.getElementById('packLabelUploadArea').classList.add('label-has-image');
                    
                    // Thêm class highlight cho dòng
                    const labelRow = document.getElementById('packLabelTable').querySelector('tr:nth-child(2)');
                    if (labelRow) {
                        labelRow.classList.add('row-has-label-image');
                        labelRow.classList.add('highlight-row');
                    }
                }
            }
        }

        // ========== KHỞI TẠO ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Khởi tạo user
            initUser();
            
            // Khởi tạo signature pads
            setupSignaturePads();
            
            // Setup real-time input
            setupRealTimeInput();
            
            // Setup label image upload
            setupLabelImageUpload();
            
            // Setup process tabs
            document.querySelectorAll('.process-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Remove active class from all tabs
                    document.querySelectorAll('.process-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Hide all process contents
                    document.querySelectorAll('.process-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Show selected process content
                    document.getElementById(tabId + '-process').classList.add('active');
                });
            });
            
            // Setup button events
            document.getElementById('projectAction').addEventListener('click', handleProjectAction);
            document.getElementById('saveToCloud').addEventListener('click', saveAllToCloud);
            document.getElementById('shareForm').addEventListener('click', generateShareLink);
            document.getElementById('exportPdf').addEventListener('click', exportToPDF);
            document.getElementById('resetForm').addEventListener('click', resetForm);
            document.getElementById('printForm').addEventListener('click', printForm);
            document.getElementById('copyLinkBtn').addEventListener('click', copyShareLink);
            document.getElementById('closeShareBtn').addEventListener('click', hideShareLink);
            
            // Setup project ID copy
            document.getElementById('projectIdDisplay').addEventListener('click', function() {
                const projectId = this.textContent.replace('ID: ', '');
                if (projectId && projectId !== 'Chưa có project') {
                    navigator.clipboard.writeText(projectId).then(() => {
                        showToast("✅ Đã copy Project ID!", "success");
                    });
                }
            });
            
            // Auto-set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            
            // Check URL for project ID
            const urlParams = new URLSearchParams(window.location.search);
            const projectIdFromUrl = urlParams.get('project');
            if (projectIdFromUrl && database) {
                showLoading("Đang tham gia project từ link...");
                setTimeout(() => {
                    joinProjectFromUrl(projectIdFromUrl);
                }, 1000);
            }
            
            // Setup defect rate calculation
            document.getElementById('totalQty').addEventListener('input', calculateDefectRate);
            document.getElementById('ngQty').addEventListener('input', calculateDefectRate);
            document.getElementById('okQty').addEventListener('input', calculateDefectRate);
        });

        async function joinProjectFromUrl(projectId) {
            try {
                const snapshot = await database.ref(`projects/${projectId}`).once("value");
                
                if (!snapshot.exists()) {
                    showToast("❌ Project từ link không tồn tại!", "error");
                    hideLoading();
                    return;
                }
                
                currentProjectId = projectId;
                if (!currentUser) initUser();
                
                await database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).set({
                    ...currentUser,
                    online: true,
                    lastActive: Date.now()
                });
                
                updateUrlWithProjectId();
                document.getElementById("projectIdDisplay").textContent = `ID: ${currentProjectId}`;
                document.getElementById("projectIdDisplay").title = "Click để copy ID";
                document.getElementById("onlineUsersContainer").style.display = "block";
                
                setupRealtimeListeners();
                loadProjectData();
                
                showToast(`✅ Đã tham gia project từ link!`, "success");
                updateStatus("Đang đồng bộ thời gian thực", "online");
                
            } catch (error) {
                console.error("Lỗi tham gia project từ link:", error);
                showToast("❌ Lỗi tham gia project từ link", "error");
            } finally {
                hideLoading();
            }
        }
    </script>
</body>
</html>