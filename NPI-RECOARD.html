<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPI Record - Multi-User Real-time</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #000;
            line-height: 1.2;
            padding: 10px;
            margin: 0;
            font-size: 11px;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .form-content {
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }
        
        .header h1 {
            color: #000;
            margin-bottom: 5px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .form-section {
            margin-bottom: 20px;
            border: 1px solid #000;
            border-radius: 2px;
            padding: 10px;
            background-color: #fff;
            page-break-inside: avoid;
        }
        
        .section-title {
            background-color: #e0e0e0;
            color: #000;
            padding: 8px 10px;
            margin: -10px -10px 10px -10px;
            border-bottom: 1px solid #000;
            font-size: 14px;
            font-weight: bold;
        }
        
        .sub-section-title {
            background-color: #f0f0f0;
            color: #000;
            padding: 6px 8px;
            margin: 10px -10px;
            border-top: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            font-size: 13px;
            font-weight: bold;
        }
        
        .form-row {
            display: flex;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .form-group {
            flex: 1;
            min-width: 180px;
            margin-bottom: 8px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #000;
            font-size: 11px;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 5px 8px;
            border: 1px solid #999;
            border-radius: 3px;
            font-size: 11px;
            background-color: white;
            transition: all 0.3s ease;
        }
        
        .form-group textarea {
            min-height: 70px;
            resize: vertical;
            overflow-y: auto;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 8px;
            padding: 8px 0;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
        }
        
        .checkbox-item input {
            margin-right: 6px;
        }
        
        .signature-container {
            border: 1px solid #999;
            border-radius: 3px;
            padding: 8px;
            margin-top: 8px;
            background-color: white;
        }
        
        .signature-pad {
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 100%;
            height: 120px;
            cursor: crosshair;
        }
        
        .signature-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .signature-controls button {
            padding: 6px 12px;
            background-color: #4a6fa5;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .signature-controls button:hover {
            background-color: #3a5a8a;
        }
        
        .signature-display {
            height: 80px;
            border: 1px dashed #999;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-style: italic;
            background-color: #f9f9f9;
        }
        
        .signature-display img {
            max-width: 100%;
            max-height: 100%;
        }
        
        .buttons-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 5px;
            position: sticky;
            top: 10px;
            z-index: 100;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            min-width: 160px;
        }
        
        .btn-primary {
            background-color: #4a6fa5;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #3a5a8a;
        }
        
        .btn-success {
            background-color: #2e7d32;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #1b5e20;
        }
        
        .btn-danger {
            background-color: #c62828;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #b71c1c;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            margin-bottom: 15px;
            font-size: 11px;
            table-layout: fixed;
        }
        
        th, td {
            border: 1px solid #000;
            padding: 6px;
            text-align: left;
            vertical-align: top;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        th {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
        }
        
        td.long-content-cell {
            min-height: 60px;
            height: auto;
        }
        
        .note {
            font-size: 10px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        .footer {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 11px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                padding: 0;
                margin: 0;
                background-color: white;
                font-size: 10pt;
            }
            
            .container {
                box-shadow: none;
                padding: 0;
                margin: 0;
                width: 100%;
            }
            
            .form-content {
                padding: 15mm;
            }
            
            .signature-display {
                border: 1px solid #000;
            }
            
            .buttons-container {
                display: none;
            }
            
            .form-section {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            table {
                page-break-inside: auto;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            td, th {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            td {
                overflow: visible !important;
                height: auto !important;
                max-height: none !important;
            }
        }
        
        .input-small {
            width: 100px;
            display: inline-block;
        }
        
        .input-medium {
            width: 180px;
            display: inline-block;
        }
        
        .form-group.full-width {
            flex: 0 0 100%;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        /* ========== HIGHLIGHT DỮ LIỆU ĐÃ NHẬP ========== */
        .form-input.has-data,
        .form-textarea.has-data,
        .form-select.has-data {
            color: #1565C0 !important;
            border-color: #1565C0 !important;
            background-color: #E3F2FD !important;
            font-weight: 600 !important;
            border-width: 2px !important;
        }
        
        .form-checkbox:checked + label {
            color: #1565C0 !important;
            font-weight: 700 !important;
        }
        
        .checkbox-item input:checked {
            accent-color: #1565C0;
        }
        
        .highlight-text {
            color: #1565C0 !important;
            font-weight: 600 !important;
            background-color: #E3F2FD !important;
            padding: 2px 4px;
            border-radius: 2px;
        }
        
        .signature-display.has-signature {
            border: 2px solid #1565C0;
            background-color: #E8F5E9;
        }
        
        /* ========== STYLE ĐẶC BIỆT ========== */
        input:focus, textarea:focus, select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(21, 101, 192, 0.2);
        }
        
        .highlight-row {
            background-color: #F5F9FF !important;
        }
        
        /* Cloud Status */
        .cloud-status {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cloud-status .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .online { background-color: #4CAF50; }
        .offline { background-color: #f44336; }
        .syncing { 
            background-color: #FF9800; 
            animation: pulse 1s infinite; 
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Online Users */
        .online-users {
            background: linear-gradient(135deg, #2196F3 0%, #21CBF3 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .users-list-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .users-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .user-badge .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .user-badge .user-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        .user-badge.editing {
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 0 2px currentColor;
        }
        
        /* Project Info */
        .project-info {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 10px;
        }
        
        #projectIdDisplay {
            font-family: monospace;
            cursor: pointer;
            padding: 2px 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }
        
        #projectIdDisplay:hover {
            background: rgba(255,255,255,0.5);
        }
        
        /* Field being edited by others */
        .field-being-edited {
            animation: fieldPulse 2s infinite;
            box-shadow: 0 0 0 2px #FF9800 !important;
            position: relative;
        }
        
        .field-being-edited::after {
            content: attr(data-editor);
            position: absolute;
            top: -20px;
            right: 0;
            background: #FF9800;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            white-space: nowrap;
            z-index: 1000;
        }
        
        @keyframes fieldPulse {
            0%, 100% { background-color: rgba(255, 152, 0, 0.1); }
            50% { background-color: rgba(255, 152, 0, 0.3); }
        }
        
        /* Real-time typing indicator */
        .typing-indicator {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #FF9800;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 11px;
            z-index: 9999;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            animation: slideInRight 0.3s;
        }
        
        .field-updated {
            animation: fieldUpdate 1s ease;
        }
        
        @keyframes fieldUpdate {
            0% { background-color: #E8F5E9; }
            50% { background-color: #C8E6C9; }
            100% { background-color: #E8F5E9; }
        }
        
        .share-link-container {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            display: none;
        }
        
        .share-link {
            word-break: break-all;
            background: white;
            padding: 8px;
            border-radius: 3px;
            margin-top: 5px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 12px;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a6fa5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: 500;
            z-index: 10001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }
        
        .toast-success {
            background: #4CAF50;
        }
        
        .toast-error {
            background: #f44336;
        }
        
        .toast-info {
            background: #2196F3;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Cloud Status Bar -->
    <div class="cloud-status no-print">
        <div>
            <span class="status-indicator offline" id="cloudStatus"></span>
            <span id="cloudStatusText">Chưa kết nối</span>
        </div>
        <div id="userCount" style="display: flex; align-items: center; gap: 5px;">
            <i class="fas fa-users"></i>
            <span>Chưa có project</span>
        </div>
    </div>

    <!-- Online Users -->
    <div class="online-users no-print" id="onlineUsersContainer" style="display: none;">
        <div class="users-list-title">
            <i class="fas fa-users"></i> 
            <span id="onlineUsersCount">0 người online</span>
            <span class="project-info">
                <i class="fas fa-project-diagram"></i>
                <span id="projectIdDisplay" title="Click để copy ID">ID: Chưa có project</span>
            </span>
        </div>
        <div class="users-list" id="usersList"></div>
    </div>

    <!-- Share Link Container -->
    <div class="share-link-container no-print" id="shareLinkContainer">
        <strong><i class="fas fa-share-alt"></i> LINK CHIA SẺ:</strong>
        <div class="share-link" id="shareLinkText"></div>
        <div style="margin-top: 10px;">
            <button id="copyLinkBtn" style="padding: 5px 10px; background: #4a6fa5; color: white; border: none; border-radius: 3px; cursor: pointer;">
                <i class="fas fa-copy"></i> Copy Link
            </button>
            <button id="closeShareBtn" style="margin-left: 10px; padding: 5px 10px; background: #666; color: white; border: none; border-radius: 3px; cursor: pointer;">
                <i class="fas fa-times"></i> Đóng
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div id="loadingMessage">Đang xử lý...</div>
        </div>
    </div>

    <!-- Buttons for actions -->
    <div class="buttons-container no-print">
        <button type="button" class="btn btn-primary" id="projectAction">
            <i class="fas fa-users"></i> Tạo/Tham gia Project
        </button>
        <button type="button" class="btn btn-success" id="saveToCloud">
            <i class="fas fa-cloud-upload-alt"></i> Lưu lên Cloud
        </button>
        <button type="button" class="btn btn-primary" id="shareForm">
            <i class="fas fa-share-alt"></i> Chia sẻ
        </button>
        <button type="button" class="btn btn-success" id="exportPdf">
            <i class="fas fa-file-pdf"></i> Xuất PDF
        </button>
        <button type="button" class="btn btn-danger" id="resetForm">
            <i class="fas fa-redo"></i> Làm mới
        </button>
        <button type="button" class="btn btn-primary" id="printForm">
            <i class="fas fa-print"></i> In trực tiếp
        </button>
    </div>

    <!-- Main form container -->
    <div class="container" id="main-form">
        <div class="form-content">
            <!-- Header -->
            <div class="header">
                <h1>BIỂU GHI NPI - NPI RECORD</h1>
                <div style="font-size: 12px; margin-top: 5px;">TNEMS-EN-F-048-NPI RECORD-VER03</div>
            </div>
            
            <!-- Product Information Section -->
            <div class="form-section" id="section-product-info">
                <div class="section-title">THÔNG TIN SẢN PHẨM - PRODUCT INFORMATION</div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="model">MÃ HÀNG / MODEL: <span class="required" style="color: red;">*</span></label>
                        <input type="text" id="model" placeholder="Nhập mã hàng/model" class="form-input required-field">
                    </div>
                    
                    <div class="form-group">
                        <label for="customer">KHÁCH HÀNG / CUSTOMER: <span class="required" style="color: red;">*</span></label>
                        <input type="text" id="customer" placeholder="Nhập tên khách hàng" class="form-input required-field">
                    </div>
                    
                    <div class="form-group">
                        <label for="partNo">Part No:</label>
                        <input type="text" id="partNo" placeholder="Nhập Part No" class="form-input">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label>Quy trình / Process:</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="processSMT" value="SMT" class="form-checkbox">
                                <label for="processSMT">SMT</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="processThroughHole" value="THROUGH HOLE" class="form-checkbox">
                                <label for="processThroughHole">THROUGH HOLE</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="processCoating" value="COATING" class="form-checkbox">
                                <label for="processCoating">COATING</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="processBoxbuild" value="BOXBUILD" class="form-checkbox">
                                <label for="processBoxbuild">BOXBUILD</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="processPacking" value="PACKING" class="form-checkbox">
                                <label for="processPacking">PACKING</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="flex: 1;">
                        <label for="date">Ngày / Date:</label>
                        <input type="date" id="date" value="" class="form-input">
                    </div>
                </div>
            </div>

            <!-- SMT Section -->
            <div class="form-section" id="section-smt">
                <div class="section-title">SMT PROCESS</div>
                
                <!-- LASER MARKING -->
                <div class="sub-section-title">LASER MARKING</div>
                <table>
                    <tr>
                        <th width="30%">NỘI DUNG</th>
                        <th width="70%">GIÁ TRỊ</th>
                    </tr>
                    <tr>
                        <td>Tên chương trình/ Program name</td>
                        <td>
                            <input type="text" id="laserProgram" placeholder="Nhập tên chương trình" style="width: 100%;" class="form-input">
                        </td>
                    </tr>
                    <tr>
                        <td>Loại QR code/ QR code type</td>
                        <td>
                            <input type="text" id="qrType" placeholder="Nhập loại QR code" style="width: 100%;" class="form-input">
                        </td>
                    </tr>
                    <tr>
                        <td>Kích thước QR code/ QR code size</td>
                        <td>
                            <input type="text" id="qrSize" placeholder="Nhập kích thước QR code" style="width: 100%;" class="form-input">
                        </td>
                    </tr>
                    <tr>
                        <td>Cường độ khắc/ Engraving intensity</td>
                        <td>
                            <input type="text" id="engravingIntensity" placeholder="Nhập cường độ khắc" style="width: 100%;" class="form-input">
                        </td>
                    </tr>
                    <tr>
                        <td>Side BOT: Nội dung QR code/ QR code content</td>
                        <td class="long-content-cell">
                            <textarea id="qrContentBot" placeholder="Nhập nội dung QR code mặt BOT" rows="3" style="width: 100%;" class="form-textarea long-content"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td>Side TOP: Nội dung QR code/ QR code content</td>
                        <td class="long-content-cell">
                            <textarea id="qrContentTop" placeholder="Nhập nội dung QR code mặt TOP" rows="3" style="width: 100%;" class="form-textarea long-content"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td>Nội dung QR code khi quét bằng máy</td>
                        <td class="long-content-cell">
                            <textarea id="qrScanContent" placeholder="Nhập nội dung khi quét QR" rows="3" style="width: 100%;" class="form-textarea long-content"></textarea>
                        </td>
                    </tr>
                </table>
                
                <!-- PRINTER -->
                <div class="sub-section-title">PRINTER</div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <input type="text" id="printerControl" placeholder="Ghi chú về printer" value="Theo Process control sheet đính kèm/According to the attached Process Control Sheet" style="width: 100%;" class="form-input">
                    </div>
                </div>
                
                <!-- MOUNTER -->
                <div class="sub-section-title">MOUNTER</div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <input type="text" id="mounterControl" placeholder="Ghi chú về mounter" value="Theo Process control sheet đính kèm (có xác nhận và đo giá trị của các bên)/According to the attached Process Control Sheet" style="width: 100%;" class="form-input">
                    </div>
                </div>
                
                <!-- VISUAL INSPECTION 1 -->
                <div class="sub-section-title">NGOẠI QUAN VISUAL INSPECTION</div>
                <table>
                    <tr>
                        <th width="40%">HƯỚNG LINH KIỆN/COMPONENT POLARITY</th>
                        <th width="30%">SỐ LƯỢNG LINH KIỆN/COMPONENT QUANTITY</th>
                        <th width="15%">KẾT QUẢ/RESULT</th>
                        <th width="15%">XÁC NHẬN/VERIFY</th>
                    </tr>
                    <tr>
                        <td>Theo bảng hướng linh kiện đính kèm (QC)</td>
                        <td>
                            <div>Theo BOM/ According to the BOM: 
                                <input type="text" id="bomQty" class="input-small form-input" placeholder="Số lượng">
                            </div>
                            <div style="margin-top: 5px;">Thực tế/ Reality: 
                                <input type="text" id="actualQty" class="input-small form-input" placeholder="Số lượng">
                            </div>
                        </td>
                        <td style="text-align: center;">
                            <select id="visualResult1" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                        <td style="text-align: center;">
                            <div>ENG: 
                                <input type="text" id="engVerify1" class="input-medium form-input" placeholder="Tên">
                            </div>
                            <div style="margin-top: 2px;">QC: 
                                <input type="text" id="qcVerify1" class="input-medium form-input" placeholder="Tên">
                            </div>
                        </td>
                    </tr>
                </table>
            </div>

            <!-- REFLOW OVEN Section -->
            <div class="form-section" id="section-reflow">
                <div class="sub-section-title">LÒ REFLOW/REFLOW OVEN</div>
                <table>
                    <tr>
                        <th width="30%">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                        <th width="40%">THÔNG SỐ CÀI ĐẶT MÁY/MACHINE PARAMETERS SETTING</th>
                        <th width="15%">KẾT QUẢ/RESULT</th>
                        <th width="15%">XÁC NHẬN/VERIFY</th>
                    </tr>
                    <tr>
                        <td>
                            - Theo Process control sheet đính kèm<br>
                            - Profile lò đính kèm
                        </td>
                        <td class="long-content-cell">
                            <textarea id="reflowParams" placeholder="Thông số cài đặt" rows="4" style="width: 100%;" class="form-textarea long-content"></textarea>
                        </td>
                        <td style="text-align: center;">
                            <select id="reflowResult" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                        <td style="text-align: center;">
                            <div>ENG: 
                                <input type="text" id="reflowEng" class="input-medium form-input" placeholder="Tên">
                            </div>
                            <div style="margin-top: 2px;">QC: 
                                <input type="text" id="reflowQc" class="input-medium form-input" placeholder="Tên">
                            </div>
                        </td>
                    </tr>
                </table>
                
                <!-- AOI -->
                <div class="sub-section-title">AOI/AUTOMATED OPTICAL INSPECTION</div>
                <table>
                    <tr>
                        <th width="30%">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                        <th width="25%">SỐ LƯỢNG PCBA ĐÃ AOI/PCBA AOI INSPECTED QUANTITY</th>
                        <th width="15%">KẾT QUẢ/RESULT</th>
                        <th width="30%">XÁC NHẬN/VERIFY</th>
                    </tr>
                    <tr>
                        <td>
                            <div>BOT: 
                                <input type="text" id="aoiProgramBot" class="input-medium form-input" placeholder="Tên chương trình">
                            </div>
                            <div style="margin-top: 5px;">TOP: 
                                <input type="text" id="aoiProgramTop" class="input-medium form-input" placeholder="Tên chương trình">
                            </div>
                        </td>
                        <td>
                            <input type="text" id="aoiQty" class="input-small form-input" placeholder="Số lượng" style="width: 100%;">
                        </td>
                        <td style="text-align: center;">
                            <select id="aoiResult" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                        <td style="text-align: center;">
                            <div>ENG: 
                                <input type="text" id="aoiEng" class="input-medium form-input" placeholder="Tên">
                            </div>
                            <div style="margin-top: 2px;">QC: 
                                <input type="text" id="aoiQc" class="input-medium form-input" placeholder="Tên">
                            </div>
                        </td>
                    </tr>
                </table>
                
                <!-- FLYING PROBE -->
                <div class="sub-section-title">FLYING PROBE (20%)</div>
                <table>
                    <tr>
                        <th width="30%">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                        <th width="25%">SỐ LƯỢNG ĐÃ ĐO/MEASURED QUANTITY</th>
                        <th width="15%">KẾT QUẢ/RESULT</th>
                        <th width="30%">XÁC NHẬN/VERIFY</th>
                    </tr>
                    <tr>
                        <td>
                            <div>BOT: 
                                <input type="text" id="probeProgramBot" class="input-medium form-input" placeholder="Tên chương trình">
                            </div>
                            <div style="margin-top: 5px;">TOP: 
                                <input type="text" id="probeProgramTop" class="input-medium form-input" placeholder="Tên chương trình">
                            </div>
                        </td>
                        <td>
                            <input type="text" id="probeQty" class="input-small form-input" placeholder="Số lượng" style="width: 100%;">
                        </td>
                        <td style="text-align: center;">
                            <select id="probeResult" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                        <td style="text-align: center;">
                            <div>ENG: 
                                <input type="text" id="probeEng" class="input-medium form-input" placeholder="Tên">
                            </div>
                            <div style="margin-top: 2px;">QC: 
                                <input type="text" id="probeQc" class="input-medium form-input" placeholder="Tên">
                            </div>
                        </td>
                    </tr>
                </table>
                
                <!-- VISUAL INSPECTION 2 -->
                <div class="sub-section-title">NGOẠI QUAN VISUAL INSPECTION</div>
                <div class="note" style="margin-bottom: 10px;">
                    KIỂM TRA SỐ LƯỢNG LINH KIỆN, CHẤT LƯỢNG MỐI HÀN, HƯỚNG LINH KIỆN, CÁC LỖI ĐÁNH GIÁ THEO IPC
                </div>
                <table>
                    <tr>
                        <th width="40%">NỘI DUNG KIỂM TRA</th>
                        <th width="30%">KẾT QUẢ</th>
                        <th width="30%">XÁC NHẬN/VERIFY</th>
                    </tr>
                    <tr>
                        <td>- Số lượng linh kiện/ Component Quantity</td>
                        <td style="text-align: center;">
                            <select id="visual2Result1" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                        <td rowspan="4" style="text-align: center; vertical-align: middle;">
                            <div>ENG: 
                                <input type="text" id="visual2Eng" class="input-medium form-input" placeholder="Tên">
                            </div>
                            <div style="margin-top: 10px;">QC: 
                                <input type="text" id="visual2Qc" class="input-medium form-input" placeholder="Tên">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>- Chất lượng mối hàn/ Solder Joint Quality</td>
                        <td style="text-align: center;">
                            <select id="visual2Result2" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>- Hướng linh kiện/ Component Orientation</td>
                        <td style="text-align: center;">
                            <select id="visual2Result3" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>- Các lỗi đánh giá theo IPC/ Defects Evaluated per IPC</td>
                        <td style="text-align: center;">
                            <select id="visual2Result4" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                    </tr>
                </table>
            </div>

            <!-- THROUGH-HOLE Section -->
            <div class="form-section" id="section-through-hole">
                <div class="section-title">THROUGH-HOLE PROCESS</div>
                
                <div class="sub-section-title">QUY TRÌNH HÀN TAY/HAND SOLDERING PROCESS</div>
                <table>
                    <tr>
                        <th width="40%">THÔNG SỐ/ PARAMETERS</th>
                        <th width="30%">GIÁ TRỊ/ VALUE</th>
                        <th width="15%">KẾT QUẢ/RESULT</th>
                        <th width="15%">XÁC NHẬN/VERIFY</th>
                    </tr>
                    <tr>
                        <td>Nhiệt độ mỏ hàn/ Soldering iron temperature</td>
                        <td>
                            <input type="text" id="solderTemp" placeholder="VD: 350°C" style="width: 100%;" class="form-input">
                        </td>
                        <td style="text-align: center;">
                            <select id="solderResult" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                        <td style="text-align: center;">
                            <div>ENG: 
                                <input type="text" id="solderEng" class="input-medium form-input" placeholder="Tên">
                            </div>
                            <div style="margin-top: 2px;">QC: 
                                <input type="text" id="solderQc" class="input-medium form-input" placeholder="Tên">
                            </div>
                        </td>
                    </tr>
                </table>
                
                <div class="sub-section-title">VISUAL INSPECTION</div>
                <div class="note" style="margin-bottom: 10px;">
                    KIỂM TRA CHẤT LƯỢNG MỐI HÀN THEO TIÊU CHUẨN IPC
                </div>
                <table>
                    <tr>
                        <th width="40%">TIÊU CHÍ/ CRITERIA</th>
                        <th width="30%">KẾT QUẢ/ RESULT</th>
                        <th width="30%">XÁC NHẬN/ VERIFY</th>
                    </tr>
                    <tr>
                        <td>- Chất lượng mối hàn/ Solder joint quality</td>
                        <td style="text-align: center;">
                            <select id="thVisual1" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                        <td rowspan="3" style="text-align: center; vertical-align: middle;">
                            <div>ENG: 
                                <input type="text" id="thEng" class="input-medium form-input" placeholder="Tên">
                            </div>
                            <div style="margin-top: 10px;">QC: 
                                <input type="text" id="thQc" class="input-medium form-input" placeholder="Tên">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>- Độ ướt chân/ Wetting</td>
                        <td style="text-align: center;">
                            <select id="thVisual2" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>- Không có cầu chì/ No solder bridges</td>
                        <td style="text-align: center;">
                            <select id="thVisual3" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                    </tr>
                </table>
            </div>

            <!-- CONCLUSION Section -->
            <div class="form-section" id="section-conclusion">
                <div class="section-title">KẾT LUẬN/ CONCLUSION</div>
                
                <table>
                    <tr>
                        <th width="20%">KẾT QUẢ CUỐI CÙNG/FINAL RESULT</th>
                        <th width="25%">RỦI RO TRONG CÁC CÔNG ĐOẠN/RISKS IN EACH PROCESS STEP</th>
                        <th width="25%">BÀI HỌC TỪNG CÔNG ĐOẠN/LESSONS LEARNED FROM EACH PROCESS STEP</th>
                        <th width="30%">CẢI TIẾN CÔNG ĐOẠN/PROCESS IMPROVEMENT</th>
                    </tr>
                    <tr>
                        <td style="text-align: center; vertical-align: middle;" class="conclusion-cell">
                            <select id="finalResult" style="width: 90%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="PASS">PASS</option>
                                <option value="FAIL">FAIL</option>
                                <option value="CONDITIONAL">CONDITIONAL PASS</option>
                            </select>
                        </td>
                        <td class="conclusion-cell long-content-cell">
                            <textarea id="processRisks" placeholder="Rủi ro trong các công đoạn" rows="8" style="width: 100%; height: auto; min-height: 120px;" class="form-textarea long-content"></textarea>
                        </td>
                        <td class="conclusion-cell long-content-cell">
                            <textarea id="lessonsLearned" placeholder="Bài học từng công đoạn" rows="8" style="width: 100%; height: auto; min-height: 120px;" class="form-textarea long-content"></textarea>
                        </td>
                        <td class="conclusion-cell long-content-cell">
                            <textarea id="processImprovement" placeholder="Cải tiến công đoạn" rows="8" style="width: 100%; height: auto; min-height: 120px;" class="form-textarea long-content"></textarea>
                        </td>
                    </tr>
                </table>
                
                <div class="form-row" style="margin-top: 15px;">
                    <div class="form-group">
                        <label for="totalQty">Tổng số lượng (PCBA): <br>Total qty (PCBA):</label>
                        <input type="number" id="totalQty" placeholder="Nhập tổng số lượng" class="form-input" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="okQty">OK :</label>
                        <input type="number" id="okQty" placeholder="Nhập số lượng OK" class="form-input" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="ngQty">NG (scrap) :</label>
                        <input type="number" id="ngQty" placeholder="Nhập số lượng NG" class="form-input" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="defectRate">Tỷ lệ lỗi/ Defect rate (%) : <br> (NG/Total)</label>
                        <input type="text" id="defectRate" placeholder="Tự động tính toán" readonly style="background-color: #f0f0f0;" class="form-input">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="defectDescription">Mô tả chi tiết lỗi / detailed defect description:</label>
                        <textarea id="defectDescription" placeholder="Mô tả chi tiết các lỗi" rows="4" style="width: 100%;" class="form-textarea long-content"></textarea>
                    </div>
                </div>
                
                <!-- Electronic Signatures -->
                <div class="sub-section-title">XÁC NHẬN ĐIỆN TỬ - ELECTRONIC SIGNATURES</div>
                <div class="two-column" style="margin-top: 10px;">
                    <div class="signature-section">
                        <label>Ký xác nhận của Kỹ sư / Engineer Signature:</label>
                        <div class="signature-container">
                            <canvas id="engineerSignature" class="signature-pad no-export"></canvas>
                            <div class="signature-controls no-print no-export">
                                <button type="button" id="clearEngineerSignature">Xóa chữ ký</button>
                                <button type="button" id="saveEngineerSignature">Lưu chữ ký</button>
                            </div>
                            <div class="signature-display" id="engineerSignatureDisplay">
                                <div style="padding: 10px; text-align: center;">Chữ ký sẽ hiển thị ở đây sau khi lưu</div>
                            </div>
                        </div>
                        <div style="margin-top: 5px;">
                            <label for="engineerName" class="inline-label">Tên Kỹ sư / Engineer Name:</label>
                            <input type="text" id="engineerName" placeholder="Nhập tên kỹ sư" style="width: 200px;" class="form-input">
                        </div>
                    </div>
                    
                    <div class="signature-section">
                        <label>Ký xác nhận của QC / QC Signature:</label>
                        <div class="signature-container">
                            <canvas id="qcSignature" class="signature-pad no-export"></canvas>
                            <div class="signature-controls no-print no-export">
                                <button type="button" id="clearQcSignature">Xóa chữ ký</button>
                                <button type="button" id="saveQcSignature">Lưu chữ ký</button>
                            </div>
                            <div class="signature-display" id="qcSignatureDisplay">
                                <div style="padding: 10px; text-align: center;">Chữ ký sẽ hiển thị ở đây sau khi lưu</div>
                            </div>
                        </div>
                        <div style="margin-top: 5px;">
                            <label for="qcName" class="inline-label">Tên QC / QC Name:</label>
                            <input type="text" id="qcName" placeholder="Nhập tên QC" style="width: 200px;" class="form-input">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="footer">
                <p>NPI Record - Phiên bản Multi-User Real-time</p>
                <p>© 2024 - Đồng bộ thời gian thực với Firebase</p>
                <p style="font-size: 10px; color: #888;" id="dataInfo"></p>
            </div>
        </div>
    </div>

    <script>
        // ========== CẤU HÌNH FIREBASE - THAY THẾ BẰNG CỦA BẠN ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDtXBh4JBdUeLvzNKWp6VUNatdML871k8E",
            authDomain: "npi-record.firebaseapp.com",
            databaseURL: "https://npi-record-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "npi-record",
            storageBucket: "npi-record.firebasestorage.app",
            messagingSenderId: "615504087682",
            appId: "1:615504087682:web:5a1a78fd56ea4f9714429b"
        };

        // ========== BIẾN TOÀN CỤC ==========
        let app;
        let database;
        let currentProjectId = null;
        let currentUser = null;
        let users = {};
        let isSaving = false;
        let lastSavedData = {};
        let userTimeout = null;
        let engineerSignaturePad = null;
        let qcSignaturePad = null;

        // ========== KHỞI TẠO FIREBASE ==========
        try {
            if (!firebase.apps.length) {
                app = firebase.initializeApp(firebaseConfig);
            } else {
                app = firebase.app();
            }
            database = firebase.database();
            console.log("✅ Firebase đã khởi tạo");
        } catch (error) {
            console.error("❌ Lỗi khởi tạo Firebase:", error);
            showToast("Không thể kết nối đến server", "error");
        }

        // ========== HÀM HIỂN THỊ THÔNG BÁO ==========
        function showToast(message, type = "success") {
            const toast = document.createElement("div");
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === "success" ? "check-circle" : type === "error" ? "exclamation-triangle" : "info-circle"}"></i>
                ${message}
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function showLoading(message) {
            document.getElementById("loadingMessage").textContent = message;
            document.getElementById("loadingOverlay").style.display = "flex";
        }

        function hideLoading() {
            document.getElementById("loadingOverlay").style.display = "none";
        }

        // ========== KHỞI TẠO NGƯỜI DÙNG ==========
        function initUser() {
            let savedUser = localStorage.getItem("npi_user");
            
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                console.log("👤 Đã load user:", currentUser.name);
            } else {
                const names = ["Kỹ sư", "QC", "Quản lý", "Chuyên viên"];
                const randomName = names[Math.floor(Math.random() * names.length)] + " " + Math.floor(Math.random() * 100);
                
                const colors = ["#FF5722", "#2196F3", "#4CAF50", "#FF9800", "#9C27B0", "#009688"];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                currentUser = {
                    id: "user_" + Math.random().toString(36).substr(2, 9),
                    name: randomName,
                    color: randomColor,
                    online: true,
                    lastActive: Date.now(),
                    editingField: null
                };
                
                localStorage.setItem("npi_user", JSON.stringify(currentUser));
                console.log("👤 Đã tạo user mới:", currentUser.name);
            }
            
            updateUserBadge();
        }

        function updateUserBadge() {
            const userCountEl = document.getElementById("userCount");
            if (userCountEl && currentUser) {
                userCountEl.innerHTML = `
                    <i class="fas fa-user" style="color: ${currentUser.color}"></i>
                    <span>${currentUser.name}</span>
                    <button id="changeNameBtn" style="background: transparent; border: none; color: white; cursor: pointer; margin-left: 5px; font-size: 10px;" title="Đổi tên">
                        <i class="fas fa-edit"></i>
                    </button>
                `;
                
                document.getElementById("changeNameBtn")?.addEventListener("click", changeUserName);
            }
        }

        function changeUserName() {
            const newName = prompt("Nhập tên hiển thị mới:", currentUser.name);
            if (newName && newName.trim() && newName !== currentUser.name) {
                currentUser.name = newName.trim();
                localStorage.setItem("npi_user", JSON.stringify(currentUser));
                updateUserBadge();
                
                if (currentProjectId && database) {
                    database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).update({
                        name: currentUser.name,
                        lastActive: Date.now()
                    });
                }
                
                showToast(`✅ Đã đổi tên thành: ${currentUser.name}`, "success");
            }
        }

        // ========== TẠO/THAM GIA PROJECT ==========
        async function handleProjectAction() {
            if (!database) {
                showToast("Chưa kết nối được Firebase", "error");
                return;
            }
            
            if (currentProjectId) {
                const confirmLeave = confirm(`Bạn đang trong project: ${currentProjectId}\n\nMuốn rời đi để tạo/tham gia project khác?`);
                if (!confirmLeave) return;
                
                await leaveCurrentProject();
                currentProjectId = null;
                document.getElementById("onlineUsersContainer").style.display = "none";
                updateStatus("Đã rời project", "offline");
            }
            
            const action = confirm(`Chọn hành động:\n\n• OK: Tạo project MỚI\n• Cancel: Tham gia project CÓ SẴN`);
            
            if (action === true) {
                await createNewProject();
            } else {
                await joinExistingProject();
            }
        }

        async function leaveCurrentProject() {
            if (currentProjectId && currentUser && database) {
                try {
                    await database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).update({
                        online: false,
                        lastActive: Date.now(),
                        editingField: null
                    });
                } catch (error) {
                    console.error("Lỗi rời project:", error);
                }
            }
        }

        async function createNewProject() {
            showLoading("Đang tạo project mới...");
            
            try {
                currentProjectId = "npi_" + Date.now().toString(36) + "_" + Math.random().toString(36).substr(2, 3).toUpperCase();
                
                if (!currentUser) initUser();
                
                const initialData = collectFormData();
                initialData._metadata = {
                    created: new Date().toISOString(),
                    createdBy: currentUser.id,
                    version: 1
                };
                
                await database.ref(`projects/${currentProjectId}`).set({
                    data: initialData,
                    users: {
                        [currentUser.id]: {
                            ...currentUser,
                            online: true,
                            lastActive: Date.now()
                        }
                    },
                    metadata: {
                        created: new Date().toISOString(),
                        createdBy: currentUser.name,
                        projectName: `NPI-${new Date().toLocaleDateString("vi-VN")}`
                    }
                });
                
                updateUrlWithProjectId();
                document.getElementById("projectIdDisplay").textContent = `ID: ${currentProjectId}`;
                document.getElementById("projectIdDisplay").title = "Click để copy ID";
                document.getElementById("onlineUsersContainer").style.display = "block";
                
                setupRealtimeListeners();
                updateShareLink();
                
                showToast(`✅ Đã tạo project: ${currentProjectId}`, "success");
                updateStatus("Đang đồng bộ thời gian thực", "online");
                
            } catch (error) {
                console.error("Lỗi tạo project:", error);
                showToast("❌ Lỗi tạo project: " + error.message, "error");
            } finally {
                hideLoading();
            }
        }

        async function joinExistingProject() {
            const projectId = prompt("Nhập ID project muốn tham gia:");
            if (!projectId || !projectId.trim()) {
                showToast("❌ Chưa nhập ID project", "error");
                return;
            }
            
            showLoading(`Đang tham gia project ${projectId}...`);
            
            try {
                const snapshot = await database.ref(`projects/${projectId}`).once("value");
                
                if (!snapshot.exists()) {
                    showToast("❌ Project không tồn tại!", "error");
                    hideLoading();
                    return;
                }
                
                currentProjectId = projectId;
                if (!currentUser) initUser();
                
                await database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).set({
                    ...currentUser,
                    online: true,
                    lastActive: Date.now()
                });
                
                updateUrlWithProjectId();
                document.getElementById("projectIdDisplay").textContent = `ID: ${currentProjectId}`;
                document.getElementById("projectIdDisplay").title = "Click để copy ID";
                document.getElementById("onlineUsersContainer").style.display = "block";
                
                setupRealtimeListeners();
                loadProjectData();
                
                showToast(`✅ Đã tham gia project ${projectId}`, "success");
                updateStatus("Đang đồng bộ thời gian thực", "online");
                
            } catch (error) {
                console.error("Lỗi tham gia project:", error);
                showToast("❌ Lỗi tham gia project: " + error.message, "error");
            } finally {
                hideLoading();
            }
        }

        // ========== REALTIME LISTENERS ==========
        function setupRealtimeListeners() {
            if (!currentProjectId || !database) return;
            
            console.log("👂 Đang lắng nghe thay đổi từ server...");
            
            // 1. Lắng nghe thay đổi dữ liệu form - QUAN TRỌNG: Sửa chỗ này
            database.ref(`projects/${currentProjectId}/data`).on("value", (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    // Luôn cập nhật dữ liệu từ server
                    updateFormFromServer(data);
                }
            });
            
            // 2. Lắng nghe thay đổi danh sách user
            database.ref(`projects/${currentProjectId}/users`).on("value", (snapshot) => {
                if (snapshot.exists()) {
                    users = snapshot.val();
                    updateUsersDisplay();
                }
            });
            
            keepAlive();
            
            window.addEventListener("beforeunload", () => {
                if (currentProjectId && currentUser) {
                    database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).update({
                        online: false,
                        lastActive: Date.now(),
                        editingField: null
                    });
                }
            });
        }

        function keepAlive() {
            if (userTimeout) clearTimeout(userTimeout);
            
            userTimeout = setTimeout(() => {
                if (currentProjectId && currentUser && database) {
                    database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).update({
                        lastActive: Date.now(),
                        online: true
                    });
                    keepAlive();
                }
            }, 10000);
        }

        // ========== XỬ LÝ DỮ LIỆU FORM ==========
        function collectFormData() {
            const data = {};
            
            document.querySelectorAll("input, textarea, select").forEach(element => {
                if (element.id && element.id !== "") {
                    if (element.type === "checkbox") {
                        data[element.id] = element.checked;
                    } else if (element.type === "radio") {
                        if (element.checked) data[element.name] = element.value;
                    } else {
                        data[element.id] = element.value;
                    }
                }
            });
            
            const engineerSig = localStorage.getItem("engineer_signature");
            const qcSig = localStorage.getItem("qc_signature");
            if (engineerSig) data._engineerSignature = engineerSig;
            if (qcSig) data._qcSignature = qcSig;
            
            return data;
        }

        // ========== HÀM QUAN TRỌNG NHẤT: CẬP NHẬT TỪ SERVER ==========
        function updateFormFromServer(serverData) {
            if (isSaving) return; // Nếu đang lưu thì không cập nhật
            
            const formData = {...serverData};
            delete formData._metadata;
            delete formData._lastUpdated;
            delete formData._lastUpdatedBy;
            
            let changedCount = 0;
            
            Object.keys(formData).forEach(fieldId => {
                if (fieldId.startsWith("_")) {
                    if (fieldId === "_engineerSignature" && formData[fieldId]) {
                        localStorage.setItem("engineer_signature", formData[fieldId]);
                        const engDisplay = document.getElementById("engineerSignatureDisplay");
                        if (engDisplay) {
                            engDisplay.innerHTML = `<img src="${formData[fieldId]}" alt="Engineer Signature" style="max-width: 100%; max-height: 70px;">`;
                            engDisplay.classList.add("has-signature");
                        }
                    }
                    if (fieldId === "_qcSignature" && formData[fieldId]) {
                        localStorage.setItem("qc_signature", formData[fieldId]);
                        const qcDisplay = document.getElementById("qcSignatureDisplay");
                        if (qcDisplay) {
                            qcDisplay.innerHTML = `<img src="${formData[fieldId]}" alt="QC Signature" style="max-width: 100%; max-height: 70px;">`;
                            qcDisplay.classList.add("has-signature");
                        }
                    }
                    return;
                }
                
                const field = document.getElementById(fieldId);
                if (field) {
                    const serverValue = formData[fieldId];
                    const currentValue = field.type === "checkbox" ? field.checked : field.value;
                    
                    // QUAN TRỌNG: Luôn cập nhật nếu dữ liệu khác
                    // Chỉ không cập nhật nếu CHÍNH MÌNH đang focus vào field này
                    if (serverValue !== currentValue) {
                        const isCurrentlyEditing = (field === document.activeElement);
                        
                        if (!isCurrentlyEditing) {
                            if (field.type === "checkbox") {
                                field.checked = Boolean(serverValue);
                            } else {
                                field.value = serverValue || "";
                            }
                            
                            updateHighlight(field);
                            changedCount++;
                            showFieldUpdateEffect(field);
                        }
                    }
                }
            });
            
            if (changedCount > 0) {
                showTypingNotification(changedCount);
            }
            
            lastSavedData = {...formData};
            calculateDefectRate();
        }

        function showFieldUpdateEffect(field) {
            field.classList.add("field-updated");
            setTimeout(() => {
                field.classList.remove("field-updated");
            }, 1000);
        }

        function showTypingNotification(count) {
            let notification = document.getElementById("typing-notification");
            if (!notification) {
                notification = document.createElement("div");
                notification.id = "typing-notification";
                notification.className = "typing-indicator";
                document.body.appendChild(notification);
            }
            
            notification.textContent = `🔄 ${count} trường được cập nhật từ người khác`;
            notification.style.display = "block";
            
            setTimeout(() => {
                notification.style.display = "none";
            }, 2000);
        }

        // ========== CẬP NHẬT GIAO DIỆN NGƯỜI DÙNG ==========
        function updateUsersDisplay() {
            const usersListEl = document.getElementById("usersList");
            const onlineCountEl = document.getElementById("onlineUsersCount");
            
            if (!usersListEl || !onlineCountEl) return;
            
            const now = Date.now();
            const onlineUsers = Object.values(users).filter(user => 
                user.online || (now - user.lastActive < 30000)
            );
            
            onlineCountEl.textContent = `${onlineUsers.length} người online`;
            usersListEl.innerHTML = "";
            
            onlineUsers.forEach(user => {
                const userEl = document.createElement("div");
                userEl.className = `user-badge ${user.editingField ? "editing" : ""}`;
                userEl.style.borderLeft = `3px solid ${user.color}`;
                
                userEl.innerHTML = `
                    <div class="status-dot" style="background: ${user.color}"></div>
                    <div class="user-avatar" style="background: ${user.color}">
                        ${user.name.charAt(0).toUpperCase()}
                    </div>
                    <span>${user.name}</span>
                    ${user.id === currentUser?.id ? '<span style="font-size:9px;">(bạn)</span>' : ""}
                    ${user.editingField ? `<span style="font-size:9px; margin-left:5px;">✏️</span>` : ""}
                `;
                
                userEl.title = `${user.name}\n${user.editingField ? `Đang nhập: ${user.editingField}` : "Đang online"}`;
                usersListEl.appendChild(userEl);
            });
            
            updateEditingHighlights();
        }

        function updateEditingHighlights() {
            document.querySelectorAll(".field-being-edited").forEach(field => {
                field.classList.remove("field-being-edited");
                field.removeAttribute("data-editor");
            });
            
            Object.values(users).forEach(user => {
                if (user.editingField && user.id !== currentUser?.id) {
                    const field = document.getElementById(user.editingField);
                    if (field) {
                        field.classList.add("field-being-edited");
                        field.setAttribute("data-editor", user.name);
                    }
                }
            });
        }

        // ========== XỬ LÝ INPUT THỜI GIAN THỰC ==========
        function setupRealTimeInput() {
            let debounceTimer;
            
            document.querySelectorAll("input, textarea, select").forEach(field => {
                field.addEventListener("focus", function() {
                    if (currentProjectId && currentUser) {
                        currentUser.editingField = this.id;
                        updateUserEditingStatus(this.id);
                    }
                });
                
                // QUAN TRỌNG: Gửi dữ liệu NGAY LẬP TỨC
                field.addEventListener("input", function() {
                    clearTimeout(debounceTimer);
                    
                    if (currentProjectId && currentUser) {
                        // Gửi ngay lập tức
                        saveFieldToServer(this.id, this.type === "checkbox" ? this.checked : this.value);
                        
                        // Debounce cho các lần gõ tiếp theo
                        debounceTimer = setTimeout(() => {
                            saveFieldToServer(this.id, this.type === "checkbox" ? this.checked : this.value);
                        }, 200); // Chỉ 200ms
                    }
                    
                    updateHighlight(this);
                    
                    if (this.id === "totalQty" || this.id === "ngQty" || this.id === "okQty") {
                        calculateDefectRate();
                    }
                });
                
                field.addEventListener("change", function() {
                    if (currentProjectId && currentUser) {
                        saveFieldToServer(this.id, this.type === "checkbox" ? this.checked : this.value);
                    }
                    updateHighlight(this);
                });
                
                field.addEventListener("blur", function() {
                    if (currentProjectId && currentUser) {
                        currentUser.editingField = null;
                        updateUserEditingStatus(null);
                    }
                });
                
                // Thêm keyup để real-time hơn
                if (field.tagName === 'INPUT' || field.tagName === 'TEXTAREA') {
                    field.addEventListener('keyup', function() {
                        if (currentProjectId && currentUser) {
                            updateUserEditingStatus(this.id);
                        }
                    });
                }
            });
        }

        async function saveFieldToServer(fieldId, value) {
            if (!currentProjectId || !database || isSaving) return;
            
            isSaving = true;
            
            try {
                await database.ref(`projects/${currentProjectId}/data/${fieldId}`).set(value);
                await database.ref(`projects/${currentProjectId}/data/_lastUpdated`).set(new Date().toISOString());
                await database.ref(`projects/${currentProjectId}/data/_lastUpdatedBy`).set(currentUser?.id || "unknown");
                
                lastSavedData[fieldId] = value;
                
            } catch (error) {
                console.error("Lỗi lưu field:", error);
                showToast("❌ Lỗi đồng bộ dữ liệu", "error");
            } finally {
                setTimeout(() => { isSaving = false; }, 50); // Chỉ chờ 50ms
            }
        }

        async function updateUserEditingStatus(fieldId) {
            if (!currentProjectId || !currentUser || !database) return;
            
            try {
                await database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).update({
                    editingField: fieldId,
                    lastActive: Date.now()
                });
            } catch (error) {
                console.error("Lỗi cập nhật trạng thái editing:", error);
            }
        }

        // ========== HIGHLIGHT DỮ LIỆU ==========
        function updateHighlight(element) {
            if (!element) return;
            
            const hasData = element.type === "checkbox" 
                ? element.checked
                : element.type === "select-one"
                ? element.value && element.value !== ""
                : element.value && element.value.trim() !== "";
            
            if (hasData) {
                element.classList.add("has-data");
                const row = element.closest("tr");
                if (row) row.classList.add("highlight-row");
            } else {
                element.classList.remove("has-data");
                const row = element.closest("tr");
                if (row) row.classList.remove("highlight-row");
            }
        }

        function calculateDefectRate() {
            const total = parseInt(document.getElementById("totalQty").value) || 0;
            const ng = parseInt(document.getElementById("ngQty").value) || 0;
            
            let rate = 0;
            if (total > 0) {
                rate = (ng / total) * 100;
            }
            
            document.getElementById("defectRate").value = rate.toFixed(2) + "%";
            updateHighlight(document.getElementById("defectRate"));
        }

        // ========== URL & SHARING ==========
        function updateUrlWithProjectId() {
            if (!currentProjectId) return;
            
            const url = new URL(window.location);
            url.searchParams.set("project", currentProjectId);
            window.history.pushState({}, "", url);
        }

        function updateShareLink() {
            if (!currentProjectId) return "";
            
            const shareUrl = `${window.location.origin}${window.location.pathname}?project=${currentProjectId}`;
            document.getElementById("shareLinkText").textContent = shareUrl;
            
            return shareUrl;
        }

        // ========== LOAD DỮ LIỆU TỪ SERVER ==========
        async function loadProjectData() {
            if (!currentProjectId || !database) return;
            
            showLoading("Đang tải dữ liệu...");
            
            try {
                const snapshot = await database.ref(`projects/${currentProjectId}/data`).once("value");
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    updateFormFromServer(data);
                    showToast("✅ Đã tải dữ liệu từ server", "success");
                }
            } catch (error) {
                console.error("Lỗi tải dữ liệu:", error);
                showToast("❌ Lỗi tải dữ liệu từ server", "error");
            } finally {
                hideLoading();
            }
        }

        // ========== HÀM LƯU TOÀN BỘ ==========
        async function saveAllToCloud() {
            if (!currentProjectId) {
                showToast("❌ Chưa có project! Hãy tạo hoặc tham gia project trước.", "error");
                return false;
            }
            
            showLoading("Đang lưu toàn bộ dữ liệu...");
            
            try {
                const formData = collectFormData();
                formData._lastUpdated = new Date().toISOString();
                formData._lastUpdatedBy = currentUser?.id || "unknown";
                
                await database.ref(`projects/${currentProjectId}/data`).set(formData);
                
                showToast("✅ Đã lưu toàn bộ dữ liệu!", "success");
                return true;
                
            } catch (error) {
                console.error("Lỗi lưu toàn bộ:", error);
                showToast("❌ Lỗi lưu dữ liệu: " + error.message, "error");
                return false;
            } finally {
                hideLoading();
            }
        }

        // ========== CHỨC NĂNG CHIA SẺ ==========
        function generateShareLink() {
            if (!currentProjectId) {
                showToast("❌ Chưa có project! Hãy tạo hoặc tham gia project trước.", "error");
                return;
            }
            
            const shareUrl = updateShareLink();
            document.getElementById("shareLinkContainer").style.display = "block";
            
            navigator.clipboard.writeText(shareUrl).then(() => {
                showToast("✅ Đã copy link vào clipboard!", "success");
            }).catch(() => {
                const tempInput = document.createElement("input");
                tempInput.value = shareUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand("copy");
                document.body.removeChild(tempInput);
                showToast("✅ Đã copy link vào clipboard!", "success");
            });
        }

        function copyShareLink() {
            const shareUrl = document.getElementById("shareLinkText").textContent;
            if (shareUrl && shareUrl.trim() !== "") {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showToast("✅ Đã copy link vào clipboard!", "success");
                }).catch(() => {
                    const tempInput = document.createElement("input");
                    tempInput.value = shareUrl;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand("copy");
                    document.body.removeChild(tempInput);
                    showToast("✅ Đã copy link vào clipboard!", "success");
                });
            } else {
                showToast("❌ Chưa có link chia sẻ!", "error");
            }
        }

        function hideShareLink() {
            document.getElementById("shareLinkContainer").style.display = "none";
        }

        // ========== CHỮ KÝ ĐIỆN TỬ ==========
        function setupSignaturePads() {
            const engineerCanvas = document.getElementById("engineerSignature");
            if (engineerCanvas) {
                engineerSignaturePad = new SignaturePad(engineerCanvas, {
                    backgroundColor: "rgb(255, 255, 255)",
                    penColor: "rgb(0, 0, 0)"
                });
                
                document.getElementById("clearEngineerSignature").addEventListener("click", function() {
                    engineerSignaturePad.clear();
                    localStorage.removeItem("engineer_signature");
                    document.getElementById("engineerSignatureDisplay").innerHTML = '<div style="padding: 10px; text-align: center;">Chữ ký sẽ hiển thị ở đây sau khi lưu</div>';
                    document.getElementById("engineerSignatureDisplay").classList.remove("has-signature");
                    showToast("Đã xóa chữ ký kỹ sư", "info");
                    
                    if (currentProjectId && database) {
                        database.ref(`projects/${currentProjectId}/data/_engineerSignature`).remove();
                    }
                });
                
                document.getElementById("saveEngineerSignature").addEventListener("click", function() {
                    if (!engineerSignaturePad.isEmpty()) {
                        const dataURL = engineerSignaturePad.toDataURL();
                        localStorage.setItem("engineer_signature", dataURL);
                        
                        const displayDiv = document.getElementById("engineerSignatureDisplay");
                        displayDiv.innerHTML = `<img src="${dataURL}" alt="Engineer Signature" style="max-width: 100%; max-height: 70px;">`;
                        displayDiv.classList.add("has-signature");
                        
                        if (currentProjectId && database) {
                            database.ref(`projects/${currentProjectId}/data/_engineerSignature`).set(dataURL);
                        }
                        
                        showToast("✅ Đã lưu chữ ký kỹ sư!", "success");
                        updateHighlight(document.getElementById("engineerName"));
                    } else {
                        showToast("❌ Vui lòng ký trước khi lưu!", "error");
                    }
                });
                
                const savedEngineerSig = localStorage.getItem("engineer_signature");
                if (savedEngineerSig) {
                    document.getElementById("engineerSignatureDisplay").innerHTML = `<img src="${savedEngineerSig}" alt="Engineer Signature" style="max-width: 100%; max-height: 70px;">`;
                    document.getElementById("engineerSignatureDisplay").classList.add("has-signature");
                }
            }
            
            const qcCanvas = document.getElementById("qcSignature");
            if (qcCanvas) {
                qcSignaturePad = new SignaturePad(qcCanvas, {
                    backgroundColor: "rgb(255, 255, 255)",
                    penColor: "rgb(0, 0, 0)"
                });
                
                document.getElementById("clearQcSignature").addEventListener("click", function() {
                    qcSignaturePad.clear();
                    localStorage.removeItem("qc_signature");
                    document.getElementById("qcSignatureDisplay").innerHTML = '<div style="padding: 10px; text-align: center;">Chữ ký sẽ hiển thị ở đây sau khi lưu</div>';
                    document.getElementById("qcSignatureDisplay").classList.remove("has-signature");
                    showToast("Đã xóa chữ ký QC", "info");
                    
                    if (currentProjectId && database) {
                        database.ref(`projects/${currentProjectId}/data/_qcSignature`).remove();
                    }
                });
                
                document.getElementById("saveQcSignature").addEventListener("click", function() {
                    if (!qcSignaturePad.isEmpty()) {
                        const dataURL = qcSignaturePad.toDataURL();
                        localStorage.setItem("qc_signature", dataURL);
                        
                        const displayDiv = document.getElementById("qcSignatureDisplay");
                        displayDiv.innerHTML = `<img src="${dataURL}" alt="QC Signature" style="max-width: 100%; max-height: 70px;">`;
                        displayDiv.classList.add("has-signature");
                        
                        if (currentProjectId && database) {
                            database.ref(`projects/${currentProjectId}/data/_qcSignature`).set(dataURL);
                        }
                        
                        showToast("✅ Đã lưu chữ ký QC!", "success");
                        updateHighlight(document.getElementById("qcName"));
                    } else {
                        showToast("❌ Vui lòng ký trước khi lưu!", "error");
                    }
                });
                
                const savedQcSig = localStorage.getItem("qc_signature");
                if (savedQcSig) {
                    document.getElementById("qcSignatureDisplay").innerHTML = `<img src="${savedQcSig}" alt="QC Signature" style="max-width: 100%; max-height: 70px;">`;
                    document.getElementById("qcSignatureDisplay").classList.add("has-signature");
                }
            }
        }

        // ========== CÁC HÀM TIỆN ÍCH ==========
        function setupFormListeners() {
            document.querySelectorAll("textarea").forEach(textarea => {
                textarea.addEventListener("input", function() {
                    this.style.height = "auto";
                    this.style.height = this.scrollHeight + "px";
                });
                setTimeout(() => {
                    textarea.dispatchEvent(new Event("input"));
                }, 100);
            });
        }

        function updateStatus(message, status = "offline") {
            const statusEl = document.getElementById("cloudStatus");
            const textEl = document.getElementById("cloudStatusText");
            
            if (statusEl) statusEl.className = "status-indicator " + status;
            if (textEl) textEl.textContent = message;
        }

        function updateCloudStatus() {
            const isOnline = navigator.onLine;
            updateStatus(isOnline ? "Đang kết nối" : "Mất kết nối", isOnline ? "online" : "offline");
        }

        // ========== XUẤT PDF ==========
        function exportToPDF() {
            showLoading("Đang tạo PDF...");
            
            const noPrintElements = document.querySelectorAll(".no-print");
            const originalDisplay = [];
            noPrintElements.forEach(el => {
                originalDisplay.push(el.style.display);
                el.style.display = "none";
            });
            
            const watermark = document.createElement("div");
            watermark.innerHTML = `
                <div style="
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%) rotate(-45deg);
                    font-size: 60px;
                    color: rgba(0,0,0,0.1);
                    z-index: 9999;
                    pointer-events: none;
                    font-weight: bold;
                    white-space: nowrap;
                ">
                    NPI RECORD - ${document.getElementById("model").value || "UNKNOWN"}
                </div>
            `;
            document.body.appendChild(watermark);
            
            const { jsPDF } = window.jspdf;
            const element = document.getElementById("main-form");
            
            html2canvas(element, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: "#ffffff",
                width: element.scrollWidth,
                height: element.scrollHeight,
                scrollX: 0,
                scrollY: -window.scrollY
            }).then(canvas => {
                const imgData = canvas.toDataURL("image/png", 1.0);
                const pdf = new jsPDF({
                    orientation: "portrait",
                    unit: "mm",
                    format: "a4"
                });
                
                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                const fileName = `NPI-Record-${document.getElementById("model").value || "Unknown"}-${new Date().toISOString().split("T")[0]}.pdf`;
                pdf.save(fileName);
                
                watermark.remove();
                noPrintElements.forEach((el, index) => {
                    el.style.display = originalDisplay[index];
                });
                
                hideLoading();
                showToast("✅ Đã xuất PDF thành công!", "success");
            }).catch(error => {
                console.error("PDF Export Error:", error);
                
                watermark.remove();
                noPrintElements.forEach((el, index) => {
                    el.style.display = originalDisplay[index];
                });
                
                hideLoading();
                showToast("❌ Lỗi xuất PDF: " + error.message, "error");
            });
        }

        function printForm() {
            window.print();
        }

        function resetForm() {
            if (confirm("Bạn có chắc muốn xóa TẤT CẢ dữ liệu hiện tại?\n\nDữ liệu đã lưu trên cloud vẫn giữ nguyên.")) {
                document.querySelectorAll("input, textarea, select").forEach(element => {
                    if (element.type === "checkbox") {
                        element.checked = false;
                    } else if (element.type === "date") {
                        element.value = new Date().toISOString().split("T")[0];
                    } else if (element.type !== "button" && element.type !== "submit") {
                        element.value = "";
                    }
                    updateHighlight(element);
                });
                
                if (engineerSignaturePad) engineerSignaturePad.clear();
                if (qcSignaturePad) qcSignaturePad.clear();
                localStorage.removeItem("engineer_signature");
                localStorage.removeItem("qc_signature");
                const engDisplay = document.getElementById("engineerSignatureDisplay");
                const qcDisplay = document.getElementById("qcSignatureDisplay");
                if (engDisplay) {
                    engDisplay.innerHTML = '<div style="padding: 10px; text-align: center;">Chữ ký sẽ hiển thị ở đây sau khi lưu</div>';
                    engDisplay.classList.remove("has-signature");
                }
                if (qcDisplay) {
                    qcDisplay.innerHTML = '<div style="padding: 10px; text-align: center;">Chữ ký sẽ hiển thị ở đây sau khi lưu</div>';
                    qcDisplay.classList.remove("has-signature");
                }
                
                updateStatus("Đã xóa dữ liệu cục bộ", "offline");
                showToast("✅ Đã xóa dữ liệu cục bộ thành công!", "success");
            }
        }

        // ========== KHỞI ĐỘNG TRANG ==========
        document.addEventListener("DOMContentLoaded", function() {
            console.log("🚀 Khởi động NPI Record Multi-User...");
            
            initUser();
            
            const today = new Date().toISOString().split("T")[0];
            document.getElementById("date").value = today;
            
            const urlParams = new URLSearchParams(window.location.search);
            const projectIdFromUrl = urlParams.get("project");
            
            setupHighlightListeners();
            setupSignaturePads();
            setupFormListeners();
            setupRealTimeInput();
            
            document.getElementById("projectAction").addEventListener("click", handleProjectAction);
            document.getElementById("saveToCloud").addEventListener("click", saveAllToCloud);
            document.getElementById("shareForm").addEventListener("click", generateShareLink);
            document.getElementById("exportPdf").addEventListener("click", exportToPDF);
            document.getElementById("printForm").addEventListener("click", printForm);
            document.getElementById("resetForm").addEventListener("click", resetForm);
            document.getElementById("copyLinkBtn").addEventListener("click", copyShareLink);
            document.getElementById("closeShareBtn").addEventListener("click", hideShareLink);
            
            document.getElementById("projectIdDisplay")?.addEventListener("click", function() {
                if (currentProjectId) {
                    navigator.clipboard.writeText(currentProjectId).then(() => {
                        showToast("✅ Đã copy Project ID", "success");
                    });
                }
            });
            
            if (projectIdFromUrl) {
                setTimeout(() => {
                    showLoading("Đang kết nối đến project...");
                    currentProjectId = projectIdFromUrl;
                    document.getElementById("projectIdDisplay").textContent = `ID: ${projectIdFromUrl}`;
                    document.getElementById("onlineUsersContainer").style.display = "block";
                    
                    if (!currentUser) initUser();
                    setupRealtimeListeners();
                    loadProjectData();
                    
                    showToast("📡 Đã tự động kết nối đến project", "info");
                    updateStatus("Đang đồng bộ thời gian thực", "online");
                    
                    setTimeout(hideLoading, 1000);
                }, 500);
            }
            
            window.addEventListener("online", updateCloudStatus);
            window.addEventListener("offline", updateCloudStatus);
            
            updateCloudStatus();
        });

        function setupHighlightListeners() {
            document.querySelectorAll("input, textarea, select").forEach(element => {
                updateHighlight(element);
                
                element.addEventListener("input", function() {
                    updateHighlight(this);
                });
                
                element.addEventListener("change", function() {
                    updateHighlight(this);
                });
            });
            
            document.querySelectorAll(".checkbox-group input[type='checkbox']").forEach(cb => {
                cb.addEventListener("change", function() {
                    updateHighlight(this);
                    const label = this.nextElementSibling;
                    if (label && this.checked) {
                        label.classList.add("highlight-text");
                    } else {
                        label.classList.remove("highlight-text");
                    }
                });
            });
        }

        console.log("🔥 NPI Record Multi-User đã sẵn sàng!");
        console.log("📌 Hướng dẫn sử dụng:");
        console.log("1. Click 'Tạo/Tham gia Project' để bắt đầu");
        console.log("2. Tạo project mới hoặc nhập ID project có sẵn");
        console.log("3. Chia sẻ link cho đồng nghiệp");
        console.log("4. Cùng nhập dữ liệu thời gian thực!");
    </script>
</body>
</html>