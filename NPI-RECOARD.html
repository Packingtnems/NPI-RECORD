<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPI Record - Multi-User Real-time</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Myriad Pro', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #000;
            line-height: 1.2;
            padding: 10px;
            margin: 0;
            font-size: 11px;
        }
        
        .container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .form-content {
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }
        
        .header h1 {
            color: #000;
            margin-bottom: 5px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .form-section {
            margin-bottom: 20px;
            border: 1px solid #000;
            border-radius: 2px;
            padding: 10px;
            background-color: #fff;
            page-break-inside: avoid;
        }
        
        .section-title {
            background-color: #e0e0e0;
            color: #000;
            padding: 8px 10px;
            margin: -10px -10px 10px -10px;
            border-bottom: 1px solid #000;
            font-size: 14px;
            font-weight: bold;
        }
        
        .sub-section-title {
            background-color: #f0f0f0;
            color: #000;
            padding: 6px 8px;
            margin: 10px -10px;
            border-top: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            font-size: 13px;
            font-weight: bold;
        }
        
        .form-row {
            display: flex;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .form-group {
            flex: 1;
            min-width: 180px;
            margin-bottom: 8px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #000;
            font-size: 11px;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 5px 8px;
            border: 1px solid #999;
            border-radius: 3px;
            font-size: 11px;
            background-color: white;
            transition: all 0.3s ease;
        }
        
        .form-group textarea {
            min-height: 70px;
            resize: vertical;
            overflow-y: auto;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 8px;
            padding: 8px 0;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
        }
        
        .checkbox-item input {
            margin-right: 6px;
        }
        
        .signature-container {
            border: 1px solid #999;
            border-radius: 3px;
            padding: 8px;
            margin-top: 8px;
            background-color: white;
        }
        
        .signature-pad {
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 100%;
            height: 120px;
            cursor: crosshair;
        }
        
        .signature-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .signature-controls button {
            padding: 6px 12px;
            background-color: #4a6fa5;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .signature-controls button:hover {
            background-color: #3a5a8a;
        }
        
        .signature-display {
            height: 80px;
            border: 1px dashed #999;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-style: italic;
            background-color: #f9f9f9;
        }
        
        .signature-display img {
            max-width: 100%;
            max-height: 100%;
        }
        
        .buttons-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 5px;
            position: sticky;
            top: 10px;
            z-index: 100;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            min-width: 160px;
        }
        
        .btn-primary {
            background-color: #4a6fa5;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #3a5a8a;
        }
        
        .btn-success {
            background-color: #2e7d32;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #1b5e20;
        }
        
        .btn-danger {
            background-color: #c62828;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #b71c1c;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            margin-bottom: 15px;
            font-size: 11px;
            table-layout: fixed;
        }
        
        th, td {
            border: 1px solid #000;
            padding: 6px;
            text-align: left;
            vertical-align: top;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        th {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
        }
        
        td.long-content-cell {
            min-height: 60px;
            height: auto;
        }
        
        .note {
            font-size: 10px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        .footer {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 11px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                padding: 0;
                margin: 0;
                background-color: white;
                font-size: 10pt;
            }
            
            .container {
                box-shadow: none;
                padding: 0;
                margin: 0;
                width: 100%;
            }
            
            .form-content {
                padding: 15mm;
            }
            
            .signature-display {
                border: 1px solid #000;
            }
            
            .buttons-container {
                display: none;
            }
            
            .form-section {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            table {
                page-break-inside: auto;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            td, th {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            td {
                overflow: visible !important;
                height: auto !important;
                max-height: none !important;
            }
            
            input, textarea, select, .signature-pad {
                display: none !important;
            }
            
            .pdf-value-display {
                display: block !important;
            }
        }
        
        .input-small {
            width: 100px;
            display: inline-block;
        }
        
        .input-medium {
            width: 180px;
            display: inline-block;
        }
        
        .form-group.full-width {
            flex: 0 0 100%;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        

    {
        background: transparent !important;
        box-shadow: none !important;
    }

    ::selection {
        background: transparent !important;
        color: #1565C0 !important; /* giữ chữ xanh */
    }

    ::-moz-selection {
        background: transparent !important;
        color: #1565C0 !important;
    }
   {
        user-select: none !important;
        -webkit-user-select: none !important;
    }
        
        /* ========== HIGHLIGHT DỮ LIỆU ĐÃ NHẬP ========== */
        .form-input.has-data,
        .form-textarea.has-data,
        .form-select.has-data {
            color: #1565C0 !important;
            border-color: #000 !important;
            background-color: transparent !important;
            font-weight: 300 !important;
            border-width: 1px !important;
        }
        
        .form-checkbox:checked + label {
            color: #1565C0 !important;
            font-weight: 700 !important;
        }
        
        .checkbox-item input:checked {
            accent-color: #1565C0;
        }
        
        .highlight-text {
            color: #1565C0 !important;
            font-weight: normal !important;
            background-color: transparent !important;
            padding: 2px 4px;
            border-radius: 2px;
        }
        
        .signature-display.has-signature {
            border: 2px solid #1565C0;
            background-color: #E8F5E9;
        }
        
        /* ========== STYLE ĐẶC BIỆT ========== */
        input:focus, textarea:focus, select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(21, 101, 192, 0.2);
        }
        
        .highlight-row {
            background-color: #F5F9FF !important;
        }
        
        /* Cloud Status */
        .cloud-status {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cloud-status .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .online { background-color: #4CAF50; }
        .offline { background-color: #f44336; }
        .syncing { 
            background-color: #FF9800; 
            animation: pulse 1s infinite; 
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Online Users */
        .online-users {
            background: linear-gradient(135deg, #2196F3 0%, #21CBF3 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .users-list-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .users-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .user-badge .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .user-badge .user-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        .user-badge.editing {
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 0 2px currentColor;
        }
        
        /* Project Info */
        .project-info {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 10px;
        }
        
        #projectIdDisplay {
            font-family: monospace;
            cursor: pointer;
            padding: 2px 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }
        
        #projectIdDisplay:hover {
            background: rgba(255,255,255,0.5);
        }
        
        /* Field being edited by others */
        .field-being-edited {
            animation: fieldPulse 2s infinite;
            box-shadow: 0 0 0 2px #FF9800 !important;
            position: relative;
        }
        
        .field-being-edited::after {
            content: attr(data-editor);
            position: absolute;
            top: -20px;
            right: 0;
            background: #FF9800;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            white-space: nowrap;
            z-index: 1000;
        }
        
        @keyframes fieldPulse {
            0%, 100% { background-color: rgba(255, 152, 0, 0.1); }
            50% { background-color: rgba(255, 152, 0, 0.3); }
        }
        
        /* Real-time typing indicator */
        .typing-indicator {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #FF9800;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 11px;
            z-index: 9999;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            animation: slideInRight 0.3s;
        }
        
        .field-updated {
            animation: fieldUpdate 1s ease;
        }
        
        @keyframes fieldUpdate {
            0% { background-color: #E8F5E9; }
            50% { background-color: #C8E6C9; }
            100% { background-color: #E8F5E9; }
        }
        
        .share-link-container {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            display: none;
        }
        
        .share-link {
            word-break: break-all;
            background: white;
            padding: 8px;
            border-radius: 3px;
            margin-top: 5px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 12px;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a6fa5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: 500;
            z-index: 10001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }
        
        .toast-success {
            background: #4CAF50;
        }
        
        .toast-error {
            background: #f44336;
        }
        
        .toast-info {
            background: #2196F3;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .pdf-template {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 210mm;
            min-height: 297mm;
            background: white;
            padding: 15mm;
            font-family: 'Arial', sans-serif;
            font-size: 10pt;
            line-height: 1.2;
            display: none;
        }
        
        .validation-error {
            border-color: #f44336 !important;
            box-shadow: 0 0 0 2px rgba(244, 67, 54, 0.2) !important;
        }
        
        /* Tab navigation for multiple processes */
        .process-tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 2px solid #4a6fa5;
            margin-bottom: 15px;
            background-color: #f0f0f0;
        }
        
        .process-tab {
            padding: 10px 20px;
            background: #e0e0e0;
            border: none;
            border-right: 1px solid #ccc;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .process-tab.active {
            background: #4a6fa5;
            color: white;
        }
        
        .process-tab:hover:not(.active) {
            background: #d0d0d0;
        }
        
        .process-content {
            display: none;
        }
        
        .process-content.active {
            display: block;
        }

    </style>
</head>
<body>
    <!-- Cloud Status Bar -->
    <div class="cloud-status no-print">
        <div>
            <span class="status-indicator offline" id="cloudStatus"></span>
            <span id="cloudStatusText">Chưa kết nối</span>
        </div>
        <div id="userCount" style="display: flex; align-items: center; gap: 5px;">
            <i class="fas fa-users"></i>
            <span>Chưa có project</span>
        </div>
    </div>

    <!-- Online Users -->
    <div class="online-users no-print" id="onlineUsersContainer" style="display: none;">
        <div class="users-list-title">
            <i class="fas fa-users"></i> 
            <span id="onlineUsersCount">0 người online</span>
            <span class="project-info">
                <i class="fas fa-project-diagram"></i>
                <span id="projectIdDisplay" title="Click để copy ID">ID: Chưa có project</span>
            </span>
        </div>
        <div class="users-list" id="usersList"></div>
    </div>

    <!-- Share Link Container -->
    <div class="share-link-container no-print" id="shareLinkContainer">
        <strong><i class="fas fa-share-alt"></i> LINK CHIA SẺ:</strong>
        <div class="share-link" id="shareLinkText"></div>
        <div style="margin-top: 10px;">
            <button id="copyLinkBtn" style="padding: 5px 10px; background: #4a6fa5; color: white; border: none; border-radius: 3px; cursor: pointer;">
                <i class="fas fa-copy"></i> Copy Link
            </button>
            <button id="closeShareBtn" style="margin-left: 10px; padding: 5px 10px; background: #666; color: white; border: none; border-radius: 3px; cursor: pointer;">
                <i class="fas fa-times"></i> Đóng
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div id="loadingMessage">Đang xử lý...</div>
        </div>
    </div>

    <!-- Buttons for actions -->
    <div class="buttons-container no-print">
        <button type="button" class="btn btn-primary" id="projectAction">
            <i class="fas fa-users"></i> Tạo/Tham gia Project
        </button>
        <button type="button" class="btn btn-success" id="saveToCloud">
            <i class="fas fa-cloud-upload-alt"></i> Lưu lên Cloud
        </button>
        <button type="button" class="btn btn-primary" id="shareForm">
            <i class="fas fa-share-alt"></i> Chia sẻ
        </button>
        <button type="button" class="btn btn-success" id="exportPdf">
            <i class="fas fa-file-pdf"></i> Xuất PDF
        </button>
        <button type="button" class="btn btn-danger" id="resetForm">
            <i class="fas fa-redo"></i> Làm mới
        </button>
        <button type="button" class="btn btn-primary" id="printForm">
            <i class="fas fa-print"></i> In trực tiếp
        </button>
    </div>

    <!-- Main form container -->
    <div class="container" id="main-form">
        <div class="form-content">
            <!-- Header -->
            <div class="header" style="display:flex; align-items:center; border-bottom:1px solid #000; padding-bottom:8px;">

    <!-- LOGO TRÁI -->
    <img src="logo.png"
         alt="Logo"
         style="height:60px; margin-right:15px;">

    <!-- TIÊU ĐỀ -->
    <div style="text-align:center; flex:1;">
        <h1 style="margin:0;">BIỂU GHI NPI - NPI RECORD</h1>
        <div style="font-size:12px; margin-top:4px;">
            TNEMS-EN-F-048-NPI RECORD-VER03
        </div>
    </div>

</div>


            
            <!-- Product Information Section -->
            <div class="form-section" id="section-product-info">
                <div class="section-title">THÔNG TIN SẢN PHẨM - PRODUCT INFORMATION</div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="model">MÃ HÀNG / MODEL: <span class="required" style="color: red;">*</span></label>
                        <input type="text" id="model" placeholder="Nhập mã hàng/model" class="form-input required-field">
                    </div>
                    
                    <div class="form-group">
                        <label for="customer">KHÁCH HÀNG / CUSTOMER: <span class="required" style="color: red;">*</span></label>
                        <input type="text" id="customer" placeholder="Nhập tên khách hàng" class="form-input required-field">
                    </div>
                    
                    <div class="form-group">
                        <label for="partNo">Part No:</label>
                        <input type="text" id="partNo" placeholder="Nhập Part No" class="form-input">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label>Quy trình / Process:</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="processSMT" value="SMT" class="form-checkbox">
                                <label for="processSMT">SMT</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="processThroughHole" value="THROUGH HOLE" class="form-checkbox">
                                <label for="processThroughHole">THROUGH HOLE</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="processCoating" value="COATING" class="form-checkbox">
                                <label for="processCoating">COATING</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="processBoxbuild" value="BOXBUILD" class="form-checkbox">
                                <label for="processBoxbuild">BOXBUILD</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="processPacking" value="PACKING" class="form-checkbox">
                                <label for="processPacking">PACKING</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="flex: 1;">
                        <label for="date">Ngày / Date:</label>
                        <input type="date" id="date" value="" class="form-input">
                    </div>
                </div>
            </div>

            <!-- Process Tabs -->
            <div class="process-tabs no-print" id="processTabs">
                <button class="process-tab active" data-tab="smt">SMT PROCESS</button>
                <button class="process-tab" data-tab="through-hole">THROUGH-HOLE</button>
                <button class="process-tab" data-tab="coating">COATING</button>
                <button class="process-tab" data-tab="boxbuild">BOXBUILD</button>
                <button class="process-tab" data-tab="packaging">PACKAGING</button>
                <button class="process-tab" data-tab="conclusion">KẾT LUẬN</button>
            </div>

            <!-- SMT Process Section -->
            <div class="process-content active" id="smt-process">
                <div class="form-section">
                    <div class="section-title">SMT PROCESS</div>
                    
                    <!-- LASER MARKING -->
                    <div class="sub-section-title">LASER MARKING</div>
                    <table>
                        <tr>
                            <th width="30%">NỘI DUNG</th>
                            <th width="70%">GIÁ TRỊ</th>
                        </tr>
                        <tr>
                            <td>Tên chương trình/ Program name</td>
                            <td>
                                <input type="text" id="laserProgram" placeholder="Nhập tên chương trình" style="width: 100%;" class="form-input">
                            </td>
                        </tr>
                        <tr>
                            <td>Loại QR code/ QR code type</td>
                            <td>
                                <input type="text" id="qrType" placeholder="Nhập loại QR code" style="width: 100%;" class="form-input">
                            </td>
                        </tr>
                        <tr>
                            <td>Kích thước QR code/ QR code size</td>
                            <td>
                                <input type="text" id="qrSize" placeholder="Nhập kích thước QR code" style="width: 100%;" class="form-input">
                            </td>
                        </tr>
                        <tr>
                            <td>Cường độ khắc/ Engraving intensity</td>
                            <td>
                                <input type="text" id="engravingIntensity" placeholder="Nhập cường độ khắc" style="width: 100%;" class="form-input">
                            </td>
                        </tr>
                        <tr>
                            <td>Side BOT: Nội dung QR code/ QR code content</td>
                            <td class="long-content-cell">
                                <textarea id="qrContentBot" placeholder="Nhập nội dung QR code mặt BOT" rows="3" style="width: 100%;" class="form-textarea long-content"></textarea>
                            </td>
                        </tr>
                        <tr>
                            <td>Side TOP: Nội dung QR code/ QR code content</td>
                            <td class="long-content-cell">
                                <textarea id="qrContentTop" placeholder="Nhập nội dung QR code mặt TOP" rows="3" style="width: 100%;" class="form-textarea long-content"></textarea>
                            </td>
                        </tr>
                        <tr>
                            <td>Nội dung QR code khi quét bằng máy</td>
                            <td class="long-content-cell">
                                <textarea id="qrScanContent" placeholder="Nhập nội dung khi quét QR" rows="3" style="width: 100%;" class="form-textarea long-content"></textarea>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- PRINTER -->
                    <div class="sub-section-title">PRINTER</div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <input type="text" id="printerControl" placeholder="Ghi chú về printer" value="Theo Process control sheet đính kèm/According to the attached Process Control Sheet" style="width: 100%;" class="form-input">
                        </div>
                    </div>
                    
                    <!-- MOUNTER -->
                    <div class="sub-section-title">MOUNTER</div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <input type="text" id="mounterControl" placeholder="Ghi chú về mounter" value="Theo Process control sheet đính kèm (có xác nhận và đo giá trị của các bên)/According to the attached Process Control Sheet" style="width: 100%;" class="form-input">
                        </div>
                    </div>
                    
                    <!-- VISUAL INSPECTION 1 -->
                    <div class="sub-section-title">NGOẠI QUAN VISUAL INSPECTION</div>
                    <table>
                        <tr>
                            <th width="40%">HƯỚNG LINH KIỆN/COMPONENT POLARITY</th>
                            <th width="30%">SỐ LƯỢNG LINH KIỆN/COMPONENT QUANTITY</th>
                            <th width="15%">KẾT QUẢ/RESULT</th>
                            <th width="15%">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td>Theo bảng hướng linh kiện đính kèm (QC)</td>
                            <td>
                                <div>Theo BOM/ According to the BOM: 
                                    <input type="text" id="bomQty" class="input-small form-input" placeholder="Số lượng">
                                </div>
                                <div style="margin-top: 5px;">Thực tế/ Reality: 
                                    <input type="text" id="actualQty" class="input-small form-input" placeholder="Số lượng">
                                </div>
                            </td>
                            <td style="text-align: center;">
                                <select id="visualResult1" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: center;">
                                <div>ENG: 
                                    <input type="text" id="engVerify1" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="qcVerify1" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- REFLOW OVEN -->
                    <div class="sub-section-title">LÒ REFLOW/REFLOW OVEN</div>
                    <table>
                        <tr>
                            <th width="30%">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                            <th width="40%">THÔNG SỐ CÀI ĐẶT MÁY/MACHINE PARAMETERS SETTING</th>
                            <th width="15%">KẾT QUẢ/RESULT</th>
                            <th width="15%">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                - Theo Process control sheet đính kèm<br>
                                - Profile lò đính kèm
                            </td>
                            <td class="long-content-cell">
                                <textarea id="reflowParams" placeholder="Thông số cài đặt" rows="4" style="width: 100%;" class="form-textarea long-content"></textarea>
                            </td>
                            <td style="text-align: center;">
                                <select id="reflowResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: center;">
                                <div>ENG: 
                                    <input type="text" id="reflowEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="reflowQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- AOI -->
                    <div class="sub-section-title">AOI/AUTOMATED OPTICAL INSPECTION</div>
                    <table>
                        <tr>
                            <th width="30%">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                            <th width="25%">SỐ LƯỢNG PCBA ĐÃ AOI/PCBA AOI INSPECTED QUANTITY</th>
                            <th width="15%">KẾT QUẢ/RESULT</th>
                            <th width="30%">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <div>BOT: 
                                    <input type="text" id="aoiProgramBot" class="input-medium form-input" placeholder="Tên chương trình">
                                </div>
                                <div style="margin-top: 5px;">TOP: 
                                    <input type="text" id="aoiProgramTop" class="input-medium form-input" placeholder="Tên chương trình">
                                </div>
                            </td>
                            <td>
                                <input type="text" id="aoiQty" class="input-small form-input" placeholder="Số lượng" style="width: 100%;">
                            </td>
                            <td style="text-align: center;">
                                <select id="aoiResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: center;">
                                <div>ENG: 
                                    <input type="text" id="aoiEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="aoiQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- FLYING PROBE -->
                    <div class="sub-section-title">FLYING PROBE (20%)</div>
                    <table>
                        <tr>
                            <th width="30%">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                            <th width="25%">SỐ LƯỢNG ĐÃ ĐO/MEASURED QUANTITY</th>
                            <th width="15%">KẾT QUẢ/RESULT</th>
                            <th width="30%">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <div>BOT: 
                                    <input type="text" id="probeProgramBot" class="input-medium form-input" placeholder="Tên chương trình">
                                </div>
                                <div style="margin-top: 5px;">TOP: 
                                    <input type="text" id="probeProgramTop" class="input-medium form-input" placeholder="Tên chương trình">
                                </div>
                            </td>
                            <td>
                                <input type="text" id="probeQty" class="input-small form-input" placeholder="Số lượng" style="width: 100%;">
                            </td>
                            <td style="text-align: center;">
                                <select id="probeResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: center;">
                                <div>ENG: 
                                    <input type="text" id="probeEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="probeQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- VISUAL INSPECTION 2 -->
                    <div class="sub-section-title">NGOẠI QUAN VISUAL INSPECTION</div>
                    <div class="note" style="margin-bottom: 10px;">
                        KIỂM TRA SỐ LƯỢNG LINH KIỆN, CHẤT LƯỢNG MỐI HÀN, HƯỚNG LINH KIỆN, CÁC LỖI ĐÁNH GIÁ THEO IPC
                    </div>
                    <table>
                        <tr>
                            <th width="40%">NỘI DUNG KIỂM TRA</th>
                            <th width="30%">KẾT QUẢ</th>
                            <th width="30%">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td>- Số lượng linh kiện/ Component Quantity</td>
                            <td style="text-align: center;">
                                <select id="visual2Result1" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td rowspan="4" style="text-align: center; vertical-align: middle;">
                                <div>ENG: 
                                    <input type="text" id="visual2Eng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 10px;">QC: 
                                    <input type="text" id="visual2Qc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>- Chất lượng mối hàn/ Solder Joint Quality</td>
                            <td style="text-align: center;">
                                <select id="visual2Result2" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>- Hướng linh kiện/ Component Orientation</td>
                            <td style="text-align: center;">
                                <select id="visual2Result3" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>- Các lỗi đánh giá theo IPC/ Defects Evaluated per IPC</td>
                            <td style="text-align: center;">
                                <select id="visual2Result4" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- THROUGH-HOLE Process Section -->
            <div class="process-content" id="through-hole-process">
                <div class="form-section">
                    <div class="section-title">THROUGH-HOLE PROCESS</div>
                    
                    <!-- Component Quantity Check -->
                    <div class="sub-section-title">KIỂM TRA SỐ LƯỢNG LINH KIỆN / COMPONENT QUANTITY CHECK</div>
                    <table>
                        <tr>
                            <th width="40%">NỘI DUNG KIỂM TRA/INSPECTION CONTENT</th>
                            <th width="30%">GIÁ TRỊ/VALUE</th>
                            <th width="15%">KẾT QUẢ/RESULT</th>
                            <th width="15%">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td>ĐÚNG MÃ / CORRECT PART NUMBER</td>
                            <td>
                                <input type="text" id="thPartNumber" placeholder="Nhập thông tin" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="thPartNumberResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: center;">
                                <div>ENG: 
                                    <input type="text" id="thQuantityEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="thQuantityQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>SỐ LƯỢNG / QUANTITY</td>
                            <td>
                                <input type="text" id="thQuantity" placeholder="Nhập số lượng" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="thQuantityResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: center;">
                                <div>ENG: 
                                    <input type="text" id="thQuantityEng2" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="thQuantityQc2" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Soldering -->
                    <div class="sub-section-title">HÀN / SOLDERING</div>
                    <table>
                        <tr>
                            <th width="40%">THÔNG SỐ / PARAMETERS</th>
                            <th width="30%">GIÁ TRỊ / VALUE</th>
                            <th width="15%">KẾT QUẢ / RESULT</th>
                            <th width="15%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>NHIỆT ĐỘ CÀI ĐẶT HÀN TAY / HAND SOLDERING TEMPERATURE SETTING</td>
                            <td>
                                <input type="text" id="handSolderTemp" placeholder="VD: 350°C" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="handSolderResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td rowspan="3" style="text-align: center; vertical-align: middle;">
                                <div>ENG: 
                                    <input type="text" id="thSolderingEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 10px;">QC: 
                                    <input type="text" id="thSolderingQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Loại nozzle/Nozzle type:</td>
                            <td>
                                <input type="text" id="nozzleType" placeholder="Nhập loại nozzle" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="nozzleResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Preheat (ºC): Solder pot (ºC): Thời gian preheat (s)</td>
                            <td>
                                <input type="text" id="solderParams" placeholder="VD: 100°C, 250°C, 30s" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="solderParamsResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Testing -->
                    <div class="sub-section-title">TESTING</div>
                    <table>
                        <tr>
                            <th width="40%">GIÁ TRỊ KIỂM TRA / INSPECTION VALUE</th>
                            <th width="30%">CÁC BƯỚC KIỂM TRA / INSPECTION STEPS</th>
                            <th width="15%">KẾT QUẢ / RESULT</th>
                            <th width="15%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>Xem file đính kèm Test đính kèm / See attached file</td>
                            <td>Xem file đính kèm Test đính kèm / See attached file</td>
                            <td style="text-align: center;">
                                <select id="testingResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: center;">
                                <div>ENG: 
                                    <input type="text" id="thTestingEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="thTestingQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- PCBA Cleaning -->
                    <div class="sub-section-title">VỆ SINH PCBA / PCBA CLEANING</div>
                    <table>
                        <tr>
                            <th width="40%">PHƯƠNG PHÁP VỆ SINH / CLEANING METHOD</th>
                            <th width="30%">DỤNG CỤ & DUNG DỊCH / TOOLS & SOLUTION</th>
                            <th width="15%">KẾT QUẢ / RESULT</th>
                            <th width="15%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <input type="text" id="cleaningMethod" placeholder="Nhập phương pháp vệ sinh" style="width: 100%;" class="form-input">
                            </td>
                            <td>
                                <input type="text" id="cleaningTools" placeholder="Nhập dụng cụ & dung dịch" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="cleaningResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: center;">
                                <div>ENG: 
                                    <input type="text" id="thCleaningEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="thCleaningQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Visual Inspection -->
                    <div class="sub-section-title">NGOẠI QUAN VISUAL INSPECTION</div>
                    <table>
                        <tr>
                            <th width="40%">CHẤT LƯỢNG MỐI HÀN VÀ VỆ SINH / SOLDER JOINT QUALITY AND CLEANLINESS</th>
                            <th width="30%">ĐÚNG, ĐỦ LINH KIỆN / CORRECT AND COMPLETE COMPONENTS</th>
                            <th width="15%">KẾT QUẢ / RESULT</th>
                            <th width="15%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <input type="text" id="thVisualQuality" placeholder="Nhập đánh giá chất lượng" style="width: 100%;" class="form-input">
                            </td>
                            <td>
                                <input type="text" id="thVisualComponents" placeholder="Nhập đánh giá linh kiện" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="thVisualResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: center;">
                                <div>ENG: 
                                    <input type="text" id="thVisualEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="thVisualQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- COATING Process Section -->
            <div class="process-content" id="coating-process">
                <div class="form-section">
                    <div class="section-title">COATING PROCESS</div>
                    
                    <div class="sub-section-title">COATING</div>
                    <table>
                        <tr>
                            <th width="40%">THÔNG SỐ / PARAMETERS</th>
                            <th width="40%">GIÁ TRỊ / VALUE</th>
                            <th width="10%">KẾT QUẢ / RESULT</th>
                            <th width="10%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>- Dung dịch coating/ Coating solution:</td>
                            <td>
                                <input type="text" id="coatingSolution" placeholder="Nhập dung dịch coating" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="coatingSolutionResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td rowspan="5" style="text-align: center; vertical-align: middle;">
                                <div>ENG: 
                                    <input type="text" id="coatingEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 10px;">QC: 
                                    <input type="text" id="coatingQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>- Phương pháp coating/ Coating method:</td>
                            <td>
                                <input type="text" id="coatingMethod" placeholder="Nhập phương pháp coating" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="coatingMethodResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>- Phương pháp sấy/ Drying method:</td>
                            <td>
                                <input type="text" id="dryingMethod" placeholder="Nhập phương pháp sấy" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="dryingMethodResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>- Nhiệt độ sấy/ Drying temperature:</td>
                            <td>
                                <input type="text" id="dryingTemp" placeholder="VD: 80°C" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="dryingTempResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>- Thời gian sấy/ Drying time:</td>
                            <td>
                                <input type="text" id="dryingTime" placeholder="VD: 30 phút" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="dryingTimeResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- BOXBUILD Process Section -->
            <div class="process-content" id="boxbuild-process">
                <div class="form-section">
                    <div class="section-title">LẮP RÁP / BOXBUILD PROCESS</div>
                    
                    <!-- Assembly Jig/Tool -->
                    <div class="sub-section-title">LẮP RÁP BOXBUILD</div>
                    <table>
                        <tr>
                            <th width="40%">JIG/DỤNG CỤ LẮP RÁP / ASSEMBLY JIG OR TOOL</th>
                            <th width="30%">TIÊU CHUẨN / SPECIFICATION</th>
                            <th width="15%">KẾT QUẢ / RESULT</th>
                            <th width="15%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <input type="text" id="assemblyJig" placeholder="Nhập JIG/dụng cụ" style="width: 100%;" class="form-input">
                            </td>
                            <td>
                                <input type="text" id="assemblySpec" placeholder="Nhập tiêu chuẩn" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="assemblyJigResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: center;">
                                <div>ENG: 
                                    <input type="text" id="assemblyJigEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="assemblyJigQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Assembly Component -->
                    <div class="sub-section-title">SỐ LƯỢNG LINH KIỆN LẮP RÁP / ASSEMBLY COMPONENT QUANTITY</div>
                    <table>
                        <tr>
                            <th width="40%">SỐ LƯỢNG LINH KIỆN / COMPONENT QUANTITY</th>
                            <th width="30%">HƯỚNG/CHIỀU LẮP LINH KIỆN / COMPONENT ORIENTATION</th>
                            <th width="15%">KẾT QUẢ / RESULT</th>
                            <th width="15%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <input type="text" id="assemblyQty" placeholder="Nhập số lượng" style="width: 100%;" class="form-input">
                            </td>
                            <td>Theo bản vẽ/ According to the drawing</td>
                            <td style="text-align: center;">
                                <select id="assemblyQtyResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: center;">
                                <div>ENG: 
                                    <input type="text" id="assemblyQtyEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="assemblyQtyQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- IMEI/Label -->
                    <div class="sub-section-title">IMEI / LABEL</div>
                    <table>
                        <tr>
                            <th width="25%">VỊ TRÍ DÁN NHÃN / LABEL POSITION</th>
                            <th width="20%">HƯỚNG DÁN NHÃN / LABEL ORIENTATION</th>
                            <th width="35%">NỘI DUNG NHÃN / LABEL CONTENT</th>
                            <th width="10%">KẾT QUẢ / RESULT</th>
                            <th width="10%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <input type="text" id="labelPosition" placeholder="Nhập vị trí" style="width: 100%;" class="form-input">
                            </td>
                            <td>
                                <input type="text" id="labelOrientation" placeholder="Nhập hướng" style="width: 100%;" class="form-input">
                            </td>
                            <td>
                                <input type="text" id="labelContent" placeholder="Nhập nội dung" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="labelResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: center;">
                                <div>ENG: 
                                    <input type="text" id="labelEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="labelQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Visual Inspection -->
                    <div class="sub-section-title">KIỂM TRA NGOẠI QUAN / VISUAL INSPECTION</div>
                    <table>
                        <tr>
                            <th width="40%">TIÊU CHUẨN KIỂM TRA / INSPECTION REQUIREMENT</th>
                            <th width="40%">MÔ TẢ / DESCRIPTION</th>
                            <th width="10%">KẾT QUẢ / RESULT</th>
                            <th width="10%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <input type="text" id="boxInspectionReq" placeholder="Nhập tiêu chuẩn" style="width: 100%;" class="form-input">
                            </td>
                            <td>
                                <input type="text" id="boxInspectionDesc" placeholder="Nhập mô tả" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="boxInspectionResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: center;">
                                <div>ENG: 
                                    <input type="text" id="boxInspectionEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="boxInspectionQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- PACKAGING Process Section -->
            <div class="process-content" id="packaging-process">
                <div class="form-section">
                    <div class="section-title">ĐÓNG GÓI / PACKAGING PROCESS</div>
                    
                    <!-- Packaging -->
                    <div class="sub-section-title">ĐÓNG GÓI / PACKAGING</div>
                    <table>
                        <tr>
                            <th width="30%">VẬT LIỆU ĐÓNG GÓI / PACKAGING MATERIAL</th>
                            <th width="30%">PHƯƠNG PHÁP ĐÓNG GÓI / PACKAGING METHOD</th>
                            <th width="20%">SỐ LƯỢNG/THÙNG / QUANTITY PER BOX</th>
                            <th width="10%">KẾT QUẢ / RESULT</th>
                            <th width="10%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <div>- Theo BOM Đính kèm/ Attached BOM</div>
                                <div>- Bổ sung (nếu có)/ Additional (if any): 
                                    <input type="text" id="packagingMaterial" placeholder="Nhập bổ sung" style="width: 100%; margin-top: 5px;" class="form-input">
                                </div>
                            </td>
                            <td>
                                <input type="text" id="packagingMethod" placeholder="Nhập phương pháp" style="width: 100%;" class="form-input">
                            </td>
                            <td>
                                <input type="text" id="packagingQty" placeholder="Nhập số lượng" style="width: 100%;" class="form-input">
                            </td>
                            <td style="text-align: center;">
                                <select id="packagingResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: center;">
                                <div>ENG: 
                                    <input type="text" id="packagingEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="packagingQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                    
                    <!-- Label -->
                    <div class="sub-section-title">LABEL</div>
                    <table>
                        <tr>
                            <th width="40%">NỘI DUNG LABEL / LABEL CONTENT</th>
                            <th width="40%">MẪU HOẶC HÌNH ẢNH LABEL THỰC TẾ / ACTUAL IMAGE/SAMPLE</th>
                            <th width="10%">KẾT QUẢ / RESULT</th>
                            <th width="10%">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td>
                                <input type="text" id="packLabelContent" placeholder="Nhập nội dung label" style="width: 100%;" class="form-input">
                            </td>
                            <td>
                                <div>- Thêm hình ảnh hoặc mẫu thực tế vào ô này</div>
                                <div>- Add actual image in this box</div>
                                <textarea id="packLabelImage" placeholder="Mô tả hoặc link hình ảnh" rows="3" style="width: 100%; margin-top: 5px;" class="form-textarea"></textarea>
                            </td>
                            <td style="text-align: center;">
                                <select id="packLabelResult" style="width: 100%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="OK">OK</option>
                                    <option value="NG">NG</option>
                                </select>
                            </td>
                            <td style="text-align: center;">
                                <div>ENG: 
                                    <input type="text" id="packLabelEng" class="input-medium form-input" placeholder="Tên">
                                </div>
                                <div style="margin-top: 2px;">QC: 
                                    <input type="text" id="packLabelQc" class="input-medium form-input" placeholder="Tên">
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- CONCLUSION Section -->
            <div class="process-content" id="conclusion-process">
                <div class="form-section">
                    <div class="section-title">KẾT LUẬN / CONCLUSION</div>
                    
                    <table>
                        <tr>
                            <th width="20%">KẾT QUẢ CUỐI CÙNG / FINAL RESULT</th>
                            <th width="25%">RỦI RO TRONG CÁC CÔNG ĐOẠN / RISKS IN EACH PROCESS STEP</th>
                            <th width="25%">BÀI HỌC TỪNG CÔNG ĐOẠN / LESSONS LEARNED FROM EACH PROCESS STEP</th>
                            <th width="30%">CẢI TIẾN CÔNG ĐOẠN / PROCESS IMPROVEMENT</th>
                        </tr>
                        <tr>
                            <td style="text-align: center; vertical-align: middle;" class="conclusion-cell">
                                <select id="finalResult" style="width: 90%;" class="form-select">
                                    <option value="">-- Chọn --</option>
                                    <option value="PASS">PASS</option>
                                    <option value="FAIL">FAIL</option>
                                    <option value="CONDITIONAL">CONDITIONAL PASS</option>
                                </select>
                            </td>
                            <td class="conclusion-cell long-content-cell">
                                <textarea id="processRisks" placeholder="Rủi ro trong các công đoạn" rows="8" style="width: 100%; height: auto; min-height: 120px;" class="form-textarea long-content"></textarea>
                            </td>
                            <td class="conclusion-cell long-content-cell">
                                <textarea id="lessonsLearned" placeholder="Bài học từng công đoạn" rows="8" style="width: 100%; height: auto; min-height: 120px;" class="form-textarea long-content"></textarea>
                            </td>
                            <td class="conclusion-cell long-content-cell">
                                <textarea id="processImprovement" placeholder="Cải tiến công đoạn" rows="8" style="width: 100%; height: auto; min-height: 120px;" class="form-textarea long-content"></textarea>
                            </td>
                        </tr>
                    </table>
                    
                    <div class="form-row" style="margin-top: 15px;">
                        <div class="form-group">
                            <label for="totalQty">Tổng số lượng (PCBA): <br>Total qty (PCBA):</label>
                            <input type="number" id="totalQty" placeholder="Nhập tổng số lượng" class="form-input" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="okQty">OK :</label>
                            <input type="number" id="okQty" placeholder="Nhập số lượng OK" class="form-input" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="ngQty">NG (scrap) :</label>
                            <input type="number" id="ngQty" placeholder="Nhập số lượng NG" class="form-input" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="defectRate">Tỷ lệ lỗi/ Defect rate (%) : <br> (NG/Total)</label>
                            <input type="text" id="defectRate" placeholder="Tự động tính toán" readonly style="background-color: #f0f0f0;" class="form-input">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="defectDescription">Mô tả chi tiết lỗi / detailed defect description:</label>
                            <textarea id="defectDescription" placeholder="Mô tả chi tiết các lỗi" rows="4" style="width: 100%;" class="form-textarea long-content"></textarea>
                        </div>
                    </div>
                    
                    <!-- Electronic Signatures -->
                    <div class="sub-section-title">XÁC NHẬN ĐIỆN TỬ - ELECTRONIC SIGNATURES</div>
                    <div class="two-column" style="margin-top: 10px;">
                        <div class="signature-section">
                            <label>Ký xác nhận của Kỹ sư / Engineer Signature:</label>
                            <div class="signature-container">
                                <canvas id="engineerSignature" class="signature-pad no-export"></canvas>
                                <div class="signature-controls no-print no-export">
                                    <button type="button" id="clearEngineerSignature">Xóa chữ ký</button>
                                    <button type="button" id="saveEngineerSignature">Lưu chữ ký</button>
                                </div>
                                <div class="signature-display" id="engineerSignatureDisplay">
                                    <div style="padding: 10px; text-align: center;">Chữ ký sẽ hiển thị ở đây sau khi lưu</div>
                                </div>
                            </div>
                            <div style="margin-top: 5px;">
                                <label for="engineerName" class="inline-label">Tên Kỹ sư / Engineer Name:</label>
                                <input type="text" id="engineerName" placeholder="Nhập tên kỹ sư" style="width: 200px;" class="form-input">
                            </div>
                        </div>
                        
                        <div class="signature-section">
                            <label>Ký xác nhận của QC / QC Signature:</label>
                            <div class="signature-container">
                                <canvas id="qcSignature" class="signature-pad no-export"></canvas>
                                <div class="signature-controls no-print no-export">
                                    <button type="button" id="clearQcSignature">Xóa chữ ký</button>
                                    <button type="button" id="saveQcSignature">Lưu chữ ký</button>
                                </div>
                                <div class="signature-display" id="qcSignatureDisplay">
                                    <div style="padding: 10px; text-align: center;">Chữ ký sẽ hiển thị ở đây sau khi lưu</div>
                                </div>
                            </div>
                            <div style="margin-top: 5px;">
                                <label for="qcName" class="inline-label">Tên QC / QC Name:</label>
                                <input type="text" id="qcName" placeholder="Nhập tên QC" style="width: 200px;" class="form-input">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="footer">
                <p>NPI Record - Phiên bản Multi-User Real-time</p>
                <p>© 2024 - Đồng bộ thời gian thực với Firebase</p>
                <p style="font-size: 10px; color: #888;" id="dataInfo"></p>
            </div>
        </div>
    </div>

    <!-- PDF Template (ẩn) -->
    <div id="pdf-template" class="pdf-template">
        <!-- PDF content will be generated here -->
    </div>

    <script>
        // ========== CẤU HÌNH FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDtXBh4JBdUeLvzNKWp6VUNatdML871k8E",
            authDomain: "npi-record.firebaseapp.com",
            databaseURL: "https://npi-record-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "npi-record",
            storageBucket: "npi-record.appspot.com",
            messagingSenderId: "615504087682",
            appId: "1:615504087682:web:5a1a78fd56ea4f9714429b"
        };

        // ========== BIẾN TOÀN CỤC ==========
        let app;
        let database;
        let currentProjectId = null;
        let currentUser = null;
        let users = {};
        let isSaving = false;
        let lastSavedData = {};
        let userTimeout = null;
        let engineerSignaturePad = null;
        let qcSignaturePad = null;

        // ========== KHỞI TẠO FIREBASE ==========
        try {
            if (!firebase.apps.length) {
                app = firebase.initializeApp(firebaseConfig);
            } else {
                app = firebase.app();
            }
            database = firebase.database();
            console.log("✅ Firebase đã khởi tạo");
        } catch (error) {
            console.error("❌ Lỗi khởi tạo Firebase:", error);
            showToast("Không thể kết nối đến server", "error");
        }

        // ========== HÀM HIỂN THỊ THÔNG BÁO ==========
        function showToast(message, type = "success") {
            const toast = document.createElement("div");
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === "success" ? "check-circle" : type === "error" ? "exclamation-triangle" : "info-circle"}"></i>
                ${message}
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function showLoading(message) {
            document.getElementById("loadingMessage").textContent = message;
            document.getElementById("loadingOverlay").style.display = "flex";
        }

        function hideLoading() {
            document.getElementById("loadingOverlay").style.display = "none";
        }

        // ========== KHỞI TẠO NGƯỜI DÙNG ==========
        function initUser() {
            let savedUser = localStorage.getItem("npi_user");
            
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                console.log("👤 Đã load user:", currentUser.name);
            } else {
                const names = ["Kỹ sư", "QC", "Quản lý", "Chuyên viên"];
                const randomName = names[Math.floor(Math.random() * names.length)] + " " + Math.floor(Math.random() * 100);
                
                const colors = ["#FF5722", "#2196F3", "#4CAF50", "#FF9800", "#9C27B0", "#009688"];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                currentUser = {
                    id: "user_" + Math.random().toString(36).substr(2, 9),
                    name: randomName,
                    color: randomColor,
                    online: true,
                    lastActive: Date.now(),
                    editingField: null
                };
                
                localStorage.setItem("npi_user", JSON.stringify(currentUser));
                console.log("👤 Đã tạo user mới:", currentUser.name);
            }
            
            updateUserBadge();
        }

        function updateUserBadge() {
            const userCountEl = document.getElementById("userCount");
            if (userCountEl && currentUser) {
                userCountEl.innerHTML = `
                    <i class="fas fa-user" style="color: ${currentUser.color}"></i>
                    <span>${currentUser.name}</span>
                    <button id="changeNameBtn" style="background: transparent; border: none; color: white; cursor: pointer; margin-left: 5px; font-size: 10px;" title="Đổi tên">
                        <i class="fas fa-edit"></i>
                    </button>
                `;
                
                document.getElementById("changeNameBtn")?.addEventListener("click", changeUserName);
            }
        }

        function changeUserName() {
            const newName = prompt("Nhập tên hiển thị mới:", currentUser.name);
            if (newName && newName.trim() && newName !== currentUser.name) {
                currentUser.name = newName.trim();
                localStorage.setItem("npi_user", JSON.stringify(currentUser));
                updateUserBadge();
                
                if (currentProjectId && database) {
                    database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).update({
                        name: currentUser.name,
                        lastActive: Date.now()
                    });
                }
                
                showToast(`✅ Đã đổi tên thành: ${currentUser.name}`, "success");
            }
        }

        // ========== TẠO/THAM GIA PROJECT ==========
        async function handleProjectAction() {
            if (!database) {
                showToast("Chưa kết nối được Firebase", "error");
                return;
            }
            
            if (currentProjectId) {
                const confirmLeave = confirm(`Bạn đang trong project: ${currentProjectId}\n\nMuốn rời đi để tạo/tham gia project khác?`);
                if (!confirmLeave) return;
                
                await leaveCurrentProject();
                currentProjectId = null;
                document.getElementById("onlineUsersContainer").style.display = "none";
                updateStatus("Đã rời project", "offline");
            }
            
            const action = confirm(`Chọn hành động:\n\n• OK: Tạo project MỚI\n• Cancel: Tham gia project CÓ SẴN`);
            
            if (action === true) {
                await createNewProject();
            } else {
                await joinExistingProject();
            }
        }

        async function leaveCurrentProject() {
            if (currentProjectId && currentUser && database) {
                try {
                    await database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).update({
                        online: false,
                        lastActive: Date.now(),
                        editingField: null
                    });
                } catch (error) {
                    console.error("Lỗi rời project:", error);
                }
            }
        }

        async function createNewProject() {
            showLoading("Đang tạo project mới...");
            
            try {
                currentProjectId = "npi_" + Date.now().toString(36) + "_" + Math.random().toString(36).substr(2, 3).toUpperCase();
                
                if (!currentUser) initUser();
                
                const initialData = collectFormData();
                initialData._metadata = {
                    created: new Date().toISOString(),
                    createdBy: currentUser.id,
                    version: 1
                };
                
                await database.ref(`projects/${currentProjectId}`).set({
                    data: initialData,
                    users: {
                        [currentUser.id]: {
                            ...currentUser,
                            online: true,
                            lastActive: Date.now()
                        }
                    },
                    metadata: {
                        created: new Date().toISOString(),
                        createdBy: currentUser.name,
                        projectName: `NPI-${new Date().toLocaleDateString("vi-VN")}`
                    }
                });
                
                updateUrlWithProjectId();
                document.getElementById("projectIdDisplay").textContent = `ID: ${currentProjectId}`;
                document.getElementById("projectIdDisplay").title = "Click để copy ID";
                document.getElementById("onlineUsersContainer").style.display = "block";
                
                setupRealtimeListeners();
                updateShareLink();
                
                showToast(`✅ Đã tạo project: ${currentProjectId}`, "success");
                updateStatus("Đang đồng bộ thời gian thực", "online");
                
            } catch (error) {
                console.error("Lỗi tạo project:", error);
                showToast("❌ Lỗi tạo project: " + error.message, "error");
            } finally {
                hideLoading();
            }
        }

        async function joinExistingProject() {
            const projectId = prompt("Nhập ID project muốn tham gia:");
            if (!projectId || !projectId.trim()) {
                showToast("❌ Chưa nhập ID project", "error");
                return;
            }
            
            showLoading(`Đang tham gia project ${projectId}...`);
            
            try {
                const snapshot = await database.ref(`projects/${projectId}`).once("value");
                
                if (!snapshot.exists()) {
                    showToast("❌ Project không tồn tại!", "error");
                    hideLoading();
                    return;
                }
                
                currentProjectId = projectId;
                if (!currentUser) initUser();
                
                await database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).set({
                    ...currentUser,
                    online: true,
                    lastActive: Date.now()
                });
                
                updateUrlWithProjectId();
                document.getElementById("projectIdDisplay").textContent = `ID: ${currentProjectId}`;
                document.getElementById("projectIdDisplay").title = "Click để copy ID";
                document.getElementById("onlineUsersContainer").style.display = "block";
                
                setupRealtimeListeners();
                loadProjectData();
                
                showToast(`✅ Đã tham gia project ${projectId}`, "success");
                updateStatus("Đang đồng bộ thời gian thực", "online");
                
            } catch (error) {
                console.error("Lỗi tham gia project:", error);
                showToast("❌ Lỗi tham gia project: " + error.message, "error");
            } finally {
                hideLoading();
            }
        }

        // ========== REALTIME LISTENERS ==========
        function setupRealtimeListeners() {
            if (!currentProjectId || !database) return;
            
            console.log("👂 Đang lắng nghe thay đổi từ server...");
            
            // 1. Lắng nghe thay đổi dữ liệu form
            database.ref(`projects/${currentProjectId}/data`).on("value", (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    updateFormFromServer(data);
                }
            });
            
            // 2. Lắng nghe thay đổi danh sách user
            database.ref(`projects/${currentProjectId}/users`).on("value", (snapshot) => {
                if (snapshot.exists()) {
                    users = snapshot.val();
                    updateUsersDisplay();
                }
            });
            
            keepAlive();
            
            window.addEventListener("beforeunload", () => {
                if (currentProjectId && currentUser) {
                    database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).update({
                        online: false,
                        lastActive: Date.now(),
                        editingField: null
                    });
                }
            });
        }

        function keepAlive() {
            if (userTimeout) clearTimeout(userTimeout);
            
            userTimeout = setTimeout(() => {
                if (currentProjectId && currentUser && database) {
                    database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).update({
                        lastActive: Date.now(),
                        online: true
                    });
                    keepAlive();
                }
            }, 10000);
        }

        // ========== XỬ LÝ DỮ LIỆU FORM ==========
        function collectFormData() {
            const data = {};
            
            document.querySelectorAll("input, textarea, select").forEach(element => {
                if (element.id && element.id !== "") {
                    if (element.type === "checkbox") {
                        data[element.id] = element.checked;
                    } else if (element.type === "radio") {
                        if (element.checked) data[element.name] = element.value;
                    } else {
                        data[element.id] = element.value;
                    }
                }
            });
            
            const engineerSig = localStorage.getItem("engineer_signature");
            const qcSig = localStorage.getItem("qc_signature");
            if (engineerSig) data._engineerSignature = engineerSig;
            if (qcSig) data._qcSignature = qcSig;
            
            return data;
        }

        function updateFormFromServer(serverData) {
            if (isSaving) return;
            
            const formData = {...serverData};
            delete formData._metadata;
            delete formData._lastUpdated;
            delete formData._lastUpdatedBy;
            
            let changedCount = 0;
            
            Object.keys(formData).forEach(fieldId => {
                if (fieldId.startsWith("_")) {
                    if (fieldId === "_engineerSignature" && formData[fieldId]) {
                        localStorage.setItem("engineer_signature", formData[fieldId]);
                        const engDisplay = document.getElementById("engineerSignatureDisplay");
                        if (engDisplay) {
                            engDisplay.innerHTML = `<img src="${formData[fieldId]}" alt="Engineer Signature" style="max-width: 100%; max-height: 70px;">`;
                            engDisplay.classList.add("has-signature");
                        }
                    }
                    if (fieldId === "_qcSignature" && formData[fieldId]) {
                        localStorage.setItem("qc_signature", formData[fieldId]);
                        const qcDisplay = document.getElementById("qcSignatureDisplay");
                        if (qcDisplay) {
                            qcDisplay.innerHTML = `<img src="${formData[fieldId]}" alt="QC Signature" style="max-width: 100%; max-height: 70px;">`;
                            qcDisplay.classList.add("has-signature");
                        }
                    }
                    return;
                }
                
                const field = document.getElementById(fieldId);
                if (field) {
                    const serverValue = formData[fieldId];
                    const currentValue = field.type === "checkbox" ? field.checked : field.value;
                    
                    if (serverValue !== currentValue) {
                        const isCurrentlyEditing = (field === document.activeElement);
                        
                        if (!isCurrentlyEditing) {
                            if (field.type === "checkbox") {
                                field.checked = Boolean(serverValue);
                            } else {
                                field.value = serverValue || "";
                            }
                            
                            updateHighlight(field);
                            changedCount++;
                            showFieldUpdateEffect(field);
                        }
                    }
                }
            });
            
            if (changedCount > 0) {
                showTypingNotification(changedCount);
            }
            
            lastSavedData = {...formData};
            calculateDefectRate();
        }

        function showFieldUpdateEffect(field) {
            field.classList.add("field-updated");
            setTimeout(() => {
                field.classList.remove("field-updated");
            }, 1000);
        }

        function showTypingNotification(count) {
            let notification = document.getElementById("typing-notification");
            if (!notification) {
                notification = document.createElement("div");
                notification.id = "typing-notification";
                notification.className = "typing-indicator";
                document.body.appendChild(notification);
            }
            
            notification.textContent = `🔄 ${count} trường được cập nhật từ người khác`;
            notification.style.display = "block";
            
            setTimeout(() => {
                notification.style.display = "none";
            }, 2000);
        }

        // ========== CẬP NHẬT GIAO DIỆN NGƯỜI DÙNG ==========
        function updateUsersDisplay() {
            const usersListEl = document.getElementById("usersList");
            const onlineCountEl = document.getElementById("onlineUsersCount");
            
            if (!usersListEl || !onlineCountEl) return;
            
            const now = Date.now();
            const onlineUsers = Object.values(users).filter(user => 
                user.online || (now - user.lastActive < 30000)
            );
            
            onlineCountEl.textContent = `${onlineUsers.length} người online`;
            usersListEl.innerHTML = "";
            
            onlineUsers.forEach(user => {
                const userEl = document.createElement("div");
                userEl.className = `user-badge ${user.editingField ? "editing" : ""}`;
                userEl.style.borderLeft = `3px solid ${user.color}`;
                
                userEl.innerHTML = `
                    <div class="status-dot" style="background: ${user.color}"></div>
                    <div class="user-avatar" style="background: ${user.color}">
                        ${user.name.charAt(0).toUpperCase()}
                    </div>
                    <span>${user.name}</span>
                    ${user.id === currentUser?.id ? '<span style="font-size:9px;">(bạn)</span>' : ""}
                    ${user.editingField ? `<span style="font-size:9px; margin-left:5px;">✏️</span>` : ""}
                `;
                
                userEl.title = `${user.name}\n${user.editingField ? `Đang nhập: ${user.editingField}` : "Đang online"}`;
                usersListEl.appendChild(userEl);
            });
            
            updateEditingHighlights();
        }

        function updateEditingHighlights() {
            document.querySelectorAll(".field-being-edited").forEach(field => {
                field.classList.remove("field-being-edited");
                field.removeAttribute("data-editor");
            });
            
            Object.values(users).forEach(user => {
                if (user.editingField && user.id !== currentUser?.id) {
                    const field = document.getElementById(user.editingField);
                    if (field) {
                        field.classList.add("field-being-edited");
                        field.setAttribute("data-editor", user.name);
                    }
                }
            });
        }

        // ========== XỬ LÝ INPUT THỜI GIAN THỰC ==========
        function setupRealTimeInput() {
            let debounceTimer;
            
            document.querySelectorAll("input, textarea, select").forEach(field => {
                field.addEventListener("focus", function() {
                    if (currentProjectId && currentUser) {
                        currentUser.editingField = this.id;
                        updateUserEditingStatus(this.id);
                    }
                });
                
                field.addEventListener("input", function() {
                    clearTimeout(debounceTimer);
                    
                    if (currentProjectId && currentUser) {
                        saveFieldToServer(this.id, this.type === "checkbox" ? this.checked : this.value);
                        
                        debounceTimer = setTimeout(() => {
                            saveFieldToServer(this.id, this.type === "checkbox" ? this.checked : this.value);
                        }, 200);
                    }
                    
                    updateHighlight(this);
                    
                    if (this.id === "totalQty" || this.id === "ngQty" || this.id === "okQty") {
                        calculateDefectRate();
                    }
                });
                
                field.addEventListener("change", function() {
                    if (currentProjectId && currentUser) {
                        saveFieldToServer(this.id, this.type === "checkbox" ? this.checked : this.value);
                    }
                    updateHighlight(this);
                });
                
                field.addEventListener("blur", function() {
                    if (currentProjectId && currentUser) {
                        currentUser.editingField = null;
                        updateUserEditingStatus(null);
                    }
                });
                
                if (field.tagName === 'INPUT' || field.tagName === 'TEXTAREA') {
                    field.addEventListener('keyup', function() {
                        if (currentProjectId && currentUser) {
                            updateUserEditingStatus(this.id);
                        }
                    });
                }
            });
        }

        async function saveFieldToServer(fieldId, value) {
            if (!currentProjectId || !database || isSaving) return;
            
            isSaving = true;
            
            try {
                await database.ref(`projects/${currentProjectId}/data/${fieldId}`).set(value);
                await database.ref(`projects/${currentProjectId}/data/_lastUpdated`).set(new Date().toISOString());
                await database.ref(`projects/${currentProjectId}/data/_lastUpdatedBy`).set(currentUser?.id || "unknown");
                
                lastSavedData[fieldId] = value;
                
            } catch (error) {
                console.error("Lỗi lưu field:", error);
                showToast("❌ Lỗi đồng bộ dữ liệu", "error");
            } finally {
                setTimeout(() => { isSaving = false; }, 50);
            }
        }

        async function updateUserEditingStatus(fieldId) {
            if (!currentProjectId || !currentUser || !database) return;
            
            try {
                await database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).update({
                    editingField: fieldId,
                    lastActive: Date.now()
                });
            } catch (error) {
                console.error("Lỗi cập nhật trạng thái editing:", error);
            }
        }

        // ========== HIGHLIGHT DỮ LIỆU ==========
        function updateHighlight(element) {
            if (!element) return;
            
            const hasData = element.type === "checkbox" 
                ? element.checked
                : element.type === "select-one"
                ? element.value && element.value !== ""
                : element.value && element.value.trim() !== "";
            
            if (hasData) {
                element.classList.add("has-data");
                const row = element.closest("tr");
                if (row) row.classList.add("highlight-row");
            } else {
                element.classList.remove("has-data");
                const row = element.closest("tr");
                if (row) row.classList.remove("highlight-row");
            }
        }

        function calculateDefectRate() {
            const total = parseInt(document.getElementById("totalQty").value) || 0;
            const ng = parseInt(document.getElementById("ngQty").value) || 0;
            
            let rate = 0;
            if (total > 0) {
                rate = (ng / total) * 100;
            }
            
            document.getElementById("defectRate").value = rate.toFixed(2) + "%";
            updateHighlight(document.getElementById("defectRate"));
        }

        // ========== URL & SHARING ==========
        function updateUrlWithProjectId() {
            if (!currentProjectId) return;
            
            const url = new URL(window.location);
            url.searchParams.set("project", currentProjectId);
            window.history.pushState({}, "", url);
        }

        function updateShareLink() {
            if (!currentProjectId) return "";
            
            const shareUrl = `${window.location.origin}${window.location.pathname}?project=${currentProjectId}`;
            document.getElementById("shareLinkText").textContent = shareUrl;
            
            return shareUrl;
        }

        // ========== LOAD DỮ LIỆU TỪ SERVER ==========
        async function loadProjectData() {
            if (!currentProjectId || !database) return;
            
            showLoading("Đang tải dữ liệu...");
            
            try {
                const snapshot = await database.ref(`projects/${currentProjectId}/data`).once("value");
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    updateFormFromServer(data);
                    showToast("✅ Đã tải dữ liệu từ server", "success");
                }
            } catch (error) {
                console.error("Lỗi tải dữ liệu:", error);
                showToast("❌ Lỗi tải dữ liệu từ server", "error");
            } finally {
                hideLoading();
            }
        }

        // ========== HÀM LƯU TOÀN BỘ ==========
        async function saveAllToCloud() {
            if (!currentProjectId) {
                showToast("❌ Chưa có project! Hãy tạo hoặc tham gia project trước.", "error");
                return false;
            }
            
            showLoading("Đang lưu toàn bộ dữ liệu...");
            
            try {
                const formData = collectFormData();
                formData._lastUpdated = new Date().toISOString();
                formData._lastUpdatedBy = currentUser?.id || "unknown";
                
                await database.ref(`projects/${currentProjectId}/data`).set(formData);
                
                showToast("✅ Đã lưu toàn bộ dữ liệu!", "success");
                return true;
                
            } catch (error) {
                console.error("Lỗi lưu toàn bộ:", error);
                showToast("❌ Lỗi lưu dữ liệu: " + error.message, "error");
                return false;
            } finally {
                hideLoading();
            }
        }

        // ========== CHỨC NĂNG CHIA SẺ ==========
        function generateShareLink() {
            if (!currentProjectId) {
                showToast("❌ Chưa có project! Hãy tạo hoặc tham gia project trước.", "error");
                return;
            }
            
            const shareUrl = updateShareLink();
            document.getElementById("shareLinkContainer").style.display = "block";
            
            navigator.clipboard.writeText(shareUrl).then(() => {
                showToast("✅ Đã copy link vào clipboard!", "success");
            }).catch(() => {
                const tempInput = document.createElement("input");
                tempInput.value = shareUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand("copy");
                document.body.removeChild(tempInput);
                showToast("✅ Đã copy link vào clipboard!", "success");
            });
        }

        function copyShareLink() {
            const shareUrl = document.getElementById("shareLinkText").textContent;
            if (shareUrl && shareUrl.trim() !== "") {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showToast("✅ Đã copy link vào clipboard!", "success");
                }).catch(() => {
                    const tempInput = document.createElement("input");
                    tempInput.value = shareUrl;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand("copy");
                    document.body.removeChild(tempInput);
                    showToast("✅ Đã copy link vào clipboard!", "success");
                });
            } else {
                showToast("❌ Chưa có link chia sẻ!", "error");
            }
        }

        function hideShareLink() {
            document.getElementById("shareLinkContainer").style.display = "none";
        }

        // ========== CHỮ KÝ ĐIỆN TỬ ==========
        function setupSignaturePads() {
            const engineerCanvas = document.getElementById("engineerSignature");
            if (engineerCanvas) {
                engineerSignaturePad = new SignaturePad(engineerCanvas, {
                    backgroundColor: "rgb(255, 255, 255)",
                    penColor: "rgb(0, 0, 0)"
                });
                
                document.getElementById("clearEngineerSignature").addEventListener("click", function() {
                    engineerSignaturePad.clear();
                    localStorage.removeItem("engineer_signature");
                    document.getElementById("engineerSignatureDisplay").innerHTML = '<div style="padding: 10px; text-align: center;">Chữ ký sẽ hiển thị ở đây sau khi lưu</div>';
                    document.getElementById("engineerSignatureDisplay").classList.remove("has-signature");
                    showToast("Đã xóa chữ ký kỹ sư", "info");
                    
                    if (currentProjectId && database) {
                        database.ref(`projects/${currentProjectId}/data/_engineerSignature`).remove();
                    }
                });
                
                document.getElementById("saveEngineerSignature").addEventListener("click", function() {
                    if (!engineerSignaturePad.isEmpty()) {
                        const dataURL = engineerSignaturePad.toDataURL();
                        localStorage.setItem("engineer_signature", dataURL);
                        
                        const displayDiv = document.getElementById("engineerSignatureDisplay");
                        displayDiv.innerHTML = `<img src="${dataURL}" alt="Engineer Signature" style="max-width: 100%; max-height: 70px;">`;
                        displayDiv.classList.add("has-signature");
                        
                        if (currentProjectId && database) {
                            database.ref(`projects/${currentProjectId}/data/_engineerSignature`).set(dataURL);
                        }
                        
                        showToast("✅ Đã lưu chữ ký kỹ sư!", "success");
                        updateHighlight(document.getElementById("engineerName"));
                    } else {
                        showToast("❌ Vui lòng ký trước khi lưu!", "error");
                    }
                });
                
                const savedEngineerSig = localStorage.getItem("engineer_signature");
                if (savedEngineerSig) {
                    document.getElementById("engineerSignatureDisplay").innerHTML = `<img src="${savedEngineerSig}" alt="Engineer Signature" style="max-width: 100%; max-height: 70px;">`;
                    document.getElementById("engineerSignatureDisplay").classList.add("has-signature");
                }
            }
            
            const qcCanvas = document.getElementById("qcSignature");
            if (qcCanvas) {
                qcSignaturePad = new SignaturePad(qcCanvas, {
                    backgroundColor: "rgb(255, 255, 255)",
                    penColor: "rgb(0, 0, 0)"
                });
                
                document.getElementById("clearQcSignature").addEventListener("click", function() {
                    qcSignaturePad.clear();
                    localStorage.removeItem("qc_signature");
                    document.getElementById("qcSignatureDisplay").innerHTML = '<div style="padding: 10px; text-align: center;">Chữ ký sẽ hiển thị ở đây sau khi lưu</div>';
                    document.getElementById("qcSignatureDisplay").classList.remove("has-signature");
                    showToast("Đã xóa chữ ký QC", "info");
                    
                    if (currentProjectId && database) {
                        database.ref(`projects/${currentProjectId}/data/_qcSignature`).remove();
                    }
                });
                
                document.getElementById("saveQcSignature").addEventListener("click", function() {
                    if (!qcSignaturePad.isEmpty()) {
                        const dataURL = qcSignaturePad.toDataURL();
                        localStorage.setItem("qc_signature", dataURL);
                        
                        const displayDiv = document.getElementById("qcSignatureDisplay");
                        displayDiv.innerHTML = `<img src="${dataURL}" alt="QC Signature" style="max-width: 100%; max-height: 70px;">`;
                        displayDiv.classList.add("has-signature");
                        
                        if (currentProjectId && database) {
                            database.ref(`projects/${currentProjectId}/data/_qcSignature`).set(dataURL);
                        }
                        
                        showToast("✅ Đã lưu chữ ký QC!", "success");
                        updateHighlight(document.getElementById("qcName"));
                    } else {
                        showToast("❌ Vui lòng ký trước khi lưu!", "error");
                    }
                });
                
                const savedQcSig = localStorage.getItem("qc_signature");
                if (savedQcSig) {
                    document.getElementById("qcSignatureDisplay").innerHTML = `<img src="${savedQcSig}" alt="QC Signature" style="max-width: 100%; max-height: 70px;">`;
                    document.getElementById("qcSignatureDisplay").classList.add("has-signature");
                }
            }
        }


// ========== XUẤT PDF GIỐNG FILE MẪU ==========
async function exportToPDF() {
    if (!validateForm()) {
        showToast('Vui lòng điền đầy đủ các trường bắt buộc (Mã hàng và Khách hàng) trước khi xuất PDF!', 'error');
        return;
    }
    
    showLoading("Đang tạo PDF... Vui lòng đợi...");
    
    try {
        // 1. Thu thập tất cả dữ liệu
        const allData = collectFormData();
        const processes = [];
        if (allData.processSMT) processes.push('SMT');
        if (allData.processThroughHole) processes.push('THROUGH HOLE');
        if (allData.processCoating) processes.push('COATING');
        if (allData.processBoxbuild) processes.push('BOXBUILD');
        if (allData.processPacking) processes.push('PACKING');
        
        // 2. Tạo nội dung PDF
        const pdfContent = createPDFContent(allData, processes);
        
        // 3. Tạo HTML đầy đủ cho tất cả các tab
        const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>NPI Record - ${allData.model || 'Unknown'}</title>
            <style>
                @page {
                    size: A4;
                    margin: 15mm;
                }
                
                body {
                    font-family: Arial, sans-serif;
                    font-size: 10pt;
                    line-height: 1.2;
                    color: #000;
                    margin: 0;
                    padding: 0;
                    width: 210mm;
                }
                
                .page-container {
                    width: 210mm;
                    min-height: 297mm;
                    padding: 15mm;
                    box-sizing: border-box;
                }
                
                .header {
                    text-align: center;
                    margin-bottom: 15px;
                    border-bottom: 2px solid #000;
                    padding-bottom: 10px;
                }
                
                .header h1 {
                    margin-bottom: 5px;
                    font-size: 18pt;
                    font-weight: bold;
                }
                
                .form-section {
                    border: 1px solid #000;
                    border-radius: 2px;
                    padding: 10px;
                    margin-bottom: 15px;
                    page-break-inside: avoid;
                }
                
                .section-title {
                    background-color: #e0e0e0;
                    color: #000;
                    padding: 8px 10px;
                    margin: -10px -10px 10px -10px;
                    border-bottom: 1px solid #000;
                    font-size: 12pt;
                    font-weight: bold;
                }
                
                .sub-section-title {
                    background-color: #f0f0f0;
                    color: #000;
                    padding: 6px 8px;
                    margin: 10px -10px;
                    border-top: 1px solid #ddd;
                    border-bottom: 1px solid #ddd;
                    font-size: 11pt;
                    font-weight: bold;
                }
                
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 10px 0;
                    font-size: 9pt;
                }
                
                th, td {
                    border: 1px solid #000;
                    padding: 4px;
                    vertical-align: top;
                }
                
                th {
                    background-color: #f0f0f0;
                    font-weight: bold;
                    text-align: center;
                }
                
                .highlight {
                    color: #1565C0 !important;
                    font-weight: normal !important;
                    background-color: #E3F2FD !important;
                }
                
                .highlight-box {
                    border-left: 3px solid #1565C0;
                    padding: 3px 6px;
                    margin: 1px 0;
                }
                
                .signature-container {
                    border: 2px solid #1565C0;
                    padding: 8px;
                    text-align: center;
                    min-height: 80px;
                    margin: 10px 0;
                }
                
                .signature-img {
                    max-width: 100%;
                    max-height: 70px;
                }
                
                /* FIX CHO PHẦN KẾT LUẬN - GIẢI PHÁP TRIỆT ĐỂ */
                .conclusion-table {
                    width: 100%;
                    border-collapse: collapse;
                    table-layout: fixed !important;
                }
                
                .conclusion-table th {
                    padding: 6px 3px !important;
                    font-size: 8.5pt !important;
                    height: 40px !important;
                    vertical-align: middle !important;
                    word-break: break-word !important;
                }
                
                .conclusion-table td {
                    height: 120px !important;
                    max-height: 120px !important;
                    vertical-align: top !important;
                    padding: 3px !important;
                    overflow: hidden !important;
                    word-wrap: break-word !important;
                    word-break: break-all !important; /* THÊM DÒNG NÀY */
                }
                
                /* CỐ ĐỊNH ĐỘ RỘNG CỘT - QUAN TRỌNG */
                .conclusion-table td:nth-child(1) { width: 18% !important; min-width: 18% !important; max-width: 18% !important; }
                .conclusion-table td:nth-child(2) { width: 27% !important; min-width: 27% !important; max-width: 27% !important; }
                .conclusion-table td:nth-child(3) { width: 27% !important; min-width: 27% !important; max-width: 27% !important; }
                .conclusion-table td:nth-child(4) { width: 28% !important; min-width: 28% !important; max-width: 28% !important; }
                
                .conclusion-table th:nth-child(1) { width: 18% !important; min-width: 18% !important; max-width: 18% !important; }
                .conclusion-table th:nth-child(2) { width: 27% !important; min-width: 27% !important; max-width: 27% !important; }
                .conclusion-table th:nth-child(3) { width: 27% !important; min-width: 27% !important; max-width: 27% !important; }
                .conclusion-table th:nth-child(4) { width: 28% !important; min-width: 28% !important; max-width: 28% !important; }
                
                /* Container bên trong */
                .conclusion-content {
                    font-size: 7pt !important; /* RẤT NHỎ */
                    line-height: 1.0 !important; /* KHÔNG CÓ KHOẢNG CÁCH */
                    margin: 0 !important;
                    padding: 1px 2px !important;
                    word-wrap: break-word !important;
                    word-break: break-all !important; /* BUỘC NGẮT CHỮ */
                    overflow: hidden !important;
                    display: block !important;
                    width: 100% !important;
                    height: 114px !important;
                    max-height: 114px !important;
                    overflow-y: hidden !important;
                    white-space: normal !important;
                    font-weight: normal !important;
                }
                
                /* Ô kết quả cuối cùng */
                .conclusion-result {
                    font-size: 9pt !important;
                    font-weight: bold !important;
                    text-align: center !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    height: 100% !important;
                    width: 100% !important;
                }
                
                .page-break {
                    page-break-before: always;
                }
                
                .no-print {
                    display: none !important;
                }
            </style>
        </head>
        <body>
            <div class="page-container">
                ${pdfContent}
            </div>
        </body>
        </html>
        `;
        
        // 4. Mở cửa sổ mới và in
        const printWindow = window.open('', '_blank', 'width=900,height=700');
        printWindow.document.open();
        printWindow.document.write(htmlContent);
        printWindow.document.close();
        
        // 5. Chờ nội dung tải xong rồi kích hoạt in
        setTimeout(() => {
            printWindow.focus();
            printWindow.print();
            
            // Tự động đóng sau khi in (tùy chọn)
            setTimeout(() => {
                if (!printWindow.closed) {
                    printWindow.close();
                }
            }, 1000);
            
            showToast("✅ PDF đã sẵn sàng để in!", "success");
            hideLoading();
        }, 500);
        
    } catch (error) {
        console.error("Lỗi xuất PDF:", error);
        showToast("❌ Lỗi xuất PDF: " + error.message, "error");
        hideLoading();
    }
}

// HÀM XỬ LÝ TEXT DÀI - CHIA THÀNH TỪNG ĐOẠN NGẮN
function splitTextForPDF(text, maxLineLength = 25, maxLines = 20) {
    if (!text || !text.trim()) return '';
    
    // Loại bỏ khoảng trắng thừa
    const cleanText = text.trim().replace(/\s+/g, ' ');
    
    // Nếu text quá ngắn, trả về luôn
    if (cleanText.length <= maxLineLength * 3) {
        return cleanText;
    }
    
    // Chia text thành các đoạn ngắn
    const chunks = [];
    let currentChunk = '';
    
    for (let i = 0; i < cleanText.length; i++) {
        currentChunk += cleanText[i];
        
        // Nếu đủ độ dài hoặc gặp dấu cách
        if (currentChunk.length >= maxLineLength && 
            (cleanText[i] === ' ' || i === cleanText.length - 1)) {
            chunks.push(currentChunk.trim());
            currentChunk = '';
        }
    }
    
    // Thêm phần còn lại
    if (currentChunk.trim()) {
        chunks.push(currentChunk.trim());
    }
    
    // Giới hạn số dòng
    if (chunks.length > maxLines) {
        return chunks.slice(0, maxLines).join(' ') + '...';
    }
    
    return chunks.join(' ');
}

// HÀM XỬ LÝ TEXT CÓ CHỮ DÀI LIÊN TIẾP (NHƯ ZZZZZZZZZZ)
function processLongContinuousText(text, maxCharsPerLine = 15) {
    if (!text || !text.trim()) return '';
    
    const result = [];
    const cleanText = text.trim();
    
    // Phân tích text để tìm chuỗi ký tự liên tục
    let currentLine = '';
    let consecutiveCount = 0;
    
    for (let i = 0; i < cleanText.length; i++) {
        currentLine += cleanText[i];
        consecutiveCount++;
        
        // Nếu gặp khoảng trắng hoặc đủ độ dài
        if (cleanText[i] === ' ' || consecutiveCount >= maxCharsPerLine || i === cleanText.length - 1) {
            result.push(currentLine);
            currentLine = '';
            consecutiveCount = 0;
        }
    }
    
    return result.join(' ');
}

// Hàm tạo nội dung PDF từ tất cả dữ liệu
function createPDFContent(data, processes) {
    // XỬ LÝ TEXT ĐẶC BIỆT CHO CONCLUSION
    const risksText = splitTextForPDF(data.processRisks || '', 20, 25);
    const lessonsText = splitTextForPDF(data.lessonsLearned || '', 20, 25);
    const improvementText = splitTextForPDF(data.processImprovement || '', 20, 25);
    const defectText = splitTextForPDF(data.defectDescription || '', 30, 10);
    
    // Hàm helper để highlight dữ liệu
    function highlight(value) {
        if (value && value.toString().trim() !== '') {
            return value.toString();
        }
        return value || '';
    }
    
    function highlightTextarea(value) {
        if (value && value.trim() !== '') {
            const processed = splitTextForPDF(value, 30, 8);
            return `<div class="highlight highlight-box">${processed}</div>`;
        }
        return '';
    }
    
    function highlightSelect(value) {
        if (value && value !== '') {
            return `<span class="highlight" style="display: inline-block; padding: 2px 6px;">${value}</span>`;
        }
        return '';
    }
    
    // Format date
    function formatDate(dateStr) {
        if (!dateStr) return '';
        try {
            const date = new Date(dateStr);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        } catch {
            return dateStr;
        }
    }
    
    // Bắt đầu xây dựng nội dung
    let content = `
    <!-- Header -->
    <div class="header" style="display:flex; align-items:center; border-bottom:1px solid #000; padding-bottom:8px;">

    <!-- LOGO TRÁI -->
    <img src="logo.png"
         alt="Logo"
         style="height:60px; margin-right:15px;">

    <!-- TIÊU ĐỀ -->
    <div style="text-align:center; flex:1;">
        <h1 style="margin:0;">BIỂU GHI NPI - NPI RECORD</h1>
        <div style="font-size:12px; margin-top:4px;">
            TNEMS-EN-F-048-NPI RECORD-VER03
        </div>
    </div>

</div>


    
    <!-- Product Information -->
    <div class="form-section">
        <div class="section-title">THÔNG TIN SẢN PHẨM - PRODUCT INFORMATION</div>
        
        <table>
            <tr>
                <td width="25%" style="font-weight: bold;">MÃ HÀNG / MODEL:</td>
                <td width="35%">${highlight(data.model)}</td>
                <td width="20%" style="font-weight: bold;">Part No:</td>
                <td width="20%">${highlight(data.partNo)}</td>
            </tr>
            <tr>
                <td style="font-weight: bold;">KHÁCH HÀNG / CUSTOMER:</td>
                <td>${highlight(data.customer)}</td>
                <td style="font-weight: bold;">Ngày / Date:</td>
                <td>${highlight(formatDate(data.date))}</td>
            </tr>
        </table>
        
        <div style="margin-top: 10px;">
            <span style="font-weight: bold;">Quy trình / Process:</span>
            <div style="margin-top: 5px;">
                ${processes.length > 0 ? highlight(processes.join(', ')) : ''}
            </div>
        </div>
    </div>`;
    
    // SMT Process
    if (processes.includes('SMT')) {
        content += `
        <div class="form-section">
            <div class="section-title">SMT PROCESS</div>
            
            <!-- LASER MARKING -->
            <div class="sub-section-title">LASER MARKING</div>
            <table>
                <tr>
                    <th width="30%">NỘI DUNG</th>
                    <th width="70%">GIÁ TRỊ</th>
                </tr>
                <tr>
                    <td>Tên chương trình/ Program name</td>
                    <td>${highlight(data.laserProgram)}</td>
                </tr>
                <tr>
                    <td>Loại QR code/ QR code type</td>
                    <td>${highlight(data.qrType)}</td>
                </tr>
                <tr>
                    <td>Kích thước QR code/ QR code size</td>
                    <td>${highlight(data.qrSize)}</td>
                </tr>
                <tr>
                    <td>Cường độ khắc/ Engraving intensity</td>
                    <td>${highlight(data.engravingIntensity)}</td>
                </tr>
                <tr>
                    <td>Side BOT: Nội dung QR code/ QR code content</td>
                    <td>${highlightTextarea(data.qrContentBot)}</td>
                </tr>
                <tr>
                    <td>Side TOP: Nội dung QR code/ QR code content</td>
                    <td>${highlightTextarea(data.qrContentTop)}</td>
                </tr>
                <tr>
                    <td>Nội dung QR code khi quét bằng máy</td>
                    <td>${highlightTextarea(data.qrScanContent)}</td>
                </tr>
            </table>
            
            <!-- PRINTER -->
            <div class="sub-section-title">PRINTER</div>
            <div style="padding: 5px;">
                ${highlight(data.printerControl)}
            </div>
            
            <!-- VISUAL INSPECTION 1 -->
            <div class="sub-section-title">NGOẠI QUAN VISUAL INSPECTION</div>
            <table>
                <tr>
                    <th width="40%">HƯỚNG LINH KIỆN/COMPONENT POLARITY</th>
                    <th width="30%">SỐ LƯỢNG LINH KIỆN/COMPONENT QUANTITY</th>
                    <th width="15%">KẾT QUẢ/RESULT</th>
                    <th width="15%">XÁC NHẬN/VERIFY</th>
                </tr>
                <tr>
                    <td>Theo bảng hướng linh kiện đính kèm (QC)</td>
                    <td>
                        <div>Theo BOM/ According to the BOM: ${highlight(data.bomQty)}</div>
                        <div style="margin-top: 3px;">Thực tế/ Reality: ${highlight(data.actualQty)}</div>
                    </td>
                    <td style="text-align: center;">${highlightSelect(data.visualResult1)}</td>
                    <td style="text-align: center;">
                        <div style="font-size: 8.5pt;">ENG: ${highlight(data.engVerify1)}</div>
                        <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.qcVerify1)}</div>
                    </td>
                </tr>
            </table>
            
            <!-- REFLOW OVEN -->
            <div class="sub-section-title">LÒ REFLOW/REFLOW OVEN</div>
            <table>
                <tr>
                    <th width="30%">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                    <th width="40%">THÔNG SỐ CÀI ĐẶT MÁY/MACHINE PARAMETERS SETTING</th>
                    <th width="15%">KẾT QUẢ/RESULT</th>
                    <th width="15%">XÁC NHẬN/VERIFY</th>
                </tr>
                <tr>
                    <td>- Theo Process control sheet đính kèm<br>- Profile lò đính kèm</td>
                    <td>${highlightTextarea(data.reflowParams)}</td>
                    <td style="text-align: center;">${highlightSelect(data.reflowResult)}</td>
                    <td style="text-align: center;">
                        <div style="font-size: 8.5pt;">ENG: ${highlight(data.reflowEng)}</div>
                        <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.reflowQc)}</div>
                    </td>
                </tr>
            </table>
        </div>`;
    }
    
    // Through-Hole Process
    if (processes.includes('THROUGH HOLE')) {
        content += `
        <div class="form-section">
            <div class="section-title">THROUGH-HOLE PROCESS</div>
            
            <!-- Component Quantity Check -->
            <div class="sub-section-title">KIỂM TRA SỐ LƯỢNG LINH KIỆN / COMPONENT QUANTITY CHECK</div>
            <table>
                <tr>
                    <th width="40%">NỘI DUNG KIỂM TRA/INSPECTION CONTENT</th>
                    <th width="30%">GIÁ TRỊ/VALUE</th>
                    <th width="15%">KẾT QUẢ/RESULT</th>
                    <th width="15%">XÁC NHẬN/VERIFY</th>
                </tr>
                <tr>
                    <td>ĐÚNG MÃ / CORRECT PART NUMBER</td>
                    <td>${highlight(data.thPartNumber)}</td>
                    <td style="text-align: center;">${highlightSelect(data.thPartNumberResult)}</td>
                    <td style="text-align: center;">
                        <div style="font-size: 8.5pt;">ENG: ${highlight(data.thQuantityEng)}</div>
                        <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.thQuantityQc)}</div>
                    </td>
                </tr>
                <tr>
                    <td>SỐ LƯỢNG / QUANTITY</td>
                    <td>${highlight(data.thQuantity)}</td>
                    <td style="text-align: center;">${highlightSelect(data.thQuantityResult)}</td>
                    <td style="text-align: center;">
                        <div style="font-size: 8.5pt;">ENG: ${highlight(data.thQuantityEng2)}</div>
                        <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.thQuantityQc2)}</div>
                    </td>
                </tr>
            </table>
        </div>`;
    }
    
    // Coating Process
    if (processes.includes('COATING')) {
        content += `
        <div class="form-section">
            <div class="section-title">COATING PROCESS</div>
            
            <div class="sub-section-title">COATING</div>
            <table>
                <tr>
                    <th width="40%">THÔNG SỐ / PARAMETERS</th>
                    <th width="40%">GIÁ TRỊ / VALUE</th>
                    <th width="10%">KẾT QUẢ / RESULT</th>
                    <th width="10%">XÁC NHẬN / VERIFY</th>
                </tr>
                <tr>
                    <td>- Dung dịch coating/ Coating solution:</td>
                    <td>${highlight(data.coatingSolution)}</td>
                    <td style="text-align: center;">${highlightSelect(data.coatingSolutionResult)}</td>
                    <td rowspan="5" style="text-align: center; vertical-align: middle;">
                        <div style="font-size: 8.5pt;">ENG: ${highlight(data.coatingEng)}</div>
                        <div style="margin-top: 5px; font-size: 8.5pt;">QC: ${highlight(data.coatingQc)}</div>
                    </td>
                </tr>
                <tr>
                    <td>- Phương pháp coating/ Coating method:</td>
                    <td>${highlight(data.coatingMethod)}</td>
                    <td style="text-align: center;">${highlightSelect(data.coatingMethodResult)}</td>
                </tr>
                <tr>
                    <td>- Phương pháp sấy/ Drying method:</td>
                    <td>${highlight(data.dryingMethod)}</td>
                    <td style="text-align: center;">${highlightSelect(data.dryingMethodResult)}</td>
                </tr>
                <tr>
                    <td>- Nhiệt độ sấy/ Drying temperature:</td>
                    <td>${highlight(data.dryingTemp)}</td>
                    <td style="text-align: center;">${highlightSelect(data.dryingTempResult)}</td>
                </tr>
                <tr>
                    <td>- Thời gian sấy/ Drying time:</td>
                    <td>${highlight(data.dryingTime)}</td>
                    <td style="text-align: center;">${highlightSelect(data.dryingTimeResult)}</td>
                </tr>
            </table>
        </div>`;
    }
    
    // Boxbuild Process
    if (processes.includes('BOXBUILD')) {
        content += `
        <div class="form-section">
            <div class="section-title">LẮP RÁP / BOXBUILD PROCESS</div>
            
            <!-- Assembly Jig/Tool -->
            <div class="sub-section-title">LẮP RÁP BOXBUILD</div>
            <table>
                <tr>
                    <th width="40%">JIG/DỤNG CỤ LẮP RÁP / ASSEMBLY JIG OR TOOL</th>
                    <th width="30%">TIÊU CHUẨN / SPECIFICATION</th>
                    <th width="15%">KẾT QUẢ / RESULT</th>
                    <th width="15%">XÁC NHẬN / VERIFY</th>
                </tr>
                <tr>
                    <td>${highlight(data.assemblyJig)}</td>
                    <td>${highlight(data.assemblySpec)}</td>
                    <td style="text-align: center;">${highlightSelect(data.assemblyJigResult)}</td>
                    <td style="text-align: center;">
                        <div style="font-size: 8.5pt;">ENG: ${highlight(data.assemblyJigEng)}</div>
                        <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.assemblyJigQc)}</div>
                    </td>
                </tr>
            </table>
        </div>`;
    }
    
    // Packaging Process
    if (processes.includes('PACKING')) {
        content += `
        <div class="form-section">
            <div class="section-title">ĐÓNG GÓI / PACKAGING PROCESS</div>
            
            <!-- Packaging -->
            <div class="sub-section-title">ĐÓNG GÓI / PACKAGING</div>
            <table>
                <tr>
                    <th width="30%">VẬT LIỆU ĐÓNG GÓI / PACKAGING MATERIAL</th>
                    <th width="30%">PHƯƠNG PHÁP ĐÓNG GÓI / PACKAGING METHOD</th>
                    <th width="20%">SỐ LƯỢNG/THÙNG / QUANTITY PER BOX</th>
                    <th width="10%">KẾT QUẢ / RESULT</th>
                    <th width="10%">XÁC NHẬN / VERIFY</th>
                </tr>
                <tr>
                    <td>
                        <div>- Theo BOM Đính kèm/ Attached BOM</div>
                        <div>- Bổ sung (nếu có)/ Additional (if any): ${highlight(data.packagingMaterial)}</div>
                    </td>
                    <td>${highlight(data.packagingMethod)}</td>
                    <td>${highlight(data.packagingQty)}</td>
                    <td style="text-align: center;">${highlightSelect(data.packagingResult)}</td>
                    <td style="text-align: center;">
                        <div style="font-size: 8.5pt;">ENG: ${highlight(data.packagingEng)}</div>
                        <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.packagingQc)}</div>
                    </td>
                </tr>
            </table>
        </div>`;
    }
    
    // Conclusion Section (Luôn hiển thị) - GIẢI PHÁP CUỐI CÙNG
    content += `
    <div class="form-section">
        <div class="section-title">KẾT LUẬN / CONCLUSION</div>
        
        <table class="conclusion-table">
            <tr>
                <th>KẾT QUẢ CUỐI CÙNG<br>FINAL RESULT</th>
                <th>RỦI RO TRONG CÁC CÔNG ĐOẠN<br>RISKS IN EACH PROCESS STEP</th>
                <th>BÀI HỌC TỪNG CÔNG ĐOẠN<br>LESSONS LEARNED FROM EACH PROCESS STEP</th>
                <th>CẢI TIẾN CÔNG ĐOẠN<br>PROCESS IMPROVEMENT</th>
            </tr>
            <tr>
                <td style="height: 120px; padding: 3px !important; overflow: hidden !important;">
                    <div class="conclusion-result">
                        ${data.finalResult ? highlightSelect(data.finalResult) : ''}
                    </div>
                </td>
                <td style="height: 120px; padding: 3px !important; overflow: hidden !important;">
                    <div class="conclusion-content ${risksText ? 'highlight' : ''}">
                        ${risksText || ''}
                    </div>
                </td>
                <td style="height: 120px; padding: 3px !important; overflow: hidden !important;">
                    <div class="conclusion-content ${lessonsText ? 'highlight' : ''}">
                        ${lessonsText || ''}
                    </div>
                </td>
                <td style="height: 120px; padding: 3px !important; overflow: hidden !important;">
                    <div class="conclusion-content ${improvementText ? 'highlight' : ''}">
                        ${improvementText || ''}
                    </div>
                </td>
            </tr>
        </table>
        
        <div style="margin-top: 15px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                <tr>
                    <td width="25%" style="padding: 4px; vertical-align: top;">
                        <div><strong>Tổng số lượng (PCBA):</strong></div>
                        <div><strong>Total qty (PCBA):</strong></div>
                        <div style="margin-top: 3px; font-size: 10pt;">
                            ${data.totalQty ? highlight(data.totalQty) : '0'}
                        </div>
                    </td>
                    <td width="20%" style="padding: 4px; vertical-align: top;">
                        <div><strong>OK :</strong></div>
                        <div style="margin-top: 3px; font-size: 10pt;">
                            ${data.okQty ? highlight(data.okQty) : '0'}
                        </div>
                    </td>
                    <td width="20%" style="padding: 4px; vertical-align: top;">
                        <div><strong>NG (scrap) :</strong></div>
                        <div style="margin-top: 3px; font-size: 10pt;">
                            ${data.ngQty ? highlight(data.ngQty) : '0'}
                        </div>
                    </td>
                    <td width="35%" style="padding: 4px; vertical-align: top;">
                        <div><strong>Tỷ lệ lỗi/ Defect rate (%) :</strong></div>
                        <div><strong>(NG/Total)</strong></div>
                        <div style="margin-top: 3px; font-size: 10pt;">
                            ${data.defectRate ? highlight(data.defectRate) : '0%'}
                        </div>
                    </td>
                </tr>
            </table>
        </div>
        
        <div style="margin-top: 10px;">
            <div><strong>Mô tả chi tiết lỗi / detailed defect description:</strong></div>
            <div style="margin-top: 3px; min-height: 40px; max-height: 60px; font-size: 8pt; line-height: 1.0; padding: 3px; border: 1px solid #ddd; overflow: hidden; word-break: break-all;">
                ${defectText ? `<div class="highlight" style="padding: 1px;">${defectText}</div>` : ''}
            </div>
        </div>
        
        <!-- Electronic Signatures -->
        <div style="margin-top: 15px;">
            <div class="sub-section-title">XÁC NHẬN ĐIỆN TỬ - ELECTRONIC SIGNATURES</div>
            
            <div style="display: flex; gap: 20px; margin-top: 8px;">
                <div style="flex: 1;">
                    <div><strong>Ký xác nhận của Kỹ sư / Engineer Signature:</strong></div>
                    <div class="signature-container">
                        ${data._engineerSignature ? `<img src="${data._engineerSignature}" alt="Engineer Signature" class="signature-img">` : ''}
                    </div>
                    <div style="margin-top: 3px; font-size: 9pt;">
                        <strong>Tên Kỹ sư / Engineer Name:</strong><br>
                        ${highlight(data.engineerName)}
                    </div>
                </div>
                
                <div style="flex: 1;">
                    <div><strong>Ký xác nhận của QC / QC Signature:</strong></div>
                    <div class="signature-container">
                        ${data._qcSignature ? `<img src="${data._qcSignature}" alt="QC Signature" class="signature-img">` : ''}
                    </div>
                    <div style="margin-top: 3px; font-size: 9pt;">
                        <strong>Tên QC / QC Name:</strong><br>
                        ${highlight(data.qcName)}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <div style="text-align: center; margin-top: 15px; color: #666; font-size: 8pt; padding-top: 10px; border-top: 1px solid #ddd;">
        <p>NPI Record - Phiên bản Multi-User Real-time</p>
        <p>© 2024 - Đồng bộ thời gian thực với Firebase</p>
        <p>Generated: ${new Date().toLocaleString('vi-VN')}</p>
    </div>`;
    
    return content;
}

// Hàm tạo nội dung PDF từ tất cả dữ liệu
function createPDFContent(data, processes) {
    // Hàm xử lý text dài - cắt bớt nếu quá dài
    function processLongText(text, maxLines = 15) {
        if (!text || !text.trim()) return '';
        
        // Chia thành các dòng
        const lines = text.trim().split(/\n/);
        
        // Giới hạn số dòng
        if (lines.length > maxLines) {
            return lines.slice(0, maxLines).join('<br>') + '...';
        }
        
        return text.replace(/\n/g, '<br>');
    }
    
    // Hàm helper để highlight dữ liệu
    function highlight(value) {
        if (value && value.toString().trim() !== '') {
            return value.toString();
        }
        return value || '';
    }
    
    function highlightTextarea(value) {
        if (value && value.trim() !== '') {
            const processed = processLongText(value, 8);
            return `<div class="highlight highlight-box">${processed}</div>`;
        }
        return '';
    }
    
    function highlightSelect(value) {
        if (value && value !== '') {
            return `<span class="highlight" style="display: inline-block; padding: 2px 6px;">${value}</span>`;
        }
        return '';
    }
    
    // Format date
    function formatDate(dateStr) {
        if (!dateStr) return '';
        try {
            const date = new Date(dateStr);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        } catch {
            return dateStr;
        }
    }
    
    // Bắt đầu xây dựng nội dung
    let content = `
    <!-- Header -->
    <div class="header" style="display:flex; align-items:center; border-bottom:1px solid #000; padding-bottom:8px;">

    <!-- LOGO TRÁI -->
    <img src="logo.png"
         alt="Logo"
         style="height:60px; margin-right:15px;">

    <!-- TIÊU ĐỀ -->
    <div style="text-align:center; flex:1;">
        <h1 style="margin:0;">BIỂU GHI NPI - NPI RECORD</h1>
        <div style="font-size:12px; margin-top:4px;">
            TNEMS-EN-F-048-NPI RECORD-VER03
        </div>
    </div>

</div>


    
    <!-- Product Information -->
    <div class="form-section">
        <div class="section-title">THÔNG TIN SẢN PHẨM - PRODUCT INFORMATION</div>
        
        <table>
            <tr>
                <td width="25%" style="font-weight: bold;">MÃ HÀNG / MODEL:</td>
                <td width="35%">${highlight(data.model)}</td>
                <td width="20%" style="font-weight: bold;">Part No:</td>
                <td width="20%">${highlight(data.partNo)}</td>
            </tr>
            <tr>
                <td style="font-weight: bold;">KHÁCH HÀNG / CUSTOMER:</td>
                <td>${highlight(data.customer)}</td>
                <td style="font-weight: bold;">Ngày / Date:</td>
                <td>${highlight(formatDate(data.date))}</td>
            </tr>
        </table>
        
        <div style="margin-top: 10px;">
            <span style="font-weight: bold;">Quy trình / Process:</span>
            <div style="margin-top: 5px;">
                ${processes.length > 0 ? highlight(processes.join(', ')) : ''}
            </div>
        </div>
    </div>`;
    
    // SMT Process
    if (processes.includes('SMT')) {
        content += `
        <div class="form-section">
            <div class="section-title">SMT PROCESS</div>
            
            <!-- LASER MARKING -->
            <div class="sub-section-title">LASER MARKING</div>
            <table>
                <tr>
                    <th width="30%">NỘI DUNG</th>
                    <th width="70%">GIÁ TRỊ</th>
                </tr>
                <tr>
                    <td>Tên chương trình/ Program name</td>
                    <td>${highlight(data.laserProgram)}</td>
                </tr>
                <tr>
                    <td>Loại QR code/ QR code type</td>
                    <td>${highlight(data.qrType)}</td>
                </tr>
                <tr>
                    <td>Kích thước QR code/ QR code size</td>
                    <td>${highlight(data.qrSize)}</td>
                </tr>
                <tr>
                    <td>Cường độ khắc/ Engraving intensity</td>
                    <td>${highlight(data.engravingIntensity)}</td>
                </tr>
                <tr>
                    <td>Side BOT: Nội dung QR code/ QR code content</td>
                    <td>${highlightTextarea(data.qrContentBot)}</td>
                </tr>
                <tr>
                    <td>Side TOP: Nội dung QR code/ QR code content</td>
                    <td>${highlightTextarea(data.qrContentTop)}</td>
                </tr>
                <tr>
                    <td>Nội dung QR code khi quét bằng máy</td>
                    <td>${highlightTextarea(data.qrScanContent)}</td>
                </tr>
            </table>
            
            <!-- PRINTER -->
            <div class="sub-section-title">PRINTER</div>
            <div style="padding: 5px;">
                ${highlight(data.printerControl)}
            </div>
            
            <!-- VISUAL INSPECTION 1 -->
            <div class="sub-section-title">NGOẠI QUAN VISUAL INSPECTION</div>
            <table>
                <tr>
                    <th width="40%">HƯỚNG LINH KIỆN/COMPONENT POLARITY</th>
                    <th width="30%">SỐ LƯỢNG LINH KIỆN/COMPONENT QUANTITY</th>
                    <th width="15%">KẾT QUẢ/RESULT</th>
                    <th width="15%">XÁC NHẬN/VERIFY</th>
                </tr>
                <tr>
                    <td>Theo bảng hướng linh kiện đính kèm (QC)</td>
                    <td>
                        <div>Theo BOM/ According to the BOM: ${highlight(data.bomQty)}</div>
                        <div style="margin-top: 3px;">Thực tế/ Reality: ${highlight(data.actualQty)}</div>
                    </td>
                    <td style="text-align: center;">${highlightSelect(data.visualResult1)}</td>
                    <td style="text-align: center;">
                        <div style="font-size: 8.5pt;">ENG: ${highlight(data.engVerify1)}</div>
                        <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.qcVerify1)}</div>
                    </td>
                </tr>
            </table>
            
            <!-- REFLOW OVEN -->
            <div class="sub-section-title">LÒ REFLOW/REFLOW OVEN</div>
            <table>
                <tr>
                    <th width="30%">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                    <th width="40%">THÔNG SỐ CÀI ĐẶT MÁY/MACHINE PARAMETERS SETTING</th>
                    <th width="15%">KẾT QUẢ/RESULT</th>
                    <th width="15%">XÁC NHẬN/VERIFY</th>
                </tr>
                <tr>
                    <td>- Theo Process control sheet đính kèm<br>- Profile lò đính kèm</td>
                    <td>${highlightTextarea(data.reflowParams)}</td>
                    <td style="text-align: center;">${highlightSelect(data.reflowResult)}</td>
                    <td style="text-align: center;">
                        <div style="font-size: 8.5pt;">ENG: ${highlight(data.reflowEng)}</div>
                        <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.reflowQc)}</div>
                    </td>
                </tr>
            </table>
        </div>`;
    }
    
    // Through-Hole Process
    if (processes.includes('THROUGH HOLE')) {
        content += `
        <div class="form-section">
            <div class="section-title">THROUGH-HOLE PROCESS</div>
            
            <!-- Component Quantity Check -->
            <div class="sub-section-title">KIỂM TRA SỐ LƯỢNG LINH KIỆN / COMPONENT QUANTITY CHECK</div>
            <table>
                <tr>
                    <th width="40%">NỘI DUNG KIỂM TRA/INSPECTION CONTENT</th>
                    <th width="30%">GIÁ TRỊ/VALUE</th>
                    <th width="15%">KẾT QUẢ/RESULT</th>
                    <th width="15%">XÁC NHẬN/VERIFY</th>
                </tr>
                <tr>
                    <td>ĐÚNG MÃ / CORRECT PART NUMBER</td>
                    <td>${highlight(data.thPartNumber)}</td>
                    <td style="text-align: center;">${highlightSelect(data.thPartNumberResult)}</td>
                    <td style="text-align: center;">
                        <div style="font-size: 8.5pt;">ENG: ${highlight(data.thQuantityEng)}</div>
                        <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.thQuantityQc)}</div>
                    </td>
                </tr>
                <tr>
                    <td>SỐ LƯỢNG / QUANTITY</td>
                    <td>${highlight(data.thQuantity)}</td>
                    <td style="text-align: center;">${highlightSelect(data.thQuantityResult)}</td>
                    <td style="text-align: center;">
                        <div style="font-size: 8.5pt;">ENG: ${highlight(data.thQuantityEng2)}</div>
                        <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.thQuantityQc2)}</div>
                    </td>
                </tr>
            </table>
        </div>`;
    }
    
    // Coating Process
    if (processes.includes('COATING')) {
        content += `
        <div class="form-section">
            <div class="section-title">COATING PROCESS</div>
            
            <div class="sub-section-title">COATING</div>
            <table>
                <tr>
                    <th width="40%">THÔNG SỐ / PARAMETERS</th>
                    <th width="40%">GIÁ TRỊ / VALUE</th>
                    <th width="10%">KẾT QUẢ / RESULT</th>
                    <th width="10%">XÁC NHẬN / VERIFY</th>
                </tr>
                <tr>
                    <td>- Dung dịch coating/ Coating solution:</td>
                    <td>${highlight(data.coatingSolution)}</td>
                    <td style="text-align: center;">${highlightSelect(data.coatingSolutionResult)}</td>
                    <td rowspan="5" style="text-align: center; vertical-align: middle;">
                        <div style="font-size: 8.5pt;">ENG: ${highlight(data.coatingEng)}</div>
                        <div style="margin-top: 5px; font-size: 8.5pt;">QC: ${highlight(data.coatingQc)}</div>
                    </td>
                </tr>
                <tr>
                    <td>- Phương pháp coating/ Coating method:</td>
                    <td>${highlight(data.coatingMethod)}</td>
                    <td style="text-align: center;">${highlightSelect(data.coatingMethodResult)}</td>
                </tr>
                <tr>
                    <td>- Phương pháp sấy/ Drying method:</td>
                    <td>${highlight(data.dryingMethod)}</td>
                    <td style="text-align: center;">${highlightSelect(data.dryingMethodResult)}</td>
                </tr>
                <tr>
                    <td>- Nhiệt độ sấy/ Drying temperature:</td>
                    <td>${highlight(data.dryingTemp)}</td>
                    <td style="text-align: center;">${highlightSelect(data.dryingTempResult)}</td>
                </tr>
                <tr>
                    <td>- Thời gian sấy/ Drying time:</td>
                    <td>${highlight(data.dryingTime)}</td>
                    <td style="text-align: center;">${highlightSelect(data.dryingTimeResult)}</td>
                </tr>
            </table>
        </div>`;
    }
    
    // Boxbuild Process
    if (processes.includes('BOXBUILD')) {
        content += `
        <div class="form-section">
            <div class="section-title">LẮP RÁP / BOXBUILD PROCESS</div>
            
            <!-- Assembly Jig/Tool -->
            <div class="sub-section-title">LẮP RÁP BOXBUILD</div>
            <table>
                <tr>
                    <th width="40%">JIG/DỤNG CỤ LẮP RÁP / ASSEMBLY JIG OR TOOL</th>
                    <th width="30%">TIÊU CHUẨN / SPECIFICATION</th>
                    <th width="15%">KẾT QUẢ / RESULT</th>
                    <th width="15%">XÁC NHẬN / VERIFY</th>
                </tr>
                <tr>
                    <td>${highlight(data.assemblyJig)}</td>
                    <td>${highlight(data.assemblySpec)}</td>
                    <td style="text-align: center;">${highlightSelect(data.assemblyJigResult)}</td>
                    <td style="text-align: center;">
                        <div style="font-size: 8.5pt;">ENG: ${highlight(data.assemblyJigEng)}</div>
                        <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.assemblyJigQc)}</div>
                    </td>
                </tr>
            </table>
        </div>`;
    }
    
    // Packaging Process
    if (processes.includes('PACKING')) {
        content += `
        <div class="form-section">
            <div class="section-title">ĐÓNG GÓI / PACKAGING PROCESS</div>
            
            <!-- Packaging -->
            <div class="sub-section-title">ĐÓNG GÓI / PACKAGING</div>
            <table>
                <tr>
                    <th width="30%">VẬT LIỆU ĐÓNG GÓI / PACKAGING MATERIAL</th>
                    <th width="30%">PHƯƠNG PHÁP ĐÓNG GÓI / PACKAGING METHOD</th>
                    <th width="20%">SỐ LƯỢNG/THÙNG / QUANTITY PER BOX</th>
                    <th width="10%">KẾT QUẢ / RESULT</th>
                    <th width="10%">XÁC NHẬN / VERIFY</th>
                </tr>
                <tr>
                    <td>
                        <div>- Theo BOM Đính kèm/ Attached BOM</div>
                        <div>- Bổ sung (nếu có)/ Additional (if any): ${highlight(data.packagingMaterial)}</div>
                    </td>
                    <td>${highlight(data.packagingMethod)}</td>
                    <td>${highlight(data.packagingQty)}</td>
                    <td style="text-align: center;">${highlightSelect(data.packagingResult)}</td>
                    <td style="text-align: center;">
                        <div style="font-size: 8.5pt;">ENG: ${highlight(data.packagingEng)}</div>
                        <div style="margin-top: 1px; font-size: 8.5pt;">QC: ${highlight(data.packagingQc)}</div>
                    </td>
                </tr>
            </table>
        </div>`;
    }
    
    // Conclusion Section (Luôn hiển thị) - GIẢI PHÁP MỚI
    // Xử lý text dài cho conclusion
    const risksText = processLongText(data.processRisks || '', 20);
    const lessonsText = processLongText(data.lessonsLearned || '', 20);
    const improvementText = processLongText(data.processImprovement || '', 20);
    const defectText = processLongText(data.defectDescription || '', 10);
    
    content += `
    <div class="form-section">
        <div class="section-title">KẾT LUẬN / CONCLUSION</div>
        
        <table class="conclusion-table">
            <tr>
                <th>KẾT QUẢ CUỐI CÙNG<br>FINAL RESULT</th>
                <th>RỦI RO TRONG CÁC CÔNG ĐOẠN<br>RISKS IN EACH PROCESS STEP</th>
                <th>BÀI HỌC TỪNG CÔNG ĐOẠN<br>LESSONS LEARNED FROM EACH PROCESS STEP</th>
                <th>CẢI TIẾN CÔNG ĐOẠN<br>PROCESS IMPROVEMENT</th>
            </tr>
            <tr>
                <td style="height: 120px; padding: 3px !important;">
                    <div class="conclusion-cell">
                        <div class="conclusion-final-result">
                            ${data.finalResult ? highlightSelect(data.finalResult) : ''}
                        </div>
                    </div>
                </td>
                <td style="height: 120px; padding: 3px !important;">
                    <div class="conclusion-cell">
                        <div class="conclusion-text ${risksText ? 'highlight' : ''}">
                            ${risksText || ''}
                        </div>
                    </div>
                </td>
                <td style="height: 120px; padding: 3px !important;">
                    <div class="conclusion-cell">
                        <div class="conclusion-text ${lessonsText ? 'highlight' : ''}">
                            ${lessonsText || ''}
                        </div>
                    </div>
                </td>
                <td style="height: 120px; padding: 3px !important;">
                    <div class="conclusion-cell">
                        <div class="conclusion-text ${improvementText ? 'highlight' : ''}">
                            ${improvementText || ''}
                        </div>
                    </div>
                </td>
            </tr>
        </table>
        
        <div style="margin-top: 15px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                <tr>
                    <td width="25%" style="padding: 4px; vertical-align: top;">
                        <div><strong>Tổng số lượng (PCBA):</strong></div>
                        <div><strong>Total qty (PCBA):</strong></div>
                        <div style="margin-top: 3px; font-size: 10pt;">
                            ${data.totalQty ? highlight(data.totalQty) : '0'}
                        </div>
                    </td>
                    <td width="20%" style="padding: 4px; vertical-align: top;">
                        <div><strong>OK :</strong></div>
                        <div style="margin-top: 3px; font-size: 10pt;">
                            ${data.okQty ? highlight(data.okQty) : '0'}
                        </div>
                    </td>
                    <td width="20%" style="padding: 4px; vertical-align: top;">
                        <div><strong>NG (scrap) :</strong></div>
                        <div style="margin-top: 3px; font-size: 10pt;">
                            ${data.ngQty ? highlight(data.ngQty) : '0'}
                        </div>
                    </td>
                    <td width="35%" style="padding: 4px; vertical-align: top;">
                        <div><strong>Tỷ lệ lỗi/ Defect rate (%) :</strong></div>
                        <div><strong>(NG/Total)</strong></div>
                        <div style="margin-top: 3px; font-size: 10pt;">
                            ${data.defectRate ? highlight(data.defectRate) : '0%'}
                        </div>
                    </td>
                </tr>
            </table>
        </div>
        
        <div style="margin-top: 10px;">
            <div><strong>Mô tả chi tiết lỗi / detailed defect description:</strong></div>
            <div style="margin-top: 3px; min-height: 40px; max-height: 60px; font-size: 8.5pt; line-height: 1.1; padding: 4px; border: 1px solid #ddd; overflow: hidden;">
                ${defectText ? `<div class="highlight" style="padding: 2px;">${defectText}</div>` : ''}
            </div>
        </div>
        
        <!-- Electronic Signatures -->
        <div style="margin-top: 15px;">
            <div class="sub-section-title">XÁC NHẬN ĐIỆN TỬ - ELECTRONIC SIGNATURES</div>
            
            <div style="display: flex; gap: 20px; margin-top: 8px;">
                <div style="flex: 1;">
                    <div><strong>Ký xác nhận của Kỹ sư / Engineer Signature:</strong></div>
                    <div class="signature-container">
                        ${data._engineerSignature ? `<img src="${data._engineerSignature}" alt="Engineer Signature" class="signature-img">` : ''}
                    </div>
                    <div style="margin-top: 3px; font-size: 9pt;">
                        <strong>Tên Kỹ sư / Engineer Name:</strong><br>
                        ${highlight(data.engineerName)}
                    </div>
                </div>
                
                <div style="flex: 1;">
                    <div><strong>Ký xác nhận của QC / QC Signature:</strong></div>
                    <div class="signature-container">
                        ${data._qcSignature ? `<img src="${data._qcSignature}" alt="QC Signature" class="signature-img">` : ''}
                    </div>
                    <div style="margin-top: 3px; font-size: 9pt;">
                        <strong>Tên QC / QC Name:</strong><br>
                        ${highlight(data.qcName)}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <div style="text-align: center; margin-top: 15px; color: #666; font-size: 8pt; padding-top: 10px; border-top: 1px solid #ddd;">
        <p>NPI Record - Phiên bản Multi-User Real-time</p>
        <p>© 2024 - Đồng bộ thời gian thực với Firebase</p>
        <p>Generated: ${new Date().toLocaleString('vi-VN')}</p>
    </div>`;
    
    return content;
}

// Hàm tạo nội dung PDF từ tất cả dữ liệu
function createPDFContent(data, processes) {
    // Hàm helper để highlight dữ liệu
    function highlight(value) {
        if (value && value.toString().trim() !== '') {
            return `<span class="highlight">${value}</span>`;
        }
        return value || '';
    }
    
    function highlightTextarea(value) {
        if (value && value.trim() !== '') {
            return `<div class="highlight highlight-box">${value.replace(/\n/g, '<br>')}</div>`;
        }
        return '';
    }
    
    function highlightSelect(value) {
        if (value && value !== '') {
            return `<span class="highlight">${value}</span>`;
        }
        return '';
    }
    
    // Format date
    function formatDate(dateStr) {
        if (!dateStr) return '';
        try {
            const date = new Date(dateStr);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getDate() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        } catch {
            return dateStr;
        }
    }
    
    // Bắt đầu xây dựng nội dung
    let content = `
    <!-- Header -->
<div class="header" style="display:flex; align-items:center; border-bottom:1px solid #000; padding-bottom:8px;">

    <!-- LOGO TRÁI -->
    <img src="logo.png"
         alt="Logo"
         style="height:60px; margin-right:15px;">

    <!-- TIÊU ĐỀ -->
    <div style="text-align:center; flex:1;">
        <h1 style="margin:0;">BIỂU GHI NPI - NPI RECORD</h1>
        <div style="font-size:12px; margin-top:4px;">
            TNEMS-EN-F-048-NPI RECORD-VER03
        </div>
    </div>

</div>


    
    <!-- Product Information -->
    <div class="form-section">
        <div class="section-title">THÔNG TIN SẢN PHẨM - PRODUCT INFORMATION</div>
        
        <table>
            <tr>
                <td width="25%" style="font-weight: bold;">MÃ HÀNG / MODEL:</td>
                <td width="35%">${highlight(data.model)}</td>
                <td width="20%" style="font-weight: bold;">Part No:</td>
                <td width="20%">${highlight(data.partNo)}</td>
            </tr>
            <tr>
                <td style="font-weight: bold;">KHÁCH HÀNG / CUSTOMER:</td>
                <td>${highlight(data.customer)}</td>
                <td style="font-weight: bold;">Ngày / Date:</td>
                <td>${highlight(formatDate(data.date))}</td>
            </tr>
        </table>
        
        <div style="margin-top: 10px;">
            <span style="font-weight: bold;">Quy trình / Process:</span>
            <div style="margin-top: 5px;">
                ${processes.length > 0 ? highlight(processes.join(', ')) : ''}
            </div>
        </div>
    </div>`;
    
    // SMT Process
    if (processes.includes('SMT')) {
        content += `
        <div class="form-section">
            <div class="section-title">SMT PROCESS</div>
            
            <!-- LASER MARKING -->
            <div class="sub-section-title">LASER MARKING</div>
            <table>
                <tr>
                    <th width="30%">NỘI DUNG</th>
                    <th width="70%">GIÁ TRỊ</th>
                </tr>
                <tr>
                    <td>Tên chương trình/ Program name</td>
                    <td>${highlight(data.laserProgram)}</td>
                </tr>
                <tr>
                    <td>Loại QR code/ QR code type</td>
                    <td>${highlight(data.qrType)}</td>
                </tr>
                <tr>
                    <td>Kích thước QR code/ QR code size</td>
                    <td>${highlight(data.qrSize)}</td>
                </tr>
                <tr>
                    <td>Cường độ khắc/ Engraving intensity</td>
                    <td>${highlight(data.engravingIntensity)}</td>
                </tr>
                <tr>
                    <td>Side BOT: Nội dung QR code/ QR code content</td>
                    <td>${highlightTextarea(data.qrContentBot)}</td>
                </tr>
                <tr>
                    <td>Side TOP: Nội dung QR code/ QR code content</td>
                    <td>${highlightTextarea(data.qrContentTop)}</td>
                </tr>
                <tr>
                    <td>Nội dung QR code khi quét bằng máy</td>
                    <td>${highlightTextarea(data.qrScanContent)}</td>
                </tr>
            </table>
            
            <!-- PRINTER -->
            <div class="sub-section-title">PRINTER</div>
            <div style="padding: 5px;">
                ${highlight(data.printerControl)}
            </div>
            
            <!-- VISUAL INSPECTION 1 -->
            <div class="sub-section-title">NGOẠI QUAN VISUAL INSPECTION</div>
            <table>
                <tr>
                    <th width="40%">HƯỚNG LINH KIỆN/COMPONENT POLARITY</th>
                    <th width="30%">SỐ LƯỢNG LINH KIỆN/COMPONENT QUANTITY</th>
                    <th width="15%">KẾT QUẢ/RESULT</th>
                    <th width="15%">XÁC NHẬN/VERIFY</th>
                </tr>
                <tr>
                    <td>Theo bảng hướng linh kiện đính kèm (QC)</td>
                    <td>
                        <div>Theo BOM/ According to the BOM: ${highlight(data.bomQty)}</div>
                        <div style="margin-top: 5px;">Thực tế/ Reality: ${highlight(data.actualQty)}</div>
                    </td>
                    <td style="text-align: center;">${highlightSelect(data.visualResult1)}</td>
                    <td style="text-align: center;">
                        <div>ENG: ${highlight(data.engVerify1)}</div>
                        <div style="margin-top: 2px;">QC: ${highlight(data.qcVerify1)}</div>
                    </td>
                </tr>
            </table>
            
            <!-- REFLOW OVEN -->
            <div class="sub-section-title">LÒ REFLOW/REFLOW OVEN</div>
            <table>
                <tr>
                    <th width="30%">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                    <th width="40%">THÔNG SỐ CÀI ĐẶT MÁY/MACHINE PARAMETERS SETTING</th>
                    <th width="15%">KẾT QUẢ/RESULT</th>
                    <th width="15%">XÁC NHẬN/VERIFY</th>
                </tr>
                <tr>
                    <td>- Theo Process control sheet đính kèm<br>- Profile lò đính kèm</td>
                    <td>${highlightTextarea(data.reflowParams)}</td>
                    <td style="text-align: center;">${highlightSelect(data.reflowResult)}</td>
                    <td style="text-align: center;">
                        <div>ENG: ${highlight(data.reflowEng)}</div>
                        <div style="margin-top: 2px;">QC: ${highlight(data.reflowQc)}</div>
                    </td>
                </tr>
            </table>
        </div>`;
    }
    
    // Through-Hole Process
    if (processes.includes('THROUGH HOLE')) {
        content += `
        <div class="form-section">
            <div class="section-title">THROUGH-HOLE PROCESS</div>
            
            <!-- Component Quantity Check -->
            <div class="sub-section-title">KIỂM TRA SỐ LƯỢNG LINH KIỆN / COMPONENT QUANTITY CHECK</div>
            <table>
                <tr>
                    <th width="40%">NỘI DUNG KIỂM TRA/INSPECTION CONTENT</th>
                    <th width="30%">GIÁ TRỊ/VALUE</th>
                    <th width="15%">KẾT QUẢ/RESULT</th>
                    <th width="15%">XÁC NHẬN/VERIFY</th>
                </tr>
                <tr>
                    <td>ĐÚNG MÃ / CORRECT PART NUMBER</td>
                    <td>${highlight(data.thPartNumber)}</td>
                    <td style="text-align: center;">${highlightSelect(data.thPartNumberResult)}</td>
                    <td style="text-align: center;">
                        <div>ENG: ${highlight(data.thQuantityEng)}</div>
                        <div style="margin-top: 2px;">QC: ${highlight(data.thQuantityQc)}</div>
                    </td>
                </tr>
                <tr>
                    <td>SỐ LƯỢNG / QUANTITY</td>
                    <td>${highlight(data.thQuantity)}</td>
                    <td style="text-align: center;">${highlightSelect(data.thQuantityResult)}</td>
                    <td style="text-align: center;">
                        <div>ENG: ${highlight(data.thQuantityEng2)}</div>
                        <div style="margin-top: 2px;">QC: ${highlight(data.thQuantityQc2)}</div>
                    </td>
                </tr>
            </table>
        </div>`;
    }
    
    // Coating Process
    if (processes.includes('COATING')) {
        content += `
        <div class="form-section">
            <div class="section-title">COATING PROCESS</div>
            
            <div class="sub-section-title">COATING</div>
            <table>
                <tr>
                    <th width="40%">THÔNG SỐ / PARAMETERS</th>
                    <th width="40%">GIÁ TRỊ / VALUE</th>
                    <th width="10%">KẾT QUẢ / RESULT</th>
                    <th width="10%">XÁC NHẬN / VERIFY</th>
                </tr>
                <tr>
                    <td>- Dung dịch coating/ Coating solution:</td>
                    <td>${highlight(data.coatingSolution)}</td>
                    <td style="text-align: center;">${highlightSelect(data.coatingSolutionResult)}</td>
                    <td rowspan="5" style="text-align: center; vertical-align: middle;">
                        <div>ENG: ${highlight(data.coatingEng)}</div>
                        <div style="margin-top: 10px;">QC: ${highlight(data.coatingQc)}</div>
                    </td>
                </tr>
                <tr>
                    <td>- Phương pháp coating/ Coating method:</td>
                    <td>${highlight(data.coatingMethod)}</td>
                    <td style="text-align: center;">${highlightSelect(data.coatingMethodResult)}</td>
                </tr>
                <tr>
                    <td>- Phương pháp sấy/ Drying method:</td>
                    <td>${highlight(data.dryingMethod)}</td>
                    <td style="text-align: center;">${highlightSelect(data.dryingMethodResult)}</td>
                </tr>
                <tr>
                    <td>- Nhiệt độ sấy/ Drying temperature:</td>
                    <td>${highlight(data.dryingTemp)}</td>
                    <td style="text-align: center;">${highlightSelect(data.dryingTempResult)}</td>
                </tr>
                <tr>
                    <td>- Thời gian sấy/ Drying time:</td>
                    <td>${highlight(data.dryingTime)}</td>
                    <td style="text-align: center;">${highlightSelect(data.dryingTimeResult)}</td>
                </tr>
            </table>
        </div>`;
    }
    
    // Boxbuild Process
    if (processes.includes('BOXBUILD')) {
        content += `
        <div class="form-section">
            <div class="section-title">LẮP RÁP / BOXBUILD PROCESS</div>
            
            <!-- Assembly Jig/Tool -->
            <div class="sub-section-title">LẮP RÁP BOXBUILD</div>
            <table>
                <tr>
                    <th width="40%">JIG/DỤNG CỤ LẮP RÁP / ASSEMBLY JIG OR TOOL</th>
                    <th width="30%">TIÊU CHUẨN / SPECIFICATION</th>
                    <th width="15%">KẾT QUẢ / RESULT</th>
                    <th width="15%">XÁC NHẬN / VERIFY</th>
                </tr>
                <tr>
                    <td>${highlight(data.assemblyJig)}</td>
                    <td>${highlight(data.assemblySpec)}</td>
                    <td style="text-align: center;">${highlightSelect(data.assemblyJigResult)}</td>
                    <td style="text-align: center;">
                        <div>ENG: ${highlight(data.assemblyJigEng)}</div>
                        <div style="margin-top: 2px;">QC: ${highlight(data.assemblyJigQc)}</div>
                    </td>
                </tr>
            </table>
        </div>`;
    }
    
    // Packaging Process
    if (processes.includes('PACKING')) {
        content += `
        <div class="form-section">
            <div class="section-title">ĐÓNG GÓI / PACKAGING PROCESS</div>
            
            <!-- Packaging -->
            <div class="sub-section-title">ĐÓNG GÓI / PACKAGING</div>
            <table>
                <tr>
                    <th width="30%">VẬT LIỆU ĐÓNG GÓI / PACKAGING MATERIAL</th>
                    <th width="30%">PHƯƠNG PHÁP ĐÓNG GÓI / PACKAGING METHOD</th>
                    <th width="20%">SỐ LƯỢNG/THÙNG / QUANTITY PER BOX</th>
                    <th width="10%">KẾT QUẢ / RESULT</th>
                    <th width="10%">XÁC NHẬN / VERIFY</th>
                </tr>
                <tr>
                    <td>
                        <div>- Theo BOM Đính kèm/ Attached BOM</div>
                        <div>- Bổ sung (nếu có)/ Additional (if any): ${highlight(data.packagingMaterial)}</div>
                    </td>
                    <td>${highlight(data.packagingMethod)}</td>
                    <td>${highlight(data.packagingQty)}</td>
                    <td style="text-align: center;">${highlightSelect(data.packagingResult)}</td>
                    <td style="text-align: center;">
                        <div>ENG: ${highlight(data.packagingEng)}</div>
                        <div style="margin-top: 2px;">QC: ${highlight(data.packagingQc)}</div>
                    </td>
                </tr>
            </table>
        </div>`;
    }
    
    // Conclusion Section (Luôn hiển thị)
    content += `
    <div class="form-section">
        <div class="section-title">KẾT LUẬN / CONCLUSION</div>
        
        <table>
            <tr>
                <th width="20%">KẾT QUẢ CUỐI CÙNG / FINAL RESULT</th>
                <th width="25%">RỦI RO TRONG CÁC CÔNG ĐOẠN / RISKS IN EACH PROCESS STEP</th>
                <th width="25%">BÀI HỌC TỪNG CÔNG ĐOẠN / LESSONS LEARNED FROM EACH PROCESS STEP</th>
                <th width="30%">CẢI TIẾN CÔNG ĐOẠN / PROCESS IMPROVEMENT</th>
            </tr>
            <tr>
                <td style="text-align: center; vertical-align: middle;">
                    ${highlightSelect(data.finalResult)}
                </td>
                <td style="min-height: 100px;">${highlightTextarea(data.processRisks)}</td>
                <td style="min-height: 100px;">${highlightTextarea(data.lessonsLearned)}</td>
                <td style="min-height: 100px;">${highlightTextarea(data.processImprovement)}</td>
            </tr>
        </table>
        
        <div style="margin-top: 15px;">
            <table style="width: 100%; border: none;">
                <tr>
                    <td width="25%" style="border: none; padding: 4px;">
                        <div><strong>Tổng số lượng (PCBA):</strong></div>
                        <div><strong>Total qty (PCBA):</strong></div>
                        <div style="margin-top: 5px; font-size: 11pt;">
                            ${data.totalQty ? highlight(data.totalQty) : '0'}
                        </div>
                    </td>
                    <td width="20%" style="border: none; padding: 4px;">
                        <div><strong>OK :</strong></div>
                        <div style="margin-top: 5px; font-size: 11pt;">
                            ${data.okQty ? highlight(data.okQty) : '0'}
                        </div>
                    </td>
                    <td width="20%" style="border: none; padding: 4px;">
                        <div><strong>NG (scrap) :</strong></div>
                        <div style="margin-top: 5px; font-size: 11pt;">
                            ${data.ngQty ? highlight(data.ngQty) : '0'}
                        </div>
                    </td>
                    <td width="35%" style="border: none; padding: 4px;">
                        <div><strong>Tỷ lệ lỗi/ Defect rate (%) :</strong></div>
                        <div><strong>(NG/Total)</strong></div>
                        <div style="margin-top: 5px; font-size: 11pt;">
                            ${data.defectRate ? highlight(data.defectRate) : '0%'}
                        </div>
                    </td>
                </tr>
            </table>
        </div>
        
        <div style="margin-top: 10px;">
            <div><strong>Mô tả chi tiết lỗi / detailed defect description:</strong></div>
            <div style="margin-top: 5px; min-height: 50px;">
                ${highlightTextarea(data.defectDescription)}
            </div>
        </div>
        
        <!-- Electronic Signatures -->
        <div style="margin-top: 20px;">
            <div class="sub-section-title">XÁC NHẬN ĐIỆN TỬ - ELECTRONIC SIGNATURES</div>
            
            <div style="display: flex; gap: 30px; margin-top: 10px;">
                <div style="flex: 1;">
                    <div><strong>Ký xác nhận của Kỹ sư / Engineer Signature:</strong></div>
                    <div class="signature-container">
                        ${data._engineerSignature ? `<img src="${data._engineerSignature}" alt="Engineer Signature" class="signature-img">` : ''}
                    </div>
                    <div style="margin-top: 5px;">
                        <strong>Tên Kỹ sư / Engineer Name:</strong> 
                        ${highlight(data.engineerName)}
                    </div>
                </div>
                
                <div style="flex: 1;">
                    <div><strong>Ký xác nhận của QC / QC Signature:</strong></div>
                    <div class="signature-container">
                        ${data._qcSignature ? `<img src="${data._qcSignature}" alt="QC Signature" class="signature-img">` : ''}
                    </div>
                    <div style="margin-top: 5px;">
                        <strong>Tên QC / QC Name:</strong> 
                        ${highlight(data.qcName)}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <div style="text-align: center; margin-top: 20px; color: #666; font-size: 9pt; padding-top: 15px; border-top: 1px solid #ddd;">
        <p>NPI Record - Phiên bản Multi-User Real-time</p>
        <p>© 2024 - Đồng bộ thời gian thực với Firebase</p>
        <p>Generated: ${new Date().toLocaleString('vi-VN')}</p>
    </div>`;
    
    return content;
}

// Thêm vào cuối file script
console.log("📄 Hàm exportToPDF đã được cập nhật để xuất tất cả các tab");

// Test function để kiểm tra
function testExport() {
    const allData = collectFormData();
    console.log("Dữ liệu đã thu thập:", allData);
    console.log("Số lượng field:", Object.keys(allData).length);
    
    // Kiểm tra xem có process nào được chọn không
    const processes = [];
    if (allData.processSMT) processes.push('SMT');
    if (allData.processThroughHole) processes.push('THROUGH HOLE');
    if (allData.processCoating) processes.push('COATING');
    if (allData.processBoxbuild) processes.push('BOXBUILD');
    if (allData.processPacking) processes.push('PACKING');
    console.log("Processes selected:", processes);
}
        // ========== HÀM MỚI TẠO NỘI DUNG PDF GIỐNG FILE MẪU (ĐẦY ĐỦ) ==========
function generatePDFContentNew() {
    // Lấy giá trị từ form
    const model = document.getElementById('model').value || '';
    const customer = document.getElementById('customer').value || '';
    const partNo = document.getElementById('partNo').value || '';
    const dateValue = document.getElementById('date').value || '';
    const date = dateValue ? formatDateForDisplay(dateValue) : '';
    
    // Process checkboxes
    const processes = [];
    if (document.getElementById('processSMT').checked) processes.push('SMT');
    if (document.getElementById('processThroughHole').checked) processes.push('THROUGH HOLE');
    if (document.getElementById('processCoating').checked) processes.push('COATING');
    if (document.getElementById('processBoxbuild').checked) processes.push('BOXBUILD');
    if (document.getElementById('processPacking').checked) processes.push('PACKING');
    const processText = processes.join(', ');
    
    // Hàm tạo text với highlight
    function createHighlightedText(value, highlightCondition = true) {
        if (value && highlightCondition) {
            return `<span style="color: #1565C0; font-weight: 600; background-color: #E3F2FD; padding: 1px 4px; border-radius: 2px; display: inline-block; margin: 1px 0;">${value}</span>`;
        }
        return value || '';
    }
    
    // Hàm tạo textarea với highlight
    function createHighlightedTextarea(value) {
        if (value) {
            return `<div style="color: #1565C0; font-weight: 600; background-color: #E3F2FD; padding: 4px 6px; border-radius: 3px; border-left: 3px solid #1565C0; white-space: pre-wrap;">${value}</div>`;
        }
        return '';
    }
    
    // Hàm tạo select với highlight
    function createHighlightedSelect(value) {
        if (value) {
            return `<span style="color: #1565C0; font-weight: 600; background-color: #E3F2FD; padding: 2px 8px; border-radius: 3px; border: 1px solid #1565C0;">${value}</span>`;
        }
        return '';
    }
    
    // Lấy tất cả giá trị từ các phần
    // SMT Process
    const laserProgram = document.getElementById('laserProgram').value || '';
    const qrType = document.getElementById('qrType').value || '';
    const qrSize = document.getElementById('qrSize').value || '';
    const engravingIntensity = document.getElementById('engravingIntensity').value || '';
    const qrContentBot = document.getElementById('qrContentBot').value || '';
    const qrContentTop = document.getElementById('qrContentTop').value || '';
    const qrScanContent = document.getElementById('qrScanContent').value || '';
    const printerControl = document.getElementById('printerControl').value || '';
    const mounterControl = document.getElementById('mounterControl').value || '';
    const bomQty = document.getElementById('bomQty').value || '';
    const actualQty = document.getElementById('actualQty').value || '';
    const visualResult1 = document.getElementById('visualResult1').value || '';
    const engVerify1 = document.getElementById('engVerify1').value || '';
    const qcVerify1 = document.getElementById('qcVerify1').value || '';
    const reflowParams = document.getElementById('reflowParams').value || '';
    const reflowResult = document.getElementById('reflowResult').value || '';
    const reflowEng = document.getElementById('reflowEng').value || '';
    const reflowQc = document.getElementById('reflowQc').value || '';
    const aoiProgramBot = document.getElementById('aoiProgramBot').value || '';
    const aoiProgramTop = document.getElementById('aoiProgramTop').value || '';
    const aoiQty = document.getElementById('aoiQty').value || '';
    const aoiResult = document.getElementById('aoiResult').value || '';
    const aoiEng = document.getElementById('aoiEng').value || '';
    const aoiQc = document.getElementById('aoiQc').value || '';
    const probeProgramBot = document.getElementById('probeProgramBot').value || '';
    const probeProgramTop = document.getElementById('probeProgramTop').value || '';
    const probeQty = document.getElementById('probeQty').value || '';
    const probeResult = document.getElementById('probeResult').value || '';
    const probeEng = document.getElementById('probeEng').value || '';
    const probeQc = document.getElementById('probeQc').value || '';
    const visual2Result1 = document.getElementById('visual2Result1').value || '';
    const visual2Result2 = document.getElementById('visual2Result2').value || '';
    const visual2Result3 = document.getElementById('visual2Result3').value || '';
    const visual2Result4 = document.getElementById('visual2Result4').value || '';
    const visual2Eng = document.getElementById('visual2Eng').value || '';
    const visual2Qc = document.getElementById('visual2Qc').value || '';
    
    // Through-Hole Process
    const thPartNumber = document.getElementById('thPartNumber').value || '';
    const thPartNumberResult = document.getElementById('thPartNumberResult').value || '';
    const thQuantity = document.getElementById('thQuantity').value || '';
    const thQuantityResult = document.getElementById('thQuantityResult').value || '';
    const thQuantityEng = document.getElementById('thQuantityEng').value || '';
    const thQuantityQc = document.getElementById('thQuantityQc').value || '';
    const handSolderTemp = document.getElementById('handSolderTemp').value || '';
    const handSolderResult = document.getElementById('handSolderResult').value || '';
    const nozzleType = document.getElementById('nozzleType').value || '';
    const nozzleResult = document.getElementById('nozzleResult').value || '';
    const solderParams = document.getElementById('solderParams').value || '';
    const solderParamsResult = document.getElementById('solderParamsResult').value || '';
    const thSolderingEng = document.getElementById('thSolderingEng').value || '';
    const thSolderingQc = document.getElementById('thSolderingQc').value || '';
    const testingResult = document.getElementById('testingResult').value || '';
    const thTestingEng = document.getElementById('thTestingEng').value || '';
    const thTestingQc = document.getElementById('thTestingQc').value || '';
    const cleaningMethod = document.getElementById('cleaningMethod').value || '';
    const cleaningTools = document.getElementById('cleaningTools').value || '';
    const cleaningResult = document.getElementById('cleaningResult').value || '';
    const thCleaningEng = document.getElementById('thCleaningEng').value || '';
    const thCleaningQc = document.getElementById('thCleaningQc').value || '';
    const thVisualQuality = document.getElementById('thVisualQuality').value || '';
    const thVisualComponents = document.getElementById('thVisualComponents').value || '';
    const thVisualResult = document.getElementById('thVisualResult').value || '';
    const thVisualEng = document.getElementById('thVisualEng').value || '';
    const thVisualQc = document.getElementById('thVisualQc').value || '';
    
    // Coating Process
    const coatingSolution = document.getElementById('coatingSolution').value || '';
    const coatingSolutionResult = document.getElementById('coatingSolutionResult').value || '';
    const coatingMethod = document.getElementById('coatingMethod').value || '';
    const coatingMethodResult = document.getElementById('coatingMethodResult').value || '';
    const dryingMethod = document.getElementById('dryingMethod').value || '';
    const dryingMethodResult = document.getElementById('dryingMethodResult').value || '';
    const dryingTemp = document.getElementById('dryingTemp').value || '';
    const dryingTempResult = document.getElementById('dryingTempResult').value || '';
    const dryingTime = document.getElementById('dryingTime').value || '';
    const dryingTimeResult = document.getElementById('dryingTimeResult').value || '';
    const coatingEng = document.getElementById('coatingEng').value || '';
    const coatingQc = document.getElementById('coatingQc').value || '';
    
    // Boxbuild Process
    const assemblyJig = document.getElementById('assemblyJig').value || '';
    const assemblySpec = document.getElementById('assemblySpec').value || '';
    const assemblyJigResult = document.getElementById('assemblyJigResult').value || '';
    const assemblyJigEng = document.getElementById('assemblyJigEng').value || '';
    const assemblyJigQc = document.getElementById('assemblyJigQc').value || '';
    const assemblyQty = document.getElementById('assemblyQty').value || '';
    const assemblyQtyResult = document.getElementById('assemblyQtyResult').value || '';
    const assemblyQtyEng = document.getElementById('assemblyQtyEng').value || '';
    const assemblyQtyQc = document.getElementById('assemblyQtyQc').value || '';
    const labelPosition = document.getElementById('labelPosition').value || '';
    const labelOrientation = document.getElementById('labelOrientation').value || '';
    const labelContent = document.getElementById('labelContent').value || '';
    const labelResult = document.getElementById('labelResult').value || '';
    const labelEng = document.getElementById('labelEng').value || '';
    const labelQc = document.getElementById('labelQc').value || '';
    const boxInspectionReq = document.getElementById('boxInspectionReq').value || '';
    const boxInspectionDesc = document.getElementById('boxInspectionDesc').value || '';
    const boxInspectionResult = document.getElementById('boxInspectionResult').value || '';
    const boxInspectionEng = document.getElementById('boxInspectionEng').value || '';
    const boxInspectionQc = document.getElementById('boxInspectionQc').value || '';
    
    // Packaging Process
    const packagingMaterial = document.getElementById('packagingMaterial').value || '';
    const packagingMethod = document.getElementById('packagingMethod').value || '';
    const packagingQty = document.getElementById('packagingQty').value || '';
    const packagingResult = document.getElementById('packagingResult').value || '';
    const packagingEng = document.getElementById('packagingEng').value || '';
    const packagingQc = document.getElementById('packagingQc').value || '';
    const packLabelContent = document.getElementById('packLabelContent').value || '';
    const packLabelImage = document.getElementById('packLabelImage').value || '';
    const packLabelResult = document.getElementById('packLabelResult').value || '';
    const packLabelEng = document.getElementById('packLabelEng').value || '';
    const packLabelQc = document.getElementById('packLabelQc').value || '';
    
    // Conclusion
    const finalResult = document.getElementById('finalResult').value || '';
    const processRisks = document.getElementById('processRisks').value || '';
    const lessonsLearned = document.getElementById('lessonsLearned').value || '';
    const processImprovement = document.getElementById('processImprovement').value || '';
    const totalQty = document.getElementById('totalQty').value || '0';
    const okQty = document.getElementById('okQty').value || '0';
    const ngQty = document.getElementById('ngQty').value || '0';
    const defectRate = document.getElementById('defectRate').value || '0%';
    const defectDescription = document.getElementById('defectDescription').value || '';
    
    // Signatures
    const engineerName = document.getElementById('engineerName').value || '';
    const qcName = document.getElementById('qcName').value || '';
    const engineerSignature = localStorage.getItem('engineer_signature');
    const qcSignature = localStorage.getItem('qc_signature');
    
    // Tạo nội dung PDF đầy đủ
    let pdfContent = `
        <div style="width: 100%; font-family: 'Arial', sans-serif; font-size: 10pt; line-height: 1.2; box-sizing: border-box;">
            <!-- Header -->
            <div style="text-align: center; margin-bottom: 10px; border-bottom: 2px solid #000; padding-bottom: 5px;">
                <h1 style="font-size: 16pt; margin: 0; font-weight: bold;">BIỂU GHI NPI - NPI RECORD</h1>
                <div style="font-size: 10pt; margin-top: 3px;">TNEMS-EN-F-048-NPI RECORD-VER03</div>
            </div>
            
            <!-- Product Information -->
            <div style="border: 1px solid #000; margin-bottom: 10px; padding: 8px; page-break-inside: avoid;">
                <div style="background-color: #e0e0e0; padding: 6px; margin: -8px -8px 8px -8px; border-bottom: 1px solid #000; font-weight: bold; font-size: 11pt;">
                    THÔNG TIN SẢN PHẨM - PRODUCT INFORMATION
                </div>
                
                <table style="width: 100%; border-collapse: collapse; margin-top: 5px;">
                    <tr>
                        <td style="width: 25%; font-weight: bold; padding: 3px 0;">MÃ HÀNG / MODEL:</td>
                        <td style="width: 35%; padding: 3px 0;">
                            <strong>${createHighlightedText(model, model !== '')}</strong>
                        </td>
                        <td style="width: 20%; font-weight: bold; padding: 3px 0;">Part No:</td>
                        <td style="width: 20%; padding: 3px 0;">
                            ${createHighlightedText(partNo, partNo !== '')}
                        </td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold; padding: 3px 0;">KHÁCH HÀNG / CUSTOMER:</td>
                        <td style="padding: 3px 0;">
                            <strong>${createHighlightedText(customer, customer !== '')}</strong>
                        </td>
                        <td style="font-weight: bold; padding: 3px 0;">Ngày / Date:</td>
                        <td style="padding: 3px 0;">
                            ${createHighlightedText(date, date !== '')}
                        </td>
                    </tr>
                </table>
                
                <div style="margin-top: 8px;">
                    <span style="font-weight: bold;">Quy trình / Process:</span>
                    <div style="margin-top: 5px;">
                        ${processText ? createHighlightedText(processText, processText !== '') : ''}
                    </div>
                </div>
            </div>`;
    
    // SMT Process Section
    if (processes.includes('SMT')) {
        pdfContent += `
            <!-- SMT Process -->
            <div style="border: 1px solid #000; margin-bottom: 10px; padding: 8px; page-break-inside: avoid;">
                <div style="background-color: #e0e0e0; padding: 6px; margin: -8px -8px 8px -8px; border-bottom: 1px solid #000; font-weight: bold; font-size: 11pt;">
                    SMT PROCESS
                </div>
                
                <!-- LASER MARKING -->
                <div style="margin-top: 10px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        LASER MARKING
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: left; width: 40%;">NỘI DUNG</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: left; width: 60%;">GIÁ TRỊ</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">Tên chương trình/ Program name</td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(laserProgram, laserProgram !== '')}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">Loại QR code/ QR code type</td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(qrType, qrType !== '')}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">Kích thước QR code/ QR code size</td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(qrSize, qrSize !== '')}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">Cường độ khắc/ Engraving intensity</td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(engravingIntensity, engravingIntensity !== '')}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">Side BOT: Nội dung QR code/ QR code content</td>
                            <td style="border: 1px solid #000; padding: 4px; min-height: 30px;">
                                ${qrContentBot ? createHighlightedTextarea(qrContentBot) : ''}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">Side TOP: Nội dung QR code/ QR code content</td>
                            <td style="border: 1px solid #000; padding: 4px; min-height: 30px;">
                                ${qrContentTop ? createHighlightedTextarea(qrContentTop) : ''}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">Nội dung QR code khi quét bằng máy</td>
                            <td style="border: 1px solid #000; padding: 4px; min-height: 30px;">
                                ${qrScanContent ? createHighlightedTextarea(qrScanContent) : ''}
                            </td>
                        </tr>
                    </table>
                </div>
                
                <!-- PRINTER -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        PRINTER
                    </div>
                    <div style="padding: 5px;">
                        ${printerControl ? createHighlightedText(printerControl) : ''}
                    </div>
                </div>
                
                <!-- MOUNTER -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        MOUNTER
                    </div>
                    <div style="padding: 5px;">
                        ${mounterControl ? createHighlightedText(mounterControl) : ''}
                    </div>
                </div>
                
                <!-- VISUAL INSPECTION 1 -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        NGOẠI QUAN VISUAL INSPECTION
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 40%;">HƯỚNG LINH KIỆN/COMPONENT POLARITY</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">SỐ LƯỢNG LINH KIỆN/COMPONENT QUANTITY</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">KẾT QUẢ/RESULT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">Theo bảng hướng linh kiện đính kèm (QC)</td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                <div>Theo BOM/ According to the BOM: 
                                    ${createHighlightedText(bomQty, bomQty !== '')}
                                </div>
                                <div style="margin-top: 5px;">Thực tế/ Reality: 
                                    ${createHighlightedText(actualQty, actualQty !== '')}
                                </div>
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${visualResult1 ? createHighlightedSelect(visualResult1) : ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                <div>ENG: ${createHighlightedText(engVerify1, engVerify1 !== '')}</div>
                                <div style="margin-top: 2px;">QC: ${createHighlightedText(qcVerify1, qcVerify1 !== '')}</div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <!-- REFLOW OVEN -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        LÒ REFLOW/REFLOW OVEN
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 40%;">THÔNG SỐ CÀI ĐẶT MÁY/MACHINE PARAMETERS SETTING</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">KẾT QUẢ/RESULT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">
                                - Theo Process control sheet đính kèm<br>
                                - Profile lò đính kèm
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; min-height: 40px;">
                                ${reflowParams ? createHighlightedTextarea(reflowParams) : ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${reflowResult ? createHighlightedSelect(reflowResult) : ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                <div>ENG: ${createHighlightedText(reflowEng, reflowEng !== '')}</div>
                                <div style="margin-top: 2px;">QC: ${createHighlightedText(reflowQc, reflowQc !== '')}</div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <!-- AOI -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        AOI/AUTOMATED OPTICAL INSPECTION
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 25%;">SỐ LƯỢNG PCBA ĐÃ AOI/PCBA AOI INSPECTED QUANTITY</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">KẾT QUẢ/RESULT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">
                                <div>BOT: ${createHighlightedText(aoiProgramBot, aoiProgramBot !== '')}</div>
                                <div style="margin-top: 5px;">TOP: ${createHighlightedText(aoiProgramTop, aoiProgramTop !== '')}</div>
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${createHighlightedText(aoiQty, aoiQty !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${aoiResult ? createHighlightedSelect(aoiResult) : ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                <div>ENG: ${createHighlightedText(aoiEng, aoiEng !== '')}</div>
                                <div style="margin-top: 2px;">QC: ${createHighlightedText(aoiQc, aoiQc !== '')}</div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <!-- FLYING PROBE -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        FLYING PROBE (20%)
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 25%;">SỐ LƯỢNG ĐÃ ĐO/MEASURED QUANTITY</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">KẾT QUẢ/RESULT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">
                                <div>BOT: ${createHighlightedText(probeProgramBot, probeProgramBot !== '')}</div>
                                <div style="margin-top: 5px;">TOP: ${createHighlightedText(probeProgramTop, probeProgramTop !== '')}</div>
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${createHighlightedText(probeQty, probeQty !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${probeResult ? createHighlightedSelect(probeResult) : ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                <div>ENG: ${createHighlightedText(probeEng, probeEng !== '')}</div>
                                <div style="margin-top: 2px;">QC: ${createHighlightedText(probeQc, probeQc !== '')}</div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <!-- VISUAL INSPECTION 2 -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        NGOẠI QUAN VISUAL INSPECTION
                    </div>
                    <div style="font-size: 8pt; color: #666; margin: 5px 0; font-style: italic;">
                        KIỂM TRA SỐ LƯỢNG LINH KIỆN, CHẤT LƯỢNG MỐI HÀN, HƯỚNG LINH KIỆN, CÁC LỖI ĐÁNH GIÁ THEO IPC
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 40%;">NỘI DUNG KIỂM TRA</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">KẾT QUẢ</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">- Số lượng linh kiện/ Component Quantity</td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${visual2Result1 ? createHighlightedSelect(visual2Result1) : ''}
                            </td>
                            <td rowspan="4" style="border: 1px solid #000; padding: 4px; text-align: center; vertical-align: middle;">
                                <div>ENG: ${createHighlightedText(visual2Eng, visual2Eng !== '')}</div>
                                <div style="margin-top: 10px;">QC: ${createHighlightedText(visual2Qc, visual2Qc !== '')}</div>
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">- Chất lượng mối hàn/ Solder Joint Quality</td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${visual2Result2 ? createHighlightedSelect(visual2Result2) : ''}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">- Hướng linh kiện/ Component Orientation</td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${visual2Result3 ? createHighlightedSelect(visual2Result3) : ''}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">- Các lỗi đánh giá theo IPC/ Defects Evaluated per IPC</td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${visual2Result4 ? createHighlightedSelect(visual2Result4) : ''}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>`;
    }
    
    // Through-Hole Process Section
    if (processes.includes('THROUGH HOLE')) {
        pdfContent += `
            <!-- THROUGH-HOLE Process -->
            <div style="border: 1px solid #000; margin-bottom: 10px; padding: 8px; page-break-inside: avoid;">
                <div style="background-color: #e0e0e0; padding: 6px; margin: -8px -8px 8px -8px; border-bottom: 1px solid #000; font-weight: bold; font-size: 11pt;">
                    THROUGH-HOLE PROCESS
                </div>
                
                <!-- Component Quantity Check -->
                <div style="margin-top: 10px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        KIỂM TRA SỐ LƯỢNG LINH KIỆN / COMPONENT QUANTITY CHECK
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 40%;">NỘI DUNG KIỂM TRA/INSPECTION CONTENT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">GIÁ TRỊ/VALUE</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">KẾT QUẢ/RESULT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">ĐÚNG MÃ / CORRECT PART NUMBER</td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(thPartNumber, thPartNumber !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${thPartNumberResult ? createHighlightedSelect(thPartNumberResult) : ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                <div>ENG: ${createHighlightedText(thQuantityEng, thQuantityEng !== '')}</div>
                                <div style="margin-top: 2px;">QC: ${createHighlightedText(thQuantityQc, thQuantityQc !== '')}</div>
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">SỐ LƯỢNG / QUANTITY</td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(thQuantity, thQuantity !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${thQuantityResult ? createHighlightedSelect(thQuantityResult) : ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                <div>ENG: ${createHighlightedText(thQuantityEng, thQuantityEng !== '')}</div>
                                <div style="margin-top: 2px;">QC: ${createHighlightedText(thQuantityQc, thQuantityQc !== '')}</div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <!-- Soldering -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        HÀN / SOLDERING
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 40%;">THÔNG SỐ / PARAMETERS</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">GIÁ TRỊ / VALUE</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">KẾT QUẢ / RESULT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">NHIỆT ĐỘ CÀI ĐẶT HÀN TAY / HAND SOLDERING TEMPERATURE SETTING</td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(handSolderTemp, handSolderTemp !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${handSolderResult ? createHighlightedSelect(handSolderResult) : ''}
                            </td>
                            <td rowspan="3" style="border: 1px solid #000; padding: 4px; text-align: center; vertical-align: middle;">
                                <div>ENG: ${createHighlightedText(thSolderingEng, thSolderingEng !== '')}</div>
                                <div style="margin-top: 10px;">QC: ${createHighlightedText(thSolderingQc, thSolderingQc !== '')}</div>
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">Loại nozzle/Nozzle type:</td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(nozzleType, nozzleType !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${nozzleResult ? createHighlightedSelect(nozzleResult) : ''}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">Preheat (ºC): Solder pot (ºC): Thời gian preheat (s)</td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(solderParams, solderParams !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${solderParamsResult ? createHighlightedSelect(solderParamsResult) : ''}
                            </td>
                        </tr>
                    </table>
                </div>
                
                <!-- Testing -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        TESTING
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 40%;">GIÁ TRỊ KIỂM TRA / INSPECTION VALUE</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">CÁC BƯỚC KIỂM TRA / INSPECTION STEPS</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">KẾT QUẢ / RESULT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">Xem file đính kèm Test đính kèm / See attached file</td>
                            <td style="border: 1px solid #000; padding: 4px;">Xem file đính kèm Test đính kèm / See attached file</td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${testingResult ? createHighlightedSelect(testingResult) : ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                <div>ENG: ${createHighlightedText(thTestingEng, thTestingEng !== '')}</div>
                                <div style="margin-top: 2px;">QC: ${createHighlightedText(thTestingQc, thTestingQc !== '')}</div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <!-- PCBA Cleaning -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        VỆ SINH PCBA / PCBA CLEANING
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 40%;">PHƯƠNG PHÁP VỆ SINH / CLEANING METHOD</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">DỤNG CỤ & DUNG DỊCH / TOOLS & SOLUTION</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">KẾT QUẢ / RESULT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(cleaningMethod, cleaningMethod !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(cleaningTools, cleaningTools !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${cleaningResult ? createHighlightedSelect(cleaningResult) : ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                <div>ENG: ${createHighlightedText(thCleaningEng, thCleaningEng !== '')}</div>
                                <div style="margin-top: 2px;">QC: ${createHighlightedText(thCleaningQc, thCleaningQc !== '')}</div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <!-- Visual Inspection -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        NGOẠI QUAN VISUAL INSPECTION
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 40%;">CHẤT LƯỢNG MỐI HÀN VÀ VỆ SINH / SOLDER JOINT QUALITY AND CLEANLINESS</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">ĐÚNG, ĐỦ LINH KIỆN / CORRECT AND COMPLETE COMPONENTS</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">KẾT QUẢ / RESULT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(thVisualQuality, thVisualQuality !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(thVisualComponents, thVisualComponents !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${thVisualResult ? createHighlightedSelect(thVisualResult) : ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                <div>ENG: ${createHighlightedText(thVisualEng, thVisualEng !== '')}</div>
                                <div style="margin-top: 2px;">QC: ${createHighlightedText(thVisualQc, thVisualQc !== '')}</div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>`;
    }
    
    // Coating Process Section
    if (processes.includes('COATING')) {
        pdfContent += `
            <!-- COATING Process -->
            <div style="border: 1px solid #000; margin-bottom: 10px; padding: 8px; page-break-inside: avoid;">
                <div style="background-color: #e0e0e0; padding: 6px; margin: -8px -8px 8px -8px; border-bottom: 1px solid #000; font-weight: bold; font-size: 11pt;">
                    COATING PROCESS
                </div>
                
                <div style="margin-top: 10px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        COATING
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 40%;">THÔNG SỐ / PARAMETERS</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 40%;">GIÁ TRỊ / VALUE</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 10%;">KẾT QUẢ / RESULT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 10%;">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">- Dung dịch coating/ Coating solution:</td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(coatingSolution, coatingSolution !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${coatingSolutionResult ? createHighlightedSelect(coatingSolutionResult) : ''}
                            </td>
                            <td rowspan="5" style="border: 1px solid #000; padding: 4px; text-align: center; vertical-align: middle;">
                                <div>ENG: ${createHighlightedText(coatingEng, coatingEng !== '')}</div>
                                <div style="margin-top: 10px;">QC: ${createHighlightedText(coatingQc, coatingQc !== '')}</div>
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">- Phương pháp coating/ Coating method:</td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(coatingMethod, coatingMethod !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${coatingMethodResult ? createHighlightedSelect(coatingMethodResult) : ''}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">- Phương pháp sấy/ Drying method:</td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(dryingMethod, dryingMethod !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${dryingMethodResult ? createHighlightedSelect(dryingMethodResult) : ''}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">- Nhiệt độ sấy/ Drying temperature:</td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(dryingTemp, dryingTemp !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${dryingTempResult ? createHighlightedSelect(dryingTempResult) : ''}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">- Thời gian sấy/ Drying time:</td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(dryingTime, dryingTime !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${dryingTimeResult ? createHighlightedSelect(dryingTimeResult) : ''}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>`;
    }
    
    // Boxbuild Process Section
    if (processes.includes('BOXBUILD')) {
        pdfContent += `
            <!-- BOXBUILD Process -->
            <div style="border: 1px solid #000; margin-bottom: 10px; padding: 8px; page-break-inside: avoid;">
                <div style="background-color: #e0e0e0; padding: 6px; margin: -8px -8px 8px -8px; border-bottom: 1px solid #000; font-weight: bold; font-size: 11pt;">
                    LẮP RÁP / BOXBUILD PROCESS
                </div>
                
                <!-- Assembly Jig/Tool -->
                <div style="margin-top: 10px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        LẮP RÁP BOXBUILD
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 40%;">JIG/DỤNG CỤ LẮP RÁP / ASSEMBLY JIG OR TOOL</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">TIÊU CHUẨN / SPECIFICATION</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">KẾT QUẢ / RESULT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(assemblyJig, assemblyJig !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(assemblySpec, assemblySpec !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${assemblyJigResult ? createHighlightedSelect(assemblyJigResult) : ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                <div>ENG: ${createHighlightedText(assemblyJigEng, assemblyJigEng !== '')}</div>
                                <div style="margin-top: 2px;">QC: ${createHighlightedText(assemblyJigQc, assemblyJigQc !== '')}</div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <!-- Assembly Component -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        SỐ LƯỢNG LINH KIỆN LẮP RÁP / ASSEMBLY COMPONENT QUANTITY
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 40%;">SỐ LƯỢNG LINH KIỆN / COMPONENT QUANTITY</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">HƯỚNG/CHIỀU LẮP LINH KIỆN / COMPONENT ORIENTATION</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">KẾT QUẢ / RESULT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(assemblyQty, assemblyQty !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px;">Theo bản vẽ/ According to the drawing</td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${assemblyQtyResult ? createHighlightedSelect(assemblyQtyResult) : ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                <div>ENG: ${createHighlightedText(assemblyQtyEng, assemblyQtyEng !== '')}</div>
                                <div style="margin-top: 2px;">QC: ${createHighlightedText(assemblyQtyQc, assemblyQtyQc !== '')}</div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <!-- IMEI/Label -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        IMEI / LABEL
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 25%;">VỊ TRÍ DÁN NHÃN / LABEL POSITION</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 20%;">HƯỚNG DÁN NHÃN / LABEL ORIENTATION</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 35%;">NỘI DUNG NHÃN / LABEL CONTENT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 10%;">KẾT QUẢ / RESULT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 10%;">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(labelPosition, labelPosition !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(labelOrientation, labelOrientation !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(labelContent, labelContent !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${labelResult ? createHighlightedSelect(labelResult) : ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                <div>ENG: ${createHighlightedText(labelEng, labelEng !== '')}</div>
                                <div style="margin-top: 2px;">QC: ${createHighlightedText(labelQc, labelQc !== '')}</div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <!-- Visual Inspection -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        KIỂM TRA NGOẠI QUAN / VISUAL INSPECTION
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 40%;">TIÊU CHUẨN KIỂM TRA / INSPECTION REQUIREMENT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 40%;">MÔ TẢ / DESCRIPTION</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 10%;">KẾT QUẢ / RESULT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 10%;">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(boxInspectionReq, boxInspectionReq !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(boxInspectionDesc, boxInspectionDesc !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${boxInspectionResult ? createHighlightedSelect(boxInspectionResult) : ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                <div>ENG: ${createHighlightedText(boxInspectionEng, boxInspectionEng !== '')}</div>
                                <div style="margin-top: 2px;">QC: ${createHighlightedText(boxInspectionQc, boxInspectionQc !== '')}</div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>`;
    }
    
    // Packaging Process Section
    if (processes.includes('PACKING')) {
        pdfContent += `
            <!-- PACKAGING Process -->
            <div style="border: 1px solid #000; margin-bottom: 10px; padding: 8px; page-break-inside: avoid;">
                <div style="background-color: #e0e0e0; padding: 6px; margin: -8px -8px 8px -8px; border-bottom: 1px solid #000; font-weight: bold; font-size: 11pt;">
                    ĐÓNG GÓI / PACKAGING PROCESS
                </div>
                
                <!-- Packaging -->
                <div style="margin-top: 10px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        ĐÓNG GÓI / PACKAGING
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">VẬT LIỆU ĐÓNG GÓI / PACKAGING MATERIAL</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">PHƯƠNG PHÁP ĐÓNG GÓI / PACKAGING METHOD</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 20%;">SỐ LƯỢNG/THÙNG / QUANTITY PER BOX</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 10%;">KẾT QUẢ / RESULT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 10%;">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">
                                <div>- Theo BOM Đính kèm/ Attached BOM</div>
                                <div>- Bổ sung (nếu có)/ Additional (if any): 
                                    ${createHighlightedText(packagingMaterial, packagingMaterial !== '')}
                                </div>
                            </td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(packagingMethod, packagingMethod !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(packagingQty, packagingQty !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${packagingResult ? createHighlightedSelect(packagingResult) : ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                <div>ENG: ${createHighlightedText(packagingEng, packagingEng !== '')}</div>
                                <div style="margin-top: 2px;">QC: ${createHighlightedText(packagingQc, packagingQc !== '')}</div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <!-- Label -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        LABEL
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 40%;">NỘI DUNG LABEL / LABEL CONTENT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 40%;">MẪU HOẶC HÌNH ẢNH LABEL THỰC TẾ / ACTUAL IMAGE/SAMPLE</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 10%;">KẾT QUẢ / RESULT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 10%;">XÁC NHẬN / VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(packLabelContent, packLabelContent !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                <div>- Thêm hình ảnh hoặc mẫu thực tế vào ô này</div>
                                <div>- Add actual image in this box</div>
                                ${packLabelImage ? createHighlightedTextarea(packLabelImage) : ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${packLabelResult ? createHighlightedSelect(packLabelResult) : ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                <div>ENG: ${createHighlightedText(packLabelEng, packLabelEng !== '')}</div>
                                <div style="margin-top: 2px;">QC: ${createHighlightedText(packLabelQc, packLabelQc !== '')}</div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>`;
    }
    
    // Conclusion Section (Luôn hiển thị)
    pdfContent += `
            <!-- Conclusion -->
            <div style="border: 1px solid #000; margin-bottom: 10px; padding: 8px; page-break-inside: avoid;">
                <div style="background-color: #e0e0e0; padding: 6px; margin: -8px -8px 8px -8px; border-bottom: 1px solid #000; font-weight: bold; font-size: 11pt;">
                    KẾT LUẬN / CONCLUSION
                </div>
                
                <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                    <tr>
                        <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 20%;">KẾT QUẢ CUỐI CÙNG / FINAL RESULT</th>
                        <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 25%;">RỦI RO TRONG CÁC CÔNG ĐOẠN / RISKS IN EACH PROCESS STEP</th>
                        <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 25%;">BÀI HỌC TỪNG CÔNG ĐOẠN / LESSONS LEARNED FROM EACH PROCESS STEP</th>
                        <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">CẢI TIẾN CÔNG ĐOẠN / PROCESS IMPROVEMENT</th>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 4px; text-align: center; vertical-align: middle;">
                            ${finalResult ? createHighlightedSelect(finalResult) : ''}
                        </td>
                        <td style="border: 1px solid #000; padding: 4px; min-height: 100px;">
                            ${processRisks ? createHighlightedTextarea(processRisks) : ''}
                        </td>
                        <td style="border: 1px solid #000; padding: 4px; min-height: 100px;">
                            ${lessonsLearned ? createHighlightedTextarea(lessonsLearned) : ''}
                        </td>
                        <td style="border: 1px solid #000; padding: 4px; min-height: 100px;">
                            ${processImprovement ? createHighlightedTextarea(processImprovement) : ''}
                        </td>
                    </tr>
                </table>
                
                <div style="margin-top: 15px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                        <tr>
                            <td style="padding: 4px; width: 25%;">
                                <div><strong>Tổng số lượng (PCBA):</strong></div>
                                <div><strong>Total qty (PCBA):</strong></div>
                                <div style="margin-top: 5px; font-size: 11pt;">
                                    ${totalQty !== '0' ? createHighlightedText(totalQty) : '0'}
                                </div>
                            </td>
                            <td style="padding: 4px; width: 20%;">
                                <div><strong>OK :</strong></div>
                                <div style="margin-top: 5px; font-size: 11pt;">
                                    ${okQty !== '0' ? createHighlightedText(okQty) : '0'}
                                </div>
                            </td>
                            <td style="padding: 4px; width: 20%;">
                                <div><strong>NG (scrap) :</strong></div>
                                <div style="margin-top: 5px; font-size: 11pt;">
                                    ${ngQty !== '0' ? createHighlightedText(ngQty) : '0'}
                                </div>
                            </td>
                            <td style="padding: 4px; width: 35%;">
                                <div><strong>Tỷ lệ lỗi/ Defect rate (%) :</strong></div>
                                <div><strong>(NG/Total)</strong></div>
                                <div style="margin-top: 5px; font-size: 11pt;">
                                    ${defectRate !== '0%' ? createHighlightedText(defectRate) : '0%'}
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <div style="margin-top: 10px;">
                    <div><strong>Mô tả chi tiết lỗi / detailed defect description:</strong></div>
                    <div style="margin-top: 5px; min-height: 50px;">
                        ${defectDescription ? createHighlightedTextarea(defectDescription) : ''}
                    </div>
                </div>
                
                <!-- Electronic Signatures -->
                <div style="margin-top: 20px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px 0;">
                        XÁC NHẬN ĐIỆN TỬ - ELECTRONIC SIGNATURES
                    </div>
                    
                    <div style="display: flex; gap: 30px; margin-top: 10px;">
                        <div style="flex: 1;">
                            <div><strong>Ký xác nhận của Kỹ sư / Engineer Signature:</strong></div>
                            <div style="border: 1px solid #000; padding: 10px; margin-top: 5px; min-height: 80px; display: flex; align-items: center; justify-content: center;">
                                ${engineerSignature ? `<img src="${engineerSignature}" alt="Engineer Signature" style="max-width: 100%; max-height: 70px;">` : ''}
                            </div>
                            <div style="margin-top: 5px;">
                                <strong>Tên Kỹ sư / Engineer Name:</strong> 
                                ${engineerName ? createHighlightedText(engineerName) : ''}
                            </div>
                        </div>
                        
                        <div style="flex: 1;">
                            <div><strong>Ký xác nhận của QC / QC Signature:</strong></div>
                            <div style="border: 1px solid #000; padding: 10px; margin-top: 5px; min-height: 80px; display: flex; align-items: center; justify-content: center;">
                                ${qcSignature ? `<img src="${qcSignature}" alt="QC Signature" style="max-width: 100%; max-height: 70px;">` : ''}
                            </div>
                            <div style="margin-top: 5px;">
                                <strong>Tên QC / QC Name:</strong> 
                                ${qcName ? createHighlightedText(qcName) : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div style="text-align: center; margin-top: 20px; color: #666; font-size: 9pt; padding-top: 15px; border-top: 1px solid #ddd;">
                <p>NPI Record - Phiên bản Multi-User Real-time</p>
                <p>© 2024 - Đồng bộ thời gian thực với Firebase</p>
            </div>
        </div>`;
    
    return pdfContent;
}

        // ========== ĐỊNH DẠNG NGÀY THÁNG ==========
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // ========== VALIDATE FORM ==========
        function validateForm() {
            const model = document.getElementById('model').value.trim();
            const customer = document.getElementById('customer').value.trim();
            
            let isValid = true;
            
            if (!model) {
                document.getElementById('model').classList.add('validation-error');
                isValid = false;
            } else {
                document.getElementById('model').classList.remove('validation-error');
            }
            
            if (!customer) {
                document.getElementById('customer').classList.add('validation-error');
                isValid = false;
            } else {
                document.getElementById('customer').classList.remove('validation-error');
            }
            
            return isValid;
        }

        // ========== IN TRỰC TIẾP ==========
        function printForm() {
            if (!validateForm()) {
                showToast('Vui lòng điền đầy đủ các trường bắt buộc (Mã hàng và Khách hàng) trước khi in!', 'error');
                return;
            }
            
            // Tạo template cho in ấn
            const printTemplate = document.createElement('div');
            printTemplate.innerHTML = generatePDFContentNew();
            
            // Mở cửa sổ in
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>NPI Record - ${document.getElementById('model').value || 'Unknown'}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 10pt;
                            margin: 0;
                            padding: 15mm;
                            line-height: 1.2;
                        }
                        @media print {
                            body { padding: 0; }
                            .page-break { page-break-before: always; }
                        }
                    </style>
                </head>
                <body>
                    ${printTemplate.innerHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // ========== CÁC HÀM TIỆN ÍCH ==========
        function setupFormListeners() {
            document.querySelectorAll("textarea").forEach(textarea => {
                textarea.addEventListener("input", function() {
                    this.style.height = "auto";
                    this.style.height = this.scrollHeight + "px";
                });
                setTimeout(() => {
                    textarea.dispatchEvent(new Event("input"));
                }, 100);
            });
        }

        function updateStatus(message, status = "offline") {
            const statusEl = document.getElementById("cloudStatus");
            const textEl = document.getElementById("cloudStatusText");
            
            if (statusEl) statusEl.className = "status-indicator " + status;
            if (textEl) textEl.textContent = message;
        }

        function updateCloudStatus() {
            const isOnline = navigator.onLine;
            updateStatus(isOnline ? "Đang kết nối" : "Mất kết nối", isOnline ? "online" : "offline");
        }

        // ========== TAB NAVIGATION ==========
        function setupTabNavigation() {
            const tabs = document.querySelectorAll('.process-tab');
            const contents = document.querySelectorAll('.process-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show active content
                    contents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${tabId}-process` || 
                            (tabId === 'smt' && content.id === 'smt-process') ||
                            (tabId === 'through-hole' && content.id === 'through-hole-process') ||
                            (tabId === 'coating' && content.id === 'coating-process') ||
                            (tabId === 'boxbuild' && content.id === 'boxbuild-process') ||
                            (tabId === 'packaging' && content.id === 'packaging-process') ||
                            (tabId === 'conclusion' && content.id === 'conclusion-process')) {
                            content.classList.add('active');
                        }
                    });
                });
            });
        }

        // ========== RESET FORM ==========
        function resetForm() {
            if (confirm("Bạn có chắc muốn xóa TẤT CẢ dữ liệu hiện tại?\n\nDữ liệu đã lưu trên cloud vẫn giữ nguyên.")) {
                document.querySelectorAll("input, textarea, select").forEach(element => {
                    if (element.type === "checkbox") {
                        element.checked = false;
                    } else if (element.type === "date") {
                        element.value = new Date().toISOString().split("T")[0];
                    } else if (element.type !== "button" && element.type !== "submit") {
                        element.value = "";
                    }
                    updateHighlight(element);
                });
                
                if (engineerSignaturePad) engineerSignaturePad.clear();
                if (qcSignaturePad) qcSignaturePad.clear();
                localStorage.removeItem("engineer_signature");
                localStorage.removeItem("qc_signature");
                const engDisplay = document.getElementById("engineerSignatureDisplay");
                const qcDisplay = document.getElementById("qcSignatureDisplay");
                if (engDisplay) {
                    engDisplay.innerHTML = '<div style="padding: 10px; text-align: center;">Chữ ký sẽ hiển thị ở đây sau khi lưu</div>';
                    engDisplay.classList.remove("has-signature");
                }
                if (qcDisplay) {
                    qcDisplay.innerHTML = '<div style="padding: 10px; text-align: center;">Chữ ký sẽ hiển thị ở đây sau khi lưu</div>';
                    qcDisplay.classList.remove("has-signature");
                }
                
                updateStatus("Đã xóa dữ liệu cục bộ", "offline");
                showToast("✅ Đã xóa dữ liệu cục bộ thành công!", "success");
            }
        }

        // ========== KHỞI ĐỘNG TRANG ==========
        document.addEventListener("DOMContentLoaded", function() {
            console.log("🚀 Khởi động NPI Record Multi-User...");
            
            initUser();
            
            const today = new Date().toISOString().split("T")[0];
            document.getElementById("date").value = today;
            
            const urlParams = new URLSearchParams(window.location.search);
            const projectIdFromUrl = urlParams.get("project");
            
            setupHighlightListeners();
            setupSignaturePads();
            setupFormListeners();
            setupRealTimeInput();
            setupTabNavigation();
            
            document.getElementById("projectAction").addEventListener("click", handleProjectAction);
            document.getElementById("saveToCloud").addEventListener("click", saveAllToCloud);
            document.getElementById("shareForm").addEventListener("click", generateShareLink);
            document.getElementById("exportPdf").addEventListener("click", exportToPDF);
            document.getElementById("printForm").addEventListener("click", printForm);
            document.getElementById("resetForm").addEventListener("click", resetForm);
            document.getElementById("copyLinkBtn").addEventListener("click", copyShareLink);
            document.getElementById("closeShareBtn").addEventListener("click", hideShareLink);
            
            document.getElementById("projectIdDisplay")?.addEventListener("click", function() {
                if (currentProjectId) {
                    navigator.clipboard.writeText(currentProjectId).then(() => {
                        showToast("✅ Đã copy Project ID", "success");
                    });
                }
            });
            
            if (projectIdFromUrl) {
                setTimeout(() => {
                    showLoading("Đang kết nối đến project...");
                    currentProjectId = projectIdFromUrl;
                    document.getElementById("projectIdDisplay").textContent = `ID: ${projectIdFromUrl}`;
                    document.getElementById("onlineUsersContainer").style.display = "block";
                    
                    if (!currentUser) initUser();
                    setupRealtimeListeners();
                    loadProjectData();
                    
                    showToast("📡 Đã tự động kết nối đến project", "info");
                    updateStatus("Đang đồng bộ thời gian thực", "online");
                    
                    setTimeout(hideLoading, 1000);
                }, 500);
            }
            
            window.addEventListener("online", updateCloudStatus);
            window.addEventListener("offline", updateCloudStatus);
            
            updateCloudStatus();
        });

        function setupHighlightListeners() {
            document.querySelectorAll("input, textarea, select").forEach(element => {
                updateHighlight(element);
                
                element.addEventListener("input", function() {
                    updateHighlight(this);
                });
                
                element.addEventListener("change", function() {
                    updateHighlight(this);
                });
            });
            
            document.querySelectorAll(".checkbox-group input[type='checkbox']").forEach(cb => {
                cb.addEventListener("change", function() {
                    updateHighlight(this);
                    const label = this.nextElementSibling;
                    if (label && this.checked) {
                        label.classList.add("highlight-text");
                    } else {
                        label.classList.remove("highlight-text");
                    }
                });
            });
        }

        console.log("🔥 NPI Record Multi-User đã sẵn sàng!");
        console.log("📌 Hướng dẫn sử dụng:");
        console.log("1. Click 'Tạo/Tham gia Project' để bắt đầu");
        console.log("2. Tạo project mới hoặc nhập ID project có sẵn");
        console.log("3. Chia sẻ link cho đồng nghiệp");
        console.log("4. Cùng nhập dữ liệu thời gian thực!");
    </script>
</body>
</html>