<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPI Record - Multi-User Real-time</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #000;
            line-height: 1.2;
            padding: 10px;
            margin: 0;
            font-size: 11px;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .form-content {
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }
        
        .header h1 {
            color: #000;
            margin-bottom: 5px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .form-section {
            margin-bottom: 20px;
            border: 1px solid #000;
            border-radius: 2px;
            padding: 10px;
            background-color: #fff;
            page-break-inside: avoid;
        }
        
        .section-title {
            background-color: #e0e0e0;
            color: #000;
            padding: 8px 10px;
            margin: -10px -10px 10px -10px;
            border-bottom: 1px solid #000;
            font-size: 14px;
            font-weight: bold;
        }
        
        .sub-section-title {
            background-color: #f0f0f0;
            color: #000;
            padding: 6px 8px;
            margin: 10px -10px;
            border-top: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            font-size: 13px;
            font-weight: bold;
        }
        
        .form-row {
            display: flex;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .form-group {
            flex: 1;
            min-width: 180px;
            margin-bottom: 8px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #000;
            font-size: 11px;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 5px 8px;
            border: 1px solid #999;
            border-radius: 3px;
            font-size: 11px;
            background-color: white;
            transition: all 0.3s ease;
        }
        
        .form-group textarea {
            min-height: 70px;
            resize: vertical;
            overflow-y: auto;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 8px;
            padding: 8px 0;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
        }
        
        .checkbox-item input {
            margin-right: 6px;
        }
        
        .signature-container {
            border: 1px solid #999;
            border-radius: 3px;
            padding: 8px;
            margin-top: 8px;
            background-color: white;
        }
        
        .signature-pad {
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 100%;
            height: 120px;
            cursor: crosshair;
        }
        
        .signature-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .signature-controls button {
            padding: 6px 12px;
            background-color: #4a6fa5;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .signature-controls button:hover {
            background-color: #3a5a8a;
        }
        
        .signature-display {
            height: 80px;
            border: 1px dashed #999;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-style: italic;
            background-color: #f9f9f9;
        }
        
        .signature-display img {
            max-width: 100%;
            max-height: 100%;
        }
        
        .buttons-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 5px;
            position: sticky;
            top: 10px;
            z-index: 100;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            min-width: 160px;
        }
        
        .btn-primary {
            background-color: #4a6fa5;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #3a5a8a;
        }
        
        .btn-success {
            background-color: #2e7d32;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #1b5e20;
        }
        
        .btn-danger {
            background-color: #c62828;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #b71c1c;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            margin-bottom: 15px;
            font-size: 11px;
            table-layout: fixed;
        }
        
        th, td {
            border: 1px solid #000;
            padding: 6px;
            text-align: left;
            vertical-align: top;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        th {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: center;
        }
        
        td.long-content-cell {
            min-height: 60px;
            height: auto;
        }
        
        .note {
            font-size: 10px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        .footer {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 11px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                padding: 0;
                margin: 0;
                background-color: white;
                font-size: 10pt;
            }
            
            .container {
                box-shadow: none;
                padding: 0;
                margin: 0;
                width: 100%;
            }
            
            .form-content {
                padding: 15mm;
            }
            
            .signature-display {
                border: 1px solid #000;
            }
            
            .buttons-container {
                display: none;
            }
            
            .form-section {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            table {
                page-break-inside: auto;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            td, th {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            td {
                overflow: visible !important;
                height: auto !important;
                max-height: none !important;
            }
            
            input, textarea, select, .signature-pad {
                display: none !important;
            }
            
            .pdf-value-display {
                display: block !important;
            }
        }
        
        .input-small {
            width: 100px;
            display: inline-block;
        }
        
        .input-medium {
            width: 180px;
            display: inline-block;
        }
        
        .form-group.full-width {
            flex: 0 0 100%;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        /* ========== HIGHLIGHT DỮ LIỆU ĐÃ NHẬP ========== */
        .form-input.has-data,
        .form-textarea.has-data,
        .form-select.has-data {
            color: #1565C0 !important;
            border-color: #1565C0 !important;
            background-color: #E3F2FD !important;
            font-weight: 600 !important;
            border-width: 2px !important;
        }
        
        .form-checkbox:checked + label {
            color: #1565C0 !important;
            font-weight: 700 !important;
        }
        
        .checkbox-item input:checked {
            accent-color: #1565C0;
        }
        
        .highlight-text {
            color: #1565C0 !important;
            font-weight: 600 !important;
            background-color: #E3F2FD !important;
            padding: 2px 4px;
            border-radius: 2px;
        }
        
        .signature-display.has-signature {
            border: 2px solid #1565C0;
            background-color: #E8F5E9;
        }
        
        /* ========== STYLE ĐẶC BIỆT ========== */
        input:focus, textarea:focus, select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(21, 101, 192, 0.2);
        }
        
        .highlight-row {
            background-color: #F5F9FF !important;
        }
        
        /* Cloud Status */
        .cloud-status {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cloud-status .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .online { background-color: #4CAF50; }
        .offline { background-color: #f44336; }
        .syncing { 
            background-color: #FF9800; 
            animation: pulse 1s infinite; 
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Online Users */
        .online-users {
            background: linear-gradient(135deg, #2196F3 0%, #21CBF3 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .users-list-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .users-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .user-badge .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .user-badge .user-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        .user-badge.editing {
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 0 2px currentColor;
        }
        
        /* Project Info */
        .project-info {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 10px;
        }
        
        #projectIdDisplay {
            font-family: monospace;
            cursor: pointer;
            padding: 2px 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }
        
        #projectIdDisplay:hover {
            background: rgba(255,255,255,0.5);
        }
        
        /* Field being edited by others */
        .field-being-edited {
            animation: fieldPulse 2s infinite;
            box-shadow: 0 0 0 2px #FF9800 !important;
            position: relative;
        }
        
        .field-being-edited::after {
            content: attr(data-editor);
            position: absolute;
            top: -20px;
            right: 0;
            background: #FF9800;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            white-space: nowrap;
            z-index: 1000;
        }
        
        @keyframes fieldPulse {
            0%, 100% { background-color: rgba(255, 152, 0, 0.1); }
            50% { background-color: rgba(255, 152, 0, 0.3); }
        }
        
        /* Real-time typing indicator */
        .typing-indicator {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #FF9800;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 11px;
            z-index: 9999;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            animation: slideInRight 0.3s;
        }
        
        .field-updated {
            animation: fieldUpdate 1s ease;
        }
        
        @keyframes fieldUpdate {
            0% { background-color: #E8F5E9; }
            50% { background-color: #C8E6C9; }
            100% { background-color: #E8F5E9; }
        }
        
        .share-link-container {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            display: none;
        }
        
        .share-link {
            word-break: break-all;
            background: white;
            padding: 8px;
            border-radius: 3px;
            margin-top: 5px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 12px;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a6fa5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: 500;
            z-index: 10001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }
        
        .toast-success {
            background: #4CAF50;
        }
        
        .toast-error {
            background: #f44336;
        }
        
        .toast-info {
            background: #2196F3;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .pdf-template {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 210mm;
            min-height: 297mm;
            background: white;
            padding: 15mm;
            font-family: 'Arial', sans-serif;
            font-size: 10pt;
            line-height: 1.2;
            display: none;
        }
        
        .validation-error {
            border-color: #f44336 !important;
            box-shadow: 0 0 0 2px rgba(244, 67, 54, 0.2) !important;
        }
    </style>
</head>
<body>
    <!-- Cloud Status Bar -->
    <div class="cloud-status no-print">
        <div>
            <span class="status-indicator offline" id="cloudStatus"></span>
            <span id="cloudStatusText">Chưa kết nối</span>
        </div>
        <div id="userCount" style="display: flex; align-items: center; gap: 5px;">
            <i class="fas fa-users"></i>
            <span>Chưa có project</span>
        </div>
    </div>

    <!-- Online Users -->
    <div class="online-users no-print" id="onlineUsersContainer" style="display: none;">
        <div class="users-list-title">
            <i class="fas fa-users"></i> 
            <span id="onlineUsersCount">0 người online</span>
            <span class="project-info">
                <i class="fas fa-project-diagram"></i>
                <span id="projectIdDisplay" title="Click để copy ID">ID: Chưa có project</span>
            </span>
        </div>
        <div class="users-list" id="usersList"></div>
    </div>

    <!-- Share Link Container -->
    <div class="share-link-container no-print" id="shareLinkContainer">
        <strong><i class="fas fa-share-alt"></i> LINK CHIA SẺ:</strong>
        <div class="share-link" id="shareLinkText"></div>
        <div style="margin-top: 10px;">
            <button id="copyLinkBtn" style="padding: 5px 10px; background: #4a6fa5; color: white; border: none; border-radius: 3px; cursor: pointer;">
                <i class="fas fa-copy"></i> Copy Link
            </button>
            <button id="closeShareBtn" style="margin-left: 10px; padding: 5px 10px; background: #666; color: white; border: none; border-radius: 3px; cursor: pointer;">
                <i class="fas fa-times"></i> Đóng
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div id="loadingMessage">Đang xử lý...</div>
        </div>
    </div>

    <!-- Buttons for actions -->
    <div class="buttons-container no-print">
        <button type="button" class="btn btn-primary" id="projectAction">
            <i class="fas fa-users"></i> Tạo/Tham gia Project
        </button>
        <button type="button" class="btn btn-success" id="saveToCloud">
            <i class="fas fa-cloud-upload-alt"></i> Lưu lên Cloud
        </button>
        <button type="button" class="btn btn-primary" id="shareForm">
            <i class="fas fa-share-alt"></i> Chia sẻ
        </button>
        <button type="button" class="btn btn-success" id="exportPdf">
            <i class="fas fa-file-pdf"></i> Xuất PDF
        </button>
        <button type="button" class="btn btn-danger" id="resetForm">
            <i class="fas fa-redo"></i> Làm mới
        </button>
        <button type="button" class="btn btn-primary" id="printForm">
            <i class="fas fa-print"></i> In trực tiếp
        </button>
    </div>

    <!-- Main form container -->
    <div class="container" id="main-form">
        <div class="form-content">
            <!-- Header -->
            <div class="header">
                <h1>BIỂU GHI NPI - NPI RECORD</h1>
                <div style="font-size: 12px; margin-top: 5px;">TNEMS-EN-F-048-NPI RECORD-VER03</div>
            </div>
            
            <!-- Product Information Section -->
            <div class="form-section" id="section-product-info">
                <div class="section-title">THÔNG TIN SẢN PHẨM - PRODUCT INFORMATION</div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="model">MÃ HÀNG / MODEL: <span class="required" style="color: red;">*</span></label>
                        <input type="text" id="model" placeholder="Nhập mã hàng/model" class="form-input required-field">
                    </div>
                    
                    <div class="form-group">
                        <label for="customer">KHÁCH HÀNG / CUSTOMER: <span class="required" style="color: red;">*</span></label>
                        <input type="text" id="customer" placeholder="Nhập tên khách hàng" class="form-input required-field">
                    </div>
                    
                    <div class="form-group">
                        <label for="partNo">Part No:</label>
                        <input type="text" id="partNo" placeholder="Nhập Part No" class="form-input">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label>Quy trình / Process:</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="processSMT" value="SMT" class="form-checkbox">
                                <label for="processSMT">SMT</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="processThroughHole" value="THROUGH HOLE" class="form-checkbox">
                                <label for="processThroughHole">THROUGH HOLE</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="processCoating" value="COATING" class="form-checkbox">
                                <label for="processCoating">COATING</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="processBoxbuild" value="BOXBUILD" class="form-checkbox">
                                <label for="processBoxbuild">BOXBUILD</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="processPacking" value="PACKING" class="form-checkbox">
                                <label for="processPacking">PACKING</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="flex: 1;">
                        <label for="date">Ngày / Date:</label>
                        <input type="date" id="date" value="" class="form-input">
                    </div>
                </div>
            </div>

            <!-- SMT Section -->
            <div class="form-section" id="section-smt">
                <div class="section-title">SMT PROCESS</div>
                
                <!-- LASER MARKING -->
                <div class="sub-section-title">LASER MARKING</div>
                <table>
                    <tr>
                        <th width="30%">NỘI DUNG</th>
                        <th width="70%">GIÁ TRỊ</th>
                    </tr>
                    <tr>
                        <td>Tên chương trình/ Program name</td>
                        <td>
                            <input type="text" id="laserProgram" placeholder="Nhập tên chương trình" style="width: 100%;" class="form-input">
                        </td>
                    </tr>
                    <tr>
                        <td>Loại QR code/ QR code type</td>
                        <td>
                            <input type="text" id="qrType" placeholder="Nhập loại QR code" style="width: 100%;" class="form-input">
                        </td>
                    </tr>
                    <tr>
                        <td>Kích thước QR code/ QR code size</td>
                        <td>
                            <input type="text" id="qrSize" placeholder="Nhập kích thước QR code" style="width: 100%;" class="form-input">
                        </td>
                    </tr>
                    <tr>
                        <td>Cường độ khắc/ Engraving intensity</td>
                        <td>
                            <input type="text" id="engravingIntensity" placeholder="Nhập cường độ khắc" style="width: 100%;" class="form-input">
                        </td>
                    </tr>
                    <tr>
                        <td>Side BOT: Nội dung QR code/ QR code content</td>
                        <td class="long-content-cell">
                            <textarea id="qrContentBot" placeholder="Nhập nội dung QR code mặt BOT" rows="3" style="width: 100%;" class="form-textarea long-content"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td>Side TOP: Nội dung QR code/ QR code content</td>
                        <td class="long-content-cell">
                            <textarea id="qrContentTop" placeholder="Nhập nội dung QR code mặt TOP" rows="3" style="width: 100%;" class="form-textarea long-content"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td>Nội dung QR code khi quét bằng máy</td>
                        <td class="long-content-cell">
                            <textarea id="qrScanContent" placeholder="Nhập nội dung khi quét QR" rows="3" style="width: 100%;" class="form-textarea long-content"></textarea>
                        </td>
                    </tr>
                </table>
                
                <!-- PRINTER -->
                <div class="sub-section-title">PRINTER</div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <input type="text" id="printerControl" placeholder="Ghi chú về printer" value="Theo Process control sheet đính kèm/According to the attached Process Control Sheet" style="width: 100%;" class="form-input">
                    </div>
                </div>
                
                <!-- MOUNTER -->
                <div class="sub-section-title">MOUNTER</div>
                <div class="form-row">
                    <div class="form-group full-width">
                        <input type="text" id="mounterControl" placeholder="Ghi chú về mounter" value="Theo Process control sheet đính kèm (có xác nhận và đo giá trị của các bên)/According to the attached Process Control Sheet" style="width: 100%;" class="form-input">
                    </div>
                </div>
                
                <!-- VISUAL INSPECTION 1 -->
                <div class="sub-section-title">NGOẠI QUAN VISUAL INSPECTION</div>
                <table>
                    <tr>
                        <th width="40%">HƯỚNG LINH KIỆN/COMPONENT POLARITY</th>
                        <th width="30%">SỐ LƯỢNG LINH KIỆN/COMPONENT QUANTITY</th>
                        <th width="15%">KẾT QUẢ/RESULT</th>
                        <th width="15%">XÁC NHẬN/VERIFY</th>
                    </tr>
                    <tr>
                        <td>Theo bảng hướng linh kiện đính kèm (QC)</td>
                        <td>
                            <div>Theo BOM/ According to the BOM: 
                                <input type="text" id="bomQty" class="input-small form-input" placeholder="Số lượng">
                            </div>
                            <div style="margin-top: 5px;">Thực tế/ Reality: 
                                <input type="text" id="actualQty" class="input-small form-input" placeholder="Số lượng">
                            </div>
                        </td>
                        <td style="text-align: center;">
                            <select id="visualResult1" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                        <td style="text-align: center;">
                            <div>ENG: 
                                <input type="text" id="engVerify1" class="input-medium form-input" placeholder="Tên">
                            </div>
                            <div style="margin-top: 2px;">QC: 
                                <input type="text" id="qcVerify1" class="input-medium form-input" placeholder="Tên">
                            </div>
                        </td>
                    </tr>
                </table>
            </div>

            <!-- REFLOW OVEN Section -->
            <div class="form-section" id="section-reflow">
                <div class="sub-section-title">LÒ REFLOW/REFLOW OVEN</div>
                <table>
                    <tr>
                        <th width="30%">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                        <th width="40%">THÔNG SỐ CÀI ĐẶT MÁY/MACHINE PARAMETERS SETTING</th>
                        <th width="15%">KẾT QUẢ/RESULT</th>
                        <th width="15%">XÁC NHẬN/VERIFY</th>
                    </tr>
                    <tr>
                        <td>
                            - Theo Process control sheet đính kèm<br>
                            - Profile lò đính kèm
                        </td>
                        <td class="long-content-cell">
                            <textarea id="reflowParams" placeholder="Thông số cài đặt" rows="4" style="width: 100%;" class="form-textarea long-content"></textarea>
                        </td>
                        <td style="text-align: center;">
                            <select id="reflowResult" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                        <td style="text-align: center;">
                            <div>ENG: 
                                <input type="text" id="reflowEng" class="input-medium form-input" placeholder="Tên">
                            </div>
                            <div style="margin-top: 2px;">QC: 
                                <input type="text" id="reflowQc" class="input-medium form-input" placeholder="Tên">
                            </div>
                        </td>
                    </tr>
                </table>
                
                <!-- AOI -->
                <div class="sub-section-title">AOI/AUTOMATED OPTICAL INSPECTION</div>
                <table>
                    <tr>
                        <th width="30%">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                        <th width="25%">SỐ LƯỢNG PCBA ĐÃ AOI/PCBA AOI INSPECTED QUANTITY</th>
                        <th width="15%">KẾT QUẢ/RESULT</th>
                        <th width="30%">XÁC NHẬN/VERIFY</th>
                    </tr>
                    <tr>
                        <td>
                            <div>BOT: 
                                <input type="text" id="aoiProgramBot" class="input-medium form-input" placeholder="Tên chương trình">
                            </div>
                            <div style="margin-top: 5px;">TOP: 
                                <input type="text" id="aoiProgramTop" class="input-medium form-input" placeholder="Tên chương trình">
                            </div>
                        </td>
                        <td>
                            <input type="text" id="aoiQty" class="input-small form-input" placeholder="Số lượng" style="width: 100%;">
                        </td>
                        <td style="text-align: center;">
                            <select id="aoiResult" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                        <td style="text-align: center;">
                            <div>ENG: 
                                <input type="text" id="aoiEng" class="input-medium form-input" placeholder="Tên">
                            </div>
                            <div style="margin-top: 2px;">QC: 
                                <input type="text" id="aoiQc" class="input-medium form-input" placeholder="Tên">
                            </div>
                        </td>
                    </tr>
                </table>
                
                <!-- FLYING PROBE -->
                <div class="sub-section-title">FLYING PROBE (20%)</div>
                <table>
                    <tr>
                        <th width="30%">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                        <th width="25%">SỐ LƯỢNG ĐÃ ĐO/MEASURED QUANTITY</th>
                        <th width="15%">KẾT QUẢ/RESULT</th>
                        <th width="30%">XÁC NHẬN/VERIFY</th>
                    </tr>
                    <tr>
                        <td>
                            <div>BOT: 
                                <input type="text" id="probeProgramBot" class="input-medium form-input" placeholder="Tên chương trình">
                            </div>
                            <div style="margin-top: 5px;">TOP: 
                                <input type="text" id="probeProgramTop" class="input-medium form-input" placeholder="Tên chương trình">
                            </div>
                        </td>
                        <td>
                            <input type="text" id="probeQty" class="input-small form-input" placeholder="Số lượng" style="width: 100%;">
                        </td>
                        <td style="text-align: center;">
                            <select id="probeResult" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                        <td style="text-align: center;">
                            <div>ENG: 
                                <input type="text" id="probeEng" class="input-medium form-input" placeholder="Tên">
                            </div>
                            <div style="margin-top: 2px;">QC: 
                                <input type="text" id="probeQc" class="input-medium form-input" placeholder="Tên">
                            </div>
                        </td>
                    </tr>
                </table>
                
                <!-- VISUAL INSPECTION 2 -->
                <div class="sub-section-title">NGOẠI QUAN VISUAL INSPECTION</div>
                <div class="note" style="margin-bottom: 10px;">
                    KIỂM TRA SỐ LƯỢNG LINH KIỆN, CHẤT LƯỢNG MỐI HÀN, HƯỚNG LINH KIỆN, CÁC LỖI ĐÁNH GIÁ THEO IPC
                </div>
                <table>
                    <tr>
                        <th width="40%">NỘI DUNG KIỂM TRA</th>
                        <th width="30%">KẾT QUẢ</th>
                        <th width="30%">XÁC NHẬN/VERIFY</th>
                    </tr>
                    <tr>
                        <td>- Số lượng linh kiện/ Component Quantity</td>
                        <td style="text-align: center;">
                            <select id="visual2Result1" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                        <td rowspan="4" style="text-align: center; vertical-align: middle;">
                            <div>ENG: 
                                <input type="text" id="visual2Eng" class="input-medium form-input" placeholder="Tên">
                            </div>
                            <div style="margin-top: 10px;">QC: 
                                <input type="text" id="visual2Qc" class="input-medium form-input" placeholder="Tên">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>- Chất lượng mối hàn/ Solder Joint Quality</td>
                        <td style="text-align: center;">
                            <select id="visual2Result2" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>- Hướng linh kiện/ Component Orientation</td>
                        <td style="text-align: center;">
                            <select id="visual2Result3" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>- Các lỗi đánh giá theo IPC/ Defects Evaluated per IPC</td>
                        <td style="text-align: center;">
                            <select id="visual2Result4" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                    </tr>
                </table>
            </div>

            <!-- THROUGH-HOLE Section -->
            <div class="form-section" id="section-through-hole">
                <div class="section-title">THROUGH-HOLE PROCESS</div>
                
                <div class="sub-section-title">QUY TRÌNH HÀN TAY/HAND SOLDERING PROCESS</div>
                <table>
                    <tr>
                        <th width="40%">THÔNG SỐ/ PARAMETERS</th>
                        <th width="30%">GIÁ TRỊ/ VALUE</th>
                        <th width="15%">KẾT QUẢ/RESULT</th>
                        <th width="15%">XÁC NHẬN/VERIFY</th>
                    </tr>
                    <tr>
                        <td>Nhiệt độ mỏ hàn/ Soldering iron temperature</td>
                        <td>
                            <input type="text" id="solderTemp" placeholder="VD: 350°C" style="width: 100%;" class="form-input">
                        </td>
                        <td style="text-align: center;">
                            <select id="solderResult" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                        <td style="text-align: center;">
                            <div>ENG: 
                                <input type="text" id="solderEng" class="input-medium form-input" placeholder="Tên">
                            </div>
                            <div style="margin-top: 2px;">QC: 
                                <input type="text" id="solderQc" class="input-medium form-input" placeholder="Tên">
                            </div>
                        </td>
                    </tr>
                </table>
                
                <div class="sub-section-title">VISUAL INSPECTION</div>
                <div class="note" style="margin-bottom: 10px;">
                    KIỂM TRA CHẤT LƯỢNG MỐI HÀN THEO TIÊU CHUẨN IPC
                </div>
                <table>
                    <tr>
                        <th width="40%">TIÊU CHÍ/ CRITERIA</th>
                        <th width="30%">KẾT QUẢ/ RESULT</th>
                        <th width="30%">XÁC NHẬN/ VERIFY</th>
                    </tr>
                    <tr>
                        <td>- Chất lượng mối hàn/ Solder joint quality</td>
                        <td style="text-align: center;">
                            <select id="thVisual1" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                        <td rowspan="3" style="text-align: center; vertical-align: middle;">
                            <div>ENG: 
                                <input type="text" id="thEng" class="input-medium form-input" placeholder="Tên">
                            </div>
                            <div style="margin-top: 10px;">QC: 
                                <input type="text" id="thQc" class="input-medium form-input" placeholder="Tên">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>- Độ ướt chân/ Wetting</td>
                        <td style="text-align: center;">
                            <select id="thVisual2" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>- Không có cầu chì/ No solder bridges</td>
                        <td style="text-align: center;">
                            <select id="thVisual3" style="width: 100%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="OK">OK</option>
                                <option value="NG">NG</option>
                            </select>
                        </td>
                    </tr>
                </table>
            </div>

            <!-- CONCLUSION Section -->
            <div class="form-section" id="section-conclusion">
                <div class="section-title">KẾT LUẬN/ CONCLUSION</div>
                
                <table>
                    <tr>
                        <th width="20%">KẾT QUẢ CUỐI CÙNG/FINAL RESULT</th>
                        <th width="25%">RỦI RO TRONG CÁC CÔNG ĐOẠN/RISKS IN EACH PROCESS STEP</th>
                        <th width="25%">BÀI HỌC TỪNG CÔNG ĐOẠN/LESSONS LEARNED FROM EACH PROCESS STEP</th>
                        <th width="30%">CẢI TIẾN CÔNG ĐOẠN/PROCESS IMPROVEMENT</th>
                    </tr>
                    <tr>
                        <td style="text-align: center; vertical-align: middle;" class="conclusion-cell">
                            <select id="finalResult" style="width: 90%;" class="form-select">
                                <option value="">-- Chọn --</option>
                                <option value="PASS">PASS</option>
                                <option value="FAIL">FAIL</option>
                                <option value="CONDITIONAL">CONDITIONAL PASS</option>
                            </select>
                        </td>
                        <td class="conclusion-cell long-content-cell">
                            <textarea id="processRisks" placeholder="Rủi ro trong các công đoạn" rows="8" style="width: 100%; height: auto; min-height: 120px;" class="form-textarea long-content"></textarea>
                        </td>
                        <td class="conclusion-cell long-content-cell">
                            <textarea id="lessonsLearned" placeholder="Bài học từng công đoạn" rows="8" style="width: 100%; height: auto; min-height: 120px;" class="form-textarea long-content"></textarea>
                        </td>
                        <td class="conclusion-cell long-content-cell">
                            <textarea id="processImprovement" placeholder="Cải tiến công đoạn" rows="8" style="width: 100%; height: auto; min-height: 120px;" class="form-textarea long-content"></textarea>
                        </td>
                    </tr>
                </table>
                
                <div class="form-row" style="margin-top: 15px;">
                    <div class="form-group">
                        <label for="totalQty">Tổng số lượng (PCBA): <br>Total qty (PCBA):</label>
                        <input type="number" id="totalQty" placeholder="Nhập tổng số lượng" class="form-input" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="okQty">OK :</label>
                        <input type="number" id="okQty" placeholder="Nhập số lượng OK" class="form-input" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="ngQty">NG (scrap) :</label>
                        <input type="number" id="ngQty" placeholder="Nhập số lượng NG" class="form-input" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="defectRate">Tỷ lệ lỗi/ Defect rate (%) : <br> (NG/Total)</label>
                        <input type="text" id="defectRate" placeholder="Tự động tính toán" readonly style="background-color: #f0f0f0;" class="form-input">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="defectDescription">Mô tả chi tiết lỗi / detailed defect description:</label>
                        <textarea id="defectDescription" placeholder="Mô tả chi tiết các lỗi" rows="4" style="width: 100%;" class="form-textarea long-content"></textarea>
                    </div>
                </div>
                
                <!-- Electronic Signatures -->
                <div class="sub-section-title">XÁC NHẬN ĐIỆN TỬ - ELECTRONIC SIGNATURES</div>
                <div class="two-column" style="margin-top: 10px;">
                    <div class="signature-section">
                        <label>Ký xác nhận của Kỹ sư / Engineer Signature:</label>
                        <div class="signature-container">
                            <canvas id="engineerSignature" class="signature-pad no-export"></canvas>
                            <div class="signature-controls no-print no-export">
                                <button type="button" id="clearEngineerSignature">Xóa chữ ký</button>
                                <button type="button" id="saveEngineerSignature">Lưu chữ ký</button>
                            </div>
                            <div class="signature-display" id="engineerSignatureDisplay">
                                <div style="padding: 10px; text-align: center;">Chữ ký sẽ hiển thị ở đây sau khi lưu</div>
                            </div>
                        </div>
                        <div style="margin-top: 5px;">
                            <label for="engineerName" class="inline-label">Tên Kỹ sư / Engineer Name:</label>
                            <input type="text" id="engineerName" placeholder="Nhập tên kỹ sư" style="width: 200px;" class="form-input">
                        </div>
                    </div>
                    
                    <div class="signature-section">
                        <label>Ký xác nhận của QC / QC Signature:</label>
                        <div class="signature-container">
                            <canvas id="qcSignature" class="signature-pad no-export"></canvas>
                            <div class="signature-controls no-print no-export">
                                <button type="button" id="clearQcSignature">Xóa chữ ký</button>
                                <button type="button" id="saveQcSignature">Lưu chữ ký</button>
                            </div>
                            <div class="signature-display" id="qcSignatureDisplay">
                                <div style="padding: 10px; text-align: center;">Chữ ký sẽ hiển thị ở đây sau khi lưu</div>
                            </div>
                        </div>
                        <div style="margin-top: 5px;">
                            <label for="qcName" class="inline-label">Tên QC / QC Name:</label>
                            <input type="text" id="qcName" placeholder="Nhập tên QC" style="width: 200px;" class="form-input">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="footer">
                <p>NPI Record - Phiên bản Multi-User Real-time</p>
                <p>© 2024 - Đồng bộ thời gian thực với Firebase</p>
                <p style="font-size: 10px; color: #888;" id="dataInfo"></p>
            </div>
        </div>
    </div>

    <!-- PDF Template (ẩn) -->
    <div id="pdf-template" class="pdf-template">
        <!-- PDF content will be generated here -->
    </div>

    <script>
        // ========== CẤU HÌNH FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDtXBh4JBdUeLvzNKWp6VUNatdML871k8E",
            authDomain: "npi-record.firebaseapp.com",
            databaseURL: "https://npi-record-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "npi-record",
            storageBucket: "npi-record.appspot.com",
            messagingSenderId: "615504087682",
            appId: "1:615504087682:web:5a1a78fd56ea4f9714429b"
        };

        // ========== BIẾN TOÀN CỤC ==========
        let app;
        let database;
        let currentProjectId = null;
        let currentUser = null;
        let users = {};
        let isSaving = false;
        let lastSavedData = {};
        let userTimeout = null;
        let engineerSignaturePad = null;
        let qcSignaturePad = null;

        // ========== KHỞI TẠO FIREBASE ==========
        try {
            if (!firebase.apps.length) {
                app = firebase.initializeApp(firebaseConfig);
            } else {
                app = firebase.app();
            }
            database = firebase.database();
            console.log("✅ Firebase đã khởi tạo");
        } catch (error) {
            console.error("❌ Lỗi khởi tạo Firebase:", error);
            showToast("Không thể kết nối đến server", "error");
        }

        // ========== HÀM HIỂN THỊ THÔNG BÁO ==========
        function showToast(message, type = "success") {
            const toast = document.createElement("div");
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === "success" ? "check-circle" : type === "error" ? "exclamation-triangle" : "info-circle"}"></i>
                ${message}
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function showLoading(message) {
            document.getElementById("loadingMessage").textContent = message;
            document.getElementById("loadingOverlay").style.display = "flex";
        }

        function hideLoading() {
            document.getElementById("loadingOverlay").style.display = "none";
        }

        // ========== KHỞI TẠO NGƯỜI DÙNG ==========
        function initUser() {
            let savedUser = localStorage.getItem("npi_user");
            
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                console.log("👤 Đã load user:", currentUser.name);
            } else {
                const names = ["Kỹ sư", "QC", "Quản lý", "Chuyên viên"];
                const randomName = names[Math.floor(Math.random() * names.length)] + " " + Math.floor(Math.random() * 100);
                
                const colors = ["#FF5722", "#2196F3", "#4CAF50", "#FF9800", "#9C27B0", "#009688"];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                currentUser = {
                    id: "user_" + Math.random().toString(36).substr(2, 9),
                    name: randomName,
                    color: randomColor,
                    online: true,
                    lastActive: Date.now(),
                    editingField: null
                };
                
                localStorage.setItem("npi_user", JSON.stringify(currentUser));
                console.log("👤 Đã tạo user mới:", currentUser.name);
            }
            
            updateUserBadge();
        }

        function updateUserBadge() {
            const userCountEl = document.getElementById("userCount");
            if (userCountEl && currentUser) {
                userCountEl.innerHTML = `
                    <i class="fas fa-user" style="color: ${currentUser.color}"></i>
                    <span>${currentUser.name}</span>
                    <button id="changeNameBtn" style="background: transparent; border: none; color: white; cursor: pointer; margin-left: 5px; font-size: 10px;" title="Đổi tên">
                        <i class="fas fa-edit"></i>
                    </button>
                `;
                
                document.getElementById("changeNameBtn")?.addEventListener("click", changeUserName);
            }
        }

        function changeUserName() {
            const newName = prompt("Nhập tên hiển thị mới:", currentUser.name);
            if (newName && newName.trim() && newName !== currentUser.name) {
                currentUser.name = newName.trim();
                localStorage.setItem("npi_user", JSON.stringify(currentUser));
                updateUserBadge();
                
                if (currentProjectId && database) {
                    database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).update({
                        name: currentUser.name,
                        lastActive: Date.now()
                    });
                }
                
                showToast(`✅ Đã đổi tên thành: ${currentUser.name}`, "success");
            }
        }

        // ========== TẠO/THAM GIA PROJECT ==========
        async function handleProjectAction() {
            if (!database) {
                showToast("Chưa kết nối được Firebase", "error");
                return;
            }
            
            if (currentProjectId) {
                const confirmLeave = confirm(`Bạn đang trong project: ${currentProjectId}\n\nMuốn rời đi để tạo/tham gia project khác?`);
                if (!confirmLeave) return;
                
                await leaveCurrentProject();
                currentProjectId = null;
                document.getElementById("onlineUsersContainer").style.display = "none";
                updateStatus("Đã rời project", "offline");
            }
            
            const action = confirm(`Chọn hành động:\n\n• OK: Tạo project MỚI\n• Cancel: Tham gia project CÓ SẴN`);
            
            if (action === true) {
                await createNewProject();
            } else {
                await joinExistingProject();
            }
        }

        async function leaveCurrentProject() {
            if (currentProjectId && currentUser && database) {
                try {
                    await database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).update({
                        online: false,
                        lastActive: Date.now(),
                        editingField: null
                    });
                } catch (error) {
                    console.error("Lỗi rời project:", error);
                }
            }
        }

        async function createNewProject() {
            showLoading("Đang tạo project mới...");
            
            try {
                currentProjectId = "npi_" + Date.now().toString(36) + "_" + Math.random().toString(36).substr(2, 3).toUpperCase();
                
                if (!currentUser) initUser();
                
                const initialData = collectFormData();
                initialData._metadata = {
                    created: new Date().toISOString(),
                    createdBy: currentUser.id,
                    version: 1
                };
                
                await database.ref(`projects/${currentProjectId}`).set({
                    data: initialData,
                    users: {
                        [currentUser.id]: {
                            ...currentUser,
                            online: true,
                            lastActive: Date.now()
                        }
                    },
                    metadata: {
                        created: new Date().toISOString(),
                        createdBy: currentUser.name,
                        projectName: `NPI-${new Date().toLocaleDateString("vi-VN")}`
                    }
                });
                
                updateUrlWithProjectId();
                document.getElementById("projectIdDisplay").textContent = `ID: ${currentProjectId}`;
                document.getElementById("projectIdDisplay").title = "Click để copy ID";
                document.getElementById("onlineUsersContainer").style.display = "block";
                
                setupRealtimeListeners();
                updateShareLink();
                
                showToast(`✅ Đã tạo project: ${currentProjectId}`, "success");
                updateStatus("Đang đồng bộ thời gian thực", "online");
                
            } catch (error) {
                console.error("Lỗi tạo project:", error);
                showToast("❌ Lỗi tạo project: " + error.message, "error");
            } finally {
                hideLoading();
            }
        }

        async function joinExistingProject() {
            const projectId = prompt("Nhập ID project muốn tham gia:");
            if (!projectId || !projectId.trim()) {
                showToast("❌ Chưa nhập ID project", "error");
                return;
            }
            
            showLoading(`Đang tham gia project ${projectId}...`);
            
            try {
                const snapshot = await database.ref(`projects/${projectId}`).once("value");
                
                if (!snapshot.exists()) {
                    showToast("❌ Project không tồn tại!", "error");
                    hideLoading();
                    return;
                }
                
                currentProjectId = projectId;
                if (!currentUser) initUser();
                
                await database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).set({
                    ...currentUser,
                    online: true,
                    lastActive: Date.now()
                });
                
                updateUrlWithProjectId();
                document.getElementById("projectIdDisplay").textContent = `ID: ${currentProjectId}`;
                document.getElementById("projectIdDisplay").title = "Click để copy ID";
                document.getElementById("onlineUsersContainer").style.display = "block";
                
                setupRealtimeListeners();
                loadProjectData();
                
                showToast(`✅ Đã tham gia project ${projectId}`, "success");
                updateStatus("Đang đồng bộ thời gian thực", "online");
                
            } catch (error) {
                console.error("Lỗi tham gia project:", error);
                showToast("❌ Lỗi tham gia project: " + error.message, "error");
            } finally {
                hideLoading();
            }
        }

        // ========== REALTIME LISTENERS ==========
        function setupRealtimeListeners() {
            if (!currentProjectId || !database) return;
            
            console.log("👂 Đang lắng nghe thay đổi từ server...");
            
            // 1. Lắng nghe thay đổi dữ liệu form
            database.ref(`projects/${currentProjectId}/data`).on("value", (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    updateFormFromServer(data);
                }
            });
            
            // 2. Lắng nghe thay đổi danh sách user
            database.ref(`projects/${currentProjectId}/users`).on("value", (snapshot) => {
                if (snapshot.exists()) {
                    users = snapshot.val();
                    updateUsersDisplay();
                }
            });
            
            keepAlive();
            
            window.addEventListener("beforeunload", () => {
                if (currentProjectId && currentUser) {
                    database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).update({
                        online: false,
                        lastActive: Date.now(),
                        editingField: null
                    });
                }
            });
        }

        function keepAlive() {
            if (userTimeout) clearTimeout(userTimeout);
            
            userTimeout = setTimeout(() => {
                if (currentProjectId && currentUser && database) {
                    database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).update({
                        lastActive: Date.now(),
                        online: true
                    });
                    keepAlive();
                }
            }, 10000);
        }

        // ========== XỬ LÝ DỮ LIỆU FORM ==========
        function collectFormData() {
            const data = {};
            
            document.querySelectorAll("input, textarea, select").forEach(element => {
                if (element.id && element.id !== "") {
                    if (element.type === "checkbox") {
                        data[element.id] = element.checked;
                    } else if (element.type === "radio") {
                        if (element.checked) data[element.name] = element.value;
                    } else {
                        data[element.id] = element.value;
                    }
                }
            });
            
            const engineerSig = localStorage.getItem("engineer_signature");
            const qcSig = localStorage.getItem("qc_signature");
            if (engineerSig) data._engineerSignature = engineerSig;
            if (qcSig) data._qcSignature = qcSig;
            
            return data;
        }

        function updateFormFromServer(serverData) {
            if (isSaving) return;
            
            const formData = {...serverData};
            delete formData._metadata;
            delete formData._lastUpdated;
            delete formData._lastUpdatedBy;
            
            let changedCount = 0;
            
            Object.keys(formData).forEach(fieldId => {
                if (fieldId.startsWith("_")) {
                    if (fieldId === "_engineerSignature" && formData[fieldId]) {
                        localStorage.setItem("engineer_signature", formData[fieldId]);
                        const engDisplay = document.getElementById("engineerSignatureDisplay");
                        if (engDisplay) {
                            engDisplay.innerHTML = `<img src="${formData[fieldId]}" alt="Engineer Signature" style="max-width: 100%; max-height: 70px;">`;
                            engDisplay.classList.add("has-signature");
                        }
                    }
                    if (fieldId === "_qcSignature" && formData[fieldId]) {
                        localStorage.setItem("qc_signature", formData[fieldId]);
                        const qcDisplay = document.getElementById("qcSignatureDisplay");
                        if (qcDisplay) {
                            qcDisplay.innerHTML = `<img src="${formData[fieldId]}" alt="QC Signature" style="max-width: 100%; max-height: 70px;">`;
                            qcDisplay.classList.add("has-signature");
                        }
                    }
                    return;
                }
                
                const field = document.getElementById(fieldId);
                if (field) {
                    const serverValue = formData[fieldId];
                    const currentValue = field.type === "checkbox" ? field.checked : field.value;
                    
                    if (serverValue !== currentValue) {
                        const isCurrentlyEditing = (field === document.activeElement);
                        
                        if (!isCurrentlyEditing) {
                            if (field.type === "checkbox") {
                                field.checked = Boolean(serverValue);
                            } else {
                                field.value = serverValue || "";
                            }
                            
                            updateHighlight(field);
                            changedCount++;
                            showFieldUpdateEffect(field);
                        }
                    }
                }
            });
            
            if (changedCount > 0) {
                showTypingNotification(changedCount);
            }
            
            lastSavedData = {...formData};
            calculateDefectRate();
        }

        function showFieldUpdateEffect(field) {
            field.classList.add("field-updated");
            setTimeout(() => {
                field.classList.remove("field-updated");
            }, 1000);
        }

        function showTypingNotification(count) {
            let notification = document.getElementById("typing-notification");
            if (!notification) {
                notification = document.createElement("div");
                notification.id = "typing-notification";
                notification.className = "typing-indicator";
                document.body.appendChild(notification);
            }
            
            notification.textContent = `🔄 ${count} trường được cập nhật từ người khác`;
            notification.style.display = "block";
            
            setTimeout(() => {
                notification.style.display = "none";
            }, 2000);
        }

        // ========== CẬP NHẬT GIAO DIỆN NGƯỜI DÙNG ==========
        function updateUsersDisplay() {
            const usersListEl = document.getElementById("usersList");
            const onlineCountEl = document.getElementById("onlineUsersCount");
            
            if (!usersListEl || !onlineCountEl) return;
            
            const now = Date.now();
            const onlineUsers = Object.values(users).filter(user => 
                user.online || (now - user.lastActive < 30000)
            );
            
            onlineCountEl.textContent = `${onlineUsers.length} người online`;
            usersListEl.innerHTML = "";
            
            onlineUsers.forEach(user => {
                const userEl = document.createElement("div");
                userEl.className = `user-badge ${user.editingField ? "editing" : ""}`;
                userEl.style.borderLeft = `3px solid ${user.color}`;
                
                userEl.innerHTML = `
                    <div class="status-dot" style="background: ${user.color}"></div>
                    <div class="user-avatar" style="background: ${user.color}">
                        ${user.name.charAt(0).toUpperCase()}
                    </div>
                    <span>${user.name}</span>
                    ${user.id === currentUser?.id ? '<span style="font-size:9px;">(bạn)</span>' : ""}
                    ${user.editingField ? `<span style="font-size:9px; margin-left:5px;">✏️</span>` : ""}
                `;
                
                userEl.title = `${user.name}\n${user.editingField ? `Đang nhập: ${user.editingField}` : "Đang online"}`;
                usersListEl.appendChild(userEl);
            });
            
            updateEditingHighlights();
        }

        function updateEditingHighlights() {
            document.querySelectorAll(".field-being-edited").forEach(field => {
                field.classList.remove("field-being-edited");
                field.removeAttribute("data-editor");
            });
            
            Object.values(users).forEach(user => {
                if (user.editingField && user.id !== currentUser?.id) {
                    const field = document.getElementById(user.editingField);
                    if (field) {
                        field.classList.add("field-being-edited");
                        field.setAttribute("data-editor", user.name);
                    }
                }
            });
        }

        // ========== XỬ LÝ INPUT THỜI GIAN THỰC ==========
        function setupRealTimeInput() {
            let debounceTimer;
            
            document.querySelectorAll("input, textarea, select").forEach(field => {
                field.addEventListener("focus", function() {
                    if (currentProjectId && currentUser) {
                        currentUser.editingField = this.id;
                        updateUserEditingStatus(this.id);
                    }
                });
                
                field.addEventListener("input", function() {
                    clearTimeout(debounceTimer);
                    
                    if (currentProjectId && currentUser) {
                        saveFieldToServer(this.id, this.type === "checkbox" ? this.checked : this.value);
                        
                        debounceTimer = setTimeout(() => {
                            saveFieldToServer(this.id, this.type === "checkbox" ? this.checked : this.value);
                        }, 200);
                    }
                    
                    updateHighlight(this);
                    
                    if (this.id === "totalQty" || this.id === "ngQty" || this.id === "okQty") {
                        calculateDefectRate();
                    }
                });
                
                field.addEventListener("change", function() {
                    if (currentProjectId && currentUser) {
                        saveFieldToServer(this.id, this.type === "checkbox" ? this.checked : this.value);
                    }
                    updateHighlight(this);
                });
                
                field.addEventListener("blur", function() {
                    if (currentProjectId && currentUser) {
                        currentUser.editingField = null;
                        updateUserEditingStatus(null);
                    }
                });
                
                if (field.tagName === 'INPUT' || field.tagName === 'TEXTAREA') {
                    field.addEventListener('keyup', function() {
                        if (currentProjectId && currentUser) {
                            updateUserEditingStatus(this.id);
                        }
                    });
                }
            });
        }

        async function saveFieldToServer(fieldId, value) {
            if (!currentProjectId || !database || isSaving) return;
            
            isSaving = true;
            
            try {
                await database.ref(`projects/${currentProjectId}/data/${fieldId}`).set(value);
                await database.ref(`projects/${currentProjectId}/data/_lastUpdated`).set(new Date().toISOString());
                await database.ref(`projects/${currentProjectId}/data/_lastUpdatedBy`).set(currentUser?.id || "unknown");
                
                lastSavedData[fieldId] = value;
                
            } catch (error) {
                console.error("Lỗi lưu field:", error);
                showToast("❌ Lỗi đồng bộ dữ liệu", "error");
            } finally {
                setTimeout(() => { isSaving = false; }, 50);
            }
        }

        async function updateUserEditingStatus(fieldId) {
            if (!currentProjectId || !currentUser || !database) return;
            
            try {
                await database.ref(`projects/${currentProjectId}/users/${currentUser.id}`).update({
                    editingField: fieldId,
                    lastActive: Date.now()
                });
            } catch (error) {
                console.error("Lỗi cập nhật trạng thái editing:", error);
            }
        }

        // ========== HIGHLIGHT DỮ LIỆU ==========
        function updateHighlight(element) {
            if (!element) return;
            
            const hasData = element.type === "checkbox" 
                ? element.checked
                : element.type === "select-one"
                ? element.value && element.value !== ""
                : element.value && element.value.trim() !== "";
            
            if (hasData) {
                element.classList.add("has-data");
                const row = element.closest("tr");
                if (row) row.classList.add("highlight-row");
            } else {
                element.classList.remove("has-data");
                const row = element.closest("tr");
                if (row) row.classList.remove("highlight-row");
            }
        }

        function calculateDefectRate() {
            const total = parseInt(document.getElementById("totalQty").value) || 0;
            const ng = parseInt(document.getElementById("ngQty").value) || 0;
            
            let rate = 0;
            if (total > 0) {
                rate = (ng / total) * 100;
            }
            
            document.getElementById("defectRate").value = rate.toFixed(2) + "%";
            updateHighlight(document.getElementById("defectRate"));
        }

        // ========== URL & SHARING ==========
        function updateUrlWithProjectId() {
            if (!currentProjectId) return;
            
            const url = new URL(window.location);
            url.searchParams.set("project", currentProjectId);
            window.history.pushState({}, "", url);
        }

        function updateShareLink() {
            if (!currentProjectId) return "";
            
            const shareUrl = `${window.location.origin}${window.location.pathname}?project=${currentProjectId}`;
            document.getElementById("shareLinkText").textContent = shareUrl;
            
            return shareUrl;
        }

        // ========== LOAD DỮ LIỆU TỪ SERVER ==========
        async function loadProjectData() {
            if (!currentProjectId || !database) return;
            
            showLoading("Đang tải dữ liệu...");
            
            try {
                const snapshot = await database.ref(`projects/${currentProjectId}/data`).once("value");
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    updateFormFromServer(data);
                    showToast("✅ Đã tải dữ liệu từ server", "success");
                }
            } catch (error) {
                console.error("Lỗi tải dữ liệu:", error);
                showToast("❌ Lỗi tải dữ liệu từ server", "error");
            } finally {
                hideLoading();
            }
        }

        // ========== HÀM LƯU TOÀN BỘ ==========
        async function saveAllToCloud() {
            if (!currentProjectId) {
                showToast("❌ Chưa có project! Hãy tạo hoặc tham gia project trước.", "error");
                return false;
            }
            
            showLoading("Đang lưu toàn bộ dữ liệu...");
            
            try {
                const formData = collectFormData();
                formData._lastUpdated = new Date().toISOString();
                formData._lastUpdatedBy = currentUser?.id || "unknown";
                
                await database.ref(`projects/${currentProjectId}/data`).set(formData);
                
                showToast("✅ Đã lưu toàn bộ dữ liệu!", "success");
                return true;
                
            } catch (error) {
                console.error("Lỗi lưu toàn bộ:", error);
                showToast("❌ Lỗi lưu dữ liệu: " + error.message, "error");
                return false;
            } finally {
                hideLoading();
            }
        }

        // ========== CHỨC NĂNG CHIA SẺ ==========
        function generateShareLink() {
            if (!currentProjectId) {
                showToast("❌ Chưa có project! Hãy tạo hoặc tham gia project trước.", "error");
                return;
            }
            
            const shareUrl = updateShareLink();
            document.getElementById("shareLinkContainer").style.display = "block";
            
            navigator.clipboard.writeText(shareUrl).then(() => {
                showToast("✅ Đã copy link vào clipboard!", "success");
            }).catch(() => {
                const tempInput = document.createElement("input");
                tempInput.value = shareUrl;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand("copy");
                document.body.removeChild(tempInput);
                showToast("✅ Đã copy link vào clipboard!", "success");
            });
        }

        function copyShareLink() {
            const shareUrl = document.getElementById("shareLinkText").textContent;
            if (shareUrl && shareUrl.trim() !== "") {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showToast("✅ Đã copy link vào clipboard!", "success");
                }).catch(() => {
                    const tempInput = document.createElement("input");
                    tempInput.value = shareUrl;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand("copy");
                    document.body.removeChild(tempInput);
                    showToast("✅ Đã copy link vào clipboard!", "success");
                });
            } else {
                showToast("❌ Chưa có link chia sẻ!", "error");
            }
        }

        function hideShareLink() {
            document.getElementById("shareLinkContainer").style.display = "none";
        }

        // ========== CHỮ KÝ ĐIỆN TỬ ==========
        function setupSignaturePads() {
            const engineerCanvas = document.getElementById("engineerSignature");
            if (engineerCanvas) {
                engineerSignaturePad = new SignaturePad(engineerCanvas, {
                    backgroundColor: "rgb(255, 255, 255)",
                    penColor: "rgb(0, 0, 0)"
                });
                
                document.getElementById("clearEngineerSignature").addEventListener("click", function() {
                    engineerSignaturePad.clear();
                    localStorage.removeItem("engineer_signature");
                    document.getElementById("engineerSignatureDisplay").innerHTML = '<div style="padding: 10px; text-align: center;">Chữ ký sẽ hiển thị ở đây sau khi lưu</div>';
                    document.getElementById("engineerSignatureDisplay").classList.remove("has-signature");
                    showToast("Đã xóa chữ ký kỹ sư", "info");
                    
                    if (currentProjectId && database) {
                        database.ref(`projects/${currentProjectId}/data/_engineerSignature`).remove();
                    }
                });
                
                document.getElementById("saveEngineerSignature").addEventListener("click", function() {
                    if (!engineerSignaturePad.isEmpty()) {
                        const dataURL = engineerSignaturePad.toDataURL();
                        localStorage.setItem("engineer_signature", dataURL);
                        
                        const displayDiv = document.getElementById("engineerSignatureDisplay");
                        displayDiv.innerHTML = `<img src="${dataURL}" alt="Engineer Signature" style="max-width: 100%; max-height: 70px;">`;
                        displayDiv.classList.add("has-signature");
                        
                        if (currentProjectId && database) {
                            database.ref(`projects/${currentProjectId}/data/_engineerSignature`).set(dataURL);
                        }
                        
                        showToast("✅ Đã lưu chữ ký kỹ sư!", "success");
                        updateHighlight(document.getElementById("engineerName"));
                    } else {
                        showToast("❌ Vui lòng ký trước khi lưu!", "error");
                    }
                });
                
                const savedEngineerSig = localStorage.getItem("engineer_signature");
                if (savedEngineerSig) {
                    document.getElementById("engineerSignatureDisplay").innerHTML = `<img src="${savedEngineerSig}" alt="Engineer Signature" style="max-width: 100%; max-height: 70px;">`;
                    document.getElementById("engineerSignatureDisplay").classList.add("has-signature");
                }
            }
            
            const qcCanvas = document.getElementById("qcSignature");
            if (qcCanvas) {
                qcSignaturePad = new SignaturePad(qcCanvas, {
                    backgroundColor: "rgb(255, 255, 255)",
                    penColor: "rgb(0, 0, 0)"
                });
                
                document.getElementById("clearQcSignature").addEventListener("click", function() {
                    qcSignaturePad.clear();
                    localStorage.removeItem("qc_signature");
                    document.getElementById("qcSignatureDisplay").innerHTML = '<div style="padding: 10px; text-align: center;">Chữ ký sẽ hiển thị ở đây sau khi lưu</div>';
                    document.getElementById("qcSignatureDisplay").classList.remove("has-signature");
                    showToast("Đã xóa chữ ký QC", "info");
                    
                    if (currentProjectId && database) {
                        database.ref(`projects/${currentProjectId}/data/_qcSignature`).remove();
                    }
                });
                
                document.getElementById("saveQcSignature").addEventListener("click", function() {
                    if (!qcSignaturePad.isEmpty()) {
                        const dataURL = qcSignaturePad.toDataURL();
                        localStorage.setItem("qc_signature", dataURL);
                        
                        const displayDiv = document.getElementById("qcSignatureDisplay");
                        displayDiv.innerHTML = `<img src="${dataURL}" alt="QC Signature" style="max-width: 100%; max-height: 70px;">`;
                        displayDiv.classList.add("has-signature");
                        
                        if (currentProjectId && database) {
                            database.ref(`projects/${currentProjectId}/data/_qcSignature`).set(dataURL);
                        }
                        
                        showToast("✅ Đã lưu chữ ký QC!", "success");
                        updateHighlight(document.getElementById("qcName"));
                    } else {
                        showToast("❌ Vui lòng ký trước khi lưu!", "error");
                    }
                });
                
                const savedQcSig = localStorage.getItem("qc_signature");
                if (savedQcSig) {
                    document.getElementById("qcSignatureDisplay").innerHTML = `<img src="${savedQcSig}" alt="QC Signature" style="max-width: 100%; max-height: 70px;">`;
                    document.getElementById("qcSignatureDisplay").classList.add("has-signature");
                }
            }
        }

        // ========== XUẤT PDF GIỐNG FILE MẪU ==========
        // ========== XUẤT PDF GIỐNG FILE MẪU ==========
async function exportToPDF() {
    // Validate required fields
    if (!validateForm()) {
        showToast('Vui lòng điền đầy đủ các trường bắt buộc (Mã hàng và Khách hàng) trước khi xuất PDF!', 'error');
        return;
    }
    
    // Show loading
    showLoading('Đang tạo PDF...');
    const exportBtn = document.getElementById('exportPdf');
    const originalText = exportBtn.innerHTML;
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tạo PDF...';
    exportBtn.disabled = true;
    
    try {
        // Tạo template PDF với đúng cấu trúc như file mẫu
        const pdfTemplate = document.createElement('div');
        pdfTemplate.id = 'pdf-export-container';
        pdfTemplate.style.position = 'absolute';
        pdfTemplate.style.left = '-9999px';
        pdfTemplate.style.top = '0';
        pdfTemplate.style.width = '210mm';
        pdfTemplate.style.minHeight = '297mm';
        pdfTemplate.style.backgroundColor = 'white';
        pdfTemplate.style.padding = '15mm';
        pdfTemplate.style.fontFamily = 'Arial, sans-serif';
        pdfTemplate.style.fontSize = '10pt';
        pdfTemplate.style.lineHeight = '1.2';
        pdfTemplate.style.boxSizing = 'border-box';
        
        // Tạo nội dung PDF giống file mẫu
        pdfTemplate.innerHTML = generatePDFContentNew();
        document.body.appendChild(pdfTemplate);
        
        // Wait for rendering
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Convert to canvas
        const canvas = await html2canvas(pdfTemplate, {
            scale: 2,
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff',
            allowTaint: true
        });
        
        // Remove template
        document.body.removeChild(pdfTemplate);
        
        // Create PDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });
        
        // Calculate dimensions
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        
        const imgWidth = pageWidth;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        // Add image to PDF
        const imgData = canvas.toDataURL('image/jpeg', 0.92);
        
        // Handle multi-page
        let currentHeight = 0;
        let remainingHeight = imgHeight;
        
        while (remainingHeight > 0) {
            const sectionHeight = Math.min(remainingHeight, pageHeight);
            
            pdf.addImage(imgData, 'JPEG', 0, -currentHeight, imgWidth, imgHeight);
            
            remainingHeight -= pageHeight;
            currentHeight += pageHeight;
            
            if (remainingHeight > 0) {
                pdf.addPage();
            }
        }
        
        // Save PDF
        const model = document.getElementById('model').value.replace(/\s+/g, '_') || 'Unknown';
        const date = document.getElementById('date').value || new Date().toISOString().slice(0, 10);
        pdf.save(`NPI_Record_${model}_${date}.pdf`);
        
        showToast('✅ PDF đã được tạo thành công!', 'success');
        
    } catch (err) {
        console.error('PDF generation error:', err);
        showToast('❌ Có lỗi khi tạo PDF. Vui lòng thử lại!', 'error');
    } finally {
        // Restore button state
        exportBtn.innerHTML = originalText;
        exportBtn.disabled = false;
        hideLoading();
    }
}
        // Hàm mới tạo nội dung PDF giống file mẫu
// ========== HÀM MỚI TẠO NỘI DUNG PDF GIỐNG FILE MẪU (VỚI HIGHLIGHT) ==========
function generatePDFContentNew() {
    // Lấy giá trị từ form
    const model = document.getElementById('model').value || '';
    const customer = document.getElementById('customer').value || '';
    const partNo = document.getElementById('partNo').value || '';
    const dateValue = document.getElementById('date').value || '';
    const date = dateValue ? formatDateForDisplay(dateValue) : '';
    
    // Process checkboxes
    const processes = [];
    if (document.getElementById('processSMT').checked) processes.push('SMT');
    if (document.getElementById('processThroughHole').checked) processes.push('THROUGH HOLE');
    if (document.getElementById('processCoating').checked) processes.push('COATING');
    if (document.getElementById('processBoxbuild').checked) processes.push('BOXBUILD');
    if (document.getElementById('processPacking').checked) processes.push('PACKING');
    const processText = processes.join(', ');
    
    // Hàm kiểm tra và highlight nếu có dữ liệu
    function highlightIfHasData(value, isCheckbox = false) {
        if (isCheckbox) {
            return value ? `<span style="color: #1565C0; font-weight: 600; background-color: #E3F2FD; padding: 1px 3px; border-radius: 2px;">${value}</span>` : value;
        }
        return value ? `<span style="color: #1565C0; font-weight: 600; background-color: #E3F2FD; padding: 1px 3px; border-radius: 2px;">${value}</span>` : '';
    }
    
    // Laser Marking
    const laserProgram = document.getElementById('laserProgram').value || '';
    const qrType = document.getElementById('qrType').value || '';
    const qrSize = document.getElementById('qrSize').value || '';
    const engravingIntensity = document.getElementById('engravingIntensity').value || '';
    const qrContentBot = document.getElementById('qrContentBot').value || '';
    const qrContentTop = document.getElementById('qrContentTop').value || '';
    const qrScanContent = document.getElementById('qrScanContent').value || '';
    
    // Printer & Mounter
    const printerControl = document.getElementById('printerControl').value || 'Theo Process control sheet đính kèm/According to the attached Process Control Sheet';
    const mounterControl = document.getElementById('mounterControl').value || 'Theo Process control sheet đính kèm (có xác nhận và đo giá trị của các bên)/According to the attached Process Control Sheet';
    
    // Visual Inspection 1
    const bomQty = document.getElementById('bomQty').value || '';
    const actualQty = document.getElementById('actualQty').value || '';
    const visualResult1 = document.getElementById('visualResult1').value || '';
    const engVerify1 = document.getElementById('engVerify1').value || '';
    const qcVerify1 = document.getElementById('qcVerify1').value || '';
    
    // Reflow Oven
    const reflowParams = document.getElementById('reflowParams').value || '';
    const reflowResult = document.getElementById('reflowResult').value || '';
    const reflowEng = document.getElementById('reflowEng').value || '';
    const reflowQc = document.getElementById('reflowQc').value || '';
    
    // AOI
    const aoiProgramBot = document.getElementById('aoiProgramBot').value || '';
    const aoiProgramTop = document.getElementById('aoiProgramTop').value || '';
    const aoiQty = document.getElementById('aoiQty').value || '';
    const aoiResult = document.getElementById('aoiResult').value || '';
    const aoiEng = document.getElementById('aoiEng').value || '';
    const aoiQc = document.getElementById('aoiQc').value || '';
    
    // Flying Probe
    const probeProgramBot = document.getElementById('probeProgramBot').value || '';
    const probeProgramTop = document.getElementById('probeProgramTop').value || '';
    const probeQty = document.getElementById('probeQty').value || '';
    const probeResult = document.getElementById('probeResult').value || '';
    const probeEng = document.getElementById('probeEng').value || '';
    const probeQc = document.getElementById('probeQc').value || '';
    
    // Visual Inspection 2
    const visual2Result1 = document.getElementById('visual2Result1').value || '';
    const visual2Result2 = document.getElementById('visual2Result2').value || '';
    const visual2Result3 = document.getElementById('visual2Result3').value || '';
    const visual2Result4 = document.getElementById('visual2Result4').value || '';
    const visual2Eng = document.getElementById('visual2Eng').value || '';
    const visual2Qc = document.getElementById('visual2Qc').value || '';
    
    // Through-Hole
    const solderTemp = document.getElementById('solderTemp').value || '';
    const solderResult = document.getElementById('solderResult').value || '';
    const solderEng = document.getElementById('solderEng').value || '';
    const solderQc = document.getElementById('solderQc').value || '';
    
    const thVisual1 = document.getElementById('thVisual1').value || '';
    const thVisual2 = document.getElementById('thVisual2').value || '';
    const thVisual3 = document.getElementById('thVisual3').value || '';
    const thEng = document.getElementById('thEng').value || '';
    const thQc = document.getElementById('thQc').value || '';
    
    // Conclusion
    const finalResult = document.getElementById('finalResult').value || '';
    const processRisks = document.getElementById('processRisks').value || '';
    const lessonsLearned = document.getElementById('lessonsLearned').value || '';
    const processImprovement = document.getElementById('processImprovement').value || '';
    
    const totalQty = document.getElementById('totalQty').value || '0';
    const okQty = document.getElementById('okQty').value || '0';
    const ngQty = document.getElementById('ngQty').value || '0';
    const defectRate = document.getElementById('defectRate').value || '0%';
    const defectDescription = document.getElementById('defectDescription').value || '';
    
    // Signatures
    const engineerName = document.getElementById('engineerName').value || '';
    const qcName = document.getElementById('qcName').value || '';
    const engineerSignature = localStorage.getItem('engineer_signature');
    const qcSignature = localStorage.getItem('qc_signature');
    
    // Hàm tạo text với highlight
    function createHighlightedText(value, highlightCondition = true) {
        if (value && highlightCondition) {
            return `<span class="highlighted-value" style="color: #1565C0; font-weight: 600; background-color: #E3F2FD; padding: 1px 4px; border-radius: 2px; display: inline-block; margin: 1px 0;">${value}</span>`;
        }
        return value || '';
    }
    
    // Hàm tạo textarea với highlight
    function createHighlightedTextarea(value) {
        if (value) {
            return `<div style="color: #1565C0; font-weight: 600; background-color: #E3F2FD; padding: 4px 6px; border-radius: 3px; border-left: 3px solid #1565C0;">${value}</div>`;
        }
        return '';
    }
    
    // Hàm tạo select với highlight
    function createHighlightedSelect(value) {
        if (value) {
            return `<span style="color: #1565C0; font-weight: 600; background-color: #E3F2FD; padding: 2px 8px; border-radius: 3px; border: 1px solid #1565C0;">${value}</span>`;
        }
        return '';
    }
    
    // Tạo nội dung PDF với cấu trúc giống file mẫu và có highlight
    return `
        <div style="width: 100%; font-family: 'Arial', sans-serif; font-size: 10pt; line-height: 1.2; box-sizing: border-box;">
            <!-- Header -->
            <div style="text-align: center; margin-bottom: 10px; border-bottom: 2px solid #000; padding-bottom: 5px;">
                <h1 style="font-size: 16pt; margin: 0; font-weight: bold;">BIỂU GHI NPI - NPI RECORD</h1>
                <div style="font-size: 10pt; margin-top: 3px;">TNEMS-EN-F-048-NPI RECORD-VER03</div>
            </div>
            
            <!-- Product Information -->
            <div style="border: 1px solid #000; margin-bottom: 10px; padding: 8px; page-break-inside: avoid;">
                <div style="background-color: #e0e0e0; padding: 6px; margin: -8px -8px 8px -8px; border-bottom: 1px solid #000; font-weight: bold; font-size: 11pt;">
                    THÔNG TIN SẢN PHẨM - PRODUCT INFORMATION
                </div>
                
                <table style="width: 100%; border-collapse: collapse; margin-top: 5px;">
                    <tr>
                        <td style="width: 25%; font-weight: bold; padding: 3px 0;">MÃ HÀNG / MODEL:</td>
                        <td style="width: 35%; padding: 3px 0;">
                            <strong>${createHighlightedText(model, model !== '')}</strong>
                        </td>
                        <td style="width: 20%; font-weight: bold; padding: 3px 0;">Part No:</td>
                        <td style="width: 20%; padding: 3px 0;">
                            ${createHighlightedText(partNo, partNo !== '')}
                        </td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold; padding: 3px 0;">KHÁCH HÀNG / CUSTOMER:</td>
                        <td style="padding: 3px 0;">
                            <strong>${createHighlightedText(customer, customer !== '')}</strong>
                        </td>
                        <td style="font-weight: bold; padding: 3px 0;">Ngày / Date:</td>
                        <td style="padding: 3px 0;">
                            ${createHighlightedText(date, date !== '')}
                        </td>
                    </tr>
                </table>
                
                <div style="margin-top: 8px;">
                    <span style="font-weight: bold;">Quy trình / Process:</span>
                    <div style="margin-top: 5px;">
                        ${processText ? createHighlightedText(processText, processText !== '') : ''}
                    </div>
                </div>
            </div>
            
            <!-- SMT Process -->
            <div style="border: 1px solid #000; margin-bottom: 10px; padding: 8px; page-break-inside: avoid;">
                <div style="background-color: #e0e0e0; padding: 6px; margin: -8px -8px 8px -8px; border-bottom: 1px solid #000; font-weight: bold; font-size: 11pt;">
                    SMT PROCESS
                </div>
                
                <!-- Laser Marking -->
                <div style="margin-top: 10px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        LASER MARKING
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: left; width: 40%;">NỘI DUNG</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: left; width: 60%;">GIÁ TRỊ</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">Tên chương trình/ Program name</td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(laserProgram, laserProgram !== '')}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">Loại QR code/ QR code type</td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(qrType, qrType !== '')}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">Kích thước QR code/ QR code size</td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(qrSize, qrSize !== '')}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">Cường độ khắc/ Engraving intensity</td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(engravingIntensity, engravingIntensity !== '')}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">Side BOT: Nội dung QR code/ QR code content</td>
                            <td style="border: 1px solid #000; padding: 4px; min-height: 30px;">
                                ${qrContentBot ? createHighlightedTextarea(qrContentBot) : ''}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">Side TOP: Nội dung QR code/ QR code content</td>
                            <td style="border: 1px solid #000; padding: 4px; min-height: 30px;">
                                ${qrContentTop ? createHighlightedTextarea(qrContentTop) : ''}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">Nội dung QR code khi quét bằng máy</td>
                            <td style="border: 1px solid #000; padding: 4px; min-height: 30px;">
                                ${qrScanContent ? createHighlightedTextarea(qrScanContent) : ''}
                            </td>
                        </tr>
                    </table>
                </div>
                
                <!-- Printer -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        PRINTER
                    </div>
                    <div style="padding: 5px;">
                        ${printerControl ? createHighlightedText(printerControl, printerControl !== 'Theo Process control sheet đính kèm/According to the attached Process Control Sheet') : ''}
                    </div>
                </div>
                
                <!-- Mounter -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        MOUNTER
                    </div>
                    <div style="padding: 5px;">
                        ${mounterControl ? createHighlightedText(mounterControl, mounterControl !== 'Theo Process control sheet đính kèm (có xác nhận và đo giá trị của các bên)/According to the attached Process Control Sheet') : ''}
                    </div>
                </div>
                
                <!-- Visual Inspection 1 -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        NGOẠI QUAN VISUAL INSPECTION
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 40%;">HƯỚNG LINH KIỆN/COMPONENT POLARITY</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">SỐ LƯỢNG LINH KIỆN/COMPONENT QUANTITY</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">KẾT QUẢ/RESULT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">Theo bảng hướng linh kiện đính kèm (QC)</td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                <div>Theo BOM/ According to the BOM: 
                                    ${createHighlightedText(bomQty, bomQty !== '')}
                                </div>
                                <div style="margin-top: 5px;">Thực tế/ Reality: 
                                    ${createHighlightedText(actualQty, actualQty !== '')}
                                </div>
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${visualResult1 ? createHighlightedSelect(visualResult1) : ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                <div>ENG: ${createHighlightedText(engVerify1, engVerify1 !== '')}</div>
                                <div style="margin-top: 2px;">QC: ${createHighlightedText(qcVerify1, qcVerify1 !== '')}</div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- Reflow Oven -->
            <div style="border: 1px solid #000; margin-bottom: 10px; padding: 8px; page-break-inside: avoid;">
                <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                    LÒ REFLOW/REFLOW OVEN
                </div>
                
                <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                    <tr>
                        <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                        <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 40%;">THÔNG SỐ CÀI ĐẶT MÁY/MACHINE PARAMETERS SETTING</th>
                        <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">KẾT QUẢ/RESULT</th>
                        <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">XÁC NHẬN/VERIFY</th>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 4px;">
                            - Theo Process control sheet đính kèm<br>
                            - Profile lò đính kèm
                        </td>
                        <td style="border: 1px solid #000; padding: 4px; min-height: 40px;">
                            ${reflowParams ? createHighlightedTextarea(reflowParams) : ''}
                        </td>
                        <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                            ${reflowResult ? createHighlightedSelect(reflowResult) : ''}
                        </td>
                        <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                            <div>ENG: ${createHighlightedText(reflowEng, reflowEng !== '')}</div>
                            <div style="margin-top: 2px;">QC: ${createHighlightedText(reflowQc, reflowQc !== '')}</div>
                        </td>
                    </tr>
                </table>
                
                <!-- AOI -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        AOI/AUTOMATED OPTICAL INSPECTION
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 25%;">SỐ LƯỢNG PCBA ĐÃ AOI/PCBA AOI INSPECTED QUANTITY</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">KẾT QUẢ/RESULT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">
                                <div>BOT: ${createHighlightedText(aoiProgramBot, aoiProgramBot !== '')}</div>
                                <div style="margin-top: 5px;">TOP: ${createHighlightedText(aoiProgramTop, aoiProgramTop !== '')}</div>
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${createHighlightedText(aoiQty, aoiQty !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${aoiResult ? createHighlightedSelect(aoiResult) : ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                <div>ENG: ${createHighlightedText(aoiEng, aoiEng !== '')}</div>
                                <div style="margin-top: 2px;">QC: ${createHighlightedText(aoiQc, aoiQc !== '')}</div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <!-- Flying Probe -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        FLYING PROBE (20%)
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">TÊN CHƯƠNG TRÌNH/PROGRAM NAME</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 25%;">SỐ LƯỢNG ĐÃ ĐO/MEASURED QUANTITY</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">KẾT QUẢ/RESULT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">
                                <div>BOT: ${createHighlightedText(probeProgramBot, probeProgramBot !== '')}</div>
                                <div style="margin-top: 5px;">TOP: ${createHighlightedText(probeProgramTop, probeProgramTop !== '')}</div>
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${createHighlightedText(probeQty, probeQty !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${probeResult ? createHighlightedSelect(probeResult) : ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                <div>ENG: ${createHighlightedText(probeEng, probeEng !== '')}</div>
                                <div style="margin-top: 2px;">QC: ${createHighlightedText(probeQc, probeQc !== '')}</div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <!-- Visual Inspection 2 -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        NGOẠI QUAN VISUAL INSPECTION
                    </div>
                    <div style="font-size: 8pt; color: #666; margin: 5px 0; font-style: italic;">
                        KIỂM TRA SỐ LƯỢNG LINH KIỆN, CHẤT LƯỢNG MỐI HÀN, HƯỚNG LINH KIỆN, CÁC LỖI ĐÁNH GIÁ THEO IPC
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 40%;">NỘI DUNG KIỂM TRA</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">KẾT QUẢ</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">- Số lượng linh kiện/ Component Quantity</td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${visual2Result1 ? createHighlightedSelect(visual2Result1) : ''}
                            </td>
                            <td rowspan="4" style="border: 1px solid #000; padding: 4px; text-align: center; vertical-align: middle;">
                                <div>ENG: ${createHighlightedText(visual2Eng, visual2Eng !== '')}</div>
                                <div style="margin-top: 10px;">QC: ${createHighlightedText(visual2Qc, visual2Qc !== '')}</div>
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">- Chất lượng mối hàn/ Solder Joint Quality</td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${visual2Result2 ? createHighlightedSelect(visual2Result2) : ''}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">- Hướng linh kiện/ Component Orientation</td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${visual2Result3 ? createHighlightedSelect(visual2Result3) : ''}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">- Các lỗi đánh giá theo IPC/ Defects Evaluated per IPC</td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${visual2Result4 ? createHighlightedSelect(visual2Result4) : ''}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- Through-Hole Process -->
            <div style="border: 1px solid #000; margin-bottom: 10px; padding: 8px; page-break-inside: avoid;">
                <div style="background-color: #e0e0e0; padding: 6px; margin: -8px -8px 8px -8px; border-bottom: 1px solid #000; font-weight: bold; font-size: 11pt;">
                    THROUGH-HOLE PROCESS
                </div>
                
                <!-- Hand Soldering -->
                <div style="margin-top: 10px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        QUY TRÌNH HÀN TAY/HAND SOLDERING PROCESS
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 40%;">THÔNG SỐ/ PARAMETERS</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">GIÁ TRỊ/ VALUE</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">KẾT QUẢ/RESULT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 15%;">XÁC NHẬN/VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">Nhiệt độ mỏ hàn/ Soldering iron temperature</td>
                            <td style="border: 1px solid #000; padding: 4px;">
                                ${createHighlightedText(solderTemp, solderTemp !== '')}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${solderResult ? createHighlightedSelect(solderResult) : ''}
                            </td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                <div>ENG: ${createHighlightedText(solderEng, solderEng !== '')}</div>
                                <div style="margin-top: 2px;">QC: ${createHighlightedText(solderQc, solderQc !== '')}</div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <!-- Visual Inspection -->
                <div style="margin-top: 15px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px -8px;">
                        VISUAL INSPECTION
                    </div>
                    <div style="font-size: 8pt; color: #666; margin: 5px 0; font-style: italic;">
                        KIỂM TRA CHẤT LƯỢNG MỐI HÀN THEO TIÊU CHUẨN IPC
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                        <tr>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 40%;">TIÊU CHÍ/ CRITERIA</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">KẾT QUẢ/ RESULT</th>
                            <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">XÁC NHẬN/ VERIFY</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">- Chất lượng mối hàn/ Solder joint quality</td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${thVisual1 ? createHighlightedSelect(thVisual1) : ''}
                            </td>
                            <td rowspan="3" style="border: 1px solid #000; padding: 4px; text-align: center; vertical-align: middle;">
                                <div>ENG: ${createHighlightedText(thEng, thEng !== '')}</div>
                                <div style="margin-top: 10px;">QC: ${createHighlightedText(thQc, thQc !== '')}</div>
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">- Độ ướt chân/ Wetting</td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${thVisual2 ? createHighlightedSelect(thVisual2) : ''}
                            </td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 4px;">- Không có cầu chì/ No solder bridges</td>
                            <td style="border: 1px solid #000; padding: 4px; text-align: center;">
                                ${thVisual3 ? createHighlightedSelect(thVisual3) : ''}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- Conclusion -->
            <div style="border: 1px solid #000; margin-bottom: 10px; padding: 8px; page-break-inside: avoid;">
                <div style="background-color: #e0e0e0; padding: 6px; margin: -8px -8px 8px -8px; border-bottom: 1px solid #000; font-weight: bold; font-size: 11pt;">
                    KẾT LUẬN/ CONCLUSION
                </div>
                
                <table style="width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt;">
                    <tr>
                        <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 20%;">KẾT QUẢ CUỐI CÙNG/FINAL RESULT</th>
                        <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 25%;">RỦI RO TRONG CÁC CÔNG ĐOẠN/RISKS IN EACH PROCESS STEP</th>
                        <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 25%;">BÀI HỌC TỪNG CÔNG ĐOẠN/LESSONS LEARNED FROM EACH PROCESS STEP</th>
                        <th style="border: 1px solid #000; padding: 4px; background-color: #f0f0f0; text-align: center; width: 30%;">CẢI TIẾN CÔNG ĐOẠN/PROCESS IMPROVEMENT</th>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 4px; text-align: center; vertical-align: middle;">
                            ${finalResult ? createHighlightedSelect(finalResult) : ''}
                        </td>
                        <td style="border: 1px solid #000; padding: 4px; min-height: 100px;">
                            ${processRisks ? createHighlightedTextarea(processRisks) : ''}
                        </td>
                        <td style="border: 1px solid #000; padding: 4px; min-height: 100px;">
                            ${lessonsLearned ? createHighlightedTextarea(lessonsLearned) : ''}
                        </td>
                        <td style="border: 1px solid #000; padding: 4px; min-height: 100px;">
                            ${processImprovement ? createHighlightedTextarea(processImprovement) : ''}
                        </td>
                    </tr>
                </table>
                
                <div style="margin-top: 15px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                        <tr>
                            <td style="padding: 4px; width: 25%;">
                                <div><strong>Tổng số lượng (PCBA):</strong></div>
                                <div><strong>Total qty (PCBA):</strong></div>
                                <div style="margin-top: 5px; font-size: 11pt;">
                                    ${totalQty !== '0' ? createHighlightedText(totalQty) : '0'}
                                </div>
                            </td>
                            <td style="padding: 4px; width: 20%;">
                                <div><strong>OK :</strong></div>
                                <div style="margin-top: 5px; font-size: 11pt;">
                                    ${okQty !== '0' ? createHighlightedText(okQty) : '0'}
                                </div>
                            </td>
                            <td style="padding: 4px; width: 20%;">
                                <div><strong>NG (scrap) :</strong></div>
                                <div style="margin-top: 5px; font-size: 11pt;">
                                    ${ngQty !== '0' ? createHighlightedText(ngQty) : '0'}
                                </div>
                            </td>
                            <td style="padding: 4px; width: 35%;">
                                <div><strong>Tỷ lệ lỗi/ Defect rate (%) :</strong></div>
                                <div><strong>(NG/Total)</strong></div>
                                <div style="margin-top: 5px; font-size: 11pt;">
                                    ${defectRate !== '0%' ? createHighlightedText(defectRate) : '0%'}
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <div style="margin-top: 10px;">
                    <div><strong>Mô tả chi tiết lỗi / detailed defect description:</strong></div>
                    <div style="margin-top: 5px; min-height: 50px;">
                        ${defectDescription ? createHighlightedTextarea(defectDescription) : ''}
                    </div>
                </div>
                
                <!-- Electronic Signatures -->
                <div style="margin-top: 20px;">
                    <div style="background-color: #f0f0f0; padding: 5px; font-weight: bold; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; margin: 5px 0;">
                        XÁC NHẬN ĐIỆN TỬ - ELECTRONIC SIGNATURES
                    </div>
                    
                    <div style="display: flex; gap: 30px; margin-top: 10px;">
                        <div style="flex: 1;">
                            <div><strong>Ký xác nhận của Kỹ sư / Engineer Signature:</strong></div>
                            <div style="border: 1px solid #000; padding: 10px; margin-top: 5px; min-height: 80px; display: flex; align-items: center; justify-content: center;">
                                ${engineerSignature ? `<img src="${engineerSignature}" alt="Engineer Signature" style="max-width: 100%; max-height: 70px;">` : ''}
                            </div>
                            <div style="margin-top: 5px;">
                                <strong>Tên Kỹ sư / Engineer Name:</strong> 
                                ${engineerName ? createHighlightedText(engineerName) : ''}
                            </div>
                        </div>
                        
                        <div style="flex: 1;">
                            <div><strong>Ký xác nhận của QC / QC Signature:</strong></div>
                            <div style="border: 1px solid #000; padding: 10px; margin-top: 5px; min-height: 80px; display: flex; align-items: center; justify-content: center;">
                                ${qcSignature ? `<img src="${qcSignature}" alt="QC Signature" style="max-width: 100%; max-height: 70px;">` : ''}
                            </div>
                            <div style="margin-top: 5px;">
                                <strong>Tên QC / QC Name:</strong> 
                                ${qcName ? createHighlightedText(qcName) : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div style="text-align: center; margin-top: 20px; color: #666; font-size: 9pt; padding-top: 15px; border-top: 1px solid #ddd;">
                <p>NPI Record - Phiên bản Multi-User Real-time</p>
                <p>© 2024 - Đồng bộ thời gian thực với Firebase</p>
            </div>
        </div>
    `;
}

        // ========== ĐỊNH DẠNG NGÀY THÁNG ==========
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // ========== VALIDATE FORM ==========
        function validateForm() {
            const model = document.getElementById('model').value.trim();
            const customer = document.getElementById('customer').value.trim();
            
            let isValid = true;
            
            if (!model) {
                document.getElementById('model').classList.add('validation-error');
                isValid = false;
            } else {
                document.getElementById('model').classList.remove('validation-error');
            }
            
            if (!customer) {
                document.getElementById('customer').classList.add('validation-error');
                isValid = false;
            } else {
                document.getElementById('customer').classList.remove('validation-error');
            }
            
            return isValid;
        }

        // ========== IN TRỰC TIẾP ==========
        function printForm() {
            if (!validateForm()) {
                showToast('Vui lòng điền đầy đủ các trường bắt buộc (Mã hàng và Khách hàng) trước khi in!', 'error');
                return;
            }
            
            // Tạo template cho in ấn
            const printTemplate = document.createElement('div');
            printTemplate.innerHTML = generatePDFContentNew();
            
            // Mở cửa sổ in
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>NPI Record - ${document.getElementById('model').value || 'Unknown'}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 10pt;
                            margin: 0;
                            padding: 15mm;
                            line-height: 1.2;
                        }
                        @media print {
                            body { padding: 0; }
                            .page-break { page-break-before: always; }
                        }
                    </style>
                </head>
                <body>
                    ${printTemplate.innerHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // ========== CÁC HÀM TIỆN ÍCH ==========
        function setupFormListeners() {
            document.querySelectorAll("textarea").forEach(textarea => {
                textarea.addEventListener("input", function() {
                    this.style.height = "auto";
                    this.style.height = this.scrollHeight + "px";
                });
                setTimeout(() => {
                    textarea.dispatchEvent(new Event("input"));
                }, 100);
            });
        }

        function updateStatus(message, status = "offline") {
            const statusEl = document.getElementById("cloudStatus");
            const textEl = document.getElementById("cloudStatusText");
            
            if (statusEl) statusEl.className = "status-indicator " + status;
            if (textEl) textEl.textContent = message;
        }

        function updateCloudStatus() {
            const isOnline = navigator.onLine;
            updateStatus(isOnline ? "Đang kết nối" : "Mất kết nối", isOnline ? "online" : "offline");
        }

        // ========== RESET FORM ==========
        function resetForm() {
            if (confirm("Bạn có chắc muốn xóa TẤT CẢ dữ liệu hiện tại?\n\nDữ liệu đã lưu trên cloud vẫn giữ nguyên.")) {
                document.querySelectorAll("input, textarea, select").forEach(element => {
                    if (element.type === "checkbox") {
                        element.checked = false;
                    } else if (element.type === "date") {
                        element.value = new Date().toISOString().split("T")[0];
                    } else if (element.type !== "button" && element.type !== "submit") {
                        element.value = "";
                    }
                    updateHighlight(element);
                });
                
                if (engineerSignaturePad) engineerSignaturePad.clear();
                if (qcSignaturePad) qcSignaturePad.clear();
                localStorage.removeItem("engineer_signature");
                localStorage.removeItem("qc_signature");
                const engDisplay = document.getElementById("engineerSignatureDisplay");
                const qcDisplay = document.getElementById("qcSignatureDisplay");
                if (engDisplay) {
                    engDisplay.innerHTML = '<div style="padding: 10px; text-align: center;">Chữ ký sẽ hiển thị ở đây sau khi lưu</div>';
                    engDisplay.classList.remove("has-signature");
                }
                if (qcDisplay) {
                    qcDisplay.innerHTML = '<div style="padding: 10px; text-align: center;">Chữ ký sẽ hiển thị ở đây sau khi lưu</div>';
                    qcDisplay.classList.remove("has-signature");
                }
                
                updateStatus("Đã xóa dữ liệu cục bộ", "offline");
                showToast("✅ Đã xóa dữ liệu cục bộ thành công!", "success");
            }
        }

        // ========== KHỞI ĐỘNG TRANG ==========
        document.addEventListener("DOMContentLoaded", function() {
            console.log("🚀 Khởi động NPI Record Multi-User...");
            
            initUser();
            
            const today = new Date().toISOString().split("T")[0];
            document.getElementById("date").value = today;
            
            const urlParams = new URLSearchParams(window.location.search);
            const projectIdFromUrl = urlParams.get("project");
            
            setupHighlightListeners();
            setupSignaturePads();
            setupFormListeners();
            setupRealTimeInput();
            
            document.getElementById("projectAction").addEventListener("click", handleProjectAction);
            document.getElementById("saveToCloud").addEventListener("click", saveAllToCloud);
            document.getElementById("shareForm").addEventListener("click", generateShareLink);
            document.getElementById("exportPdf").addEventListener("click", exportToPDF);
            document.getElementById("printForm").addEventListener("click", printForm);
            document.getElementById("resetForm").addEventListener("click", resetForm);
            document.getElementById("copyLinkBtn").addEventListener("click", copyShareLink);
            document.getElementById("closeShareBtn").addEventListener("click", hideShareLink);
            
            document.getElementById("projectIdDisplay")?.addEventListener("click", function() {
                if (currentProjectId) {
                    navigator.clipboard.writeText(currentProjectId).then(() => {
                        showToast("✅ Đã copy Project ID", "success");
                    });
                }
            });
            
            if (projectIdFromUrl) {
                setTimeout(() => {
                    showLoading("Đang kết nối đến project...");
                    currentProjectId = projectIdFromUrl;
                    document.getElementById("projectIdDisplay").textContent = `ID: ${projectIdFromUrl}`;
                    document.getElementById("onlineUsersContainer").style.display = "block";
                    
                    if (!currentUser) initUser();
                    setupRealtimeListeners();
                    loadProjectData();
                    
                    showToast("📡 Đã tự động kết nối đến project", "info");
                    updateStatus("Đang đồng bộ thời gian thực", "online");
                    
                    setTimeout(hideLoading, 1000);
                }, 500);
            }
            
            window.addEventListener("online", updateCloudStatus);
            window.addEventListener("offline", updateCloudStatus);
            
            updateCloudStatus();
        });

        function setupHighlightListeners() {
            document.querySelectorAll("input, textarea, select").forEach(element => {
                updateHighlight(element);
                
                element.addEventListener("input", function() {
                    updateHighlight(this);
                });
                
                element.addEventListener("change", function() {
                    updateHighlight(this);
                });
            });
            
            document.querySelectorAll(".checkbox-group input[type='checkbox']").forEach(cb => {
                cb.addEventListener("change", function() {
                    updateHighlight(this);
                    const label = this.nextElementSibling;
                    if (label && this.checked) {
                        label.classList.add("highlight-text");
                    } else {
                        label.classList.remove("highlight-text");
                    }
                });
            });
        }

        console.log("🔥 NPI Record Multi-User đã sẵn sàng!");
        console.log("📌 Hướng dẫn sử dụng:");
        console.log("1. Click 'Tạo/Tham gia Project' để bắt đầu");
        console.log("2. Tạo project mới hoặc nhập ID project có sẵn");
        console.log("3. Chia sẻ link cho đồng nghiệp");
        console.log("4. Cùng nhập dữ liệu thời gian thực!");
    </script>
</body>
</html>